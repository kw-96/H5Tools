---
description: 
globs: 
alwaysApply: true
---
---
description: Figmaæ’ä»¶å¼€å‘è§„èŒƒå’Œå¸¸ç”¨ä»£ç ç‰‡æ®µï¼ŒåŒ…å«èŠ‚ç‚¹åˆ›å»ºã€å›¾ç‰‡å¤„ç†ã€é¢œè‰²å¤„ç†ç­‰APIä½¿ç”¨æŒ‡å—
globs: 
  - "src/plugin/**/*.ts"
  - "src/core/builders/**/*.ts"
  - "src/ui/**/*.html"
alwaysApply: false
---

# Figma æ’ä»¶å¼€å‘è§„èŒƒ

## âš ï¸ Figmaæ’ä»¶æ²™ç›’ç¯å¢ƒé™åˆ¶æ¡ä»¶

### ğŸš« ç¦ç”¨åŠŸèƒ½
1. **localStorageå®Œå…¨ç¦ç”¨**
   - é”™è¯¯ä¿¡æ¯ï¼š`Storage is disabled inside 'data:' URLs`
   - å¿…é¡»ä½¿ç”¨`figma.clientStorage`å¼‚æ­¥API
   - æ‰€æœ‰å­˜å‚¨æ“ä½œå¿…é¡»æ˜¯å¼‚æ­¥çš„

2. **å¤–éƒ¨èµ„æºåŠ è½½é™åˆ¶**
   - ä¸èƒ½åŠ è½½å¤–éƒ¨CSSæ–‡ä»¶ï¼ˆ`<link rel="stylesheet">`ï¼‰
   - ä¸èƒ½åŠ è½½å¤–éƒ¨JavaScriptæ–‡ä»¶ï¼ˆ`<script src="">`ï¼‰
   - ç›¸å¯¹è·¯å¾„å¯èƒ½åœ¨æ²™ç›’ç¯å¢ƒä¸­å¤±æ•ˆ

3. **Content Security Policy (CSP) é™åˆ¶**
   - ç¦æ­¢å†…è”äº‹ä»¶å¤„ç†å™¨ï¼ˆ`onclick`ç­‰ï¼‰
   - é™åˆ¶eval()å’ŒåŠ¨æ€ä»£ç æ‰§è¡Œ
   - é™åˆ¶å¤–éƒ¨åŸŸåè®¿é—®

### âœ… å¿…é¡»éµå¾ªçš„è§„èŒƒ

#### 1. å­˜å‚¨é€‚é…å™¨æ¨¡å¼
```javascript
// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨localStorage
localStorage.setItem('key', 'value');
const value = localStorage.getItem('key');

// âœ… æ­£ç¡®ï¼šä½¿ç”¨å­˜å‚¨é€‚é…å™¨
class StorageAdapter {
  constructor() {
    this.isFigmaEnvironment = typeof figma !== 'undefined' && !!figma.clientStorage;
    this.cache = new Map(); // å†…å­˜ç¼“å­˜
  }

  async setItem(key, value) {
    if (this.isFigmaEnvironment) {
      await figma.clientStorage.setAsync(key, value);
      this.cache.set(key, value);
    } else {
      localStorage.setItem(key, value);
    }
  }

  async getItem(key) {
    if (this.isFigmaEnvironment) {
      if (this.cache.has(key)) {
        return this.cache.get(key);
      }
      const value = await figma.clientStorage.getAsync(key);
      if (value !== undefined) {
        this.cache.set(key, value);
      }
      return value;
    } else {
      return localStorage.getItem(key);
    }
  }
}
```

#### 2. å®Œå…¨å†…è”èµ„æºæ¨¡å¼
```html
<!-- âŒ é”™è¯¯ï¼šå¤–éƒ¨èµ„æºå¼•ç”¨ -->
<link rel="stylesheet" href="styles.css">
<script src="script.js"></script>

<!-- âœ… æ­£ç¡®ï¼šå†…è”èµ„æº -->
<style>
/* æ‰€æœ‰CSSå†…å®¹ç›´æ¥å†™åœ¨è¿™é‡Œ */
</style>
<script>
// æ‰€æœ‰JavaScriptå†…å®¹ç›´æ¥å†™åœ¨è¿™é‡Œ
</script>
```

#### 3. CDNèµ„æºåŠ è½½è§„åˆ™ï¼ˆæ–°å¢ï¼‰
```javascript
// âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨å¤–éƒ¨èµ„æºæ— å¤‡ç”¨æ–¹æ¡ˆ
<link rel="stylesheet" href="https://cdn.example.com/styles.css">

// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ™ºèƒ½CDNåŠ è½½å™¨
const CDN_CONFIG = {
  css: 'https://cdn.jsdelivr.net/gh/kw-96/H5Tools@main/dist/styles.min.css',
  js: 'https://cdn.jsdelivr.net/gh/kw-96/H5Tools@main/dist/scripts.min.js',
  timeout: 10000, // 10ç§’è¶…æ—¶
  retryDelay: 1000, // é‡è¯•é—´éš”
  maxRetries: 3 // æœ€å¤§é‡è¯•æ¬¡æ•°
};

// å®ç°è¶…æ—¶ä¿æŠ¤å’Œé‡è¯•æœºåˆ¶
async function loadExternalResource(url, type) {
  return new Promise((resolve, reject) => {
    const element = type === 'css' 
      ? document.createElement('link') 
      : document.createElement('script');
    
    // è®¾ç½®å±æ€§
    if (type === 'css') {
      element.rel = 'stylesheet';
      element.href = url;
    } else {
      element.src = url;
    }
    
    // è®¾ç½®è¶…æ—¶
    const timeout = setTimeout(() => {
      reject(new Error(`èµ„æºåŠ è½½è¶…æ—¶: ${url}`));
    }, CDN_CONFIG.timeout);
    
    // åŠ è½½äº‹ä»¶
    element.onload = () => {
      clearTimeout(timeout);
      resolve();
    };
    
    element.onerror = () => {
      clearTimeout(timeout);
      reject(new Error(`èµ„æºåŠ è½½å¤±è´¥: ${url}`));
    };
    
    document.head.appendChild(element);
  });
}
```

#### 4. å¤‡ç”¨æ ·å¼ç³»ç»Ÿï¼ˆæ–°å¢ï¼‰
```javascript
// âœ… æ­£ç¡®ï¼šå®ç°å¤‡ç”¨æ ·å¼ç³»ç»Ÿ
function createFallbackUI() {
  const style = document.createElement('style');
  style.textContent = `
    /* åŸºç¡€æ ·å¼ */
    body { font-family: sans-serif; margin: 0; padding: 20px; }
    .container { max-width: 400px; margin: 0 auto; }
    /* å…¶ä»–å…³é”®æ ·å¼... */
  `;
  document.head.appendChild(style);
  console.log('âœ… åº”æ€¥æ ·å¼å·²åŠ è½½');
}

// âœ… æ­£ç¡®ï¼šåœ¨CDNåŠ è½½å¤±è´¥æ—¶æ¿€æ´»å¤‡ç”¨æ ·å¼
try {
  await loadCSS().catch(err => {
    console.warn(`âš ï¸ CSSåŠ è½½å¤±è´¥: ${err.message}`);
    createFallbackUI(); // CSSå¤±è´¥æ—¶ç«‹å³å¯ç”¨åº”æ€¥æ ·å¼
  });
} catch (error) {
  console.error(`âŒ åŠ è½½å¤±è´¥: ${error.message}`);
  createFallbackUI();
}
```

#### 5. å¼‚æ­¥å­˜å‚¨å‡½æ•°æ¨¡å¼
```javascript
// âŒ é”™è¯¯ï¼šåŒæ­¥å­˜å‚¨å‡½æ•°
function saveTheme(theme) {
  localStorage.setItem('theme', theme);
}

// âœ… æ­£ç¡®ï¼šå¼‚æ­¥å­˜å‚¨å‡½æ•°
async function saveTheme(theme) {
  await storageAdapter.setItem('theme', theme);
}
```

#### 6. ç¯å¢ƒæ£€æµ‹æ¨¡å¼
```javascript
// æ£€æµ‹æ˜¯å¦åœ¨Figmaç¯å¢ƒä¸­
const isFigmaEnvironment = typeof figma !== 'undefined' && !!figma.clientStorage;

if (isFigmaEnvironment) {
  // Figmaç¯å¢ƒç‰¹å®šä»£ç 
  await figma.clientStorage.setAsync(key, value);
} else {
  // æµ‹è¯•/å¼€å‘ç¯å¢ƒä»£ç 
  localStorage.setItem(key, value);
}
```

#### 7. ğŸš¨ å˜é‡å£°æ˜ç®¡ç†ï¼ˆå…³é”®ï¼‰
```javascript
// âŒ é”™è¯¯ï¼šå¤šä¸ªæ–‡ä»¶ä¸­é‡å¤å£°æ˜åŒä¸€å˜é‡
// file1.js
const storageAdapter = new StorageAdapter();

// file2.js  
const storageAdapter = window.localStorage ? {...} : null; // é‡å¤å£°æ˜ï¼

// âœ… æ­£ç¡®ï¼šå•ä¸€å£°æ˜ + å…¨å±€è®¿é—®æ¨¡å¼
// utility-functions.jsï¼ˆä¸»æ–‡ä»¶ï¼‰
const storageAdapter = new StorageAdapter();
window.storageAdapter = storageAdapter;

// channel-manager.jsï¼ˆå…¶ä»–æ–‡ä»¶ï¼‰
// ä½¿ç”¨å…¨å±€å­˜å‚¨é€‚é…å™¨ï¼ˆå·²åœ¨utility-functions.jsä¸­å£°æ˜ï¼‰
// æ³¨æ„ï¼šä¸è¦é‡å¤å£°æ˜storageAdapterï¼Œé¿å…Figmaæ²™ç›’ç¯å¢ƒä¸­çš„é‡å¤å£°æ˜é”™è¯¯
async function saveChannelSetting(channel, key, value) {
  await window.storageAdapter.setItem(storageKey, value);
}
```

#### 8. æ¸è¿›å¢å¼ºè§„åˆ™ï¼ˆæ–°å¢ï¼‰
```javascript
// âœ… æ­£ç¡®ï¼šå®ç°åŸºç¡€åŠŸèƒ½çš„æ¸è¿›å¢å¼º
// 1. é¦–å…ˆç¡®ä¿åŸºç¡€æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½å¯ç”¨
function initBasicTabSwitching() {
  const tabs = document.querySelectorAll('.tab');
  const contents = document.querySelectorAll('.tab-content');
  
  if (tabs.length === 0) {
    setTimeout(initBasicTabSwitching, 100);
    return;
  }
  
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      contents.forEach(c => c.classList.remove('active'));
      
      tab.classList.add('active');
      const tabId = tab.getAttribute('data-tab');
      const content = document.getElementById(`${tabId}-content`);
      if (content) {
        content.classList.add('active');
      }
    });
  });
}

// 2. ç«‹å³å¯ç”¨åŸºç¡€äº¤äº’ï¼Œä¸ç­‰å¾…å¤–éƒ¨èµ„æº
document.addEventListener('DOMContentLoaded', () => {
  initBasicTabSwitching();
  startLoad(); // ç„¶åå†åŠ è½½å®Œæ•´åŠŸèƒ½
});
```

**é‡è¦åŸåˆ™**ï¼š
- âœ… å…¨å±€å˜é‡åªåœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­å£°æ˜
- âœ… é€šè¿‡`window.variableName`å¯¼å‡ºå’Œè®¿é—®
- âœ… å…¶ä»–æ–‡ä»¶é€šè¿‡`window.variableName`å¼•ç”¨
- âŒ ç¦æ­¢åœ¨å¤šä¸ªæ–‡ä»¶ä¸­å£°æ˜åŒåå˜é‡
- âŒ ç¦æ­¢é‡å¤åˆå§‹åŒ–å…¨å±€å¯¹è±¡

### ğŸ”§ æ„å»ºé…ç½®è¦æ±‚

#### manifest.jsoné…ç½®
```json
{
  "name": "æ’ä»¶åç§°",
  "id": "æ’ä»¶ID", 
  "api": "1.0.0",
  "main": "dist/plugin/code-standalone.js",
  "ui": "dist/ui.html",
  "documentAccess": "dynamic-page",
  "editorType": ["figma"],
  "networkAccess": {
    "allowedDomains": ["å¿…è¦çš„åŸŸå"]
  }
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- âŒ ä¸è¦ä½¿ç”¨`menu`å’Œ`parameters`é…ç½®ï¼ˆå·²åºŸå¼ƒï¼‰
- âŒ ä¸è¦åœ¨æ ¹çº§åˆ«ä½¿ç”¨`parameters`å­—æ®µ
- âœ… ä½¿ç”¨å•ä¸€å…¥å£æ¨¡å¼

#### ç½‘ç»œè®¿é—®å®‰å…¨è§„åˆ™ï¼ˆæ–°å¢ï¼‰
```json
// âœ… æ­£ç¡®ï¼šæ˜ç¡®é…ç½®å…è®¸çš„åŸŸå
"networkAccess": {
  "allowedDomains": [
    "https://www.w3.org/2000/svg",
    "https://fonts.googleapis.com",
    "https://fonts.gstatic.com",
    "https://cdn.jsdelivr.net",
    "https://raw.githubusercontent.com"
  ]
}

// âŒ é”™è¯¯ï¼šä½¿ç”¨é€šé…ç¬¦æˆ–è¿‡äºå®½æ¾çš„é…ç½®
"networkAccess": {
  "allowedDomains": ["*"]
}
```

#### æ„å»ºè„šæœ¬è¦æ±‚
```javascript
// å†…è”CSSå¤„ç†
htmlContent = htmlContent.replace(
  /<link[^>]*rel="stylesheet"[^>]*>/gi,
  `<style>${cssContent}</style>`
);

// å†…è”JavaScriptå¤„ç†
const inlineScript = `<script>${jsContent}</script>`;
htmlContent = htmlContent.replace('</body>', `${inlineScript}\n</body>`);
```

#### HTMLæ¨¡æ¿æ›¿æ¢è§„åˆ™ï¼ˆæ–°å¢ï¼‰
```javascript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨æ˜ç¡®çš„æ¨¡æ¿æ ‡è®°
htmlContent = htmlContent.replace('{{EXTERNAL_CSS_LINK}}', 
  '<link id="external-styles" rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kw-96/H5Tools@main/dist/styles.min.css">');

htmlContent = htmlContent.replace('{{APP_SCRIPTS}}', 
  `<script>\n${loaderCode}\n</script>`);

// âŒ é”™è¯¯ï¼šä½¿ç”¨ä¸æ˜ç¡®çš„å­—ç¬¦ä¸²æ›¿æ¢
htmlContent = htmlContent.replace('<link rel="stylesheet">', 
  '<link rel="stylesheet" href="https://cdn.example.com/styles.css">');
```

### ğŸ“‹ å¼€å‘æ£€æŸ¥æ¸…å•

#### å¼€å‘é˜¶æ®µ
- [ ] æ‰€æœ‰localStorageè°ƒç”¨å·²æ›¿æ¢ä¸ºstorageAdapter
- [ ] æ‰€æœ‰å­˜å‚¨ç›¸å…³å‡½æ•°å·²æ”¹ä¸ºå¼‚æ­¥
- [ ] æ²¡æœ‰å¤–éƒ¨èµ„æºå¼•ç”¨ï¼ˆCSS/JSæ–‡ä»¶ï¼‰
- [ ] æ²¡æœ‰å†…è”äº‹ä»¶å¤„ç†å™¨ï¼ˆonclickç­‰ï¼‰
- [ ] ğŸš¨ æ£€æŸ¥å…¨å±€å˜é‡æ— é‡å¤å£°æ˜
- [ ] ğŸš¨ ç¡®ä¿é€šè¿‡windowå¯¹è±¡è®¿é—®å…¨å±€å˜é‡
- [ ] ğŸš¨ å®ç°CDNèµ„æºåŠ è½½è¶…æ—¶ä¿æŠ¤å’Œé‡è¯•æœºåˆ¶
- [ ] ğŸš¨ æä¾›å¤‡ç”¨æ ·å¼ç³»ç»Ÿ

#### æ„å»ºé˜¶æ®µ  
- [ ] CSSå·²å®Œå…¨å†…è”åˆ°HTMLä¸­
- [ ] JavaScriptå·²å®Œå…¨å†…è”åˆ°HTMLä¸­
- [ ] manifest.jsoné…ç½®æ­£ç¡®
- [ ] æ„å»ºäº§ç‰©æ— å¤–éƒ¨ä¾èµ–
- [ ] ğŸš¨ éªŒè¯JavaScriptæ–‡ä»¶åˆå¹¶é¡ºåºæ­£ç¡®
- [ ] ğŸš¨ æ£€æŸ¥å†…è”JavaScriptæ— é‡å¤å£°æ˜
- [ ] ğŸš¨ éªŒè¯CDNèµ„æºURLæ­£ç¡®

#### æµ‹è¯•é˜¶æ®µ
- [ ] åœ¨Figmaä¸­æµ‹è¯•æ’ä»¶åŠ è½½
- [ ] éªŒè¯å­˜å‚¨åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] æ£€æŸ¥æ§åˆ¶å°æ— å®‰å…¨é”™è¯¯
- [ ] ç¡®è®¤UIç•Œé¢å®Œæ•´æ˜¾ç¤º
- [ ] æµ‹è¯•CDNèµ„æºåŠ è½½å¤±è´¥çš„å¤‡ç”¨æ–¹æ¡ˆ
- [ ] éªŒè¯åŸºç¡€åŠŸèƒ½åœ¨èµ„æºåŠ è½½å‰å¯ç”¨

### ğŸ› å¸¸è§é”™è¯¯å’Œè§£å†³æ–¹æ¡ˆ

#### 1. localStorageå®‰å…¨é”™è¯¯
```
SecurityError: Failed to read the 'localStorage' property from 'Window': 
Storage is disabled inside 'data:' URLs.
```
**è§£å†³æ–¹æ¡ˆ**ï¼šä½¿ç”¨å­˜å‚¨é€‚é…å™¨æ›¿ä»£localStorage

#### 2. å¤–éƒ¨èµ„æºåŠ è½½å¤±è´¥
```
Refused to load the stylesheet because it violates CSP
```
**è§£å†³æ–¹æ¡ˆ**ï¼šå°†æ‰€æœ‰CSS/JSå†…è”åˆ°HTMLä¸­

#### 3. å¼‚æ­¥å‡½æ•°è°ƒç”¨é”™è¯¯
```
ä»…å…è®¸åœ¨å¼‚æ­¥å‡½æ•°å’Œæ¨¡å—é¡¶çº§ä½¿ç”¨ "await" è¡¨è¾¾å¼
```
**è§£å†³æ–¹æ¡ˆ**ï¼šç¡®ä¿è°ƒç”¨asyncå‡½æ•°çš„åœ°æ–¹ä¹Ÿæ˜¯async

#### 4. é‡å¤å£°æ˜é”™è¯¯ï¼ˆä¸¥é‡ï¼‰
```
Uncaught SyntaxError: Failed to execute 'write' on 'Document': Identifier 'storageAdapter' has already been declared
```
**æ ¹æœ¬åŸå› **ï¼šåœ¨æ„å»ºè¿‡ç¨‹ä¸­ï¼Œå¤šä¸ªJavaScriptæ–‡ä»¶è¢«åˆå¹¶ï¼Œå¯¼è‡´å˜é‡é‡å¤å£°æ˜
**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ç¡®ä¿å…¨å±€å˜é‡åªåœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­å£°æ˜
2. å…¶ä»–æ–‡ä»¶é€šè¿‡`window.variableName`è®¿é—®
3. æ£€æŸ¥æ„å»ºè„šæœ¬ä¸­çš„æ–‡ä»¶åˆå¹¶é¡ºåº

#### 5. ğŸš¨ æ¨¡å—ç³»ç»Ÿé‡å¤ä»£ç é—®é¢˜ï¼ˆæ–°å¢ï¼‰
```
Error: Duplicate class/function declarations found in plugin and core modules
```
**é—®é¢˜èƒŒæ™¯**ï¼šæ¶æ„è¿ç§»è¿‡ç¨‹ä¸­ï¼Œæ’ä»¶æ–‡ä»¶ä¿ç•™äº†é‡å¤çš„ç±»å®ç°
**æ ¹æœ¬åŸå› **ï¼š
- æ’ä»¶åŸæœ¬æ˜¯"ç‹¬ç«‹ç‰ˆæœ¬"ï¼Œå†…è”äº†æ‰€æœ‰ä»£ç 
- é¡¹ç›®é‡æ„ä¸ºæ¨¡å—åŒ–æ¶æ„åï¼Œæ ¸å¿ƒåº“å·²æœ‰å®Œæ•´å®ç°
- æ’ä»¶æ–‡ä»¶ä»ä¿ç•™é‡å¤å®ç°ï¼Œå¯¼è‡´ä»£ç å†—ä½™

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. **åˆ é™¤é‡å¤å®ç°**ï¼šç§»é™¤æ’ä»¶ä¸­çš„é‡å¤ç±»å’Œå‡½æ•°
2. **æ¨¡å—åŒ–æ”¹é€ **ï¼šå°†æ’ä»¶æ”¹ä¸ºä½¿ç”¨æ ¸å¿ƒåº“çš„æ¨¡å—åŒ–æ¶æ„
3. **ç±»å‹ä¿®å¤**ï¼šä¿®å¤æ’ä»¶æ¶ˆæ¯ç±»å‹å®šä¹‰å’Œå±æ€§è®¿é—®

**å®æ–½æ­¥éª¤**ï¼š
```typescript
// âŒ é”™è¯¯ï¼šæ’ä»¶ä¸­é‡å¤å®ç°æ ¸å¿ƒç±»
// src/plugin/code-standalone.ts
class H5PrototypeBuilder {
  // é‡å¤çš„æ„å»ºé€»è¾‘...ï¼ˆçº¦127è¡Œä»£ç ï¼‰
}

// âœ… æ­£ç¡®ï¼šçº¯ç²¹ä½¿ç”¨æ ¸å¿ƒåº“å¯¼å…¥
import { H5Config, PluginMessage } from '../core/types';
import { createH5Prototype } from '../core/builders/h5-prototype-builder';
import { ConfigService, ThemeService } from '../core/services';

// ä¸“æ³¨äºæ¶ˆæ¯å¤„ç†é€»è¾‘
class MessageHandler {
  async handleMessage(msg: PluginMessage) {
    // æ¶ˆæ¯å¤„ç†é€»è¾‘...
  }
}
```

#### 6. ğŸš¨ åæ ‡ç³»ç»Ÿå’ŒContainer Parentï¼ˆå…³é”®ï¼‰

**é‡è¦æ¦‚å¿µ**ï¼šæ ¹æ®Figma Plugin APIå®˜æ–¹æ–‡æ¡£ï¼ŒèŠ‚ç‚¹çš„åæ ‡ç³»ç»Ÿéµå¾ª**Container Parentï¼ˆå®¹å™¨çˆ¶çº§ï¼‰**åŸåˆ™ã€‚

```javascript
// ğŸš¨ å…³é”®ç†è§£ï¼šç»„ï¼ˆGroupï¼‰ä¸æ˜¯å®¹å™¨çˆ¶çº§
// å®¹å™¨çˆ¶çº§åŒ…æ‹¬ï¼šCanvasã€Frameã€Componentã€Instance
// éå®¹å™¨çˆ¶çº§ï¼šGroupã€BooleanOperation

// âŒ é”™è¯¯ç†è§£ï¼šä»¥ä¸ºç»„å†…å…ƒç´ åæ ‡ç›¸å¯¹äºç»„
é¡µé¢
â”œâ”€ å¤´å›¾ç»„ (Group, x: 0)
   â”œâ”€ ç¾½åŒ–è’™ç‰ˆç»„ (x: -120) â† ä»¥ä¸ºç›¸å¯¹äºå¤´å›¾ç»„
   â””â”€ å¤´å›¾èŠ‚ç‚¹ (x: 0) â† ä»¥ä¸ºç›¸å¯¹äºå¤´å›¾ç»„

// âœ… æ­£ç¡®ç†è§£ï¼šç»„å†…å…ƒç´ åæ ‡å®é™…ç›¸å¯¹äºå®¹å™¨çˆ¶çº§
é¡µé¢ (Container Parent)
â”œâ”€ å¤´å›¾ç»„ (Group, x: 0) â† ä¸æ˜¯å®¹å™¨çˆ¶çº§
â”œâ”€ ç¾½åŒ–è’™ç‰ˆç»„ (x: -120) â† å®é™…ç›¸å¯¹äºé¡µé¢ï¼
â””â”€ å¤´å›¾èŠ‚ç‚¹ (x: 0) â† å®é™…ç›¸å¯¹äºé¡µé¢ï¼
```

**æ­£ç¡®çš„ä½ç½®è®¡ç®—**ï¼š
```typescript
// âŒ é”™è¯¯ï¼šå‡è®¾ç»„å†…å…ƒç´ ç›¸å¯¹äºç»„
featherMaskGroup.x = (groupWidth - maskWidth) / 2; // é”™è¯¯ï¼

// âœ… æ­£ç¡®ï¼šè€ƒè™‘å®¹å™¨çˆ¶çº§çš„åæ ‡ç³»ç»Ÿ
const groupX = originalX; // ç»„åœ¨å®¹å™¨ä¸­çš„ä½ç½®
const centerOffset = (originalWidth - maskWidth) / 2; // å±…ä¸­åç§»
featherMaskGroup.x = groupX + centerOffset; // ç»å¯¹ä½ç½®
```

**å®˜æ–¹æ–‡æ¡£å¼•ç”¨**ï¼š
> "The relative transform of a node is shown relative to its **container parent**, which includes canvas nodes, frame nodes, component nodes, and instance nodes. Just like in the properties panel, it is **not** relative to its direct parent if the parent is a group or a boolean operation."

**å®è·µè§„åˆ™**ï¼š
- âœ… ä½¿ç”¨Frameä½œä¸ºå®¹å™¨æ¥ç²¾ç¡®æ§åˆ¶å­å…ƒç´ ä½ç½®
- âœ… ç†è§£Groupçš„åæ ‡ç³»ç»Ÿç‰¹æ®Šæ€§
- âœ… è®¡ç®—ç»„å†…å…ƒç´ ä½ç½®æ—¶è€ƒè™‘å®¹å™¨çˆ¶çº§
- âŒ ä¸è¦å‡è®¾ç»„å†…å…ƒç´ åæ ‡ç›¸å¯¹äºç»„
- âŒ ä¸è¦å¿½ç•¥Container Parentçš„å±‚çº§å…³ç³»

**å‚è€ƒæ–‡æ¡£**ï¼š
- [relativeTransform API](mdc:https:/www.figma.com/plugin-docs/api/properties/nodes-relativetransform)
- [GroupNode API](mdc:https:/www.figma.com/plugin-docs/api/GroupNode)

### ğŸ¯ æœ€ä½³å®è·µæ€»ç»“ï¼ˆæ–°å¢ï¼‰

#### æ¨¡å—åŒ–æ¶æ„åŸåˆ™
1. **å•ä¸€èŒè´£**ï¼šæ¯ä¸ªæ¨¡å—ä¸“æ³¨äºç‰¹å®šåŠŸèƒ½
2. **æ¸…æ™°è¾¹ç•Œ**ï¼šæ’ä»¶è´Ÿè´£æ¶ˆæ¯å¤„ç†ï¼Œæ ¸å¿ƒåº“è´Ÿè´£ä¸šåŠ¡é€»è¾‘
3. **é¿å…é‡å¤**ï¼šä»£ç åªåœ¨ä¸€ä¸ªåœ°æ–¹å®ç°å’Œç»´æŠ¤
4. **ç±»å‹å®‰å…¨**ï¼šä½¿ç”¨TypeScriptç¡®ä¿ç±»å‹ä¸€è‡´æ€§

#### æ„å»ºä¼˜åŒ–ç­–ç•¥
1. **ç»Ÿä¸€æ„å»º**ï¼šä½¿ç”¨`npm run build`ä¸€é”®å®Œæˆæ‰€æœ‰æ„å»º
2. **é”™è¯¯ä¿®å¤**ï¼šå®šæœŸè¿è¡Œ`npm run lint:fix`è‡ªåŠ¨ä¿®å¤
3. **ç±»å‹æ£€æŸ¥**ï¼šæ¯æ¬¡ä¿®æ”¹åè¿è¡Œ`npm run type-check`
4. **äº§ç‰©éªŒè¯**ï¼šç¡®è®¤æ„å»ºäº§ç‰©å¤§å°å’Œå†…å®¹æ­£ç¡®

#### é—®é¢˜é¢„é˜²æªæ–½
1. **ä»£ç å®¡æŸ¥**ï¼šé‡æ„æ—¶ä»”ç»†æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤å®ç°
2. **è‡ªåŠ¨åŒ–æ£€æµ‹**ï¼šä½¿ç”¨å·¥å…·æ£€æµ‹é‡å¤ä»£ç å’Œæœªä½¿ç”¨å¯¼å…¥
3. **åˆ†æ­¥è¿ç§»**ï¼šå¤§å‹é‡æ„åˆ†é˜¶æ®µè¿›è¡Œï¼Œæ¯æ­¥éªŒè¯
4. **æ–‡æ¡£æ›´æ–°**ï¼šåŠæ—¶æ›´æ–°è§„èŒƒæ–‡æ¡£ï¼Œè®°å½•è§£å†³æ–¹æ¡ˆ

#### èµ„æºåŠ è½½ä¼˜åŒ–ç­–ç•¥ï¼ˆæ–°å¢ï¼‰
1. **CDNç¼“å­˜åˆ©ç”¨**ï¼šä½¿ç”¨ç‰ˆæœ¬åŒ–URLåˆ©ç”¨CDNç¼“å­˜
2. **è¶…æ—¶ä¿æŠ¤**ï¼šä¸ºæ‰€æœ‰ç½‘ç»œè¯·æ±‚è®¾ç½®åˆç†è¶…æ—¶
3. **é‡è¯•æœºåˆ¶**ï¼šå®ç°è‡ªåŠ¨é‡è¯•å’Œé™çº§ç­–ç•¥
4. **å¤‡ç”¨æ–¹æ¡ˆ**ï¼šæä¾›æœ¬åœ°å¤‡ç”¨æ ·å¼å’ŒåŠŸèƒ½
5. **æ¸è¿›å¢å¼º**ï¼šç¡®ä¿åŸºç¡€åŠŸèƒ½åœ¨èµ„æºåŠ è½½å‰å¯ç”¨

#### 7. ğŸ¯ ç¾½åŒ–è’™ç‰ˆç»„åæ ‡ç³»ç»Ÿæœ€ç»ˆè§£å†³æ–¹æ¡ˆï¼ˆå®æˆ˜éªŒè¯ï¼‰

**é—®é¢˜èƒŒæ™¯**ï¼šç¾½åŒ–è’™ç‰ˆç»„åœ¨å¤´å›¾å®¹å™¨ä¸­æ— æ³•æ­£ç¡®å±…ä¸­ï¼Œç»è¿‡å¤šæ¬¡è°ƒè¯•å’Œå®˜æ–¹æ–‡æ¡£ç ”ç©¶åçš„æœ€ç»ˆè§£å†³æ–¹æ¡ˆã€‚

**å…³é”®å‘ç°**ï¼š
```javascript
// ğŸš¨ é”™è¯¯ç†è§£ï¼šä»¥ä¸ºç»„å†…å…ƒç´ ç›¸å¯¹äºç»„
é¡µé¢
â”œâ”€ å¤´å›¾ç»„ (Group, x: 0)
   â”œâ”€ ç¾½åŒ–è’™ç‰ˆç»„ (x: -120) â† ä»¥ä¸ºç›¸å¯¹äºå¤´å›¾ç»„
   â””â”€ å¤´å›¾èŠ‚ç‚¹ (x: 0) â† ä»¥ä¸ºç›¸å¯¹äºå¤´å›¾ç»„

// âœ… æ­£ç¡®ç†è§£ï¼šç»„å†…å…ƒç´ å®é™…ç›¸å¯¹äºå®¹å™¨çˆ¶çº§
é¡µé¢ (Container Parent)
â”œâ”€ å¤´å›¾ç»„ (Group) â† ä¸æ˜¯å®¹å™¨çˆ¶çº§ï¼Œä¼šè‡ªåŠ¨è°ƒæ•´
â”œâ”€ ç¾½åŒ–è’™ç‰ˆç»„ â† å®é™…ç›¸å¯¹äºé¡µé¢/Frameï¼
â””â”€ å¤´å›¾èŠ‚ç‚¹ â† å®é™…ç›¸å¯¹äºé¡µé¢/Frameï¼
```

**æœ€ç»ˆæ­£ç¡®å®ç°**ï¼š
```typescript
// âœ… æ­£ç¡®ï¼šè’™ç‰ˆçŸ©å½¢ç›¸å¯¹äºframeçš„ç»å¯¹ä½ç½®
const centerOffsetX = (originalWidth - rectWidth) / 2;
maskRect.x = originalX + centerOffsetX; // æ°´å¹³å±…ä¸­
maskRect.y = 0; // ğŸ¯ å®æˆ˜éªŒè¯ï¼šYä½ç½®è®¾ä¸º0æœ€æœ‰æ•ˆ

// âœ… æ­£ç¡®ï¼šå¤´å›¾èŠ‚ç‚¹ä¿æŒåŸå§‹ä½ç½®
headerNode.x = originalX;
headerNode.y = originalY;

// âœ… æ­£ç¡®ï¼šå¤åˆ¶èŠ‚ç‚¹ä¹Ÿç›¸å¯¹äºframe
headerNodeCopy.x = originalX;
headerNodeCopy.y = originalY;

// ğŸ¯ å…³é”®ï¼šç»„çš„ä½ç½®ä¼šè‡ªåŠ¨è®¡ç®—ï¼Œæ— éœ€æ‰‹åŠ¨è®¾ç½®
// featherMaskGroupå’ŒheaderGroupçš„x,yä¼šè‡ªåŠ¨è°ƒæ•´
```

**å®æˆ˜è°ƒè¯•ç»éªŒ**ï¼š
1. **Yä½ç½®è®¾ç½®**ï¼šæœ€åˆä½¿ç”¨`originalY - blurRadius`ï¼Œä½†å®æˆ˜ä¸­å‘ç°è®¾ä¸º`0`æ•ˆæœæœ€ä½³
2. **ç»„çš„è‡ªåŠ¨è°ƒæ•´**ï¼šä¸è¦æ‰‹åŠ¨è®¾ç½®ç»„çš„x,yåæ ‡ï¼Œè®©Figmaè‡ªåŠ¨è®¡ç®—åŒ…å›´ç›’
3. **Container ParentéªŒè¯**ï¼šå¯é€šè¿‡Figma UIè§‚å¯Ÿå…ƒç´ åæ ‡æ¥éªŒè¯ç†è§£æ˜¯å¦æ­£ç¡®

**è°ƒè¯•éªŒè¯æ–¹æ³•**ï¼š
```typescript
// è°ƒè¯•ä»£ç ï¼šéªŒè¯åæ ‡ç†è§£
console.log('è’™ç‰ˆçŸ©å½¢ä½ç½®:', maskRect.x, maskRect.y);
console.log('ç¾½åŒ–è’™ç‰ˆç»„ä½ç½®:', featherMaskGroup.x, featherMaskGroup.y);
console.log('å¤´å›¾ç»„ä½ç½®:', headerGroup.x, headerGroup.y);
```

**å®˜æ–¹æ–‡æ¡£æ ¸å¿ƒå¼•ç”¨**ï¼š
> "Groups in Figma are always positioned and sized to fit their content. The relative transform of a node is shown relative to its **container parent**, which includes canvas nodes, frame nodes, component nodes, and instance nodes. It is **not** relative to its direct parent if the parent is a group."

**å¼€å‘æ£€æŸ¥æ¸…å•**ï¼š
- [ ] ç¡®è®¤ç»„å†…å…ƒç´ åæ ‡ç›¸å¯¹äºå®¹å™¨çˆ¶çº§è®¾ç½®
- [ ] ä¸è¦æ‰‹åŠ¨è®¾ç½®ç»„çš„ä½ç½®ï¼Œè®©å…¶è‡ªåŠ¨è°ƒæ•´
- [ ] ä½¿ç”¨è°ƒè¯•ä»£ç éªŒè¯åæ ‡ç†è§£
- [ ] åœ¨Figma UIä¸­æ£€æŸ¥æœ€ç»ˆæ•ˆæœ
- [ ] ğŸ¯ Yä½ç½®ä¼˜å…ˆå°è¯•ç®€å•å€¼ï¼ˆå¦‚0ï¼‰è€Œéå¤æ‚è®¡ç®—

## å¸¸ç”¨ä»£ç ç‰‡æ®µ

### åˆ›å»ºFigmaèŠ‚ç‚¹
```typescript
// åˆ›å»ºæ¡†æ¶
const frame = figma.createFrame();
frame.name = 'MyFrame';
frame.resize(width, height);

// åˆ›å»ºæ–‡æœ¬
const text = figma.createText();
await figma.loadFontAsync({ family: "Inter", style: "Regular" });
text.characters = 'Hello World';
text.fontSize = 16;
```

### å¤„ç†å›¾ç‰‡
```typescript
// æ’å…¥å›¾ç‰‡
const imageNode = await ImageNodeBuilder.insertImage(
  imageInfo, 
  "å›¾ç‰‡åç§°", 
  width, 
  height
);

// è®¾ç½®å›¾ç‰‡å¡«å……
await ImageNodeBuilder.setImageFill(node, imageInfo);
```

### é¢œè‰²å¤„ç†
```typescript
// åå…­è¿›åˆ¶è½¬RGB
const rgb = ColorUtils.hexToRgb('#ff0000');

// åˆ›å»ºçº¯è‰²å¡«å……
const fill = ColorUtils.createSolidFill(rgb);
node.fills = [fill];
```

### CDNèµ„æºæµ‹è¯•ï¼ˆæ–°å¢ï¼‰
```javascript
// åˆ›å»ºCDNèµ„æºç›´æ¥è®¿é—®æµ‹è¯•
function createCDNDirectTest() {
  const testHtml = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <title>CDNèµ„æºç›´æ¥è®¿é—®æµ‹è¯•</title>
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/kw-96/H5Tools@main/dist/styles.min.css">
    </head>
    <body>
      <div class="container">
        <h1>CDNèµ„æºç›´æ¥è®¿é—®æµ‹è¯•</h1>
        <div class="tab-container">
          <div class="tab active" data-tab="test">æµ‹è¯•æ ‡ç­¾</div>
        </div>
        <div class="tab-content active" id="test-content">
          <p>å¦‚æœæ‚¨èƒ½çœ‹åˆ°æ ·å¼æ­£å¸¸åº”ç”¨ï¼Œåˆ™CDNèµ„æºè®¿é—®æˆåŠŸï¼</p>
        </div>
      </div>
      <script src="https://cdn.jsdelivr.net/gh/kw-96/H5Tools@main/dist/scripts.min.js"></script>
    </body>
    </html>
  `;
  
  // ä¿å­˜ä¸ºæµ‹è¯•æ–‡ä»¶
  // åœ¨å®é™…å¼€å‘ä¸­ï¼Œå¯ä»¥ä½¿ç”¨fs.writeFileSyncæˆ–å…¶ä»–æ–¹æ³•ä¿å­˜
  console.log('âœ… CDNèµ„æºç›´æ¥è®¿é—®æµ‹è¯•HTMLå·²ç”Ÿæˆ');
}
```

## è°ƒè¯•å’Œæµ‹è¯•

### è°ƒè¯•æŠ€å·§
- **Figmaæ§åˆ¶å°**: ä½¿ç”¨`console.log`æŸ¥çœ‹æ’ä»¶æ—¥å¿—
- **UIè°ƒè¯•**: åœ¨æµè§ˆå™¨ä¸­è°ƒè¯•UIç•Œé¢
- **ç±»å‹æ£€æŸ¥**: ä½¿ç”¨`npm run type-check`éªŒè¯ç±»å‹
- **æ„å»ºæµ‹è¯•**: ä½¿ç”¨`npm run build`éªŒè¯æ„å»º
- **CDNæµ‹è¯•**: åˆ›å»ºæµ‹è¯•HTMLéªŒè¯CDNèµ„æºåŠ è½½ï¼ˆæ–°å¢ï¼‰
- **ç½‘ç»œç›‘æ§**: ä½¿ç”¨æµè§ˆå™¨å¼€å‘å·¥å…·ç›‘æ§ç½‘ç»œè¯·æ±‚ï¼ˆæ–°å¢ï¼‰

### æµ‹è¯•ç­–ç•¥
- **å•å…ƒæµ‹è¯•**: æµ‹è¯•å·¥å…·å‡½æ•°å’ŒæœåŠ¡ç±»
- **é›†æˆæµ‹è¯•**: æµ‹è¯•æ¨¡å—é—´äº¤äº’
- **ç«¯åˆ°ç«¯æµ‹è¯•**: æµ‹è¯•å®Œæ•´çš„ç”¨æˆ·æµç¨‹
- **ç±»å‹æµ‹è¯•**: ç¡®ä¿TypeScriptç±»å‹æ­£ç¡®
- **ç¦»çº¿æµ‹è¯•**: æµ‹è¯•ç½‘ç»œä¸å¯ç”¨æƒ…å†µä¸‹çš„é™çº§æ–¹æ¡ˆï¼ˆæ–°å¢ï¼‰
- **é”™è¯¯æ¢å¤æµ‹è¯•**: éªŒè¯é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶ï¼ˆæ–°å¢ï¼‰

