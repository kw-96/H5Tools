---
description: 
globs: 
alwaysApply: true
---
# ğŸš¨ å˜é‡å£°æ˜ç®¡ç†è§„èŒƒ

## æ ¸å¿ƒåŸåˆ™

### âœ… å•ä¸€å£°æ˜åŸåˆ™
- **æ¯ä¸ªå…¨å±€å˜é‡åªèƒ½åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­å£°æ˜**
- **é€šè¿‡windowå¯¹è±¡å¯¼å‡ºå’Œè®¿é—®å…¨å±€å˜é‡**
- **ç¦æ­¢åœ¨å¤šä¸ªæ–‡ä»¶ä¸­å£°æ˜åŒåå˜é‡**

### âŒ ä¸¥ç¦çš„åšæ³•
```javascript
// file1.js
const storageAdapter = new StorageAdapter();

// file2.js - è¿™ä¼šå¯¼è‡´é‡å¤å£°æ˜é”™è¯¯ï¼
const storageAdapter = window.localStorage ? {...} : null;
```

### âœ… æ­£ç¡®çš„åšæ³•
```javascript
// utility-functions.jsï¼ˆä¸»å£°æ˜æ–‡ä»¶ï¼‰
class StorageAdapter {
  // ç±»å®šä¹‰...
}
const storageAdapter = new StorageAdapter();
window.storageAdapter = storageAdapter; // å¯¼å‡ºåˆ°å…¨å±€

// channel-manager.jsï¼ˆä½¿ç”¨æ–‡ä»¶ï¼‰
// ä½¿ç”¨å…¨å±€å­˜å‚¨é€‚é…å™¨ï¼ˆå·²åœ¨utility-functions.jsä¸­å£°æ˜ï¼‰
// æ³¨æ„ï¼šä¸è¦é‡å¤å£°æ˜storageAdapter
async function saveChannelSetting(channel, key, value) {
  await window.storageAdapter.setItem(storageKey, value);
}
```

## å®é™…æ¡ˆä¾‹åˆ†æ

### é—®é¢˜åœºæ™¯
H5Toolsé¡¹ç›®ä¸­é‡åˆ°çš„å®é™…é”™è¯¯ï¼š
```
Uncaught SyntaxError: Failed to execute 'write' on 'Document': 
Identifier 'storageAdapter' has already been declared
```

### é”™è¯¯åŸå› 
1. `utility-functions.js`ä¸­å£°æ˜ï¼š`const storageAdapter = new StorageAdapter()`
2. `channel-manager.js`ä¸­é‡å¤å£°æ˜ï¼š`const storageAdapter = window.localStorage ? {...} : null`
3. æ„å»ºæ—¶ä¸¤ä¸ªæ–‡ä»¶åˆå¹¶ï¼Œå¯¼è‡´é‡å¤å£°æ˜

### ä¿®å¤æ–¹æ¡ˆ
1. **ç§»é™¤é‡å¤å£°æ˜**ï¼šåˆ é™¤`channel-manager.js`ä¸­çš„å£°æ˜
2. **ç»Ÿä¸€è®¿é—®æ–¹å¼**ï¼šæ‰€æœ‰åœ°æ–¹ä½¿ç”¨`window.storageAdapter`
3. **æ³¨é‡Šè¯´æ˜**ï¼šæ·»åŠ æ³¨é‡Šé¿å…æœªæ¥é‡å¤é”™è¯¯

## å¼€å‘è§„èŒƒ

### æ–‡ä»¶ç»„ç»‡åŸåˆ™
```
src/ui/scripts/
â”œâ”€â”€ utility-functions.js     # ğŸ¯ å…¨å±€å˜é‡å£°æ˜æ–‡ä»¶
â”œâ”€â”€ plugin-communicator.js   # ä½¿ç”¨ window.pluginComm
â”œâ”€â”€ notification-system.js   # ä½¿ç”¨ window.notificationSystem  
â”œâ”€â”€ theme-manager.js         # ä½¿ç”¨ window.themeManager
â””â”€â”€ channel-manager.js       # ä½¿ç”¨ window.storageAdapter
```

### å‘½åçº¦å®š
```javascript
// å£°æ˜æ–‡ä»¶ï¼ˆutility-functions.jsï¼‰
const storageAdapter = new StorageAdapter();
const pluginComm = new PluginCommunicator();
const notificationSystem = new NotificationSystem();

// å¯¼å‡ºåˆ°å…¨å±€
window.storageAdapter = storageAdapter;
window.pluginComm = pluginComm;
window.notificationSystem = notificationSystem;

// ä½¿ç”¨æ–‡ä»¶
// é€šè¿‡windowå¯¹è±¡è®¿é—®ï¼Œé¿å…é‡å¤å£°æ˜
window.storageAdapter.setItem(key, value);
window.pluginComm.postMessage(type, data);
```

## æ„å»ºæ—¶æ£€æŸ¥

### è‡ªåŠ¨æ£€æŸ¥è„šæœ¬
```javascript
// åœ¨build.jsä¸­æ·»åŠ æ£€æŸ¥
function checkDuplicateDeclarations(jsContent) {
  const declarations = [];
  const regex = /(?:const|let|var)\s+(\w+)\s*=/g;
  let match;
  
  while ((match = regex.exec(jsContent)) !== null) {
    const varName = match[1];
    if (declarations.includes(varName)) {
      throw new Error(`é‡å¤å£°æ˜æ£€æµ‹åˆ°: ${varName}`);
    }
    declarations.push(varName);
  }
}
```

### æ‰‹åŠ¨éªŒè¯å‘½ä»¤
```bash
# Windowsç¯å¢ƒ
findstr /n "const storageAdapter" dist\\ui.html
findstr /n "let storageAdapter" dist\\ui.html
findstr /n "var storageAdapter" dist\\ui.html

# é¢„æœŸç»“æœï¼šåªåº”è¯¥æœ‰ä¸€è¡Œå£°æ˜
```

## ç´§æ€¥ä¿®å¤æŒ‡å—

### å¿«é€Ÿè¯Šæ–­
1. **æŸ¥çœ‹Figmaæ§åˆ¶å°é”™è¯¯**
2. **æ£€æŸ¥å˜é‡å£°æ˜ä½ç½®**ï¼š`findstr /n "const variableName" dist\\ui.html`
3. **ç¡®è®¤é‡å¤å£°æ˜æ•°é‡**

### ä¿®å¤æ­¥éª¤
1. **å®šä½é‡å¤å£°æ˜çš„æ–‡ä»¶**
2. **ä¿ç•™ä¸»å£°æ˜æ–‡ä»¶ä¸­çš„å£°æ˜**
3. **ç§»é™¤å…¶ä»–æ–‡ä»¶ä¸­çš„é‡å¤å£°æ˜**
4. **æ”¹ä¸ºé€šè¿‡windowå¯¹è±¡è®¿é—®**
5. **é‡æ–°æ„å»ºéªŒè¯**

### éªŒè¯ä¿®å¤
```bash
npm run build
findstr /n "const storageAdapter" dist\\ui.html
# åº”è¯¥åªæœ‰ä¸€è¡Œç»“æœ
```

## æœ€ä½³å®è·µæ€»ç»“

### âœ… æ¨èåšæ³•
- ä½¿ç”¨å•ä¸€å…¨å±€å£°æ˜æ–‡ä»¶ï¼ˆå¦‚utility-functions.jsï¼‰
- é€šè¿‡windowå¯¹è±¡å¯¼å‡ºå…¨å±€å˜é‡
- å…¶ä»–æ–‡ä»¶é€šè¿‡window.variableNameè®¿é—®
- æ·»åŠ æ³¨é‡Šè¯´æ˜å˜é‡æ¥æº
- æ„å»ºæ—¶è‡ªåŠ¨æ£€æŸ¥é‡å¤å£°æ˜

### âŒ é¿å…çš„åšæ³•
- åœ¨å¤šä¸ªæ–‡ä»¶ä¸­å£°æ˜åŒåå˜é‡
- ç›´æ¥è®¿é—®å¯èƒ½æœªå£°æ˜çš„å˜é‡
- å¿½ç•¥æ„å»ºæ—¶çš„é‡å¤å£°æ˜è­¦å‘Š
- åœ¨æ²™ç›’ç¯å¢ƒä¸­ä½¿ç”¨evalæˆ–åŠ¨æ€å£°æ˜

### ğŸ”§ å·¥å…·æ”¯æŒ
- ESLintè§„åˆ™ï¼šno-redeclare
- æ„å»ºè„šæœ¬ï¼šè‡ªåŠ¨é‡å¤å£°æ˜æ£€æŸ¥
- TypeScriptï¼šä¸¥æ ¼æ¨¡å¼ç±»å‹æ£€æŸ¥
- æ‰‹åŠ¨éªŒè¯ï¼šfindstr/grepå‘½ä»¤æ£€æŸ¥

