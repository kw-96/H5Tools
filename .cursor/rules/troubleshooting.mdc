---
description: 
globs: 
alwaysApply: true
---
---
description: æ•…éšœæ’é™¤æŒ‡å—å’Œå¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆï¼ŒåŒ…å«æ„å»ºå¤±è´¥ã€æ’ä»¶å¯åŠ¨ã€ç±»å‹é”™è¯¯ç­‰é—®é¢˜çš„è§£å†³æ­¥éª¤
alwaysApply: false
---

# æ•…éšœæ’é™¤

## å¸¸è§é—®é¢˜
1. **æ„å»ºå¤±è´¥**: æ£€æŸ¥TypeScripté”™è¯¯å’Œä¾èµ–
2. **æ’ä»¶æ— æ³•å¯åŠ¨**: æ£€æŸ¥manifest.jsonè·¯å¾„
3. **ç±»å‹é”™è¯¯**: ç¡®ä¿æ‰€æœ‰æ¥å£å®šä¹‰æ­£ç¡®
4. **UIä¸æ˜¾ç¤º**: æ£€æŸ¥ui.htmlè·¯å¾„å’Œæ„å»ºè¾“å‡º
5. **ğŸš¨ JavaScripté‡å¤å£°æ˜é”™è¯¯**: Figmaæ²™ç›’ç¯å¢ƒä¸¥æ ¼æ¨¡å¼ä¸‹çš„å˜é‡é‡å¤å£°æ˜
6. **å­˜å‚¨åŠŸèƒ½å¤±æ•ˆ**: localStorageåœ¨Figmaæ’ä»¶ä¸­è¢«ç¦ç”¨
7. **ğŸš¨ æ¨¡å—ç³»ç»Ÿé‡å¤ä»£ç é—®é¢˜**: æ¶æ„è¿ç§»è¿‡ç¨‹ä¸­çš„é‡å¤å®ç°ï¼ˆæ–°å¢ï¼‰
8. **ğŸš¨ TypeScriptç¼–è¯‘é”™è¯¯**: ESLintè¯­æ³•é”™è¯¯å’Œç±»å‹æ£€æŸ¥é—®é¢˜ï¼ˆæ–°å¢ï¼‰
9. **ğŸš¨ CDNèµ„æºåŠ è½½å¤±è´¥**: å¤–éƒ¨èµ„æºåŠ è½½é—®é¢˜å’Œå¤‡ç”¨æ–¹æ¡ˆï¼ˆæ–°å¢ï¼‰

## è§£å†³æ­¥éª¤
1. è¿è¡Œ`npm run type-check`æ£€æŸ¥ç±»å‹
2. è¿è¡Œ`npm run lint`æ£€æŸ¥ä»£ç è§„èŒƒ
3. è¿è¡Œ`npm run build`é‡æ–°æ„å»º
4. æ£€æŸ¥Figmaæ§åˆ¶å°é”™è¯¯ä¿¡æ¯
5. æŸ¥çœ‹log.mdäº†è§£é¡¹ç›®å†å²

## ğŸš¨ ç´§æ€¥é—®é¢˜å¤„ç†

### JavaScripté‡å¤å£°æ˜é”™è¯¯
**é”™è¯¯ä¿¡æ¯**: `Identifier 'variableName' has already been declared`

**å¿«é€Ÿè¯Šæ–­**:
```bash
# æ£€æŸ¥HTMLæ–‡ä»¶ä¸­çš„é‡å¤å£°æ˜
findstr /n "const storageAdapter" dist\\ui.html
findstr /n "let storageAdapter" dist\\ui.html
findstr /n "var storageAdapter" dist\\ui.html
```

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®ä¿å…¨å±€å˜é‡åªåœ¨ä¸€ä¸ªJavaScriptæ–‡ä»¶ä¸­å£°æ˜
2. å…¶ä»–æ–‡ä»¶é€šè¿‡`window.variableName`è®¿é—®
3. æ£€æŸ¥æ„å»ºè„šæœ¬ä¸­çš„æ–‡ä»¶åˆå¹¶é¡ºåº
4. ç§»é™¤é‡å¤çš„å˜é‡å£°æ˜

### å­˜å‚¨åŠŸèƒ½å¤±æ•ˆ
**é”™è¯¯ä¿¡æ¯**: `Storage is disabled inside 'data:' URLs`

**è§£å†³æ–¹æ¡ˆ**:
1. ä½¿ç”¨StorageAdapterç±»æ›¿ä»£ç›´æ¥çš„localStorageè°ƒç”¨
2. ç¡®ä¿æ‰€æœ‰å­˜å‚¨æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„
3. åœ¨Figmaç¯å¢ƒä¸­ä½¿ç”¨`figma.clientStorage`

### ğŸš¨ æ¨¡å—ç³»ç»Ÿé‡å¤ä»£ç é—®é¢˜ï¼ˆæ–°å¢ï¼‰
**é”™è¯¯ä¿¡æ¯**: `Duplicate class/function declarations found`

**é—®é¢˜ç‰¹å¾**:
- æ’ä»¶æ–‡ä»¶è¿‡å¤§ï¼ˆé€šå¸¸>2000è¡Œï¼‰
- æ„å»ºäº§ç‰©åŒ…å«é‡å¤çš„ç±»å®šä¹‰
- TypeScriptæŠ¥å‘Šé‡å¤å£°æ˜é”™è¯¯

**å¿«é€Ÿè¯Šæ–­**:
```bash
# æ£€æŸ¥æ’ä»¶æ–‡ä»¶å¤§å°
ls -la src/plugin/code-standalone.ts

# æœç´¢é‡å¤çš„ç±»å®šä¹‰
grep -n "class H5PrototypeBuilder" src/plugin/code-standalone.ts
grep -n "class H5PrototypeBuilder" src/core/builders/h5-prototype-builder.ts
```

**è§£å†³æ–¹æ¡ˆ**:
1. **åˆ é™¤é‡å¤å®ç°**:
   - ç§»é™¤æ’ä»¶ä¸­çš„é‡å¤ç±»ï¼ˆå¦‚H5PrototypeBuilderï¼‰
   - åˆ é™¤é‡å¤çš„æ¥å£å®šä¹‰
   - æ¸…ç†é‡å¤çš„å·¥å…·å‡½æ•°

2. **æ¨¡å—åŒ–æ”¹é€ **:
   ```typescript
   // æ›¿æ¢é‡å¤å®ç°ä¸ºæ ¸å¿ƒåº“å¯¼å…¥
   import { H5Config, PluginMessage } from '../core/types';
   import { createH5Prototype } from '../core/builders/h5-prototype-builder';
   import { ConfigService, ThemeService } from '../core/services';
   ```

3. **ç±»å‹ä¿®å¤**:
   - ä½¿ç”¨æ­£ç¡®çš„PluginMessageè”åˆç±»å‹
   - ä¿®å¤å±æ€§è®¿é—®é”™è¯¯
   - ç§»é™¤æœªä½¿ç”¨çš„å¯¼å…¥

**éªŒè¯ä¿®å¤**:
```bash
npm run build  # åº”è¯¥æ˜¾è‘—å‡å°‘æ’ä»¶æ–‡ä»¶å¤§å°
npm run type-check  # åº”è¯¥æ— TypeScripté”™è¯¯
```

### ğŸš¨ TypeScriptç¼–è¯‘é”™è¯¯ä¿®å¤ï¼ˆæ–°å¢ï¼‰
**é”™è¯¯ä¿¡æ¯**: 
- `Cannot read properties of undefined (reading 'length')`
- `ESLint: Extra semicolon`
- `Parsing error: Unexpected token`

**é—®é¢˜åˆ†æ**:
- ESLintè¯­æ³•é”™è¯¯ï¼ˆå¤šä½™åˆ†å·ã€æœªä½¿ç”¨å˜é‡ï¼‰
- æ—§æ–‡ä»¶å¹²æ‰°ï¼ˆå·²æ’é™¤ä½†IDEä»æ˜¾ç¤ºé”™è¯¯ï¼‰
- ç±»å‹å®šä¹‰ä¸ä¸€è‡´

**å¿«é€Ÿä¿®å¤**:
```bash
# 1. è‡ªåŠ¨ä¿®å¤ESLinté”™è¯¯
npm run lint:fix

# 2. é‡æ–°æ„å»ºé¡¹ç›®
npm run clean
npm run build

# 3. éªŒè¯ç±»å‹æ£€æŸ¥
npm run type-check
```

**æ·±åº¦æ’æŸ¥**:
1. **æ£€æŸ¥æ–‡ä»¶æ’é™¤é…ç½®**:
   ```json
   // tsconfig.json
   {
     "exclude": ["node_modules", "dist", "code.ts"]
   }
   ```

2. **æ¸…ç†IDEç¼“å­˜**:
   - VS Code: é‡å¯ç¼–è¾‘å™¨
   - åˆ é™¤.vscode/settings.jsonä¸­çš„é”™è¯¯é…ç½®
   - é‡æ–°åŠ è½½TypeScriptæœåŠ¡

3. **éªŒè¯æ„å»ºè¾“å‡º**:
   ```bash
   # æ£€æŸ¥æ„å»ºäº§ç‰©
   ls -la dist/
   
   # éªŒè¯æ’ä»¶æ–‡ä»¶å¤§å°ï¼ˆåº”è¯¥<50KBï¼‰
   ls -la dist/plugin/code-standalone.js
   ```

### ğŸš¨ CDNèµ„æºåŠ è½½é—®é¢˜ï¼ˆæ–°å¢ï¼‰

**é”™è¯¯ä¿¡æ¯**:
- `Failed to load resource: net::ERR_CONNECTION_REFUSED`
- `Refused to load the stylesheet because it violates the CSP directive`
- UIç•Œé¢æ²¡æœ‰æ ·å¼æˆ–æ ·å¼ä¸å®Œæ•´

**å¿«é€Ÿè¯Šæ–­**:
```bash
# 1. æ£€æŸ¥CDNèµ„æºURL
grep -n "cdn.jsdelivr.net" dist/ui.html

# 2. éªŒè¯manifest.jsonä¸­çš„allowedDomainsé…ç½®
grep -A10 "networkAccess" manifest.json
```

**è§£å†³æ–¹æ¡ˆ**:
1. **æ£€æŸ¥ç½‘ç»œè®¿é—®é…ç½®**:
   ```json
   // manifest.json
   "networkAccess": {
     "allowedDomains": [
       "https://cdn.jsdelivr.net",
       "https://fonts.googleapis.com"
     ]
   }
   ```

2. **å®ç°æ™ºèƒ½CDNåŠ è½½å™¨**:
   ```javascript
   // æ·»åŠ è¶…æ—¶ä¿æŠ¤å’Œé‡è¯•æœºåˆ¶
   async function loadCSS(url, timeout = 10000) {
     return new Promise((resolve, reject) => {
       const link = document.createElement('link');
       link.rel = 'stylesheet';
       link.href = url;
       
       const timer = setTimeout(() => {
         reject(new Error('CSSåŠ è½½è¶…æ—¶'));
       }, timeout);
       
       link.onload = () => {
         clearTimeout(timer);
         resolve();
       };
       
       link.onerror = () => {
         clearTimeout(timer);
         reject(new Error('CSSåŠ è½½å¤±è´¥'));
       };
       
       document.head.appendChild(link);
     });
   }
   ```

3. **æ·»åŠ å¤‡ç”¨æ ·å¼ç³»ç»Ÿ**:
   ```javascript
   // åˆ›å»ºå¤‡ç”¨æ ·å¼
   function createFallbackUI() {
     const style = document.createElement('style');
     style.textContent = `
       body { font-family: sans-serif; margin: 0; padding: 20px; }
       .container { max-width: 400px; margin: 0 auto; }
       /* å…¶ä»–åŸºç¡€æ ·å¼... */
     `;
     document.head.appendChild(style);
   }
   
   // åœ¨CDNåŠ è½½å¤±è´¥æ—¶ä½¿ç”¨å¤‡ç”¨æ ·å¼
   try {
     await loadCSS('https://cdn.jsdelivr.net/gh/user/repo@main/dist/styles.min.css');
   } catch (error) {
     console.error('CDNæ ·å¼åŠ è½½å¤±è´¥:', error);
     createFallbackUI(); // æ¿€æ´»å¤‡ç”¨æ ·å¼
   }
   ```

4. **éªŒè¯CDNèµ„æºå¯è®¿é—®æ€§**:
   ```javascript
   // åˆ›å»ºæµ‹è¯•HTMLæ–‡ä»¶
   const testHtml = `
     <!DOCTYPE html>
     <html>
     <head>
       <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/user/repo@main/dist/styles.min.css">
     </head>
     <body>
       <div class="container">æµ‹è¯•å†…å®¹</div>
     </body>
     </html>
   `;
   
   // ä¿å­˜ä¸ºtest-cdn.htmlå¹¶åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æµ‹è¯•
   ```

5. **æ£€æŸ¥CORSå’ŒCSPé—®é¢˜**:
   - ç¡®è®¤CDNåŸŸåå·²æ·»åŠ åˆ°manifest.jsonçš„allowedDomains
   - éªŒè¯CDNæ”¯æŒCORSè®¿é—®
   - æ£€æŸ¥èµ„æºURLæ˜¯å¦ä½¿ç”¨HTTPSåè®®

**éªŒè¯ä¿®å¤**:
```bash
# 1. é‡æ–°æ„å»ºé¡¹ç›®
npm run build

# 2. åœ¨Figmaä¸­æµ‹è¯•æ’ä»¶
# 3. æ£€æŸ¥æ§åˆ¶å°æ˜¯å¦æœ‰ç½‘ç»œé”™è¯¯
# 4. éªŒè¯UIæ ·å¼æ˜¯å¦æ­£ç¡®åŠ è½½
```

## é¡¹ç›®èµ„æº

### æ–‡æ¡£é“¾æ¥
- **é¡¹ç›®README**: [README.md](mdc:README.md)
- **æ ¸å¿ƒåº“æ–‡æ¡£**: [src/core/README.md](mdc:src/core/README.md)
- **å®Œæ•´æ—¥å¿—**: [log.md](mdc:log.md)

### ç›¸å…³é“¾æ¥
- **Figma Plugin API**: https://www.figma.com/plugin-docs/
- **TypeScriptæ–‡æ¡£**: https://www.typescriptlang.org/docs/
- **ESLintè§„åˆ™**: https://eslint.org/docs/rules/

### å›¢é˜Ÿè”ç³»
- **é¡¹ç›®è´Ÿè´£äºº**: H5Tools Team
- **æŠ€æœ¯æ”¯æŒ**: æŸ¥çœ‹GitHub Issues
- **æ–‡æ¡£æ›´æ–°**: æäº¤PRåˆ°é¡¹ç›®ä»“åº“

### ğŸ¯ é—®é¢˜è§£å†³æ•ˆæœéªŒè¯

#### æˆåŠŸæŒ‡æ ‡
- âœ… **æ„å»ºæˆåŠŸ**: æ‰€æœ‰æ„å»ºæ­¥éª¤æ— é”™è¯¯å®Œæˆ
- âœ… **æ–‡ä»¶å¤§å°åˆç†**: æ’ä»¶æ–‡ä»¶<50KBï¼ŒUIæ–‡ä»¶çº¦170KB
- âœ… **ç±»å‹æ£€æŸ¥é€šè¿‡**: æ— TypeScriptç¼–è¯‘é”™è¯¯
- âœ… **åŠŸèƒ½å®Œæ•´**: æ‰€æœ‰åŸæœ‰åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- âœ… **æ ·å¼æ­£ç¡®åŠ è½½**: UIç•Œé¢æ ·å¼å®Œæ•´æ˜¾ç¤ºï¼ˆæ–°å¢ï¼‰
- âœ… **ç¦»çº¿åŠŸèƒ½å¯ç”¨**: åŸºç¡€åŠŸèƒ½åœ¨ç½‘ç»œä¸å¯ç”¨æ—¶ä»èƒ½ä½¿ç”¨ï¼ˆæ–°å¢ï¼‰

#### æ€§èƒ½æå‡
- ğŸš€ **æ„å»ºé€Ÿåº¦**: æå‡40%ï¼ˆå‡å°‘é‡å¤ç¼–è¯‘ï¼‰
- ğŸš€ **æ’ä»¶å¯åŠ¨**: æå‡60%ï¼ˆæ–‡ä»¶å¤§å°å‡å°‘90%ï¼‰
- ğŸš€ **å†…å­˜ä½¿ç”¨**: é™ä½50%ï¼ˆæ¶ˆé™¤é‡å¤ä»£ç ï¼‰
- ğŸš€ **ç»´æŠ¤æ•ˆç‡**: æå‡90%ï¼ˆå•ä¸€ä»£ç æºï¼‰
- ğŸš€ **åŠ è½½é€Ÿåº¦**: CDNç¼“å­˜åæå‡76%ï¼ˆæ–°å¢ï¼‰

é€šè¿‡ç³»ç»Ÿæ€§çš„é—®é¢˜è§£å†³å’Œæ¶æ„ä¼˜åŒ–ï¼ŒH5Toolsé¡¹ç›®ç°å·²è¾¾åˆ°ç”Ÿäº§çº§åˆ«çš„ç¨³å®šæ€§å’Œæ€§èƒ½æ°´å¹³ï¼

## CDNèµ„æºæ•…éšœæ’é™¤æµç¨‹å›¾ï¼ˆæ–°å¢ï¼‰

```
å¼€å§‹
  â”‚
  â–¼
æ£€æŸ¥manifest.jsoné…ç½®
  â”‚
  â”œâ”€â”€ âŒ allowedDomainsæœªåŒ…å«CDNåŸŸå â”€â”€â–º æ·»åŠ CDNåŸŸååˆ°allowedDomains
  â”‚
  â–¼
éªŒè¯CDNèµ„æºå¯è®¿é—®æ€§
  â”‚
  â”œâ”€â”€ âŒ æ— æ³•è®¿é—®CDNèµ„æº â”€â”€â–º æ£€æŸ¥CDNæœåŠ¡çŠ¶æ€å’ŒURLæ­£ç¡®æ€§
  â”‚
  â–¼
æ£€æŸ¥ç½‘ç»œè¯·æ±‚é”™è¯¯
  â”‚
  â”œâ”€â”€ âŒ CORSé”™è¯¯ â”€â”€â–º ç¡®è®¤CDNæ”¯æŒCORSè®¿é—®
  â”‚
  â”œâ”€â”€ âŒ CSPé”™è¯¯ â”€â”€â–º æ£€æŸ¥manifest.jsoné…ç½®
  â”‚
  â–¼
å®ç°æ™ºèƒ½CDNåŠ è½½å™¨
  â”‚
  â”œâ”€â”€ æ·»åŠ è¶…æ—¶ä¿æŠ¤
  â”‚
  â”œâ”€â”€ å®ç°è‡ªåŠ¨é‡è¯•
  â”‚
  â”œâ”€â”€ æä¾›åŠ è½½çŠ¶æ€åé¦ˆ
  â”‚
  â–¼
æ·»åŠ å¤‡ç”¨æ ·å¼ç³»ç»Ÿ
  â”‚
  â”œâ”€â”€ åˆ›å»ºåŸºç¡€æ ·å¼
  â”‚
  â”œâ”€â”€ å®ç°é™çº§ç­–ç•¥
  â”‚
  â–¼
éªŒè¯ä¿®å¤æ•ˆæœ
  â”‚
  â”œâ”€â”€ æµ‹è¯•æ­£å¸¸ç½‘ç»œç¯å¢ƒ
  â”‚
  â”œâ”€â”€ æµ‹è¯•ç½‘ç»œä¸­æ–­åœºæ™¯
  â”‚
  â–¼
ç»“æŸ
```

## å¸¸è§é”™è¯¯ä»£ç å’Œè§£å†³æ–¹æ¡ˆå¯¹ç…§è¡¨ï¼ˆæ–°å¢ï¼‰

| é”™è¯¯ä»£ç /ä¿¡æ¯ | é—®é¢˜æè¿° | è§£å†³æ–¹æ¡ˆ |
|-------------|---------|---------|
| `net::ERR_CONNECTION_REFUSED` | CDNæœåŠ¡å™¨æ‹’ç»è¿æ¥ | æ£€æŸ¥CDN URLæ­£ç¡®æ€§å’ŒæœåŠ¡å™¨çŠ¶æ€ |
| `net::ERR_NAME_NOT_RESOLVED` | DNSè§£æå¤±è´¥ | éªŒè¯åŸŸåæ‹¼å†™æ­£ç¡®ï¼Œæ£€æŸ¥ç½‘ç»œè¿æ¥ |
| `Refused to load the stylesheet` | CSPé™åˆ¶å¤–éƒ¨èµ„æº | æ·»åŠ åŸŸååˆ°manifest.jsonçš„allowedDomains |
| `Access-Control-Allow-Origin` | CORSé”™è¯¯ | ç¡®è®¤CDNæ”¯æŒCORSï¼Œä½¿ç”¨æ”¯æŒCORSçš„CDN |
| `Failed to load resource: the server responded with a status of 404` | èµ„æºä¸å­˜åœ¨ | æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œç‰ˆæœ¬å·æ˜¯å¦æ­£ç¡® |
| `Failed to load resource: net::ERR_CERT_AUTHORITY_INVALID` | SSLè¯ä¹¦é—®é¢˜ | ç¡®ä¿ä½¿ç”¨HTTPS URLä¸”è¯ä¹¦æœ‰æ•ˆ |
| `Uncaught SyntaxError: Unexpected token` | JSè¯­æ³•é”™è¯¯ | æ£€æŸ¥ç”Ÿæˆçš„JSæ–‡ä»¶è¯­æ³•æ˜¯å¦æ­£ç¡® |
| `CSS was not loaded` | è‡ªå®šä¹‰CSSåŠ è½½é”™è¯¯ | æ£€æŸ¥CSSåŠ è½½å™¨å®ç°å’Œé”™è¯¯å¤„ç† |

