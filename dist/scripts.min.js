// H5Tools UI Scripts
// å¤–è”JavaScriptæ–‡ä»¶ï¼Œé€šè¿‡CDNåŠ è½½
// æ„å»ºæ—¶é—´: 2025-06-27T03:41:18.179Z

/* === utility-functions.js === */
// ==================== å­˜å‚¨é€‚é…å™¨ ====================
// è§£å†³Figmaæ’ä»¶æ²™ç›’ç¯å¢ƒä¸­localStorageè¢«ç¦ç”¨çš„é—®é¢˜
class StorageAdapter {
  constructor() {
    // æ›´ä¸¥æ ¼çš„Figmaç¯å¢ƒæ£€æµ‹
    this.isFigmaEnvironment = this.checkFigmaEnvironment();
    this.cache = new Map(); // å†…å­˜ç¼“å­˜
    
    // è¾“å‡ºç¯å¢ƒæ£€æµ‹ç»“æœ
    console.log('StorageAdapter ç¯å¢ƒæ£€æµ‹:', {
      isFigmaEnvironment: this.isFigmaEnvironment,
      hasFigma: typeof figma !== 'undefined',
      hasClientStorage: typeof figma !== 'undefined' && !!figma.clientStorage,
      isDataURL: window.location.protocol === 'data:',
      userAgent: navigator.userAgent.includes('Figma')
    });
  }

  // æ£€æµ‹æ˜¯å¦åœ¨Figmaç¯å¢ƒä¸­
  checkFigmaEnvironment() {
    // å…³é”®ä¿®å¤ï¼šåœ¨Figmaæ’ä»¶UIä¸­ï¼Œfigmaå¯¹è±¡ä¸å¯ç”¨ï¼
    // æˆ‘ä»¬éœ€è¦é€šè¿‡å…¶ä»–æ–¹å¼æ£€æµ‹Figmaç¯å¢ƒ
    const isDataURL = window.location.protocol === 'data:';
    const isFigmaUA = navigator.userAgent.includes('Figma') || window.location.href.includes('figma');
    const hasFigmaParent = window.parent !== window; // æ’ä»¶è¿è¡Œåœ¨iframeä¸­
    
    // ğŸš¨ é‡è¦ä¿®å¤ï¼šåœ¨Figmaæ’ä»¶UIçº¿ç¨‹ä¸­ï¼Œfigmaå¯¹è±¡æ˜¯undefinedï¼
    // ä½†æˆ‘ä»¬ä»åœ¨Figmaç¯å¢ƒä¸­ï¼Œéœ€è¦ä½¿ç”¨data:åè®®ä½œä¸ºä¸»è¦åˆ¤æ–­ä¾æ®
    const result = isDataURL || isFigmaUA;
    
    console.log('ğŸ”§ Figmaç¯å¢ƒæ£€æµ‹è¯¦æƒ…:', {
      isDataURL,
      isFigmaUA,
      hasFigmaParent,
      protocol: window.location.protocol,
      href: window.location.href,
      userAgent: navigator.userAgent,
      result: result ? 'âœ… Figmaç¯å¢ƒ' : 'âŒ éFigmaç¯å¢ƒ'
    });
    
    return result;
  }

  async setItem(key, value) {
    try {
      if (this.isFigmaEnvironment) {
        // ğŸš¨ é‡è¦ä¿®å¤ï¼šåœ¨Figma UIçº¿ç¨‹ä¸­ï¼Œä¸èƒ½ç›´æ¥è®¿é—®figma.clientStorage
        // éœ€è¦é€šè¿‡postMessageä¸æ’ä»¶ä¸»çº¿ç¨‹é€šä¿¡
        console.log(`ğŸ“¤ å‘æ’ä»¶å‘é€å­˜å‚¨è®¾ç½®è¯·æ±‚: ${key}`);
        
        // å‘é€æ¶ˆæ¯åˆ°æ’ä»¶ä¸»çº¿ç¨‹
        window.parent.postMessage({
          pluginMessage: {
            type: 'storage-set',
            key: key,
            value: value
          }
        }, '*');
        
        // åŒæ—¶ä¿å­˜åˆ°å†…å­˜ç¼“å­˜
        this.cache.set(key, value);
        console.log(`âœ… ç¼“å­˜è®¾ç½®æˆåŠŸ: ${key}`);
      } else {
        // åœ¨éFigmaç¯å¢ƒä¸­ï¼Œå°è¯•ä½¿ç”¨localStorage
        try {
          localStorage.setItem(key, value);
          console.log(`âœ… localStorageè®¾ç½®æˆåŠŸ: ${key}`);
        } catch (localStorageError) {
          console.warn(`localStorageä¸å¯ç”¨ï¼Œä½¿ç”¨å†…å­˜å­˜å‚¨: ${key}`, localStorageError);
          this.cache.set(key, value);
        }
      }
    } catch (error) {
      console.warn(`å­˜å‚¨è®¾ç½®å¤±è´¥ ${key}:`, error);
      this.cache.set(key, value); // å›é€€åˆ°å†…å­˜å­˜å‚¨
    }
  }

  async getItem(key) {
    try {
      if (this.isFigmaEnvironment) {
        // ğŸš¨ é‡è¦ä¿®å¤ï¼šåœ¨Figma UIçº¿ç¨‹ä¸­ï¼Œä¼˜å…ˆä½¿ç”¨å†…å­˜ç¼“å­˜
        // å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œå¯ä»¥å‘æ’ä»¶ä¸»çº¿ç¨‹è¯·æ±‚æ•°æ®
        if (this.cache.has(key)) {
          console.log(`ğŸ“¦ ä»ç¼“å­˜è·å–: ${key}`);
          return this.cache.get(key);
        }
        
        // å¦‚æœç¼“å­˜ä¸­æ²¡æœ‰ï¼Œè¿”å›undefinedï¼Œé¿å…å¼‚æ­¥ç­‰å¾…
        // å®é™…é¡¹ç›®ä¸­å¯ä»¥é€šè¿‡æ¶ˆæ¯é€šä¿¡ä»æ’ä»¶ä¸»çº¿ç¨‹è·å–
        console.log(`âš ï¸ ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ° ${key}ï¼Œè¿”å›é»˜è®¤å€¼`);
        return undefined;
      } else {
        // åœ¨éFigmaç¯å¢ƒä¸­ï¼Œå°è¯•ä½¿ç”¨localStorage
        try {
          const value = localStorage.getItem(key);
          console.log(`âœ… localStorageè¯»å–æˆåŠŸ: ${key}`);
          return value;
        } catch (localStorageError) {
          console.warn(`localStorageä¸å¯ç”¨ï¼Œä½¿ç”¨å†…å­˜å­˜å‚¨: ${key}`, localStorageError);
          return this.cache.get(key);
        }
      }
    } catch (error) {
      console.warn(`å­˜å‚¨è¯»å–å¤±è´¥ ${key}:`, error);
      return this.cache.get(key); // å›é€€åˆ°å†…å­˜å­˜å‚¨
    }
  }

  async removeItem(key) {
    try {
      if (this.isFigmaEnvironment) {
        // ğŸš¨ é‡è¦ä¿®å¤ï¼šåœ¨Figma UIçº¿ç¨‹ä¸­ï¼Œä¸èƒ½ç›´æ¥è®¿é—®figma.clientStorage
        // éœ€è¦é€šè¿‡postMessageä¸æ’ä»¶ä¸»çº¿ç¨‹é€šä¿¡
        console.log(`ğŸ“¤ å‘æ’ä»¶å‘é€å­˜å‚¨åˆ é™¤è¯·æ±‚: ${key}`);
        
        // å‘é€æ¶ˆæ¯åˆ°æ’ä»¶ä¸»çº¿ç¨‹
        window.parent.postMessage({
          pluginMessage: {
            type: 'storage-delete',
            key: key
          }
        }, '*');
        
        // åŒæ—¶ä»å†…å­˜ç¼“å­˜ä¸­åˆ é™¤
        this.cache.delete(key);
        console.log(`âœ… ç¼“å­˜åˆ é™¤æˆåŠŸ: ${key}`);
      } else {
        // åœ¨éFigmaç¯å¢ƒä¸­ï¼Œæ£€æµ‹localStorageæ˜¯å¦å¯ç”¨
        // æ·»åŠ é¢å¤–çš„data:åè®®æ£€æŸ¥ï¼Œé˜²æ­¢åœ¨Figmaæ²™ç›’ä¸­è¯¯è°ƒç”¨localStorage
        if (window.location.protocol === 'data:') {
          console.warn(`æ£€æµ‹åˆ°data:åè®®ï¼Œè·³è¿‡localStorageï¼Œä½¿ç”¨å†…å­˜å­˜å‚¨: ${key}`);
          this.cache.delete(key);
          return;
        }
        
        try {
          localStorage.removeItem(key);
          console.log(`âœ… localStorageåˆ é™¤æˆåŠŸ: ${key}`);
        } catch (localStorageError) {
          console.warn(`localStorageä¸å¯ç”¨ï¼Œä½¿ç”¨å†…å­˜å­˜å‚¨: ${key}`, localStorageError);
          this.cache.delete(key);
        }
      }
    } catch (error) {
      console.warn(`å­˜å‚¨åˆ é™¤å¤±è´¥ ${key}:`, error);
      this.cache.delete(key); // å›é€€åˆ°å†…å­˜å­˜å‚¨
    }
  }

  async getAllKeys() {
    try {
      if (this.isFigmaEnvironment) {
        // ğŸš¨ é‡è¦ä¿®å¤ï¼šåœ¨Figma UIçº¿ç¨‹ä¸­ï¼Œä¸èƒ½ç›´æ¥è®¿é—®figma.clientStorage
        // ä¼˜å…ˆè¿”å›å†…å­˜ç¼“å­˜çš„é”®ï¼Œé¿å…å¤æ‚çš„å¼‚æ­¥é€šä¿¡
        console.log(`ğŸ“¦ è¿”å›ç¼“å­˜ä¸­çš„å­˜å‚¨é”®`);
        return Array.from(this.cache.keys());
      } else {
        // åœ¨éFigmaç¯å¢ƒä¸­ï¼Œæ£€æµ‹localStorageæ˜¯å¦å¯ç”¨
        // æ·»åŠ é¢å¤–çš„data:åè®®æ£€æŸ¥ï¼Œé˜²æ­¢åœ¨Figmaæ²™ç›’ä¸­è¯¯è°ƒç”¨localStorage
        if (window.location.protocol === 'data:') {
          console.warn(`æ£€æµ‹åˆ°data:åè®®ï¼Œè·³è¿‡localStorageï¼Œä½¿ç”¨å†…å­˜å­˜å‚¨`);
          return Array.from(this.cache.keys());
        }
        
        try {
          const keys = Object.keys(localStorage);
          console.log(`âœ… localStorageé”®è·å–æˆåŠŸ: ${keys.length}ä¸ª`);
          return keys;
        } catch (localStorageError) {
          console.warn(`localStorageä¸å¯ç”¨ï¼Œä½¿ç”¨å†…å­˜å­˜å‚¨`, localStorageError);
          return Array.from(this.cache.keys());
        }
      }
    } catch (error) {
      console.warn('è·å–å­˜å‚¨é”®å¤±è´¥:', error);
      return Array.from(this.cache.keys()); // å›é€€åˆ°å†…å­˜å­˜å‚¨
    }
  }
}

// åˆ›å»ºå…¨å±€å­˜å‚¨é€‚é…å™¨å®ä¾‹
const storageAdapter = new StorageAdapter();

// å¯¼å‡ºåˆ°å…¨å±€
window.storageAdapter = storageAdapter;

// ==================== å·¥å…·å‡½æ•°æ¨¡å— ====================

// æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
function switchTab(tabName) {
  // ç§»é™¤æ‰€æœ‰æ ‡ç­¾é¡µçš„æ¿€æ´»çŠ¶æ€
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(tab => {
    tab.classList.remove('active');
  });
  
  // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
  const tabContents = document.querySelectorAll('.tab-content');
  tabContents.forEach(content => {
    content.classList.remove('active');
  });
  
  // æ¿€æ´»ç›®æ ‡æ ‡ç­¾é¡µ
  const targetTab = document.querySelector(`[data-tab="${tabName}"]`);
  if (targetTab) {
    targetTab.classList.add('active');
  }
  
  // æ˜¾ç¤ºç›®æ ‡æ ‡ç­¾é¡µå†…å®¹
  const targetContent = document.getElementById(`${tabName}-content`);
  if (targetContent) {
    targetContent.classList.add('active');
  }
}

// æŒ‰é’®ç‰ˆæœ¬åˆ‡æ¢åŠŸèƒ½
function switchButtonVersion() {
  const selector = document.getElementById('buttonVersionSelect');
  if (!selector) return;
  
  // éšè—æ‰€æœ‰ç‰ˆæœ¬å†…å®¹
  const contents = document.querySelectorAll('#buttonVersionContent .version-content');
  contents.forEach(content => content.classList.remove('active'));
  
  // æ˜¾ç¤ºé€‰ä¸­çš„ç‰ˆæœ¬å†…å®¹
  const selectedValue = selector.value;
  const targetContent = document.getElementById(`${selectedValue}Content`);
  if (targetContent) {
    targetContent.classList.add('active');
  }
}

// åˆ›å»ºåŸå‹åŠŸèƒ½
function createPrototype() {
  try {
    console.log('å¼€å§‹åˆ›å»ºåŸå‹...');
    
    // æ”¶é›†è¡¨å•æ•°æ®
    const config = window.dataCollector.collectFormData();
    
    // å‘é€åˆ°æ’ä»¶ä¸»çº¿ç¨‹
    window.pluginComm.postMessage('create-prototype', { config });
    
  } catch (error) {
    console.error('åˆ›å»ºåŸå‹å¤±è´¥:', error);
    window.notificationSystem.show(`åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
  }
}

// è·å–å›¾ç‰‡æ•°æ®
async function getImageData(inputId) {
  try {
    const input = document.getElementById(inputId);
    if (!input || !input.files || input.files.length === 0) {
      return null;
    }
    
    const file = input.files[0];
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => resolve(e.target.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
    
  } catch (error) {
    console.error(`è·å–å›¾ç‰‡æ•°æ®å¤±è´¥ (${inputId}):`, error);
    return null;
  }
}

// æ”¶é›†æ¨¡å—æ•°æ®
function collectModuleData() {
  const modules = document.querySelectorAll('#modulesContainer .module');
  const moduleData = [];
  
  modules.forEach(moduleEl => {
    const moduleType = moduleEl.dataset.moduleType;
    const moduleId = moduleEl.id;
    
    if (moduleType && moduleId) {
      const moduleContent = collectModuleContent(moduleEl, moduleType);
      if (moduleContent) {
        moduleData.push({
          id: moduleId,
          type: moduleType,
          content: moduleContent
        });
      }
    }
  });
  
  return moduleData;
}

// æ”¶é›†æ¨¡å—å†…å®¹
function collectModuleContent(container, moduleType) {
  switch (moduleType) {
    case 'nineGrid':
      return collectNineGridData(container);
    case 'signIn':
      return collectSignInData(container, container.id);
    case 'collectCards':
      return collectCardsData(container, container.id);
    case 'activityContent':
      return collectActivityContentData(container, container.id);
    default:
      console.warn(`æœªçŸ¥çš„æ¨¡å—ç±»å‹: ${moduleType}`);
      return null;
  }
}

// æ”¶é›†ä¹å®«æ ¼æ•°æ®
function collectNineGridData(container) {
  const data = {
    prizes: []
  };
  
  // æ”¶é›†å¥–å“ä¿¡æ¯
  const prizeElements = container.querySelectorAll('.prize-item');
  prizeElements.forEach((prizeEl, index) => {
    const nameInput = prizeEl.querySelector('.prize-name');
    const imageInput = prizeEl.querySelector('.prize-upload');
    
    if (nameInput || imageInput) {
      const prize = {
        position: getPrizePosition(index),
        name: nameInput ? nameInput.value : '',
        image: imageInput && imageInput.files[0] ? imageInput.files[0] : null
      };
      data.prizes.push(prize);
    }
  });
  
  return data;
}

// æ”¶é›†ç­¾åˆ°æ•°æ®
function collectSignInData(container, moduleId) {
  const data = {};
  
  // æ”¶é›†åŸºæœ¬ä¿¡æ¯
  const titleInput = container.querySelector('.sign-in-title');
  if (titleInput) data.title = titleInput.value;
  
  const descInput = container.querySelector('.sign-in-description');
  if (descInput) data.description = descInput.value;
  
  // æ”¶é›†å›¾ç‰‡
  const images = ['title', 'bg', 'dayicon', 'signbtn'];
  images.forEach(imageType => {
    const imageData = window.imageManager.getModule(`${moduleId}-${imageType}`);
    if (imageData) {
      data[`${imageType}Image`] = imageData;
    }
  });
  
  return data;
}

// æ”¶é›†é›†å¡æ•°æ®
function collectCardsData(container, moduleId) {
  const data = {};
  
  // æ”¶é›†åŸºæœ¬ä¿¡æ¯
  const titleInput = container.querySelector('.collect-title');
  if (titleInput) data.title = titleInput.value;
  
  const descInput = container.querySelector('.collect-description');
  if (descInput) data.description = descInput.value;
  
  // æ”¶é›†å›¾ç‰‡
  const images = ['title', 'bg', 'cardbg', 'combinebtn'];
  images.forEach(imageType => {
    const imageData = window.imageManager.getModule(`${moduleId}-${imageType}`);
    if (imageData) {
      data[`${imageType}Image`] = imageData;
    }
  });
  
  return data;
}

// æ”¶é›†æ´»åŠ¨å†…å®¹æ•°æ®
function collectActivityContentData(container, moduleId) {
  const data = {};
  
  // æ”¶é›†æ–‡æœ¬å†…å®¹
  const mainTitleInput = container.querySelector('.activity-main-title');
  if (mainTitleInput) data.mainTitle = mainTitleInput.value;
  
  const subTitleInput = container.querySelector('.activity-sub-title');
  if (subTitleInput) data.subTitle = subTitleInput.value;
  
  const contentInput = container.querySelector('.activity-content-text');
  if (contentInput) data.content = contentInput.value;
  
  // æ”¶é›†å›¾ç‰‡
  const images = ['main-title-bg', 'sub-title-bg', 'image'];
  images.forEach(imageType => {
    const imageData = window.imageManager.getModule(`${moduleId}-${imageType}`);
    if (imageData) {
      data[`${imageType.replace('-', '')}Image`] = imageData;
    }
  });
  
  return data;
}

// è·å–å¥–å“ä½ç½®
function getPrizePosition(index) {
  // ä¹å®«æ ¼ä½ç½®æ˜ å°„ (3x3ç½‘æ ¼)
  const positions = [
    { row: 0, col: 0 }, // ä½ç½®0: å·¦ä¸Š
    { row: 0, col: 1 }, // ä½ç½®1: ä¸Šä¸­
    { row: 0, col: 2 }, // ä½ç½®2: å³ä¸Š
    { row: 1, col: 2 }, // ä½ç½®3: å³ä¸­
    { row: 2, col: 2 }, // ä½ç½®4: å³ä¸‹
    { row: 2, col: 1 }, // ä½ç½®5: ä¸‹ä¸­
    { row: 2, col: 0 }, // ä½ç½®6: å·¦ä¸‹
    { row: 1, col: 0 }, // ä½ç½®7: å·¦ä¸­
    { row: 1, col: 1 }  // ä½ç½®8: ä¸­å¿ƒ(æŠ½å¥–æŒ‰é’®ä½ç½®)
  ];
  
  return positions[index] || { row: 0, col: 0 };
}

// é€šç”¨å›¾ç‰‡é¢„è§ˆå‡½æ•°
function previewImage(input, previewElement) {
  if (!input.files || input.files.length === 0) return;
  
  const file = input.files[0];
  if (!file.type.startsWith('image/')) {
    alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    if (previewElement) {
      previewElement.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: contain;">`;
    }
  };
  reader.readAsDataURL(file);
  
  // å¤„ç†æ¨¡å—å›¾ç‰‡ä¸Šä¼ 
  if (input.closest('.module')) {
    window.fileProcessor.handleModuleImageUpload({ target: input });
  }
}

// ä¸»é¢˜ç³»ç»ŸåŠŸèƒ½
function setupSystemThemeListener() {
  if (window.matchMedia) {
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    
    const handleThemeChange = async (e) => {
      const isDark = e.matches;
      console.log('ç³»ç»Ÿä¸»é¢˜å˜åŒ–:', isDark ? 'æ·±è‰²' : 'æµ…è‰²');
      
      // æ£€æŸ¥æ˜¯å¦å¯ç”¨äº†è‡ªåŠ¨ä¸»é¢˜
      if (window.storageAdapter) {
        try {
          const autoThemeEnabled = await window.storageAdapter.getItem('autoTheme') === 'true';
          if (autoThemeEnabled) {
            applyTheme(isDark ? 'dark' : 'light');
            
            // é€šçŸ¥ç”¨æˆ·ä¸»é¢˜å·²è‡ªåŠ¨åˆ‡æ¢
            const themeText = isDark ? 'æ·±è‰²' : 'æµ…è‰²';
            console.log(`å·²è‡ªåŠ¨åˆ‡æ¢åˆ°${themeText}ä¸»é¢˜`);
          }
        } catch (error) {
          console.warn('æ£€æŸ¥è‡ªåŠ¨ä¸»é¢˜è®¾ç½®å¤±è´¥:', error);
        }
      } else {
        console.warn('StorageAdapterä¸å¯ç”¨ï¼Œæ— æ³•æ£€æŸ¥è‡ªåŠ¨ä¸»é¢˜è®¾ç½®');
      }
    };
    
    // ç›‘å¬ç³»ç»Ÿä¸»é¢˜å˜åŒ–
    if (mediaQuery.addEventListener) {
      mediaQuery.addEventListener('change', handleThemeChange);
    } else {
      // å…¼å®¹æ—§ç‰ˆæµè§ˆå™¨
      mediaQuery.addListener(handleThemeChange);
    }
    
    // åˆå§‹æ£€æŸ¥
    handleThemeChange(mediaQuery);
  }
}

// åŠ è½½ä¸»é¢˜åå¥½
async function loadThemePreference() {
  try {
    // ç¡®ä¿StorageAdapterå·²ç»åˆå§‹åŒ–
    if (!window.storageAdapter) {
      console.warn('StorageAdapteræœªåˆå§‹åŒ–ï¼Œä½¿ç”¨é»˜è®¤ä¸»é¢˜');
      applyTheme('light');
      return;
    }

    console.log('å¼€å§‹åŠ è½½ä¸»é¢˜åå¥½...');
    
    const savedTheme = await window.storageAdapter.getItem('theme');
    const autoTheme = await window.storageAdapter.getItem('autoTheme') === 'true';
    
    console.log('ä¸»é¢˜è®¾ç½®:', { savedTheme, autoTheme });
    
    if (autoTheme) {
      // è‡ªåŠ¨ä¸»é¢˜ï¼šè·Ÿéšç³»ç»Ÿ
      console.log('ä½¿ç”¨è‡ªåŠ¨ä¸»é¢˜æ¨¡å¼');
      detectAndApplySystemTheme();
    } else if (savedTheme) {
      // ä½¿ç”¨ä¿å­˜çš„ä¸»é¢˜
      console.log(`ä½¿ç”¨ä¿å­˜çš„ä¸»é¢˜: ${savedTheme}`);
      applyTheme(savedTheme);
    } else {
      // é»˜è®¤è·Ÿéšç³»ç»Ÿ
      console.log('ä½¿ç”¨é»˜è®¤ç³»ç»Ÿä¸»é¢˜');
      detectAndApplySystemTheme();
    }
  } catch (error) {
    console.error('åŠ è½½ä¸»é¢˜åå¥½å¤±è´¥:', error);
    // é™çº§åˆ°é»˜è®¤æµ…è‰²ä¸»é¢˜
    console.log('é™çº§åˆ°é»˜è®¤æµ…è‰²ä¸»é¢˜');
    applyTheme('light');
  }
}

// æ£€æµ‹å¹¶åº”ç”¨ç³»ç»Ÿä¸»é¢˜
function detectAndApplySystemTheme() {
  try {
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const systemTheme = prefersDark ? 'dark' : 'light';
    applyTheme(systemTheme);
    console.log('å·²åº”ç”¨ç³»ç»Ÿä¸»é¢˜:', systemTheme);
  } catch (error) {
    console.error('æ£€æµ‹ç³»ç»Ÿä¸»é¢˜å¤±è´¥:', error);
    applyTheme('light');
  }
}

// åº”ç”¨ä¸»é¢˜
async function applyTheme(theme) {
  try {
    // ç§»é™¤ç°æœ‰ä¸»é¢˜ç±»
    document.body.classList.remove('light-theme', 'dark-theme');
    
    // åº”ç”¨æ–°ä¸»é¢˜
    document.body.classList.add(`${theme}-theme`);
    
    // æ›´æ–°ä¸»é¢˜æŒ‰é’®çŠ¶æ€
    updateThemeButtonsState(theme);
    
    // ä¿å­˜ä¸»é¢˜åå¥½ï¼ˆå¦‚æœå­˜å‚¨é€‚é…å™¨å¯ç”¨ï¼‰
    if (window.storageAdapter) {
      try {
        await window.storageAdapter.setItem('theme', theme);
        console.log(`âœ… ä¸»é¢˜å·²ä¿å­˜: ${theme}`);
      } catch (storageError) {
        console.warn(`ä¸»é¢˜ä¿å­˜å¤±è´¥ï¼Œä½†å·²åº”ç”¨åˆ°ç•Œé¢: ${theme}`, storageError);
      }
    } else {
      console.warn(`StorageAdapterä¸å¯ç”¨ï¼Œä¸»é¢˜ä»…åº”ç”¨åˆ°ç•Œé¢: ${theme}`);
    }
    
    console.log('ä¸»é¢˜å·²åˆ‡æ¢åˆ°:', theme);
  } catch (error) {
    console.error('åº”ç”¨ä¸»é¢˜å¤±è´¥:', error);
  }
}

// æ›´æ–°ä¸»é¢˜æŒ‰é’®çŠ¶æ€
function updateThemeButtonsState(activeTheme) {
  try {
    const lightBtn = document.getElementById('lightTheme');
    const darkBtn = document.getElementById('darkTheme');
    
    if (lightBtn && darkBtn) {
      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      lightBtn.classList.toggle('active', activeTheme === 'light');
      darkBtn.classList.toggle('active', activeTheme === 'dark');
      
      // æ›´æ–°æŒ‰é’®æ–‡æœ¬æˆ–å›¾æ ‡ï¼ˆå¦‚æœéœ€è¦ï¼‰
      // lightBtn.setAttribute('aria-pressed', activeTheme === 'light');
      // darkBtn.setAttribute('aria-pressed', activeTheme === 'dark');
    }
  } catch (error) {
    console.error('æ›´æ–°ä¸»é¢˜æŒ‰é’®çŠ¶æ€å¤±è´¥:', error);
  }
}

// åˆ‡æ¢ä¸»é¢˜
async function switchTheme(theme) {
  try {
    await applyTheme(theme);
    
    // ç¦ç”¨è‡ªåŠ¨ä¸»é¢˜ï¼ˆå¦‚æœå­˜å‚¨é€‚é…å™¨å¯ç”¨ï¼‰
    if (window.storageAdapter) {
      try {
        await window.storageAdapter.setItem('autoTheme', 'false');
        console.log('âœ… è‡ªåŠ¨ä¸»é¢˜å·²ç¦ç”¨');
      } catch (storageError) {
        console.warn('è‡ªåŠ¨ä¸»é¢˜è®¾ç½®ä¿å­˜å¤±è´¥:', storageError);
      }
    } else {
      console.warn('StorageAdapterä¸å¯ç”¨ï¼Œæ— æ³•ä¿å­˜è‡ªåŠ¨ä¸»é¢˜è®¾ç½®');
    }
    
    console.log('æ‰‹åŠ¨åˆ‡æ¢ä¸»é¢˜åˆ°:', theme);
  } catch (error) {
    console.error('åˆ‡æ¢ä¸»é¢˜å¤±è´¥:', error);
  }
}

// ç»‘å®šä¸»é¢˜æŒ‰é’®äº‹ä»¶
function bindThemeButtonEvents() {
  try {
    const lightBtn = document.getElementById('lightTheme');
    const darkBtn = document.getElementById('darkTheme');
    
    if (lightBtn) {
      lightBtn.addEventListener('click', () => switchTheme('light'));
    }
    
    if (darkBtn) {
      darkBtn.addEventListener('click', () => switchTheme('dark'));
    }
    
    // å¯é€‰ï¼šæ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + Shift + T åˆ‡æ¢ä¸»é¢˜
      if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'T') {
        e.preventDefault();
        const currentTheme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        switchTheme(newTheme);
      }
    });
    
    console.log('ä¸»é¢˜æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
  } catch (error) {
    console.error('ç»‘å®šä¸»é¢˜æŒ‰é’®äº‹ä»¶å¤±è´¥:', error);
  }
}

// å…¨å±€ç‚¹å‡»å¤„ç†å™¨
function globalClickHandler(e) {
  // å¤„ç†æ ‡ç­¾é¡µç‚¹å‡»
  if (e.target.classList.contains('tab')) {
    const tabName = e.target.dataset.tab;
    if (tabName) {
      switchTab(tabName);
    }
  }
  
  // å¤„ç†ä¸»é¢˜æŒ‰é’®ç‚¹å‡»
  if (e.target.id === 'lightTheme') {
    switchTheme('light');
  } else if (e.target.id === 'darkTheme') {
    switchTheme('dark');
  }
  
  // åˆ›å»ºæŒ‰é’®å·²ç”±UIæ§åˆ¶å™¨å¤„ç†ï¼Œé¿å…é‡å¤ç»‘å®š
  
  // å¤„ç†é‡ç½®æŒ‰é’®ç‚¹å‡»
  if (e.target.id === 'reset') {
    if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
      window.formResetter.resetAll();
    }
  }
}

// å…¨å±€changeå¤„ç†å™¨
function globalChangeHandler(e) {
  // å¤„ç†æŒ‰é’®ç‰ˆæœ¬é€‰æ‹©å™¨
  if (e.target.id === 'buttonVersionSelect') {
    switchButtonVersion();
  }
  
  // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
  if (e.target.type === 'file') {
    handleFileUpload(e.target);
  }
}

// å…¨å±€inputå¤„ç†å™¨
function globalInputHandler(e) {
  // å¤„ç†é¢œè‰²è¾“å…¥åŒæ­¥
  if (e.target.type === 'color') {
    const textInput = e.target.nextElementSibling;
    if (textInput && textInput.classList.contains('color-value')) {
      textInput.value = e.target.value.toUpperCase();
    }
  }
  
  // å¤„ç†é¢œè‰²æ–‡æœ¬è¾“å…¥
  if (e.target.classList.contains('color-value')) {
    const colorInput = e.target.previousElementSibling;
    if (colorInput && colorInput.type === 'color' && /^#[0-9A-F]{6}$/i.test(e.target.value)) {
      colorInput.value = e.target.value;
    }
  }
}

// å¤„ç†æ–‡ä»¶ä¸Šä¼ 
function handleFileUpload(input) {
  if (!input.files || input.files.length === 0) return;
  
  // æŸ¥æ‰¾é¢„è§ˆå®¹å™¨
  const previewContainer = input.nextElementSibling?.querySelector('.img-preview-inline, .preview-container');
  if (previewContainer) {
    previewImage(input, previewContainer);
  }
  
  // ç‰¹æ®Šå¤„ç†æ¸¸æˆå›¾æ ‡
  if (input.id === 'gameIconUpload') {
    const gameIconPreview = document.getElementById('gameIconPreview');
    if (gameIconPreview) {
      previewImage(input, gameIconPreview);
    }
  }
}

// é‡ç½®è¡¨å•
function resetForm() {
  if (window.formResetter) {
    window.formResetter.resetAll();
  }
}

// å¯¼å‡ºä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
window.utilityFunctions = {
  switchTab,
  switchButtonVersion,
  createPrototype,
  getImageData,
  collectModuleData,
  previewImage,
  setupSystemThemeListener,
  loadThemePreference,
  applyTheme,
  switchTheme,
  bindThemeButtonEvents,
  globalClickHandler,
  globalChangeHandler,
  globalInputHandler,
  handleFileUpload,
  resetForm
};


/* === plugin-communicator.js === */
// ==================== æ’ä»¶é€šä¿¡ç®¡ç† ====================

class PluginCommunicator {
  constructor() {
    this.messageHandlers = new Map();
    this.isInitialized = false;
    this.init();
  }
  
  // åˆå§‹åŒ–é€šä¿¡
  init() {
    if (this.isInitialized) return;
    
    window.addEventListener('message', this.handleMessage.bind(this));
    
    // é¡µé¢åŠ è½½å®Œæˆåé€šçŸ¥æ’ä»¶
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        this.postMessage('ui-loaded', {});
      });
    } else {
      this.postMessage('ui-loaded', {});
    }
    
    this.isInitialized = true;
    console.log('æ’ä»¶é€šä¿¡å™¨å·²åˆå§‹åŒ–');
  }
  
  // å‘é€æ¶ˆæ¯åˆ°æ’ä»¶
  postMessage(type, data = {}) {
    try {
      const message = { pluginMessage: { type, ...data } };
      parent.postMessage(message, '*');
      console.log(`å‘é€æ¶ˆæ¯åˆ°æ’ä»¶: ${type}`, message);
    } catch (error) {
      console.error(`å‘é€æ¶ˆæ¯å¤±è´¥: ${type}`, error);
    }
  }
  
  // å¤„ç†æ’ä»¶æ¶ˆæ¯
  handleMessage(event) {
    try {
      const message = event.data.pluginMessage;
      if (!message) return;
      
      console.log(`æ”¶åˆ°æ’ä»¶æ¶ˆæ¯: ${message.type}`, message);
      
      const handler = this.messageHandlers.get(message.type);
      if (handler) {
        handler(message);
      } else {
        console.warn(`æœªæ‰¾åˆ°æ¶ˆæ¯å¤„ç†å™¨: ${message.type}`);
      }
    } catch (error) {
      console.error('å¤„ç†æ’ä»¶æ¶ˆæ¯å¤±è´¥:', error);
    }
  }
  
  // æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨
  on(type, handler) {
    this.messageHandlers.set(type, handler);
    console.log(`æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨: ${type}`);
  }
  
  // æµ‹è¯•é€šä¿¡è¿æ¥
  testConnection() {
    this.postMessage('ping', { timestamp: Date.now() });
  }
}

// åˆ›å»ºé€šä¿¡å™¨å®ä¾‹å¹¶æŒ‚è½½åˆ°windowå¯¹è±¡
console.log('ğŸ”§ å‡†å¤‡åˆ›å»ºPluginCommunicatorå®ä¾‹...');
try {
  window.pluginComm = new PluginCommunicator();
  console.log('âœ… PluginCommunicatorå®ä¾‹åˆ›å»ºæˆåŠŸ:', !!window.pluginComm);
} catch (error) {
  console.error('âŒ PluginCommunicatoråˆ›å»ºå¤±è´¥:', error);
  // åˆ›å»ºä¸€ä¸ªç®€åŒ–ç‰ˆæœ¬çš„é€šä¿¡å™¨
  window.pluginComm = {
    postMessage: function(type, data = {}) {
      try {
        const message = { pluginMessage: { type, ...data } };
        parent.postMessage(message, '*');
        console.log(`ğŸ“¤ å‘é€æ¶ˆæ¯åˆ°æ’ä»¶: ${type}`, message);
      } catch (err) {
        console.error(`ğŸ“¤ å‘é€æ¶ˆæ¯å¤±è´¥: ${type}`, err);
      }
    },
    on: function(type) {
      console.log(`ğŸ“ æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨: ${type} (ç®€åŒ–ç‰ˆ)`);
    }
  };
  console.log('âœ… å·²åˆ›å»ºç®€åŒ–ç‰ˆPluginCommunicator');
}

// æ³¨å†Œå›¾ç‰‡åˆ‡ç‰‡æ¶ˆæ¯å¤„ç†å™¨
window.pluginComm.on('slice-large-image', async (message) => {
  try {
    console.log('æ”¶åˆ°å›¾ç‰‡åˆ‡ç‰‡è¯·æ±‚:', message.imageData?.name);
    await window.imageSliceHandler.handleSliceRequest(message);
  } catch (error) {
    console.error('å¤„ç†å›¾ç‰‡åˆ‡ç‰‡è¯·æ±‚å¤±è´¥:', error);
    // å‘é€å¤±è´¥å“åº”
    window.pluginComm.postMessage('slice-image-response', {
      success: false,
      imageName: message.imageData?.name || 'æœªçŸ¥å›¾ç‰‡',
      error: error.message
    });
  }
}); 

/* === notification-system.js === */
// ==================== UI é€šçŸ¥ç³»ç»Ÿ ====================

class NotificationSystem {
  constructor() {
    this.notifications = new Set();
    this.loadingElement = null;
    this.init();
  }
  
  init() {
    // åˆ›å»ºåŠ è½½çŠ¶æ€å…ƒç´ 
    this.createLoadingElement();
  }
  
  createLoadingElement() {
    if (document.getElementById('loadingOverlay')) return;
    
    const overlay = document.createElement('div');
    overlay.id = 'loadingOverlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    `;
    
    const spinner = document.createElement('div');
    spinner.style.cssText = `
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    `;
    
    // æ·»åŠ æ—‹è½¬åŠ¨ç”»
    const style = document.createElement('style');
    style.textContent = `
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(style);
    
    overlay.appendChild(spinner);
    document.body.appendChild(overlay);
    this.loadingElement = overlay;
  }
  
  show(message, type = 'info', duration = 5000) {
    const notification = this.createElement(message, type);
    this.notifications.add(notification);
    
    document.body.appendChild(notification);
    
    // ä½¿ç”¨ requestAnimationFrame ç¡®ä¿å¹³æ»‘åŠ¨ç”»
    requestAnimationFrame(() => {
      notification.style.opacity = '1';
      notification.style.transform = 'translateY(0)';
    });
    
    // è‡ªåŠ¨ç§»é™¤
    setTimeout(() => this.hide(notification), duration);
    
    return notification;
  }
  
  createElement(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.style.opacity = '0';
    notification.style.transform = 'translateY(-20px)';
    return notification;
  }
  
  hide(notification) {
    notification.style.opacity = '0';
    notification.style.transform = 'translateY(-20px)';
    
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
      this.notifications.delete(notification);
    }, 300);
  }
  
  clear() {
    this.notifications.forEach(notification => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    });
    this.notifications.clear();
  }
  
  showLoading() {
    if (this.loadingElement) {
      this.loadingElement.style.display = 'flex';
    }
  }
  
  hideLoading() {
    if (this.loadingElement) {
      this.loadingElement.style.display = 'none';
    }
  }
}

// åˆ›å»ºå…¨å±€é€šçŸ¥ç³»ç»Ÿå®ä¾‹å¹¶æŒ‚è½½åˆ°windowå¯¹è±¡
window.notificationSystem = new NotificationSystem();

// ==================== åŠ è½½çŠ¶æ€ç®¡ç† ====================

// æ˜¾ç¤ºåŠ è½½çŠ¶æ€ - ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
window.showLoading = function(message = 'æ­£åœ¨å¤„ç†...') {
  window.notificationSystem.showLoading();
  console.log('æ˜¾ç¤ºåŠ è½½çŠ¶æ€:', message);
};

// éšè—åŠ è½½çŠ¶æ€ - ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
window.hideLoading = function() {
  window.notificationSystem.hideLoading();
  console.log('éšè—åŠ è½½çŠ¶æ€');
};

// å…¼å®¹å‡½æ•° - ä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
window.showNotification = function(message, type) {
  window.notificationSystem.show(message, type);
}; 

/* === theme-manager.js === */
// ==================== ä¸»é¢˜ç®¡ç†å™¨æ¨¡å— ====================

class ThemeManager {
  init() {
    this.checkSystemTheme();
    this.bindThemeButtons();
    this.watchSystemTheme();
  }
  
  checkSystemTheme() {
    const prefersDark = window.matchMedia?.('(prefers-color-scheme: dark)').matches;
    this.applyTheme(prefersDark ? 'dark' : 'light');
  }
  
  applyTheme(theme) {
    document.body.className = document.body.className.replace(/\b(light|dark)-theme\b/g, '');
    document.body.classList.add(`${theme}-theme`);
    
    this.updateThemeButtons(theme);
  }
  
  updateThemeButtons(theme) {
    const lightBtn = document.getElementById('lightTheme');
    const darkBtn = document.getElementById('darkTheme');
    
    if (lightBtn && darkBtn) {
      lightBtn.classList.toggle('active', theme === 'light');
      darkBtn.classList.toggle('active', theme === 'dark');
    }
  }
  
  bindThemeButtons() {
    const lightBtn = document.getElementById('lightTheme');
    const darkBtn = document.getElementById('darkTheme');
    
    if (lightBtn) {
      lightBtn.addEventListener('click', () => this.applyTheme('light'));
    }
    
    if (darkBtn) {
      darkBtn.addEventListener('click', () => this.applyTheme('dark'));
    }
  }
  
  watchSystemTheme() {
    if (window.matchMedia) {
      window.matchMedia('(prefers-color-scheme: dark)')
        .addEventListener('change', () => this.checkSystemTheme());
    }
  }
}

// åˆ›å»ºå…¨å±€ä¸»é¢˜ç®¡ç†å™¨å®ä¾‹
const themeManager = new ThemeManager();

// å¯¼å‡ºä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
window.themeManager = themeManager; 

/* === file-processor.js === */
// ==================== æ–‡ä»¶å¤„ç†å™¨ ====================

class FileProcessor {
  // å¤„ç†å›¾ç‰‡æ–‡ä»¶ä¸Šä¼ 
  async processImageFile(file, storageKey, isModule = false) {
    if (!this.isValidImageFile(file)) {
      throw new Error('è¯·ä¸Šä¼ æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
    }
    
    try {
      const uint8Array = await this.fileToUint8Array(file);
      
      // è·å–å›¾ç‰‡å°ºå¯¸
      const imageDimensions = await this.getImageDimensions(file);
      console.log(`å›¾ç‰‡ä¸Šä¼ æˆåŠŸ: ${storageKey}, å¤§å°: ${uint8Array.length} bytes, å°ºå¯¸: ${imageDimensions.width}x${imageDimensions.height}`);
      
      // å­˜å‚¨å›¾ç‰‡æ•°æ®å’Œå°ºå¯¸ä¿¡æ¯
      const imageData = {
        data: uint8Array,
        width: imageDimensions.width,
        height: imageDimensions.height,
        name: file.name,
        type: file.type
      };
      
      if (isModule) {
        window.imageManager.setModule(storageKey, imageData);
      } else {
        window.imageManager.set(storageKey, imageData);
      }
      
      return imageData;
    } catch (error) {
      console.error(`å›¾ç‰‡å¤„ç†å¤±è´¥: ${storageKey}`, error);
      throw new Error(`å›¾ç‰‡å¤„ç†å¤±è´¥: ${error.message}`);
    }
  }

  async handleImageUpload(e, storageKey) {
    try {
      await this.handleUpload(e.target, storageKey, false);
    } catch (error) {
      console.error(`åŸºç¡€å›¾ç‰‡ä¸Šä¼ å¤±è´¥ ${storageKey}:`, error);
      window.notificationSystem.show(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
    }
  }
  
  async handleUpload(input, storageKey, isModule = false) {
    if (!input.files?.[0]) return;
    
    console.log(`å¼€å§‹å¤„ç†å›¾ç‰‡ä¸Šä¼ : ${storageKey}, æ–‡ä»¶:`, input.files[0].name);
    
    try {
      await this.processImageFile(input.files[0], storageKey, isModule);
      
      // éªŒè¯å›¾ç‰‡æ˜¯å¦æ­£ç¡®å­˜å‚¨
      const storedData = isModule ? window.imageManager.getModule(storageKey) : window.imageManager.get(storageKey);
      console.log(`å›¾ç‰‡å­˜å‚¨éªŒè¯ ${storageKey}:`, storedData ? 'æˆåŠŸ' : 'å¤±è´¥');
      
      window.notificationSystem.show('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
    } catch (error) {
      console.error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥ ${storageKey}:`, error);
      window.notificationSystem.show(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
    }
  }

  async handleModuleImageUpload(e) {
    try {
      const input = e.target;
      const moduleEl = input.closest('.module');
      if (!moduleEl) return;
      
      const moduleId = moduleEl.id;
      const storageKey = this.getModuleStorageKey(input, moduleId);
      
      if (storageKey) {
        await this.handleUpload(input, storageKey, true);
      }
    } catch (error) {
      console.error('æ¨¡å—å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error);
      window.notificationSystem.show(`æ¨¡å—å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
    }
  }
  
  getModuleStorageKey(input, moduleId) {
    const classMap = {
      'derived-item-upload': `${moduleId}-titlebg`,
      'nine-grid-bg': `${moduleId}-gridbg`,
      'draw-btn': `${moduleId}-drawbtn`,
      'prize-bg': `${moduleId}-prizebg`,
      'sign-in-title-upload': `${moduleId}-title`,
      'sign-in-bg-upload': `${moduleId}-bg`,
      'day-icon-upload': `${moduleId}-dayicon`,
      'sign-in-btn-upload': `${moduleId}-signbtn`,
      'collect-title-upload': `${moduleId}-title`,
      'collect-bg-upload': `${moduleId}-bg`,
      'card-bg-upload': `${moduleId}-cardbg`,
      'combine-button-upload': `${moduleId}-combinebtn`,
      'activity-content-main-title-bg-upload': `${moduleId}-main-title-bg`,
      'activity-content-sub-title-bg-upload': `${moduleId}-sub-title-bg`,
      'activity-content-image-upload': `${moduleId}-image`
    };
    
    // ç‰¹æ®Šå¤„ç†å¥–å“å›¾ç‰‡ä¸Šä¼ 
    if (input.classList.contains('prize-upload')) {
      const prizeIndex = this.getPrizeIndex(input);
      return `${moduleId}-prize-${prizeIndex}`;
    }
    
    // æ£€æŸ¥æ‰€æœ‰å¯èƒ½çš„ç±»ååŒ¹é…
    for (const [className, key] of Object.entries(classMap)) {
      if (input.classList.contains(className)) {
        return key;
      }
    }
    
    // è°ƒè¯•ä¿¡æ¯
    console.log(`æœªæ‰¾åˆ°åŒ¹é…çš„å­˜å‚¨é”®ï¼Œè¾“å…¥ç±»å:`, input.className, `æ¨¡å—ID: ${moduleId}`);
    return null;
  }
  
  // è·å–å¥–å“åœ¨ä¹å®«æ ¼ä¸­çš„ç´¢å¼•
  getPrizeIndex(input) {
    const moduleEl = input.closest('.module');
    if (!moduleEl) return 0;
    
    const prizeInputs = Array.from(moduleEl.querySelectorAll('.prize-upload'));
    return prizeInputs.indexOf(input);
  }

  // è·å–å›¾ç‰‡å°ºå¯¸
  async getImageDimensions(file) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      
      img.onload = () => {
        resolve({
          width: img.naturalWidth,
          height: img.naturalHeight
        });
        // æ¸…ç†URLå¯¹è±¡
        URL.revokeObjectURL(img.src);
      };
      
      img.onerror = () => {
        URL.revokeObjectURL(img.src);
        reject(new Error('æ— æ³•è¯»å–å›¾ç‰‡å°ºå¯¸'));
      };
      
      // åˆ›å»ºä¸´æ—¶URL
      img.src = URL.createObjectURL(file);
    });
  }
  
  // éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆå›¾ç‰‡æ–‡ä»¶
  isValidImageFile(file) {
    return file && file.type.startsWith('image/');
  }
  
  // å°†æ–‡ä»¶è½¬æ¢ä¸º Uint8Array
  fileToUint8Array(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const arrayBuffer = e.target.result;
        const uint8Array = new Uint8Array(arrayBuffer);
        resolve(uint8Array);
      };
      reader.onerror = () => reject(new Error('æ–‡ä»¶è¯»å–å¤±è´¥'));
      reader.readAsArrayBuffer(file);
    });
  }
  
  // åˆ‡ç‰‡å¤§å›¾æ–¹æ³• - ä½¿ç”¨æ™ºèƒ½åˆ‡ç‰‡ç­–ç•¥
  async sliceLargeImage(imageData, sliceWidth = null, sliceHeight = null) {
    try {
      console.log(`å¼€å§‹åˆ‡ç‰‡å›¾ç‰‡: ${imageData.name || 'æœªçŸ¥å›¾ç‰‡'}`);
      
      // ğŸš¨ ä¿®å¤ï¼šä½¿ç”¨ä¼ å…¥çš„åˆ‡ç‰‡ç­–ç•¥ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨æ™ºèƒ½ç­–ç•¥
      let finalSliceWidth = sliceWidth;
      let finalSliceHeight = sliceHeight;
      
      // å¦‚æœæ²¡æœ‰æŒ‡å®šåˆ‡ç‰‡å°ºå¯¸ï¼Œä½¿ç”¨æ™ºèƒ½ç­–ç•¥è®¡ç®—
      if (!sliceWidth || !sliceHeight) {
        const tempImg = new Image();
        const tempBlob = new Blob([new Uint8Array(imageData.bytes || imageData.data)], { type: imageData.type });
        const tempUrl = URL.createObjectURL(tempBlob);
        
        await new Promise((resolve, reject) => {
          tempImg.onload = resolve;
          tempImg.onerror = reject;
          tempImg.src = tempUrl;
        });
        
        // ä½¿ç”¨æ™ºèƒ½ç­–ç•¥è®¡ç®—åˆ‡ç‰‡å°ºå¯¸
        const strategy = this.calculateSliceStrategy(tempImg.width, tempImg.height, 4096);
        finalSliceWidth = strategy.sliceWidth;
        finalSliceHeight = strategy.sliceHeight;
        
        console.log(`æ™ºèƒ½ç­–ç•¥: ${strategy.description}`);
        console.log(`è®¡ç®—å¾—å‡ºåˆ‡ç‰‡å°ºå¯¸: ${finalSliceWidth}x${finalSliceHeight}`);
        
        URL.revokeObjectURL(tempUrl);
      }
      
      console.log(`ç›®æ ‡åˆ‡ç‰‡å°ºå¯¸: ${finalSliceWidth}x${finalSliceHeight}`);
      
      // ğŸš¨ ä¿®å¤ï¼šç¡®ä¿å›¾ç‰‡æ•°æ®æ ¼å¼æ­£ç¡®
      let uint8ArrayData;
      if (imageData.bytes && Array.isArray(imageData.bytes)) {
        // ä»æ’ä»¶ä¼ æ¥çš„æ˜¯Arrayæ ¼å¼ï¼Œéœ€è¦è½¬æ¢ä¸ºUint8Array
        console.log('æ£€æµ‹åˆ°Arrayæ ¼å¼çš„å›¾ç‰‡æ•°æ®ï¼Œæ­£åœ¨è½¬æ¢ä¸ºUint8Array...');
        uint8ArrayData = new Uint8Array(imageData.bytes);
      } else if (imageData.data instanceof Uint8Array) {
        // å·²ç»æ˜¯Uint8Arrayæ ¼å¼
        uint8ArrayData = imageData.data;
      } else if (imageData.data && Array.isArray(imageData.data)) {
        // dataå­—æ®µæ˜¯Arrayæ ¼å¼
        console.log('æ£€æµ‹åˆ°dataå­—æ®µä¸ºArrayæ ¼å¼ï¼Œæ­£åœ¨è½¬æ¢ä¸ºUint8Array...');
        uint8ArrayData = new Uint8Array(imageData.data);
      } else {
        throw new Error('å›¾ç‰‡æ•°æ®æ ¼å¼ä¸æ­£ç¡®ï¼Œæ— æ³•å¤„ç†');
      }
      
      // éªŒè¯æ•°æ®å®Œæ•´æ€§
      if (!uint8ArrayData || uint8ArrayData.length === 0) {
        throw new Error('å›¾ç‰‡æ•°æ®ä¸ºç©ºæˆ–æŸå');
      }
      
      console.log(`å›¾ç‰‡æ•°æ®å¤§å°: ${uint8ArrayData.length} bytes`);
      
      // åˆ›å»ºç”»å¸ƒæ¥å¤„ç†å›¾ç‰‡
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      if (!ctx) {
        throw new Error('æ— æ³•åˆ›å»º Canvas ä¸Šä¸‹æ–‡');
      }
      
      // ä» Uint8Array åˆ›å»ºå›¾ç‰‡
      const blob = new Blob([uint8ArrayData], { type: imageData.type || 'image/png' });
      const img = new Image();
      const imgUrl = URL.createObjectURL(blob);
      
      console.log(`åˆ›å»ºå›¾ç‰‡URL: ${imgUrl}`);
      console.log(`å›¾ç‰‡ç±»å‹: ${imageData.type || 'image/png'}`);
      
      return new Promise((resolve, reject) => {
        const timeoutId = setTimeout(() => {
          URL.revokeObjectURL(imgUrl);
          reject(new Error('å›¾ç‰‡åŠ è½½è¶…æ—¶'));
        }, 30000); // 30ç§’è¶…æ—¶
        
        img.onload = () => {
          console.log('å›¾ç‰‡åŠ è½½æˆåŠŸ');
          clearTimeout(timeoutId);
          
          try {
            const originalWidth = img.width;
            const originalHeight = img.height;
            
            console.log(`åŸå›¾å°ºå¯¸: ${originalWidth}x${originalHeight}`);
            console.log(`åˆ‡ç‰‡å°ºå¯¸: ${finalSliceWidth}x${finalSliceHeight}`);
            
            // è®¡ç®—éœ€è¦åˆ‡ç‰‡çš„æ•°é‡
            const cols = Math.ceil(originalWidth / finalSliceWidth);
            const rows = Math.ceil(originalHeight / finalSliceHeight);
            const totalSlices = cols * rows;
            
            console.log(`åˆ‡ç‰‡æ•°é‡: ${cols}åˆ— x ${rows}è¡Œ = ${totalSlices}ç‰‡`);
            
            const slices = [];
            let completedSlices = 0;
            
            // å¤„ç†å®Œæˆæ£€æŸ¥å‡½æ•°
            const checkCompletion = () => {
              if (completedSlices === totalSlices) {
                // æŒ‰è¡Œåˆ—é¡ºåºæ’åº
                slices.sort((a, b) => {
                  if (a.row !== b.row) return a.row - b.row;
                  return a.col - b.col;
                });
                
                URL.revokeObjectURL(imgUrl);
                console.log(`å›¾ç‰‡åˆ‡ç‰‡å®Œæˆï¼Œå…± ${slices.length} ç‰‡`);
                
                resolve({
                  slices: slices,
                  originalWidth: originalWidth,
                  originalHeight: originalHeight,
                  sliceWidth: finalSliceWidth,
                  sliceHeight: finalSliceHeight,
                  cols: cols,
                  rows: rows
                });
              }
            };
            
            // ç”Ÿæˆæ¯ä¸ªåˆ‡ç‰‡
            for (let row = 0; row < rows; row++) {
              for (let col = 0; col < cols; col++) {
                // è®¡ç®—å½“å‰åˆ‡ç‰‡çš„ä½ç½®å’Œå°ºå¯¸
                  const x = col * finalSliceWidth;
                  const y = row * finalSliceHeight;
                  const currentSliceWidth = Math.min(finalSliceWidth, originalWidth - x);
                  const currentSliceHeight = Math.min(finalSliceHeight, originalHeight - y);
                
                // è®¾ç½®ç”»å¸ƒå°ºå¯¸
                canvas.width = currentSliceWidth;
                canvas.height = currentSliceHeight;
                
                // æ¸…ç©ºç”»å¸ƒ
                ctx.clearRect(0, 0, currentSliceWidth, currentSliceHeight);
                
                // ç»˜åˆ¶å›¾ç‰‡çš„å¯¹åº”éƒ¨åˆ†
                ctx.drawImage(
                  img,
                  x, y, currentSliceWidth, currentSliceHeight,
                  0, 0, currentSliceWidth, currentSliceHeight
                );
                
                // è½¬æ¢ä¸º Uint8Arrayï¼ˆä½¿ç”¨ç«‹å³æ‰§è¡Œå‡½æ•°ä¿æŒä½œç”¨åŸŸï¼‰
                ((currentRow, currentCol, sliceX, sliceY, width, height) => {
                  canvas.toBlob((blob) => {
                    if (!blob) {
                      completedSlices++;
                      console.warn(`åˆ‡ç‰‡ ${currentRow}_${currentCol} åˆ›å»ºå¤±è´¥`);
                      checkCompletion();
                      return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                      try {
                        const sliceData = new Uint8Array(e.target.result);
                        slices.push({
                          data: sliceData,
                          width: width,
                          height: height,
                          row: currentRow,
                          col: currentCol,
                          x: sliceX,
                          y: sliceY,
                          name: `slice_${currentRow}_${currentCol}.png`
                        });
                        
                        completedSlices++;
                        console.log(`åˆ‡ç‰‡è¿›åº¦: ${completedSlices}/${totalSlices}`);
                        checkCompletion();
                      } catch (sliceError) {
                        console.error(`åˆ‡ç‰‡ ${currentRow}_${currentCol} å¤„ç†å¤±è´¥:`, sliceError);
                        completedSlices++;
                        checkCompletion();
                      }
                    };
                    
                    reader.onerror = () => {
                      console.error(`åˆ‡ç‰‡ ${currentRow}_${currentCol} è¯»å–å¤±è´¥`);
                      completedSlices++;
                      checkCompletion();
                    };
                    
                    reader.readAsArrayBuffer(blob);
                  }, 'image/png', 0.9); // æ·»åŠ è´¨é‡å‚æ•°
                })(row, col, x, y, currentSliceWidth, currentSliceHeight);
              }
            }
            
          } catch (error) {
            clearTimeout(timeoutId);
            URL.revokeObjectURL(imgUrl);
            reject(error);
          }
        };
        
        img.onerror = (errorEvent) => {
          console.error('å›¾ç‰‡åŠ è½½å¤±è´¥äº‹ä»¶:', errorEvent);
          console.error('å›¾ç‰‡URL:', imgUrl);
          console.error('å›¾ç‰‡ç±»å‹:', imageData.type);
          console.error('Blobå¤§å°:', blob.size);
          clearTimeout(timeoutId);
          URL.revokeObjectURL(imgUrl);
          reject(new Error('å›¾ç‰‡åŠ è½½å¤±è´¥'));
        };
        
        img.src = imgUrl;
      });
    } catch (error) {
      console.error('å›¾ç‰‡åˆ‡ç‰‡å¤±è´¥:', error);
      throw error;
    }
  }

  // ğŸš¨ æ–°å¢ï¼šæ™ºèƒ½åˆ‡ç‰‡ç­–ç•¥è®¡ç®—æ–¹æ³•ï¼ˆä¸æ ¸å¿ƒåº“ä¿æŒä¸€è‡´ï¼‰
  calculateSliceStrategy(width, height, maxSize = 4096) {
    const strategy = {
      direction: 'none',
      sliceWidth: width,
      sliceHeight: height,
      slicesCount: 1,
      description: '',
      cols: 1,
      rows: 1,
      totalSlices: 1
    };

    const widthExceeds = width > maxSize;
    const heightExceeds = height > maxSize;

    if (!widthExceeds && !heightExceeds) {
      // ä¸éœ€è¦åˆ‡å‰²
      strategy.description = 'å›¾ç‰‡å°ºå¯¸æ­£å¸¸ï¼Œæ— éœ€åˆ‡å‰²';
      return strategy;
    }

    if (widthExceeds && !heightExceeds) {
      // åªæœ‰å®½åº¦è¶…é™ï¼šå‚ç›´åˆ‡å‰²ï¼ˆä¿æŒé«˜åº¦ï¼‰
      strategy.direction = 'vertical';
      strategy.sliceWidth = Math.floor(maxSize * 0.9); // ç•™10%å®‰å…¨è¾¹è·
      strategy.sliceHeight = height;
      strategy.cols = Math.ceil(width / strategy.sliceWidth);
      strategy.rows = 1;
      strategy.slicesCount = strategy.cols;
      strategy.totalSlices = strategy.cols;
      strategy.description = `å®½åº¦è¶…é™ï¼Œå‚ç›´åˆ‡å‰²ä¸º${strategy.slicesCount}ç‰‡ï¼Œæ¯ç‰‡${strategy.sliceWidth}Ã—${height}`;
    } else if (!widthExceeds && heightExceeds) {
      // åªæœ‰é«˜åº¦è¶…é™ï¼šæ°´å¹³åˆ‡å‰²ï¼ˆä¿æŒå®½åº¦ï¼‰
      strategy.direction = 'horizontal';
      strategy.sliceWidth = width;
      strategy.sliceHeight = Math.floor(maxSize * 0.9); // ç•™10%å®‰å…¨è¾¹è·
      strategy.cols = 1;
      strategy.rows = Math.ceil(height / strategy.sliceHeight);
      strategy.slicesCount = strategy.rows;
      strategy.totalSlices = strategy.rows;
      strategy.description = `é«˜åº¦è¶…é™ï¼Œæ°´å¹³åˆ‡å‰²ä¸º${strategy.slicesCount}ç‰‡ï¼Œæ¯ç‰‡${width}Ã—${strategy.sliceHeight}`;
    } else {
      // å®½åº¦å’Œé«˜åº¦éƒ½è¶…é™ï¼šç½‘æ ¼åˆ‡å‰²
      strategy.direction = 'both';
      strategy.sliceWidth = Math.floor(maxSize * 0.9);
      strategy.sliceHeight = Math.floor(maxSize * 0.9);
      strategy.cols = Math.ceil(width / strategy.sliceWidth);
      strategy.rows = Math.ceil(height / strategy.sliceHeight);
      strategy.slicesCount = strategy.cols * strategy.rows;
      strategy.totalSlices = strategy.cols * strategy.rows;
      strategy.description = `å®½é«˜éƒ½è¶…é™ï¼Œç½‘æ ¼åˆ‡å‰²ä¸º${strategy.cols}Ã—${strategy.rows}=${strategy.slicesCount}ç‰‡`;
    }

    return strategy;
  }
}

// åˆ›å»ºæ–‡ä»¶å¤„ç†å™¨å®ä¾‹å¹¶æŒ‚è½½åˆ°windowå¯¹è±¡
window.fileProcessor = new FileProcessor(); 

/* === data-collector.js === */
// ==================== æ•°æ®æ”¶é›†å™¨ ====================

class DataCollector {
  // æ”¶é›†è¡¨å•æ•°æ®
  collectFormData() {
    const config = {
      // é¡µé¢åŸºç¡€è®¾ç½®
      pageBgColor: document.getElementById('pageColor')?.value || '#FFFFFF',
      pageBgImage: window.imageManager.get('pageBackground'),
      headerImage: window.imageManager.get('headerImage'),
      titleUpload: window.imageManager.get('titleUpload'),
      gameIcon: window.imageManager.get('gameIcon'),
      
      // æ¸¸æˆä¿¡æ¯
      buttonVersion: document.getElementById('buttonVersionSelect')?.value || 'imageButton',
      
      // æ¸¸æˆä¿¡æ¯ - å¸¦iconç‰ˆ
      gameName: document.getElementById('gameNameInput')?.value || '',
      gameDesc: document.getElementById('gameCopyInput')?.value || '',
      gameTextColor: document.getElementById('gameCopyTextColor')?.value || '#FFFFFF',
      iconButtonText: document.getElementById('iconButtonText')?.value || 'ç«‹å³ä¸‹è½½',
      iconButtonTextColor: document.getElementById('iconButtonTextColor')?.value || '#FFFFFF',
      iconButtonBg: window.imageManager.get('iconButtonBg'),
      
      // æ¸¸æˆä¿¡æ¯ - å•æŒ‰é’®ç‰ˆ
      singleButtonText: document.getElementById('singleButtonText')?.value || 'ç«‹å³ä¸‹è½½',
      singleButtonTextColor: document.getElementById('singleButtonTextColor')?.value || '#FFFFFF',
      singleButtonBg: window.imageManager.get('singleButtonBg'),
      
      // æ¸¸æˆä¿¡æ¯ - åŒæŒ‰é’®ç‰ˆ
      leftButtonText: document.getElementById('leftButtonText')?.value || 'å·¦ä¾§æŒ‰é’®',
      leftButtonBg: window.imageManager.get('leftButtonBg'),
      leftButtonTextColor: document.getElementById('leftButtonTextColor')?.value || '#FFFFFF',
      rightButtonText: document.getElementById('rightButtonText')?.value || 'å³ä¾§æŒ‰é’®',
      rightButtonBg: window.imageManager.get('rightButtonBg'),
      rightButtonTextColor: document.getElementById('rightButtonTextColor')?.value || '#FFFFFF',
      btnSpacing: parseInt(document.getElementById('btnSpacing')?.value) || 10,
      
      // æ´»åŠ¨è§„åˆ™
      rulesTitle: document.getElementById('rulesTitle')?.value || '',
      rulesBgImage: window.imageManager.get('rulesBg'),
      rulesContent: document.getElementById('rulesContent')?.value || '',
      footerLogo: window.imageManager.get('footerLogo'),
      footerBg: window.imageManager.get('footerBg'),
      
      // æ¨¡å—æ•°æ®
      modules: this.collectModuleData()
    };
    
    console.log('æ”¶é›†åˆ°çš„è¡¨å•æ•°æ®:', config);
    return config;
  }
  
  // æ”¶é›†æ¨¡å—æ•°æ®
  collectModuleData() {
    const modules = document.querySelectorAll('#modulesContainer .module');
    const moduleData = [];
    
    modules.forEach(moduleEl => {
      const moduleType = moduleEl.dataset.moduleType;
      const moduleId = moduleEl.id;
      
      if (moduleType && moduleId) {
        const moduleContent = this.collectModuleContent(moduleEl, moduleType, moduleId);
        if (moduleContent) {
          // è·å–æ¨¡å—æ ‡é¢˜
          const moduleTitle = this.getModuleTitle(moduleType);
          
          moduleData.push({
            id: moduleId,
            type: moduleType,  // ä¿æŒå­—ç¬¦ä¸²æ ¼å¼ï¼Œåœ¨åç«¯å¤„ç†ç±»å‹è½¬æ¢
            title: moduleTitle, // æ·»åŠ æ ‡é¢˜å­—æ®µ
            content: moduleContent
          });
          
          console.log('ğŸ“Š [æ¨¡å—æ•°æ®æ”¶é›†]', {
            moduleId,
            moduleType,
            moduleTitle,
            æ”¶é›†å†…å®¹: moduleContent
          });
        }
      }
    });
    
    console.log('ğŸ¯ [æ‰€æœ‰æ¨¡å—æ•°æ®æ”¶é›†å®Œæˆ]', moduleData);
    return moduleData;
  }
  
  // è·å–æ¨¡å—æ ‡é¢˜
  getModuleTitle(moduleType) {
    const titleMap = {
      'nineGrid': 'ä¹å®«æ ¼æŠ½å¥–',
      'signIn': 'æ¯æ—¥ç­¾åˆ°',
      'collectCards': 'é›†å¡æ´»åŠ¨',
      'activityContent': 'æ´»åŠ¨è¯¦æƒ…',
      'carousel': 'å›¾ç‰‡è½®æ’­ï¼ˆæ¨ªç‰ˆï¼‰'
    };
    return titleMap[moduleType] || 'æœªçŸ¥æ¨¡å—';
  }
  
  // æ”¶é›†æ¨¡å—å†…å®¹
  collectModuleContent(container, moduleType, moduleId) {
    switch (moduleType) {
      case 'nineGrid':
        return this.collectLotteryData(container, moduleId);
      case 'lotteryModule':
        return this.collectLotteryData(container, moduleId);
      case 'signInModule':
        return this.collectSignInData(container, moduleId);
      case 'collectModule':
        return this.collectCardsData(container, moduleId);
      case 'activityContent':
        return this.collectActivityContentData(container, moduleId);
      case 'carousel':
        return this.collectCarouselData(container, moduleId);
      default:
        console.warn(`æœªçŸ¥çš„æ¨¡å—ç±»å‹: ${moduleType}`);
        return null;
    }
  }
  
  // æ”¶é›†ä¹å®«æ ¼æŠ½å¥–æ•°æ®
  collectLotteryData(container, moduleId) {
    const data = {
      mainTitle: container.querySelector('.big-title-input')?.value || "æŠ½å¥–æ´»åŠ¨",
      titleBgImage: window.imageManager.getModule(`${moduleId}-titlebg`),
      gridBgImage: window.imageManager.getModule(`${moduleId}-gridbg`),
      drawButtonImage: window.imageManager.getModule(`${moduleId}-drawbtn`),
      prizeBgImage: window.imageManager.getModule(`${moduleId}-prizebg`),
      prizes: this.collectNineGridPrizes(container, moduleId)
    };
    
    return data;
  }
  
  // æ”¶é›†ç­¾åˆ°æ•°æ®
  collectSignInData(container, moduleId) {
    const data = {
      titleImage: window.imageManager.getModule(`${moduleId}-title`),
      bgImage: window.imageManager.getModule(`${moduleId}-bg`),
      daysCount: parseInt(container.querySelector('.days-count')?.value) || 7,
      dayIcon: window.imageManager.getModule(`${moduleId}-dayicon`),
      signButton: window.imageManager.getModule(`${moduleId}-signbtn`)
    };
    
    return data;
  }
  
  // æ”¶é›†é›†å¡æ•°æ®
  collectCardsData(container, moduleId) {
    const data = {
      titleImage: window.imageManager.getModule(`${moduleId}-title`),
      bgImage: window.imageManager.getModule(`${moduleId}-bg`),
      cardsCount: parseInt(container.querySelector('.cards-count')?.value) || 5,
      cardStyle: container.querySelector('input[name="cardStyle"]:checked')?.value || 'style1',
      cardBg: window.imageManager.getModule(`${moduleId}-cardbg`),
      combineButton: window.imageManager.getModule(`${moduleId}-combinebtn`)
    };
    
    return data;
  }
  
  // æ”¶é›†æ´»åŠ¨å†…å®¹æ•°æ®
  collectActivityContentData(container, moduleId) {
    const data = {
      mainTitle: container.querySelector('.activity-content-main-title-input')?.value || '',
      mainTitleBg: window.imageManager.getModule(`${moduleId}-main-title-bg`),
      subTitle: container.querySelector('.activity-content-sub-title-input')?.value || '',
      subTitleBg: window.imageManager.getModule(`${moduleId}-sub-title-bg`),
      text: container.querySelector('.activity-content-text-input')?.value || '',
      image: window.imageManager.getModule(`${moduleId}-image`)
    };
    
    console.log('ğŸ” [æ´»åŠ¨å†…å®¹æ•°æ®æ”¶é›†]', {
      moduleId,
      data,
      ä¸»æ ‡é¢˜: data.mainTitle,
      å‰¯æ ‡é¢˜: data.subTitle,
      æ­£æ–‡: data.text,
      å›¾ç‰‡: !!data.image
    });
    
    return data;
  }
  
  // æ”¶é›†å›¾ç‰‡è½®æ’­æ•°æ®
  collectCarouselData(container, moduleId) {
    const data = {
      title: container.querySelector('.carousel-title-input')?.value || '',
      titleBgImage: window.imageManager.getModule(`${moduleId}-title-bg`),
      carouselImage: window.imageManager.getModule(`${moduleId}-image`),
      carouselBgImage: window.imageManager.getModule(`${moduleId}-image-bg`)
    };
    
    console.log('ğŸ” [å›¾ç‰‡è½®æ’­æ•°æ®æ”¶é›†]', {
      moduleId,
      data,
      æ ‡é¢˜: data.title,
      è½®æ’­å›¾ç‰‡: !!data.carouselImage,
      æ ‡é¢˜èƒŒæ™¯: !!data.titleBgImage,
      è½®æ’­èƒŒæ™¯: !!data.carouselBgImage
    });
    
    return data;
  }
  
  // è·å–å¥–å“ä½ç½®
  getPrizePosition(index) {
    // ä¹å®«æ ¼ä½ç½®æ˜ å°„ (3x3ç½‘æ ¼)
    const positions = [
      { row: 0, col: 0 }, // ä½ç½®0: å·¦ä¸Š
      { row: 0, col: 1 }, // ä½ç½®1: ä¸Šä¸­
      { row: 0, col: 2 }, // ä½ç½®2: å³ä¸Š
      { row: 1, col: 2 }, // ä½ç½®3: å³ä¸­
      { row: 2, col: 2 }, // ä½ç½®4: å³ä¸‹
      { row: 2, col: 1 }, // ä½ç½®5: ä¸‹ä¸­
      { row: 2, col: 0 }, // ä½ç½®6: å·¦ä¸‹
      { row: 1, col: 0 }, // ä½ç½®7: å·¦ä¸­
      { row: 1, col: 1 }  // ä½ç½®8: ä¸­å¿ƒ(æŠ½å¥–æŒ‰é’®ä½ç½®)
    ];
    
    return positions[index] || { row: 0, col: 0 };
  }
  
  // æ”¶é›†ä¹å®«æ ¼å¥–å“æ•°æ®ï¼ˆä¸“é—¨å¤„ç†3-2-3å¸ƒå±€ï¼‰
  collectNineGridPrizes(container, moduleId) {
    const prizes = [];
    const prizeElements = container.querySelectorAll('.prize-grid-custom .grid-item, .prize-upload');
    
    prizeElements.forEach((prizeEl, index) => {
      const prizeLabel = prizeEl.querySelector('.prize-label')?.textContent || `å¥–å“${String(index + 1).padStart(2, '0')}`;
      prizes.push({
        image: window.imageManager.getModule(`${moduleId}-prize-${index}`),
        name: prizeLabel,
        position: this.getNineGridPosition(index) // æ·»åŠ ä½ç½®ä¿¡æ¯
      });
    });
    
    return prizes;
  }

  // è·å–ä¹å®«æ ¼ä½ç½®ï¼ˆ3-2-3å¸ƒå±€è½¬æ¢ä¸ºæ ‡å‡†3x3ä½ç½®ï¼‰
  getNineGridPosition(index) {
    // 3-2-3å¸ƒå±€å¯¹åº”çš„ä¹å®«æ ¼ä½ç½®æ˜ å°„
    const positionMap = {
      0: 0, // ç¬¬ä¸€è¡Œç¬¬ä¸€ä¸ª -> ä½ç½®0
      1: 1, // ç¬¬ä¸€è¡Œç¬¬äºŒä¸ª -> ä½ç½®1  
      2: 2, // ç¬¬ä¸€è¡Œç¬¬ä¸‰ä¸ª -> ä½ç½®2
      3: 3, // ç¬¬äºŒè¡Œç¬¬ä¸€ä¸ª -> ä½ç½®3
      4: 5, // ç¬¬äºŒè¡Œç¬¬äºŒä¸ª -> ä½ç½®5ï¼ˆè·³è¿‡ä¸­é—´çš„æŠ½å¥–æŒ‰é’®ä½ç½®4ï¼‰
      5: 6, // ç¬¬ä¸‰è¡Œç¬¬ä¸€ä¸ª -> ä½ç½®6
      6: 7, // ç¬¬ä¸‰è¡Œç¬¬äºŒä¸ª -> ä½ç½®7
      7: 8  // ç¬¬ä¸‰è¡Œç¬¬ä¸‰ä¸ª -> ä½ç½®8
    };
    
    return positionMap[index] || index;
  }
  
  // æ”¶é›†å¥–å“æ•°æ®ï¼ˆå¤‡ç”¨æ–¹æ³•ï¼‰
  collectPrizeData(container, moduleId) {
    const prizes = [];
    const prizeElements = container.querySelectorAll('.grid-item');
    
    prizeElements.forEach((prizeEl, index) => {
      const prize = {
        position: this.getPrizePosition(index),
        image: window.imageManager.getModule(`${moduleId}-prize-${index}`),
      };
      prizes.push(prize);
    });
    
    return prizes;
  }
  
  // éªŒè¯æ”¶é›†çš„æ•°æ®
  validateData(config) {
    const errors = [];
    
    // åŸºç¡€éªŒè¯
    if (!config.pageBgColor) {
      errors.push('é¡µé¢é¢œè‰²ä¸èƒ½ä¸ºç©º');
    }
    
    // æŒ‰é’®ç‰ˆæœ¬éªŒè¯
    if (!config.buttonVersion) {
      errors.push('å¿…é¡»é€‰æ‹©æŒ‰é’®ç‰ˆæœ¬');
    }
    
    return errors;
  }
}

// åˆ›å»ºå…¨å±€æ•°æ®æ”¶é›†å™¨å®ä¾‹å¹¶æŒ‚è½½åˆ°windowå¯¹è±¡
window.dataCollector = new DataCollector(); 

/* === data-manager.js === */
// ==================== æ ¸å¿ƒæ•°æ®ç®¡ç† ====================

// å›¾ç‰‡æ•°æ®å­˜å‚¨ç®¡ç†
class ImageDataManager {
    constructor() {
      this.data = {
        pageBackground: null,
        headerImage: null,
        titleUpload: null,
        gameIcon: null,
        btnImage: null,
        footerLogo: null,
        footerBg: null,
        rulesBg: null
      };
      this.moduleData = {};
    }
    
    set(key, value) {
      this.data[key] = value;
    }
    
    get(key) {
      return this.data[key];
    }
    
    setModule(key, value) {
      this.moduleData[key] = value;
    }
    
    getModule(key) {
      return this.moduleData[key];
    }
    
    clear() {
      // é‡ç½®ä¸ºåˆå§‹çŠ¶æ€ï¼Œä¿æŒæ•°æ®ç»“æ„
      this.data = {
        pageBackground: null,
        headerImage: null,
        titleUpload: null,
        gameIcon: null,
        btnImage: null,
        footerLogo: null,
        footerBg: null,
        rulesBg: null
      };
      this.moduleData = {};
      console.log('å›¾ç‰‡ç®¡ç†å™¨å·²æ¸…ç†');
    }
  }
  
  // æ³¨æ„ï¼šå®ä¾‹åˆ›å»ºç°åœ¨åœ¨global-init.jsä¸­ç»Ÿä¸€ç®¡ç† 

/* === channel-manager.js === */
// ==================== æ¸ é“ç®¡ç†å™¨æ¨¡å— ====================

// ä½¿ç”¨å…¨å±€å­˜å‚¨é€‚é…å™¨ï¼ˆå·²åœ¨utility-functions.jsä¸­å£°æ˜ï¼‰
// æ³¨æ„ï¼šä¸è¦é‡å¤å£°æ˜storageAdapterï¼Œé¿å…Figmaæ²™ç›’ç¯å¢ƒä¸­çš„é‡å¤å£°æ˜é”™è¯¯

class ChannelManager {
  constructor() {
    this.channelImages = {};
  }

  // æ¸ é“é¢„è§ˆåŠŸèƒ½
  previewChannel(channel) {
    const previewArea = document.getElementById(`${channel}-preview`);
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    previewArea.innerHTML = `
      <div class="preview-placeholder">
        <span>æ­£åœ¨ç”Ÿæˆé¢„è§ˆ...</span>
      </div>
    `;

    // æ¨¡æ‹Ÿé¢„è§ˆç”Ÿæˆè¿‡ç¨‹ï¼ˆåç»­å®Œå–„ï¼‰
    setTimeout(() => {
      previewArea.innerHTML = `
        <div class="preview-placeholder">
          <span>${channel.toUpperCase()} ç‰ˆæœ¬é¢„è§ˆ</span>
          <div style="margin-top: 8px; font-size: 12px; color: #666;">
            é¢„è§ˆåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­
          </div>
        </div>
      `;
    }, 1000);
  }

  // æ¸ é“ç”ŸæˆåŠŸèƒ½
  generateChannel(channel) {
    try {
      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      window.notificationSystem.showLoading();
      
      // å‘é€æ¶ˆæ¯åˆ°æ’ä»¶ä¸»çº¿ç¨‹
      parent.postMessage({
        pluginMessage: {
          type: 'channel-generate',
          channel: channel
        }
      }, '*');
      
    } catch (error) {
      console.error('ç”Ÿæˆæ¸ é“ç‰ˆæœ¬å¤±è´¥:', error);
              window.notificationSystem.hideLoading();
        window.notificationSystem.show(`ç”Ÿæˆ ${channel.toUpperCase()} ç‰ˆæœ¬å¤±è´¥`, 'error');
    }
  }

  // æ¸ é“è®¾ç½®åŠŸèƒ½
  showChannelSettings(channel) {
    try {
      console.log(`æ‰“å¼€ ${channel.toUpperCase()} æ¸ é“è®¾ç½®`);
      
      // éšè—ä¸»è§†å›¾ï¼Œæ˜¾ç¤ºè®¾ç½®è§†å›¾
      const mainView = document.getElementById('channelsMainView');
      const settingsView = document.getElementById('channelSettingsView');
      
      if (mainView) {
        mainView.style.display = 'none';
      }
      
      if (settingsView) {
        // ğŸ”§ å…³é”®ä¿®å¤ï¼šç§»é™¤hiddenç±»å¹¶ç¡®ä¿æ˜¾ç¤º
        settingsView.classList.remove('hidden');
        settingsView.style.display = 'block';
        settingsView.style.visibility = 'visible';
        console.log('ğŸ”§ è®¾ç½®è§†å›¾æ˜¾ç¤ºçŠ¶æ€å·²æ›´æ–°');
      } else {
        console.error('âŒ æ‰¾ä¸åˆ°channelSettingsViewå…ƒç´ ');
        return;
      }
      
      // æ›´æ–°è®¾ç½®æ ‡é¢˜
      const settingsTitle = document.getElementById('settingsTitle');
      if (settingsTitle) {
        settingsTitle.textContent = `${this.getChannelDisplayName(channel)} è®¾ç½®`;
      }
      
      // ç”Ÿæˆè®¾ç½®å†…å®¹
      this.generateChannelSettingsContent(channel);
      
      // æ»šåŠ¨åˆ°é¡µé¢é¡¶éƒ¨ - é’ˆå¯¹Figmaæ’ä»¶ç¯å¢ƒ
      requestAnimationFrame(() => {
        try {
          // æŸ¥æ‰¾å¹¶æ»šåŠ¨æ‰€æœ‰å¯èƒ½çš„æ»šåŠ¨å®¹å™¨
          const scrollableContainers = [
            document.documentElement,
            document.body,
            document.querySelector('.container'),
            document.querySelector('.main-content'),
            document.querySelector('#app'),
            document.getElementById('channelSettingsView')
          ].filter(Boolean);
          
          scrollableContainers.forEach(container => {
            if (container) {
              container.scrollTop = 0;
              // ä¹Ÿå°è¯•scrollLeftä»¥é˜²ä¸‡ä¸€
              if (container.scrollLeft !== undefined) {
                container.scrollLeft = 0;
              }
            }
          });
          
          // å°è¯•å°†è®¾ç½®æ ‡é¢˜æ»šåŠ¨åˆ°è§†å›¾ä¸­
          const settingsTitle = document.getElementById('settingsTitle');
          if (settingsTitle) {
            settingsTitle.scrollIntoView({
              behavior: 'auto',
              block: 'start'
            });
          }
          
          console.log('å·²å°è¯•æ»šåŠ¨åˆ°é¡¶éƒ¨');
        } catch (scrollError) {
          console.warn('æ»šåŠ¨æ“ä½œå¤±è´¥:', scrollError);
        }
      });
      
      // æ˜¾ç¤ºæˆåŠŸæç¤º
      if (window.notificationSystem) {
        window.notificationSystem.show(`å·²è¿›å…¥ ${this.getChannelDisplayName(channel)} è®¾ç½®é¡µé¢`, 'info');
      }
      
    } catch (error) {
      console.error('æ‰“å¼€æ¸ é“è®¾ç½®å¤±è´¥:', error);
      if (window.notificationSystem) {
        window.notificationSystem.show(`æ‰“å¼€ ${this.getChannelDisplayName(channel)} è®¾ç½®å¤±è´¥`, 'error');
      }
    }
  }

  // è¿”å›æ¸ é“åˆ—è¡¨
  backToChannelsList() {
    const mainView = document.getElementById('channelsMainView');
    const settingsView = document.getElementById('channelSettingsView');
    
    if (settingsView) {
      settingsView.style.display = 'none';
      settingsView.classList.add('hidden');
    }
    
    if (mainView) {
      mainView.style.display = 'block';
    }
  }

  // è·å–æ¸ é“æ˜¾ç¤ºåç§°
  getChannelDisplayName(channel) {
    const channelNames = {
      'oppo': 'OPPO',
      'vivo': 'VIVO', 
      'huawei': 'åä¸º',
      'xiaomi': 'å°ç±³'
    };
    return channelNames[channel] || channel.toUpperCase();
  }

  // ç”Ÿæˆæ¸ é“è®¾ç½®å†…å®¹
  generateChannelSettingsContent(channel) {
    console.log(`ğŸ” å¼€å§‹ç”Ÿæˆ ${channel} æ¸ é“è®¾ç½®å†…å®¹`);
    
    const settingsContainer = document.getElementById('settingsContent');
    console.log('ğŸ” settingsContainer å…ƒç´ :', settingsContainer);
    
    if (!settingsContainer) {
      console.error('âŒ æ‰¾ä¸åˆ°settingsContentå…ƒç´ ');
      return;
    }
    
    const config = this.getChannelSettingsConfig(channel);
    console.log(`ğŸ” ${channel} æ¸ é“é…ç½®:`, config);
    
    let html = '';
    config.forEach((item, index) => {
      const itemHTML = this.generateSettingItemHTML(item, channel);
      console.log(`ğŸ” ç”Ÿæˆç¬¬${index + 1}ä¸ªè®¾ç½®é¡¹:`, item, 'HTML:', itemHTML);
      html += itemHTML;
    });
    
    console.log(`ğŸ” æœ€ç»ˆç”Ÿæˆçš„HTMLé•¿åº¦: ${html.length}å­—ç¬¦`);
    console.log('ğŸ” æœ€ç»ˆç”Ÿæˆçš„HTML:', html);
    
    settingsContainer.innerHTML = html;
    console.log('âœ… HTMLå·²è®¾ç½®åˆ°settingsContainer');
    
    // éªŒè¯HTMLæ˜¯å¦æ­£ç¡®è®¾ç½®
    console.log('ğŸ” è®¾ç½®åçš„settingsContainerå†…å®¹:', settingsContainer.innerHTML);
    console.log('ğŸ” è®¾ç½®åçš„settingsContainerå­å…ƒç´ æ•°é‡:', settingsContainer.children.length);
    
    // ğŸ”§ æ–°å¢ï¼šCSSæ ·å¼è°ƒè¯•
    const settingsView = document.getElementById('channelSettingsView');
    const settingsContent = document.getElementById('settingsContent');
    
    console.log('ğŸ¨ CSSè°ƒè¯•ä¿¡æ¯:');
    console.log('- è®¾ç½®è§†å›¾æ˜¾ç¤º:', settingsView ? window.getComputedStyle(settingsView).display : 'å…ƒç´ ä¸å­˜åœ¨');
    console.log('- è®¾ç½®è§†å›¾å¯è§:', settingsView ? window.getComputedStyle(settingsView).visibility : 'å…ƒç´ ä¸å­˜åœ¨');
    console.log('- è®¾ç½®å†…å®¹æ˜¾ç¤º:', settingsContent ? window.getComputedStyle(settingsContent).display : 'å…ƒç´ ä¸å­˜åœ¨');
    console.log('- è®¾ç½®å†…å®¹é«˜åº¦:', settingsContent ? window.getComputedStyle(settingsContent).height : 'å…ƒç´ ä¸å­˜åœ¨');
    
    // æ£€æŸ¥ç¬¬ä¸€ä¸ªè®¾ç½®é¡¹
    const firstItem = settingsContainer.querySelector('.setting-item');
    if (firstItem) {
      console.log('- ç¬¬ä¸€ä¸ªè®¾ç½®é¡¹æ˜¾ç¤º:', window.getComputedStyle(firstItem).display);
      console.log('- ç¬¬ä¸€ä¸ªè®¾ç½®é¡¹é«˜åº¦:', window.getComputedStyle(firstItem).height);
      console.log('- ç¬¬ä¸€ä¸ªè®¾ç½®é¡¹è¾¹è·:', window.getComputedStyle(firstItem).marginBottom);
    } else {
      console.log('- âŒ æ‰¾ä¸åˆ°ç¬¬ä¸€ä¸ªè®¾ç½®é¡¹');
    }
    
    // ç»‘å®šäº‹ä»¶
    this.bindSettingsEvents(channel);
    
    // åŠ è½½å·²ä¿å­˜çš„å›¾ç‰‡
    this.loadSavedChannelImages(channel);
    
    console.log('âœ… æ¸ é“è®¾ç½®å†…å®¹ç”Ÿæˆå®Œæˆ');
  }

  // è·å–æ¸ é“è®¾ç½®é…ç½®
  getChannelSettingsConfig(channel) {
    const configs = {
      'oppo': [
        { type: 'image', key: 'eggBreaking', label: 'ç ¸è›‹æ ·å¼', description: 'æ¨èå°ºå¯¸ï¼š864x512px' },
        { type: 'image', key: 'footerStyle', label: 'å°¾ç‰ˆæ ·å¼', description: 'æ¨èå°ºå¯¸ï¼š1080x289px' }
      ],
      'vivo': [
        { type: 'image', key: 'eggBreaking', label: 'ç ¸è›‹æ ·å¼', description: 'æ¨èå°ºå¯¸ï¼š864x512px' },
        { type: 'image', key: 'footerStyle', label: 'å°¾ç‰ˆæ ·å¼', description: 'æ¨èå°ºå¯¸ï¼š1080x289px' }
      ],
      'huawei': [
        { type: 'image', key: 'eggBreaking', label: 'ç ¸è›‹æ ·å¼', description: 'æ¨èå°ºå¯¸ï¼š864x512px' },
        { type: 'image', key: 'footerStyle', label: 'å°¾ç‰ˆæ ·å¼', description: 'æ¨èå°ºå¯¸ï¼š1080x289px' }
      ],
      'xiaomi': [
        { type: 'image', key: 'eggBreaking', label: 'ç ¸è›‹æ ·å¼', description: 'æ¨èå°ºå¯¸ï¼š864x512px' },
        { type: 'image', key: 'footerStyle', label: 'å°¾ç‰ˆæ ·å¼', description: 'æ¨èå°ºå¯¸ï¼š1080x289px' }
      ]
    };
    
    return configs[channel] || [];
  }

  // ç”Ÿæˆè®¾ç½®é¡¹HTML
  generateSettingItemHTML(item, channel) {
    const { type, key, label, placeholder, description } = item;
    
    let inputHTML = '';
    
    if (type === 'text') {
      inputHTML = `<input type="text" class="setting-input" id="${channel}-${key}" placeholder="${placeholder || ''}" data-key="${key}">`;
    } else if (type === 'textarea') {
      inputHTML = `<textarea class="setting-input setting-textarea" id="${channel}-${key}" placeholder="${placeholder || ''}" data-key="${key}"></textarea>`;
    } else if (type === 'image') {
      inputHTML = `
        <div class="setting-upload-group">
          <input type="file" accept="image/*" style="display:none" id="${channel}-${key}-input" data-key="${key}">
          <button type="button" class="setting-upload-btn" onclick="document.getElementById('${channel}-${key}-input').click()">é€‰æ‹©å›¾ç‰‡</button>
          <div class="setting-preview" id="${channel}-${key}-preview">
            <div class="setting-preview-placeholder">é¢„è§ˆ</div>
          </div>
        </div>
      `;
    }
    
    return `
      <div class="setting-item">
        <label class="setting-label">${label}</label>
        ${inputHTML}
        ${description ? `<div class="setting-description">${description}</div>` : ''}
      </div>
    `;
  }

  // ç»‘å®šè®¾ç½®äº‹ä»¶
  bindSettingsEvents(channel) {
    // ç»‘å®šæ–‡æœ¬è¾“å…¥äº‹ä»¶
    const textInputs = document.querySelectorAll(`#settingsContent input[type="text"], #settingsContent textarea`);
    textInputs.forEach(input => {
      input.addEventListener('change', (e) => {
        const key = e.target.dataset.key;
        const value = e.target.value;
        this.saveChannelSetting(channel, key, value);
      });
    });

    // ç»‘å®šå›¾ç‰‡ä¸Šä¼ äº‹ä»¶
    const imageInputs = document.querySelectorAll(`#settingsContent input[type="file"]`);
    imageInputs.forEach(input => {
      input.addEventListener('change', async (e) => {
        const key = e.target.dataset.key;
        const file = e.target.files[0];
        if (file) {
          try {
            // å¤„ç†å›¾ç‰‡æ–‡ä»¶å¹¶ä¿å­˜åˆ°å›¾ç‰‡ç®¡ç†å™¨
            const storageKey = `${channel}-${key}`;
            const imageData = await window.fileProcessor.processImageFile(file, storageKey, true);
            
            // æ›´æ–°é¢„è§ˆ
            this.updateImagePreview(channel, key, file);
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            this.saveChannelImageToLocal(channel, key, imageData);
            
            // é€šçŸ¥ä¸»ç¨‹åºå›¾ç‰‡å·²ä¸Šä¼ 
            window.pluginComm.postMessage('channel-image-uploaded', {
              channel: channel,
              imageType: key,
              imageData: {
                data: Array.from(imageData.data), // è½¬æ¢ä¸ºæ•°ç»„ä»¥ä¾¿ä¼ è¾“
                width: imageData.width,
                height: imageData.height,
                name: imageData.name,
                type: imageData.type
              }
            });
            
            window.notificationSystem.show(`${key === 'eggBreaking' ? 'ç ¸è›‹æ ·å¼' : 'å°¾ç‰ˆæ ·å¼'}ä¸Šä¼ æˆåŠŸ`, 'success');
          } catch (error) {
            console.error(`${channel}-${key} å›¾ç‰‡ä¸Šä¼ å¤±è´¥:`, error);
            window.notificationSystem.show(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
          }
        }
      });
    });
    
    // åŠ è½½å·²ä¿å­˜çš„å›¾ç‰‡
    this.loadSavedChannelImages(channel);
  }

  // æ›´æ–°å›¾ç‰‡é¢„è§ˆ
  updateImagePreview(channel, key, file) {
    const previewElement = document.getElementById(`${channel}-${key}-preview`);
    if (previewElement && file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        previewElement.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: contain;">`;
      };
      reader.readAsDataURL(file);
    }
  }

  // ä¿å­˜æ¸ é“è®¾ç½®
  async saveChannelSetting(channel, key, value) {
    try {
      const storageKey = `channel-settings-${channel}`;
      let settings = {};
      
      try {
        const stored = await window.storageAdapter.getItem(storageKey);
        if (stored) {
          settings = JSON.parse(stored);
        }
      } catch (e) {
        console.warn('è¯»å–æ¸ é“è®¾ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤è®¾ç½®');
      }
      
      settings[key] = value;
      await window.storageAdapter.setItem(storageKey, JSON.stringify(settings));
      
      console.log(`${channel} æ¸ é“è®¾ç½®å·²ä¿å­˜:`, { [key]: value });
      
    } catch (error) {
      console.error('ä¿å­˜æ¸ é“è®¾ç½®å¤±è´¥:', error);
      if (window.notificationSystem) {
        window.notificationSystem.show('è®¾ç½®ä¿å­˜å¤±è´¥', 'error');
      }
    }
  }

  // ä¿å­˜æ¸ é“å›¾ç‰‡åˆ°æœ¬åœ°å­˜å‚¨
  async saveChannelImageToLocal(channel, imageType, imageData) {
    const storageKey = `channel-image-${channel}-${imageType}`;
    const imageInfo = {
      data: Array.from(imageData.data),
      width: imageData.width,
      height: imageData.height,
      name: imageData.name,
      type: imageData.type,
      timestamp: Date.now()
    };
    
    try {
      await window.storageAdapter.setItem(storageKey, JSON.stringify(imageInfo));
      console.log(`${channel} ${imageType} å›¾ç‰‡å·²ä¿å­˜åˆ°æœ¬åœ°`);
      
      // æ›´æ–°å†…å­˜ä¸­çš„å›¾ç‰‡æ•°æ®
      if (!this.channelImages[channel]) {
        this.channelImages[channel] = {};
      }
      this.channelImages[channel][imageType] = imageData;
      
      // æ¸…ç†æ—§çš„å›¾ç‰‡æ•°æ®ï¼ˆé¿å…å­˜å‚¨ç©ºé—´è¿‡æ»¡ï¼‰
      this.clearOldChannelImages();
      
    } catch (error) {
      console.error('ä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°å¤±è´¥:', error);
      // å¦‚æœå­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œå°è¯•æ¸…ç†æ—§æ•°æ®
      if (error.name === 'QuotaExceededError') {
        try {
          await this.clearOldChannelImages();
          await window.storageAdapter.setItem(storageKey, JSON.stringify(imageInfo));
          console.log('æ¸…ç†åé‡æ–°ä¿å­˜å›¾ç‰‡æˆåŠŸ');
        } catch (retryError) {
          console.error('æ¸…ç†åä»ç„¶ä¿å­˜å¤±è´¥:', retryError);
          if (window.notificationSystem) {
            window.notificationSystem.show('å­˜å‚¨ç©ºé—´ä¸è¶³ï¼Œè¯·æ¸…ç†æµè§ˆå™¨ç¼“å­˜', 'error');
          }
        }
      } else {
        if (window.notificationSystem) {
          window.notificationSystem.show('å›¾ç‰‡ä¿å­˜å¤±è´¥', 'error');
        }
      }
    }
  }

  // åŠ è½½å·²ä¿å­˜çš„æ¸ é“å›¾ç‰‡
  async loadSavedChannelImages(channel) {
    const imageTypes = ['eggBreaking', 'footerStyle'];
    
    for (const imageType of imageTypes) {
      try {
        const storageKey = `channel-image-${channel}-${imageType}`;
        const saved = await window.storageAdapter.getItem(storageKey);
        
        if (saved) {
          const imageInfo = JSON.parse(saved);
          const imageData = {
            data: new Uint8Array(imageInfo.data),
            width: imageInfo.width,
            height: imageInfo.height,
            name: imageInfo.name,
            type: imageInfo.type
          };
          
          // ä¿å­˜åˆ°å›¾ç‰‡ç®¡ç†å™¨
          const managerKey = `${channel}-${imageType}`;
          if (window.imageManager) {
            window.imageManager.setModule(managerKey, imageData);
          }
          
          // æ›´æ–°é¢„è§ˆ
          this.updateImagePreviewFromData(channel, imageType, imageData);
          
          // æ›´æ–°å†…å­˜ä¸­çš„å›¾ç‰‡æ•°æ®
          if (!this.channelImages[channel]) {
            this.channelImages[channel] = {};
          }
          this.channelImages[channel][imageType] = imageData;
          
          console.log(`å·²åŠ è½½ ${channel} ${imageType} å›¾ç‰‡`);
        }
      } catch (error) {
        console.error(`åŠ è½½ ${channel} ${imageType} å›¾ç‰‡å¤±è´¥:`, error);
      }
    }
  }

  // æ¸…ç†æ—§çš„æ¸ é“å›¾ç‰‡æ•°æ®
  async clearOldChannelImages() {
    try {
      const MAX_STORAGE_SIZE = 50 * 1024 * 1024; // 50MBå­˜å‚¨é™åˆ¶
      const MAX_IMAGES_PER_CHANNEL_TYPE = 1; // æ¯ä¸ªæ¸ é“æ¯ç§ç±»å‹æœ€å¤šä¿ç•™1å¼ å›¾ç‰‡
      
      const keys = await window.storageAdapter.getAllKeys();
      const channelImageKeys = keys.filter(key => key.startsWith('channel-image-'));
      
      // è®¡ç®—å½“å‰å­˜å‚¨ä½¿ç”¨é‡
      let totalSize = 0;
      const allImageData = [];
      
      for (const key of channelImageKeys) {
        try {
          const data = await window.storageAdapter.getItem(key);
          if (data) {
            const parsed = JSON.parse(data);
            const size = JSON.stringify(parsed).length * 2; // ä¼°ç®—å­—èŠ‚å¤§å°
            totalSize += size;
            
            allImageData.push({
              key,
              timestamp: parsed.timestamp || 0,
              size,
              channel: parsed.channel || 'unknown',
              imageType: parsed.imageType || 'unknown'
            });
          }
        } catch (error) {
          console.warn(`è§£æå›¾ç‰‡æ•°æ®å¤±è´¥: ${key}`, error);
          // åˆ é™¤æŸåçš„æ•°æ®
          await window.storageAdapter.removeItem(key);
        }
      }
      
      console.log(`å½“å‰æ¸ é“å›¾ç‰‡å­˜å‚¨ä½¿ç”¨é‡: ${(totalSize / 1024 / 1024).toFixed(2)}MB`);
      
      let imagesToDelete = [];
      
      // 1. åŸºäºæ¸ é“ç±»å‹æ•°é‡çš„æ¸…ç†ï¼šæ¯ä¸ªæ¸ é“æ¯ç§ç±»å‹åªä¿ç•™1å¼ æœ€æ–°çš„
      const channelTypeGroups = {};
      
      for (const imageData of allImageData) {
        const groupKey = `${imageData.channel}-${imageData.imageType}`;
        if (!channelTypeGroups[groupKey]) {
          channelTypeGroups[groupKey] = [];
        }
        channelTypeGroups[groupKey].push(imageData);
      }
      
      // å¯¹æ¯ä¸ªç»„æŒ‰æ—¶é—´æˆ³æ’åºï¼Œä¿ç•™æœ€æ–°çš„1å¼ ï¼Œå…¶ä½™æ ‡è®°åˆ é™¤
      for (const [groupKey, images] of Object.entries(channelTypeGroups)) {
        if (images.length > MAX_IMAGES_PER_CHANNEL_TYPE) {
          // æŒ‰æ—¶é—´æˆ³é™åºæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
          images.sort((a, b) => b.timestamp - a.timestamp);
          
          // ä¿ç•™æœ€æ–°çš„1å¼ ï¼Œå…¶ä½™åˆ é™¤
          const toDelete = images.slice(MAX_IMAGES_PER_CHANNEL_TYPE);
          imagesToDelete.push(...toDelete);
          
          console.log(`æ¸ é“ç±»å‹ ${groupKey}: ä¿ç•™1å¼ æœ€æ–°å›¾ç‰‡ï¼Œåˆ é™¤${toDelete.length}å¼ æ—§å›¾ç‰‡`);
        }
      }
      
      // 2. åŸºäºå­˜å‚¨å®¹é‡çš„æ¸…ç†ï¼šå¦‚æœæ€»å®¹é‡è¶…è¿‡é™åˆ¶ï¼Œç»§ç»­åˆ é™¤æœ€æ—§çš„å›¾ç‰‡
      if (totalSize > MAX_STORAGE_SIZE) {
        const remainingImages = allImageData.filter(img => 
          !imagesToDelete.some(delImg => delImg.key === img.key)
        );
        
        // æŒ‰æ—¶é—´æˆ³å‡åºæ’åºï¼ˆæœ€æ—§çš„åœ¨å‰ï¼‰
        remainingImages.sort((a, b) => a.timestamp - b.timestamp);
        
        let currentSize = totalSize - imagesToDelete.reduce((sum, img) => sum + img.size, 0);
        
        for (const imageData of remainingImages) {
          if (currentSize <= MAX_STORAGE_SIZE) break;
          
          imagesToDelete.push(imageData);
          currentSize -= imageData.size;
          console.log(`å®¹é‡æ¸…ç†: åˆ é™¤å›¾ç‰‡ ${imageData.key} (${(imageData.size / 1024).toFixed(1)}KB)`);
        }
      }
      
      // æ‰§è¡Œåˆ é™¤æ“ä½œ
      let deletedCount = 0;
      let deletedSize = 0;
      
      for (const imageData of imagesToDelete) {
        try {
          await window.storageAdapter.removeItem(imageData.key);
          deletedCount++;
          deletedSize += imageData.size;
          console.log(`å·²åˆ é™¤æ—§å›¾ç‰‡: ${imageData.key}`);
        } catch (error) {
          console.error(`åˆ é™¤å›¾ç‰‡å¤±è´¥: ${imageData.key}`, error);
        }
      }
      
      const finalSize = totalSize - deletedSize;
      console.log(`æ¸…ç†å®Œæˆ: åˆ é™¤${deletedCount}å¼ å›¾ç‰‡ï¼Œé‡Šæ”¾${(deletedSize / 1024 / 1024).toFixed(2)}MBç©ºé—´`);
      console.log(`å½“å‰å­˜å‚¨ä½¿ç”¨é‡: ${(finalSize / 1024 / 1024).toFixed(2)}MB`);
      
      return {
        deletedCount,
        deletedSize,
        finalSize,
        success: true
      };
      
    } catch (error) {
      console.error('æ¸…ç†æ—§å›¾ç‰‡å¤±è´¥:', error);
      return {
        deletedCount: 0,
        deletedSize: 0,
        finalSize: 0,
        success: false,
        error: error.message
      };
    }
  }

  // ä»å›¾ç‰‡æ•°æ®æ›´æ–°é¢„è§ˆ
  updateImagePreviewFromData(channel, imageType, imageData) {
    try {
      const preview = document.getElementById(`${channel}-${imageType}-preview`);
      if (preview && imageData) {
        const blob = new Blob([imageData.data], { type: imageData.type });
        const url = URL.createObjectURL(blob);
        
        preview.innerHTML = `<img src="${url}" alt="é¢„è§ˆ" onload="URL.revokeObjectURL(this.src)">`;
      }
    } catch (error) {
      console.error('æ›´æ–°å›¾ç‰‡é¢„è§ˆå¤±è´¥:', error);
    }
  }
}

// åˆ›å»ºå…¨å±€æ¸ é“ç®¡ç†å™¨å®ä¾‹
const channelManager = new ChannelManager();

// å¯¼å‡ºä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
window.channelManager = channelManager;

// å…¼å®¹æ€§å‡½æ•° - ä¾›HTML onclickäº‹ä»¶ä½¿ç”¨
window.previewChannel = function(channel) {
  channelManager.previewChannel(channel);
};

window.generateChannel = function(channel) {
  channelManager.generateChannel(channel);
};

window.showChannelSettings = function(channel) {
  channelManager.showChannelSettings(channel);
};

window.backToChannelsList = function() {
  channelManager.backToChannelsList();
}; 

/* === image-uploader.js === */
// ==================== å›¾ç‰‡ä¸Šä¼ ç®¡ç†å™¨æ¨¡å— ====================

// å›¾ç‰‡ä¸Šä¼ å¤„ç†ç±»
class ImageUploader {
  init() {
    this.bindImageUploaders();
    this.bindModuleImageUploaders();
  }
  
  bindImageUploaders() {
    // ç»‘å®šåŸºç¡€å›¾ç‰‡ä¸Šä¼ 
    const uploaders = [
      { id: 'pageBackground', key: 'pageBackground' },
      { id: 'headerImage', key: 'headerImage' },
      { id: 'titleUpload', key: 'titleUpload' },
      { id: 'gameIconUpload', key: 'gameIcon' },
      { id: 'iconButtonBgUpload', key: 'iconButtonBg' },
      { id: 'singleButtonBgUpload', key: 'singleButtonBg' },
      { id: 'leftButtonBgUpload', key: 'leftButtonBg' },
      { id: 'rightButtonBgUpload', key: 'rightButtonBg' },
      { id: 'footerLogoUpload', key: 'footerLogo' },
      { id: 'footerBgUpload', key: 'footerBg' },
      { id: 'rulesBgUpload', key: 'rulesBgImage' }
    ];
    
    uploaders.forEach(uploader => {
      const input = document.getElementById(uploader.id);
      if (input) {
        input.addEventListener('change', (e) => this.handleImageUpload(e, uploader.key));
      }
    });
  }

  handleImageUpload(e, storageKey) {
    this.handleUpload(e.target, storageKey, false);
  }      
  
  bindModuleImageUploaders() {
    // ä½¿ç”¨äº‹ä»¶å§”æ‰˜å¤„ç†æ¨¡å—å†…çš„å›¾ç‰‡ä¸Šä¼ 
    document.addEventListener('change', (e) => {
      if (e.target.type === 'file' && e.target.accept === 'image/*' && e.target.closest('.module')) {
        window.fileProcessor.handleModuleImageUpload(e);
      }
    });
  }
  
  bindModuleUploaders(moduleEl, moduleId) {
    const inputs = moduleEl.querySelectorAll('input[type="file"]');
    inputs.forEach((input) => {
      const storageKey = this.getModuleStorageKey(input, moduleId);
      if (storageKey) {
        input.addEventListener('change', async (e) => {
          await this.handleUpload(e.target, storageKey, true);
        });
      }
    });
  }
  
  getModuleStorageKey(input, moduleId) {
    const classMap = {
      'derived-item-upload': `${moduleId}-titlebg`,
      'nine-grid-bg': `${moduleId}-gridbg`,
      'draw-btn': `${moduleId}-drawbtn`,
      'prize-bg': `${moduleId}-prizebg`,
      'sign-in-title-upload': `${moduleId}-title`,
      'sign-in-bg-upload': `${moduleId}-bg`,
      'day-icon-upload': `${moduleId}-dayicon`,
      'sign-in-btn-upload': `${moduleId}-signbtn`,
      'collect-title-upload': `${moduleId}-title`,
      'collect-bg-upload': `${moduleId}-bg`,
      'card-bg-upload': `${moduleId}-cardbg`,
      'combine-button-upload': `${moduleId}-combinebtn`,
      'activity-content-main-title-bg-upload': `${moduleId}-main-title-bg`,
      'activity-content-sub-title-bg-upload': `${moduleId}-sub-title-bg`,
      'activity-content-image-upload': `${moduleId}-image`,
      'carousel-title-bg-upload': `${moduleId}-title-bg`,
      'carousel-image-upload': `${moduleId}-image`,
      'carousel-image-bg-upload': `${moduleId}-image-bg`
    };
    
    // ç‰¹æ®Šå¤„ç†å¥–å“å›¾ç‰‡ä¸Šä¼ 
    if (input.classList.contains('prize-upload')) {
      const prizeIndex = this.getPrizeIndex(input);
      return `${moduleId}-prize-${prizeIndex}`;
    }
    
    for (const [className, key] of Object.entries(classMap)) {
      if (input.classList.contains(className)) {
        return key;
      }
    }
    return null;
  }
  
  // è·å–å¥–å“åœ¨ä¹å®«æ ¼ä¸­çš„ç´¢å¼•
  getPrizeIndex(input) {
    const moduleEl = input.closest('.module');
    if (!moduleEl) return 0;
    
    const prizeInputs = Array.from(moduleEl.querySelectorAll('.prize-upload'));
    return prizeInputs.indexOf(input);
  }
  
  async handleUpload(input, storageKey, isModule = false) {
    if (!input.files?.[0]) return;
    
    console.log(`å¼€å§‹å¤„ç†å›¾ç‰‡ä¸Šä¼ : ${storageKey}, æ–‡ä»¶:`, input.files[0].name);
    
    try {
      await window.fileProcessor.processImageFile(input.files[0], storageKey, isModule);
      
      // æ›´æ–°é¢„è§ˆ
      this.updatePreview(input, storageKey);
      
      // éªŒè¯å›¾ç‰‡æ˜¯å¦æ­£ç¡®å­˜å‚¨
      const storedData = isModule ? window.imageManager.getModule(storageKey) : window.imageManager.get(storageKey);
      console.log(`å›¾ç‰‡å­˜å‚¨éªŒè¯ ${storageKey}:`, storedData ? 'æˆåŠŸ' : 'å¤±è´¥');
      
      window.notificationSystem.show('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
    } catch (error) {
      console.error(`å›¾ç‰‡ä¸Šä¼ å¤±è´¥ ${storageKey}:`, error);
      window.notificationSystem.show(`ä¸Šä¼ å¤±è´¥: ${error.message}`, 'error');
    }
  }
  
  updatePreview(input, storageKey) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      const previewContainer = this.findPreviewContainer(input, storageKey);
      if (previewContainer) {
        this.renderPreview(previewContainer, e.target.result, storageKey);
      }
    };
    reader.readAsDataURL(file);
  }
  
  findPreviewContainer(input, storageKey) {
    // ç‰¹æ®Šå¤„ç†æ¸¸æˆiconé¢„è§ˆ
    if (storageKey === 'gameIcon') {
      return document.getElementById('gameIconPreview');
    }
    
    const uploadBtn = input.nextElementSibling;
    if (!uploadBtn) return null;
    
    if (input.classList.contains('prize-upload')) {
      return uploadBtn.querySelector('.preview-container');
    }
    
    return uploadBtn.querySelector('.img-preview-inline');
  }
  
  renderPreview(container, src, storageKey) {
    container.innerHTML = '';
    const img = document.createElement('img');
    img.src = src;
    img.alt = "Preview";
    
    // æ¸¸æˆiconä½¿ç”¨ç‰¹æ®Šæ ·å¼
    if (storageKey === 'gameIcon') {
      img.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:8px';
      container.style.border = '1px solid rgba(0, 113, 227, 0.5)';
    } else {
      img.style.cssText = 'width:100%;height:100%;object-fit:contain;border-radius:8px';
    }
    
    container.appendChild(img);
    
    // æ›´æ–°æŒ‰é’®æ ·å¼
    const btn = container.closest('.upload-btn, .grid-btn');
    if (btn) {
      btn.style.border = '1px solid rgba(0, 113, 227, 0.5)';
    }
  }
}

// åˆ›å»ºå…¨å±€å›¾ç‰‡ä¸Šä¼ ç®¡ç†å™¨å®ä¾‹
const imageUploader = new ImageUploader();

// å¯¼å‡ºä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
window.imageUploader = imageUploader; 

/* === image-slice-handler.js === */
// ==================== å›¾ç‰‡åˆ‡ç‰‡å¤„ç†å™¨ ====================

class ImageSliceHandler {
  async handleSliceRequest(message) {
    try {
      const { imageData, sliceWidth, sliceHeight, sliceStrategy } = message;
      
      if (!imageData) {
        throw new Error('ç¼ºå°‘å›¾ç‰‡æ•°æ®');
      }
      
      console.log(`å¼€å§‹å¤„ç†å›¾ç‰‡åˆ‡ç‰‡: ${imageData.name}`);
      if (sliceStrategy) {
        console.log(`ä½¿ç”¨æ™ºèƒ½åˆ‡ç‰‡ç­–ç•¥: ${sliceStrategy.description}`);
      }
      
      // æ‰§è¡Œåˆ‡ç‰‡æ“ä½œ - ä¼ é€’ç­–ç•¥è®¡ç®—çš„å°ºå¯¸
      const result = await window.fileProcessor.sliceLargeImage(imageData, sliceWidth, sliceHeight);
      
      if (!result || !result.slices || result.slices.length === 0) {
        throw new Error('å›¾ç‰‡åˆ‡ç‰‡å¤±è´¥ï¼Œæœªç”Ÿæˆåˆ‡ç‰‡æ•°æ®');
      }
      
      console.log(`å›¾ç‰‡åˆ‡ç‰‡å®Œæˆ: ${imageData.name}, ç”Ÿæˆ ${result.slices.length} ä¸ªåˆ‡ç‰‡`);
      
      // ğŸš¨ ä¿®å¤ï¼šè½¬æ¢åˆ‡ç‰‡æ•°æ®æ ¼å¼ä¸ºæ’ä»¶å¯å¤„ç†çš„æ ¼å¼
      const processedSlices = result.slices.map((slice, index) => {
        try {
          return {
            bytes: Array.from(slice.data), // è½¬æ¢Uint8Arrayä¸ºArray
            width: slice.width,
            height: slice.height,
            x: slice.x,
            y: slice.y,
            row: slice.row,
            col: slice.col,
            name: slice.name || `slice_${index}.png`
          };
        } catch (error) {
          console.error(`å¤„ç†åˆ‡ç‰‡ ${index} æ•°æ®æ—¶å‡ºé”™:`, error);
          return null;
        }
      }).filter(slice => slice !== null); // è¿‡æ»¤æ‰å¤„ç†å¤±è´¥çš„åˆ‡ç‰‡
      
      console.log(`æˆåŠŸå¤„ç† ${processedSlices.length}/${result.slices.length} ä¸ªåˆ‡ç‰‡`);
      
      // å‘é€æˆåŠŸå“åº”
      window.pluginComm.postMessage('slice-image-response', {
        success: true,
        imageName: imageData.name,
        slices: processedSlices,
        originalWidth: result.originalWidth,
        originalHeight: result.originalHeight,
        sliceWidth: result.sliceWidth,
        sliceHeight: result.sliceHeight,
        cols: result.cols,
        rows: result.rows
      });
      
    } catch (error) {
      console.error('å›¾ç‰‡åˆ‡ç‰‡å¤„ç†å¤±è´¥:', error);
      
      // å‘é€å¤±è´¥å“åº”
      window.pluginComm.postMessage('slice-image-response', {
        success: false,
        imageName: message.imageData?.name || 'æœªçŸ¥å›¾ç‰‡',
        error: error.message
      });
    }
  }
}

// åˆ›å»ºå…¨å±€å›¾ç‰‡åˆ‡ç‰‡å¤„ç†å™¨å®ä¾‹å¹¶æŒ‚è½½åˆ°windowå¯¹è±¡
window.imageSliceHandler = new ImageSliceHandler(); 

/* === module-manager.js === */
// ==================== æ¨¡å—ç®¡ç†å™¨æ¨¡å— ====================

class ModuleManager {
  constructor() {
    this.moduleCounter = 0;
  }
  
  init() {
    this.bindAddModuleEvent();
    this.updateModuleCount();
  }
  
  bindAddModuleEvent() {
    const addBtn = document.getElementById('addModuleBtn');
    const typeSelect = document.getElementById('moduleTypeSelect');
    
    if (addBtn) {
      addBtn.addEventListener('click', () => {
        const moduleType = typeSelect?.value;
        if (moduleType) {
          this.addModule(moduleType);
        }
      });
    }
  }
  
  addModule(moduleType) {
    // ç»Ÿä¸€ä½¿ç”¨ moduleType + "Template" çš„å‘½åè§„åˆ™
    const templateId = `${moduleType}Template`;
    const template = document.getElementById(templateId);
    
    if (!template) {
      console.error(`æ‰¾ä¸åˆ°æ¨¡æ¿: ${templateId}`);
      window.notificationSystem.show(`æ¨¡æ¿ ${templateId} ä¸å­˜åœ¨`, 'error');
      return;
    }
    
    // åˆ›å»ºæ–°æ¨¡å—
    this.moduleCounter++;
    const moduleId = `module-${this.moduleCounter}`;
    const newModule = template.cloneNode(true);
    
    newModule.id = moduleId;
    newModule.className = 'module';
    newModule.style.display = 'block';
    
    // ç»Ÿä¸€æ¨¡å—ç±»å‹æ ‡è¯†ç¬¦
    const moduleTypeMapping = {
      'lotteryModule': 'nineGrid',
      'signInModule': 'signIn', 
      'collectModule': 'collectCards',
      'activityContentModule': 'activityContent',
      'carouselModule': 'carousel'
    };
    
    newModule.dataset.moduleType = moduleTypeMapping[moduleType] || moduleType;
    
    this.bindModuleEvents(newModule);
    
    const container = document.getElementById('modulesContainer');
    const emptyMessage = container.querySelector('.empty-modules-message');
    if (emptyMessage) {
      emptyMessage.style.display = 'none';
    }
    
    container.appendChild(newModule);
    
    this.updateModuleCount();
    
    // æ»šåŠ¨åˆ°æ–°æ¨¡å—
    requestAnimationFrame(() => {
      newModule.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });
    
    // è§¦å‘æ¨¡å—æ·»åŠ äº‹ä»¶
    document.dispatchEvent(new CustomEvent('moduleAdded', { 
      detail: { moduleId } 
    }));
  }
  
  // æ¨¡å—ç±»å‹æ˜ å°„
  getModuleTypeMapping(templateType) {
    const typeMap = {
      'lotteryModule': 'nineGrid',
      'signInModule': 'signIn', 
      'collectModule': 'collectCards',
      'activityContentModule': 'activityContent',
      'carouselModule': 'carousel'
    };
    return typeMap[templateType] || templateType;
  }
  
  bindModuleEvents(moduleEl) {
    const deleteBtn = moduleEl.querySelector('.delete-btn');
    const collapseBtn = moduleEl.querySelector('.collapse-btn');
    const moveUpBtn = moduleEl.querySelector('.move-up-btn');
    const moveDownBtn = moduleEl.querySelector('.move-down-btn');
    
    // ä¸ºåˆ é™¤æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    if (deleteBtn) {
      deleteBtn.addEventListener('click', (e) => {
        e.preventDefault(); // é˜»æ­¢é»˜è®¤è¡Œä¸º
        e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
        this.deleteModule(moduleEl); // è°ƒç”¨åˆ é™¤æ¨¡å—æ–¹æ³•
      });
    }
    
    if (collapseBtn) {
      collapseBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        moduleEl.classList.toggle('module-collapsed');
        collapseBtn.classList.toggle('collapsed');
      });
    }
    
    if (moveUpBtn) {
      moveUpBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        this.moveModuleUp(moduleEl);
      });
    }
    
    if (moveDownBtn) {
      moveDownBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        this.moveModuleDown(moduleEl);
      });
    }
    
    // ç»‘å®šå›¾ç‰‡ä¸Šä¼ äº‹ä»¶
    this.bindModuleImageUploads(moduleEl);
  }     

  // ç»‘å®šæ¨¡å—å†…çš„å›¾ç‰‡ä¸Šä¼ äº‹ä»¶
  bindModuleImageUploads(moduleEl) {
    const imageInputs = moduleEl.querySelectorAll('input[type="file"][accept="image/*"]');
    imageInputs.forEach(input => {
      // ç§»é™¤ç°æœ‰çš„äº‹ä»¶ç›‘å¬å™¨ï¼ˆå¦‚æœæœ‰ï¼‰
      const newInput = input.cloneNode(true);
      input.parentNode.replaceChild(newInput, input);
      
      // é‡æ–°ç»‘å®š onchange äº‹ä»¶
      if (newInput.classList.contains('prize-upload')) {
        newInput.addEventListener('change', () => window.utilityFunctions.previewImage(newInput));
      } else {
        // å¯¹äºå…¶ä»–ç±»å‹çš„å›¾ç‰‡ä¸Šä¼ ï¼Œä½¿ç”¨æ ‡å‡†é¢„è§ˆå‡½æ•°
        newInput.addEventListener('change', () => {
          const previewContainer = newInput.nextElementSibling?.querySelector('.img-preview-inline');
          if (previewContainer) {
            window.utilityFunctions.previewImage(newInput, previewContainer);
          }
        });
      }
    });
  }
  
  deleteModule(moduleEl) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ¨¡å—å—ï¼Ÿ')) {
      const moduleId = moduleEl.id;
      
      // ä¸€æ­¥å®Œæˆï¼šDOM + æ•°æ® + æ›´æ–°
      moduleEl.remove();
      this.cleanupModuleData(moduleId);
      this.updateModuleCount();
    }
  }
  
  // æç®€é«˜æ•ˆæ¸…ç†
  cleanupModuleData(moduleId) {
    if (!moduleId || !window.imageManager?.moduleData) return;
    
    // ç›´æ¥è¿‡æ»¤é‡å»ºï¼Œæ¯”é€ä¸ªåˆ é™¤æ›´é«˜æ•ˆ
    const newData = {};
    for (const key in window.imageManager.moduleData) {
      if (!key.startsWith(moduleId)) {
        newData[key] = window.imageManager.moduleData[key];
      }
    }
    window.imageManager.moduleData = newData;
  }
  
  moveModuleUp(moduleEl) {
    const prevModule = moduleEl.previousElementSibling;
    if (prevModule && !prevModule.classList.contains('empty-modules-message')) {
      moduleEl.parentNode.insertBefore(moduleEl, prevModule);
    }
  }
  
  moveModuleDown(moduleEl) {
    const nextModule = moduleEl.nextElementSibling;
    if (nextModule) {
      moduleEl.parentNode.insertBefore(nextModule, moduleEl);
    }
  }
  
  updateModuleCount() {
    const counter = document.getElementById('moduleCounter');
    const modules = document.querySelectorAll('#modulesContainer .module');
    const emptyMessage = document.getElementById('emptyModulesMessage');
    
    if (counter) {
      counter.textContent = modules.length;
    }
    
    // æ˜¾ç¤ºæˆ–éšè—ç©ºçŠ¶æ€æ¶ˆæ¯
    if (emptyMessage) {
      emptyMessage.style.display = modules.length === 0 ? 'block' : 'none';
    }
  }
}

// åˆ›å»ºå…¨å±€æ¨¡å—ç®¡ç†å™¨å®ä¾‹
const moduleManager = new ModuleManager();

// å¯¼å‡ºä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
window.moduleManager = moduleManager; 

/* === form-resetter.js === */
// ==================== è¡¨å•é‡ç½®å™¨æ¨¡å— ====================

class FormResetter {
  resetAll() {
    try {
      console.log('å¼€å§‹é‡ç½®è¡¨å•...');
      
      // 1. æ¸…ç†å›¾ç‰‡ç®¡ç†å™¨æ•°æ®
      if (window.imageManager) {
        window.imageManager.clear();
      }
      
      // 2. ç«‹å³é‡ç½®è¡¨å•è¾“å…¥
      this.resetInputs();
      
      // 3. ç«‹å³é‡ç½®æ¨¡å—
      this.resetModules();
      
      // 4. ç«‹å³é‡ç½®é¢„è§ˆ
      this.resetPreviews();
      
      console.log('è¡¨å•é‡ç½®å®Œæˆ');
      return true;
    } catch (error) {
      console.error('é‡ç½®è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯:', error);
      window.notificationSystem.show('é‡ç½®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œè¯·åˆ·æ–°é¡µé¢', 'error');
      return false;
    }
  }
  
  resetInputs() {
    try {
      // ç«‹å³é‡ç½®æ‰€æœ‰è¾“å…¥ï¼Œä¿æŒåŸæœ‰åŠŸèƒ½
      // é‡ç½®æ–‡æœ¬è¾“å…¥æ¡†
      document.querySelectorAll('input[type="text"], textarea').forEach(input => {
        input.value = '';
      });
      
      // é‡ç½®æ–‡ä»¶è¾“å…¥æ¡†
      document.querySelectorAll('input[type="file"]').forEach(input => {
        input.value = '';
      });
      
      // é‡ç½®é¢œè‰²è¾“å…¥æ¡†åˆ°é»˜è®¤å€¼
      const colorDefaults = {
        '#pageColor': '#D9D9D9',
        '#gameCopyTextColor': '#FFFFFF',
        '#iconButtonTextColor': '#FFFFFF',
        '#singleButtonTextColor': '#FFFFFF',
        '#leftButtonTextColor': '#FFFFFF',
        '#rightButtonTextColor': '#FFFFFF'
      };
      
      for (const [selector, defaultValue] of Object.entries(colorDefaults)) {
        const colorInput = document.querySelector(selector);
        if (colorInput) {
          colorInput.value = defaultValue;
          const textInput = colorInput.nextElementSibling;
          if (textInput && textInput.classList.contains('color-value')) {
            textInput.value = defaultValue;
          }
        }
      }
      
      // é‡ç½®é€‰æ‹©æ¡†
      document.querySelectorAll('select').forEach(select => {
        if (select.options.length > 0) {
          select.selectedIndex = 0;
        }
      });
      
      // é‡ç½®æ•°å­—è¾“å…¥æ¡†
      document.querySelectorAll('input[type="number"]').forEach(input => {
        const defaultValue = input.getAttribute('placeholder') || '0';
        input.value = defaultValue;
      });
      
      // ç«‹å³å¤„ç†æŒ‰é’®ç‰ˆæœ¬é€‰æ‹©å™¨
      const buttonVersionSelect = document.getElementById('buttonVersionSelect');
      if (buttonVersionSelect) {
        buttonVersionSelect.selectedIndex = 0;
        window.utilityFunctions.switchButtonVersion(); // ç›´æ¥è°ƒç”¨å‡½æ•°è€Œä¸æ˜¯è§¦å‘äº‹ä»¶
      }
      
      console.log('è¾“å…¥å­—æ®µé‡ç½®å®Œæˆ');
    } catch (error) {
      console.error('é‡ç½®è¾“å…¥å­—æ®µå¤±è´¥:', error);
      throw error;
    }
  }
  
  reinitializeComponents() {
    try {
      console.log('é‡æ–°åˆå§‹åŒ–ç»„ä»¶...');
      
      // åªé‡æ–°ç»‘å®šå¿…è¦çš„é¢œè‰²è¾“å…¥äº‹ä»¶ï¼Œä¸å…‹éš†DOMèŠ‚ç‚¹
      this.rebindColorInputs();
      
      console.log('ç»„ä»¶é‡æ–°åˆå§‹åŒ–å®Œæˆ');
    } catch (error) {
      console.error('ç»„ä»¶é‡æ–°åˆå§‹åŒ–å¤±è´¥:', error);
    }
  }
  
  // é«˜æ•ˆé‡æ–°ç»‘å®šé¢œè‰²è¾“å…¥äº‹ä»¶
  rebindColorInputs() {
    document.querySelectorAll('.color-input-group').forEach(group => {
      const colorInput = group.querySelector('input[type="color"]');
      const textInput = group.querySelector('.color-value');
      
      if (colorInput && textInput && !colorInput.dataset.bound) {
        // æ ‡è®°å·²ç»‘å®šï¼Œé¿å…é‡å¤ç»‘å®š
        colorInput.dataset.bound = 'true';
        textInput.dataset.bound = 'true';
        
        // ç›´æ¥ç»‘å®šäº‹ä»¶ï¼Œä¸å…‹éš†èŠ‚ç‚¹
        colorInput.addEventListener('input', () => {
          textInput.value = colorInput.value.toUpperCase();
        });
        
        textInput.addEventListener('input', () => {
          if (/^#[0-9A-F]{6}$/i.test(textInput.value)) {
            colorInput.value = textInput.value;
          }
        });
      }
    });
  }
  
  resetModules() {
    const container = document.getElementById('modulesContainer');
    if (container) {
      // ç›´æ¥ç§»é™¤æ‰€æœ‰æ¨¡å—ï¼Œä¸ä½¿ç”¨åŠ¨ç”»
      const modules = container.querySelectorAll('.module');
      modules.forEach(module => module.remove());
      
      // å»¶è¿Ÿæ¸…ç†æ¨¡å—æ•°æ®ï¼Œé¿å…é˜»å¡UI
      setTimeout(() => {
        if (window.imageManager && window.imageManager.moduleData) {
          window.imageManager.moduleData = {};
        }
      }, 50);
      
      // ç«‹å³æ›´æ–°æ¨¡å—è®¡æ•°
      if (window.moduleManager) {
        window.moduleManager.updateModuleCount();
      }
    }
  }
  
  resetPreviews() {
    // æ‰¹é‡é‡ç½®é¢„è§ˆ
    const previews = document.querySelectorAll('.img-preview-inline, .preview-container');
    previews.forEach(preview => {
      preview.innerHTML = '<span class="upload-icon-inline">+</span>';
    });
    
    // ç‰¹æ®Šå¤„ç†æ¸¸æˆiconé¢„è§ˆ
    const gameIconPreview = document.getElementById('gameIconPreview');
    if (gameIconPreview) {
      gameIconPreview.innerHTML = '<span class="upload-icon-text">+</span>';
    }
    
    // æ‰¹é‡é‡ç½®æŒ‰é’®æ ·å¼
    document.querySelectorAll('.upload-btn, .grid-btn').forEach(btn => {
      btn.style.border = '';
    });
  }
}

// åˆ›å»ºå…¨å±€è¡¨å•é‡ç½®å™¨å®ä¾‹
const formResetter = new FormResetter();

// å¯¼å‡ºä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
window.formResetter = formResetter; 

/* === ui-controller.js === */
// ==================== UI æ§åˆ¶å™¨æ¨¡å— ====================

class UIController {
  constructor() {
    this.initialized = false;
    this.eventListeners = new Map();
  }
  
  init() {
    if (this.initialized) return;
    
    this.initializeComponents();
    this.bindEvents();
    this.initialized = true;
  }
  
  // åˆå§‹åŒ–ç»„ä»¶
  initializeComponents() {
    this.initializeTabs();
    this.initializeModuleManagement();
    this.initializeImageUploaders();
    this.initializeThemeSystem();
    this.initializeColorPickers();
    this.initializeCollapsiblePanels();
  }
  
  // ç»‘å®šäº‹ä»¶
  bindEvents() {
    this.bindTabEvents();
    this.bindButtonEvents();
    this.bindVersionSelectorEvents();
  }
  
  // åˆå§‹åŒ–æ ‡ç­¾é¡µ
  initializeTabs() {
    const activeTab = document.querySelector('.tab.active');
    if (!activeTab) {
      const firstTab = document.querySelector('.tab');
      if (firstTab) {
        firstTab.classList.add('active');
        this.showTabContent(firstTab.dataset.tab);
      }
    } else {
      this.showTabContent(activeTab.dataset.tab);
    }
  }
  
  // æ˜¾ç¤ºæ ‡ç­¾é¡µå†…å®¹
  showTabContent(tabId) {
    // éšè—æ‰€æœ‰å†…å®¹
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    
    // æ˜¾ç¤ºç›®æ ‡å†…å®¹
    const targetContent = document.getElementById(`${tabId}-content`);
    if (targetContent) {
      targetContent.classList.add('active');
    }
  }
  
  // ç»‘å®šæ ‡ç­¾é¡µäº‹ä»¶
  bindTabEvents() {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        this.showTabContent(tab.dataset.tab);
      });
    });
  }
  
  // åˆå§‹åŒ–æ¨¡å—ç®¡ç†
  initializeModuleManagement() {
    if (window.moduleManager) {
      window.moduleManager.init();
    }
  }
  
  // åˆå§‹åŒ–å›¾ç‰‡ä¸Šä¼ 
  initializeImageUploaders() {
    if (window.imageUploader) {
      window.imageUploader.init();
    }
  }
  
  // åˆå§‹åŒ–ä¸»é¢˜ç³»ç»Ÿ
  initializeThemeSystem() {
    if (window.themeManager) {
      window.themeManager.init();
    }
  }
  
  // åˆå§‹åŒ–é¢œè‰²é€‰æ‹©å™¨
  initializeColorPickers() {
    const colorInputs = document.querySelectorAll('input[type="color"]');
    colorInputs.forEach(colorInput => {
      const textInput = colorInput.nextElementSibling;
      if (textInput && textInput.classList.contains('color-value')) {
        this.syncColorInputs(colorInput, textInput);
      }
    });
  }
  
  // åŒæ­¥é¢œè‰²è¾“å…¥
  syncColorInputs(colorInput, textInput) {
    colorInput.addEventListener('input', () => {
      textInput.value = colorInput.value.toUpperCase();
    });
    
    textInput.addEventListener('input', () => {
      if (/^#[0-9A-F]{6}$/i.test(textInput.value)) {
        colorInput.value = textInput.value;
      }
    });
  }
  
  // åˆå§‹åŒ–æŠ˜å é¢æ¿
  initializeCollapsiblePanels() {
    const collapseButtons = document.querySelectorAll('.collapse-btn');
    collapseButtons.forEach(button => {
      button.addEventListener('click', () => {
        const targetId = button.getAttribute('data-target');
        const contentElement = document.getElementById(targetId);
        
        if (contentElement) {
          button.classList.toggle('collapsed');
          contentElement.classList.toggle('collapsed');
        }
      });
    });
  }
  
  // ç»‘å®šæŒ‰é’®äº‹ä»¶
  bindButtonEvents() {
    const createBtn = document.getElementById('create');
    const resetBtn = document.getElementById('reset');
    
    if (createBtn) {
      createBtn.addEventListener('click', () => this.handleCreatePrototype());
    }
    
    if (resetBtn) {
      resetBtn.addEventListener('click', () => this.handleReset());
    }
  }
  
  // ç»‘å®šç‰ˆæœ¬é€‰æ‹©å™¨äº‹ä»¶
  bindVersionSelectorEvents() {
    const selector = document.getElementById('buttonVersionSelect');
    if (selector) {
      selector.addEventListener('change', (e) => {
        const contents = document.querySelectorAll('#buttonVersionContent .version-content');
        contents.forEach(content => content.classList.remove('active'));
        
        const targetContent = document.getElementById(`${e.target.value}Content`);
        if (targetContent) {
          targetContent.classList.add('active');
        }
      });
    }
  }
  
  // å¤„ç†åˆ›å»ºåŸå‹
  handleCreatePrototype() {
    const createBtn = document.getElementById('create');
    if (!createBtn) return;
    
    createBtn.disabled = true;
    createBtn.textContent = 'å¤„ç†ä¸­...';
    
    try {
      const config = window.dataCollector.collectFormData();
      window.pluginComm.postMessage('create-prototype', { config });
    } catch (error) {
      window.notificationSystem.show(`åˆ›å»ºå¤±è´¥: ${error.message}`, 'error');
      this.resetCreateButton();
    }
  }
  
  // å¤„ç†é‡ç½®
  handleReset() {
    if (!confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚')) {
      return;
    }
    
    try {
      console.log('å¼€å§‹æ‰§è¡Œé‡ç½®æ“ä½œ...');
      
      const success = window.formResetter.resetAll();
      
      if (success) {
        // é€šçŸ¥æ’ä»¶é‡ç½®å·²å®Œæˆ
        window.pluginComm.postMessage('reset-complete', {});
        window.notificationSystem.show('æ‰€æœ‰è®¾ç½®å·²é‡ç½®', 'success');
        console.log('é‡ç½®æ“ä½œå®Œæˆ');
      } else {
        window.notificationSystem.show('é‡ç½®å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
      }
    } catch (error) {
      console.error('é‡ç½®æ“ä½œå¤±è´¥:', error);
      window.notificationSystem.show(`é‡ç½®å¤±è´¥: ${error.message}`, 'error');
    }
  }
  
  // é‡ç½®åˆ›å»ºæŒ‰é’®
  resetCreateButton() {
    const createBtn = document.getElementById('create');
    if (createBtn) {
      createBtn.textContent = 'åˆ›å»ºåŸå‹';
      createBtn.disabled = false;
    }
  }
}

// åˆ›å»ºå…¨å±€UIæ§åˆ¶å™¨å®ä¾‹
const uiController = new UIController();

// å¯¼å‡ºä¾›å…¶ä»–æ¨¡å—ä½¿ç”¨
window.uiController = uiController; 

/* === app.js === */
// ==================== ä¸»åº”ç”¨åˆå§‹åŒ–å’Œæ¶ˆæ¯å¤„ç† ====================

// ç­‰å¾…æ‰€æœ‰æ¨¡å—åŠ è½½å®Œæˆååˆå§‹åŒ–
function waitForModules() {
  return new Promise((resolve) => {
    let attempts = 0;
    const maxAttempts = 100; // æœ€å¤šç­‰å¾…1ç§’
    
    const checkModules = () => {
      attempts++;
      
      // æ£€æŸ¥å…³é”®æ¨¡å—æ˜¯å¦å·²åŠ è½½
      const coreModules = [
        'pluginComm', 'notificationSystem', 'uiController', 
        'dataCollector', 'utilityFunctions'
      ];
      
      const missingModules = coreModules.filter(module => !window[module]);
      
      if (missingModules.length === 0) {
        console.log('âœ… æ‰€æœ‰æ ¸å¿ƒæ¨¡å—åŠ è½½å®Œæˆ');
        resolve();
      } else if (attempts >= maxAttempts) {
        console.warn('âš ï¸ æ¨¡å—åŠ è½½è¶…æ—¶ï¼Œä½†ç»§ç»­åˆå§‹åŒ–:', missingModules);
        resolve(); // å³ä½¿æœ‰æ¨¡å—ç¼ºå¤±ä¹Ÿç»§ç»­åˆå§‹åŒ–
      } else {
        setTimeout(checkModules, 10);
      }
    };
    checkModules();
  });
}

// æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨
function registerMessageHandlers() {
  window.pluginComm.on('init', (message) => {
    console.log('æ’ä»¶åˆå§‹åŒ–:', message.data);
  });

  window.pluginComm.on('prototype-created', () => {
    window.notificationSystem.show('åŸå‹åˆ›å»ºæˆåŠŸï¼', 'success');
    window.uiController.resetCreateButton();
  });

  window.pluginComm.on('error', (message) => {
    console.error('æ“ä½œå¤±è´¥:', message);
    
    // éšè—åŠ è½½çŠ¶æ€
    window.notificationSystem.hideLoading();
    
    // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
    const errorMsg = message.message || 'æœªçŸ¥é”™è¯¯';
    window.notificationSystem.show(`æ“ä½œå¤±è´¥: ${errorMsg}`, 'error');
    
    // é‡ç½®åˆ›å»ºæŒ‰é’®çŠ¶æ€
    window.uiController.resetCreateButton();
    
    // å¯é€‰ï¼šè®°å½•é”™è¯¯æ—¥å¿—æˆ–å‘é€é”™è¯¯æŠ¥å‘Š
    if (message.details) {
      console.error('é”™è¯¯è¯¦æƒ…:', message.details);
    }
    
    // å¯é€‰ï¼šæ ¹æ®é”™è¯¯ç±»å‹æä¾›ä¸åŒçš„ç”¨æˆ·æç¤º
    if (message.errorType === 'validation') {
      window.notificationSystem.show('è¯·æ£€æŸ¥è¾“å…¥çš„æ•°æ®æ˜¯å¦å®Œæ•´', 'warning', 3000);
    } else if (message.errorType === 'network') {
      window.notificationSystem.show('ç½‘ç»œè¿æ¥å¼‚å¸¸ï¼Œè¯·ç¨åé‡è¯•', 'warning', 3000);
    }
  });

  window.pluginComm.on('save-success', () => {
    window.notificationSystem.show('é…ç½®å·²ä¿å­˜', 'success');
  });

  window.pluginComm.on('load-config-success', (message) => {
    if (message.config) {
      // TODO: å®ç°é…ç½®åŠ è½½é€»è¾‘
      window.notificationSystem.show('é…ç½®åŠ è½½æˆåŠŸ', 'success');
    }
  });

  window.pluginComm.on('reset-acknowledged', (message) => {
    console.log('æ’ä»¶ç¡®è®¤é‡ç½®å®Œæˆ:', message.message);
  });

  window.pluginComm.on('pong', (message) => {
    console.log('æ’ä»¶è¿æ¥æ­£å¸¸:', message.message);
  });

  // æ¸ é“ç”ŸæˆæˆåŠŸå¤„ç†
  window.pluginComm.on('channel-version-generated', (message) => {
    console.log('æ¸ é“ç‰ˆæœ¬ç”ŸæˆæˆåŠŸ:', message.message);
    window.notificationSystem.hideLoading();
    window.notificationSystem.show(message.message, 'success');
  });
}

// åˆå§‹åŒ–åº”ç”¨ (å…¨å±€å‡½æ•°ï¼Œä¾›global-init.jsè°ƒç”¨)
window.initializeApp = async function() {
  try {
    console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–H5Toolsåº”ç”¨...');
    
    // ç­‰å¾…æ‰€æœ‰æ¨¡å—åŠ è½½å®Œæˆ
    await waitForModules();
    
    // æ³¨å†Œæ¶ˆæ¯å¤„ç†å™¨
    registerMessageHandlers();
    
    // ğŸ¯ å¼ºåˆ¶æ˜¾ç¤ºUIå†…å®¹ - ä¿®å¤ç©ºç™½é¡µé¢é—®é¢˜
    forceShowUI();
    
    // åˆå§‹åŒ–UIæ§åˆ¶å™¨
    if (window.uiController) {
    window.uiController.init();
    } else {
      console.warn('âš ï¸ UIControlleræœªåŠ è½½ï¼Œä½¿ç”¨å¤‡ç”¨åˆå§‹åŒ–');
      fallbackUIInit();
    }
    
    // è®¾ç½®å…¨å±€äº‹ä»¶ç›‘å¬å™¨
    setupEventListeners();
    
    // åˆå§‹åŒ–ä¸»é¢˜ç³»ç»Ÿï¼ˆå¯é€‰ï¼‰
    initializeThemeSystem();
    
    console.log('âœ… H5Toolsåº”ç”¨åˆå§‹åŒ–å®Œæˆ');
    
    // å‘é€åˆå§‹åŒ–å®Œæˆæ¶ˆæ¯
    if (window.pluginComm) {
      window.pluginComm.postMessage('ui-ready', { timestamp: Date.now() });
    }
    
  } catch (error) {
    console.error('âŒ åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
    // å³ä½¿åˆå§‹åŒ–å¤±è´¥ï¼Œä¹Ÿå°è¯•æ˜¾ç¤ºåŸºç¡€UI
    forceShowUI();
  }
};

// ğŸš¨ å¼ºåˆ¶æ˜¾ç¤ºUIå†…å®¹ - è§£å†³ç©ºç™½é¡µé¢é—®é¢˜
function forceShowUI() {
  console.log('ğŸ”§ å¼ºåˆ¶æ˜¾ç¤ºUIå†…å®¹...');
  
  // ç¡®ä¿ç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µæ¿€æ´»
  const firstTab = document.querySelector('.tab');
  if (firstTab && !document.querySelector('.tab.active')) {
    firstTab.classList.add('active');
    console.log('âœ… æ¿€æ´»ç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µ:', firstTab.dataset.tab);
  }
  
  // æ˜¾ç¤ºå¯¹åº”çš„å†…å®¹åŒºåŸŸ
  const activeTab = document.querySelector('.tab.active');
  if (activeTab) {
    const tabId = activeTab.dataset.tab;
    const content = document.getElementById(`${tabId}-content`);
    if (content) {
      // éšè—æ‰€æœ‰å†…å®¹
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      // æ˜¾ç¤ºç›®æ ‡å†…å®¹
      content.classList.add('active');
      console.log('âœ… æ˜¾ç¤ºæ ‡ç­¾é¡µå†…å®¹:', tabId);
    }
  }
  
  // ç¡®ä¿å¿…è¦çš„å…ƒç´ å¯è§
  const channelsMainView = document.getElementById('channelsMainView');
  if (channelsMainView) {
    channelsMainView.style.display = 'block';
    console.log('âœ… æ˜¾ç¤ºæ¸ é“ä¸»è§†å›¾');
  }
}

// å¤‡ç”¨UIåˆå§‹åŒ–
function fallbackUIInit() {
  console.log('ğŸ”§ æ‰§è¡Œå¤‡ç”¨UIåˆå§‹åŒ–...');
  
  // åŸºç¡€æ ‡ç­¾é¡µåˆ‡æ¢
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      // æ˜¾ç¤ºå¯¹åº”å†…å®¹
      const tabId = tab.dataset.tab;
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      const content = document.getElementById(`${tabId}-content`);
      if (content) {
        content.classList.add('active');
      }
    });
  });
  
  console.log('âœ… å¤‡ç”¨UIåˆå§‹åŒ–å®Œæˆ');
}

// è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
function setupEventListeners() {
  try {
    if (window.utilityFunctions) {
    document.addEventListener('click', window.utilityFunctions.globalClickHandler);
    document.addEventListener('change', window.utilityFunctions.globalChangeHandler);
    document.addEventListener('input', window.utilityFunctions.globalInputHandler);
    }
  } catch (error) {
    console.warn('âš ï¸ å…¨å±€äº‹ä»¶ç›‘å¬å™¨è®¾ç½®å¤±è´¥:', error);
  }
}
    
    // åˆå§‹åŒ–ä¸»é¢˜ç³»ç»Ÿ
function initializeThemeSystem() {
  try {
    if (window.utilityFunctions) {
    window.utilityFunctions.loadThemePreference();
    window.utilityFunctions.setupSystemThemeListener();
    window.utilityFunctions.bindThemeButtonEvents();
    }
  } catch (error) {
    console.warn('âš ï¸ ä¸»é¢˜ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥:', error);
  }
}

// æ³¨æ„ï¼šDOMäº‹ä»¶ç›‘å¬å™¨å’Œå…¼å®¹æ€§å‡½æ•°ç°åœ¨åœ¨global-init.jsä¸­å¤„ç†


/* === global-init.js === */
// ==================== å…¨å±€å®ä¾‹åŒ–å’Œåˆå§‹åŒ–ç®¡ç† ====================

/* eslint-disable no-undef */
// æ³¨æ„ï¼šä»¥ä¸‹ç±»ç”±å…¶ä»–æ–‡ä»¶åœ¨æ„å»ºæ—¶æä¾›ï¼ŒESLintæ— æ³•æ£€æµ‹åˆ°å®šä¹‰

// === å…¨å±€å®ä¾‹åŒ–ä»£ç  ===

// åˆ›å»ºå…¨å±€æ•°æ®æ”¶é›†å™¨å®ä¾‹
window.dataCollector = new DataCollector();

// åˆ›å»ºå…¨å±€å›¾ç‰‡æ•°æ®ç®¡ç†å™¨å®ä¾‹  
window.imageDataManager = new ImageDataManager();

// ğŸš¨ å‘åå…¼å®¹ï¼šä¸ºimageManageråˆ›å»ºåˆ«å
window.imageManager = window.imageDataManager;

// åˆ›å»ºå…¨å±€æ¸ é“ç®¡ç†å™¨å®ä¾‹
window.channelManager = new ChannelManager();

// åˆ›å»ºå…¨å±€å›¾ç‰‡ä¸Šä¼ å™¨å®ä¾‹
window.imageUploader = new ImageUploader();

// åˆ›å»ºå…¨å±€å›¾ç‰‡åˆ‡ç‰‡å¤„ç†å™¨å®ä¾‹
window.imageSliceHandler = new ImageSliceHandler();

// åˆ›å»ºå…¨å±€æ¨¡å—ç®¡ç†å™¨å®ä¾‹
window.moduleManager = new ModuleManager();

// åˆ›å»ºå…¨å±€è¡¨å•é‡ç½®å™¨å®ä¾‹
window.formResetter = new FormResetter();

// åˆ›å»ºå…¨å±€UIæ§åˆ¶å™¨å®ä¾‹
window.uiController = new UIController();

// åˆ›å»ºå…¨å±€ä¸»é¢˜ç®¡ç†å™¨å®ä¾‹
window.themeManager = new ThemeManager();

// åˆ›å»ºå…¨å±€æ–‡ä»¶å¤„ç†å™¨å®ä¾‹
window.fileProcessor = new FileProcessor();

// åˆ›å»ºå…¨å±€å·¥å…·å‡½æ•°å¯¹è±¡
window.utilityFunctions = {
  switchTab,
  switchButtonVersion,
  createPrototype,
  getImageData,
  collectModuleData,
  collectModuleContent,
  collectNineGridData,
  collectSignInData,
  collectCardsData,
  collectActivityContentData,
  getPrizePosition,
  previewImage,
  setupSystemThemeListener,
  loadThemePreference,
  detectAndApplySystemTheme,
  applyTheme,
  updateThemeButtonsState,
  switchTheme,
  bindThemeButtonEvents,
  globalClickHandler,
  globalChangeHandler,
  globalInputHandler,
  handleFileUpload,
  resetForm
};

console.log('âœ… æ‰€æœ‰å…¨å±€å®ä¾‹åˆ›å»ºå®Œæˆ:', {
  storageAdapter: !!window.storageAdapter,
  pluginComm: !!window.pluginComm,
  notificationSystem: !!window.notificationSystem,
  dataCollector: !!window.dataCollector,
  imageManager: !!window.imageManager,
  channelManager: !!window.channelManager,
  imageUploader: !!window.imageUploader,
  imageSliceHandler: !!window.imageSliceHandler,
  moduleManager: !!window.moduleManager,
  formResetter: !!window.formResetter,
  uiController: !!window.uiController,
  themeManager: !!window.themeManager,
  fileProcessor: !!window.fileProcessor,
  utilityFunctions: !!window.utilityFunctions,
  IconManager: !!window.IconManager
});



// ğŸš¨ é‡è¦ï¼šè§¦å‘æ’ä»¶é€šä¿¡å™¨å°±ç»ªäº‹ä»¶ï¼ˆå‘ŠçŸ¥å†…è”è„šæœ¬ï¼‰
if (window.pluginComm) {
  // åœ¨å…¨å±€çª—å£å¯¹è±¡ä¸Šè®¾ç½®æ ‡å¿—
  window._h5ToolsPluginCommReady = true;
  
  // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶
  const event = new CustomEvent('h5ToolsReady', {
    detail: { 
      pluginCommReady: true,
      timestamp: Date.now(),
      modules: Object.keys(window).filter(k => k.includes('Comm') || k.includes('Manager'))
    }
  });
  window.dispatchEvent(event);
  
  console.log('ğŸ¯ æ’ä»¶é€šä¿¡å™¨å°±ç»ªäº‹ä»¶å·²è§¦å‘');
}

// å…¼å®¹æ€§å‡½æ•° - ä¿æŒå‘åå…¼å®¹
window.collectFormData = function() {
  return window.dataCollector ? window.dataCollector.collectFormData() : null;
};

window.postMessageToPlugin = function(type, data) {
  if (window.pluginComm) {
    window.pluginComm.postMessage(type, data);
  }
};

window.showNotification = function(message, type) {
  if (window.notificationSystem) {
    window.notificationSystem.show(message, type);
  }
};

// ğŸš¨ å…³é”®ä¿®å¤ï¼šç¡®ä¿åœ¨DOMåŠ è½½å®Œæˆä¸”æ‰€æœ‰å®ä¾‹åˆ›å»ºåæ‰åˆå§‹åŒ–åº”ç”¨
function safeInitializeApp() {
  console.log('ğŸ”§ å®‰å…¨åˆå§‹åŒ–åº”ç”¨...');
  
  // ç›´æ¥è°ƒç”¨åˆå§‹åŒ–ï¼Œæ­¤æ—¶æ‰€æœ‰å®ä¾‹éƒ½å·²åˆ›å»º
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', window.initializeApp);
  } else {
    // DOMå·²ç»åŠ è½½å®Œæˆï¼Œç›´æ¥åˆå§‹åŒ–
    // ä½¿ç”¨setTimeoutç¡®ä¿å½“å‰æ‰§è¡Œæ ˆå®Œæˆåå†åˆå§‹åŒ–
    setTimeout(() => {
      window.initializeApp();
    }, 0);
  }
}

// è°ƒç”¨å®‰å…¨åˆå§‹åŒ–
safeInitializeApp();

// ğŸ¯ ç«‹å³åˆå§‹åŒ–æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½ï¼ˆä¸ç­‰å¾…å…¶ä»–æ¨¡å—ï¼‰
(function immediateTabInit() {
  const initTabs = () => {
    const tabs = document.querySelectorAll('.tab');
    if (tabs.length === 0) {
      // DOMå¯èƒ½è¿˜æ²¡æœ‰å®Œå…¨åŠ è½½ï¼Œå»¶è¿Ÿé‡è¯•
      setTimeout(initTabs, 10);
      return;
    }
    
    tabs.forEach(tab => {
      // ç§»é™¤ç°æœ‰äº‹ä»¶ç›‘å¬å™¨ï¼ˆé¿å…é‡å¤ç»‘å®šï¼‰
      tab.removeEventListener('click', tab._tabClickHandler);
      
      // åˆ›å»ºæ–°çš„äº‹ä»¶å¤„ç†å™¨
      tab._tabClickHandler = () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        const tabId = tab.getAttribute('data-tab');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        const content = document.getElementById(`${tabId}-content`);
        if (content) {
          content.classList.add('active');
        }
        
        console.log(`âœ… æ ‡ç­¾é¡µåˆ‡æ¢åˆ°: ${tabId}`);
      };
      
      // ç»‘å®šäº‹ä»¶
      tab.addEventListener('click', tab._tabClickHandler);
    });
    
    console.log('âœ… ç«‹å³æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½å·²åˆå§‹åŒ–');
  };
  
  // ç«‹å³å°è¯•åˆå§‹åŒ–
  initTabs();
})(); 

