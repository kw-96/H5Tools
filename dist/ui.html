<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>渠道美术-H5延展工具</title>

  <!-- 样式文件 - 外部CDN版本 -->
  <style>
/* 基础样式和重置 */
* {
  box-sizing: border-box;
  /* IE/Edge 隐藏滚动条 */
  -ms-overflow-style: none;
  -webkit-user-select: none; /* 兼容Safari/Chrome */
  -moz-user-select: none;    /* 兼容Firefox */
  -ms-user-select: none;     /* 兼容IE/Edge */
  user-select: none;
}

/* WebKit 浏览器滚动条样式 */
::-webkit-scrollbar {
  width: 0;
  height: 0;
  background: transparent;
}

body {
  margin: 0;
  padding: 0;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
  color: #1d1d1f;
  background-color: #ffffff;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  overflow-x: hidden;
}

.container {
  max-width: 100%;
  margin: 0 auto;
  overflow-x: hidden;
  height: 100vh;
  display: flex;
  flex-direction: column;
  padding-top: 46px;
  padding-bottom: 40px;
}

html, body, .container {
    height: 100%;
    min-height: 100%;
  }

/* 动画效果 */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(5px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* 通用工具类 */
.row-layout {
  display: flex;
  align-items: center;
  justify-content: space-between;
  width: 100%;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #666;
}

.empty-state h3 {
  margin-bottom: 10px;
  color: #333;
}

.empty-state p {
  margin: 8px 0;
  line-height: 1.5;
}

.gray-text {
  color: #999;
  font-size: 14px;
}

/* 可访问性优化 */
.hidden-file-input {
  display: none !important;
}

.hidden {
  display: none !important;
}

/* 视觉隐藏但对屏幕阅读器可见 */
.sr-only {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0, 0, 0, 0);
  white-space: nowrap;
  border: 0;
}

/* 空状态图标样式 */
.empty-icon {
  margin-bottom: 16px;
  opacity: 0.5;
}

/* 隐藏元素 */
.visually-hidden {
  display: none !important;
}

:root {
  --panel-bg: #f5f5f7;
  --panel-sidebar-bg: #fff;
  --panel-sidebar-border: #e0e0e0;
  --panel-menu-color: #666;
  --panel-menu-hover-bg: #e6f0ff;
  --panel-menu-hover-color: #0071e3;
  --tool-card-bg: #fff;
  --tool-card-shadow: 0 2px 8px rgba(0,0,0,0.04);
  --editor-preview-bg: #f0f0f0;
  --editor-placeholder-color: #bbb;
  --editor-slider-label: #888;
  --editor-slider-track: #e0e0e0;
  --editor-slider-thumb: #0071e3;
  --editor-reset-bg: #f5f5f7;
  --editor-reset-color: #666;
  --editor-reset-hover-bg: #e0e0e0;
  --editor-reset-hover-color: #0071e3;
  --editor-confirm-bg: #0071e3;
  --editor-confirm-hover-bg: #005bb5;
} 
/* 布局样式 */
.page-footer {
  width: 100%;
  padding: 10px;
  background-color: rgba(255, 255, 255, 0.72);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid rgba(0, 0, 0, 0.1);
  position: fixed;
  bottom: 0;
  left: 0;
  z-index: 100;
}

.version-info {
  display: flex;
  justify-content: space-between;
  width: 100%;
  color: #86868b;
  font-size: 13px;
}

/* 主题切换器 */
.theme-switcher {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 16px;
  background-color: #f5f5f7;
  border-radius: 12px;
  margin-bottom: 20px;
}

.theme-buttons {
  display: flex;
  gap: 8px;
} 
/* 通知样式 */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 12px 20px;
  background-color: #333;
  color: white;
  border-radius: 8px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
  z-index: 9999;
  font-size: 14px;
  opacity: 0;
  transform: translateY(-20px);
  transition: all 0.3s ease;
}

.notification.success {
  background-color: #34c759;
}

.notification.error {
  background-color: #ff3b30;
}

.notification.warning {
  background-color: #ff9500;
}

.notification.info {
  background-color: #0071e3;
}
/* 加载遮罩样式 */
#loadingOverlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

.loading-content {
  background: white;
  padding: 30px;
  border-radius: 12px;
  text-align: center;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  min-width: 200px;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid #f3f3f3;
  border-top: 4px solid #007AFF;
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto 16px;
}

.loading-message {
  font-size: 14px;
  color: #333;
  font-weight: 500;
} 
/* 标签页和导航 */
.tab-container {
  display: flex;
  width: 100%;
  justify-content: space-between;
  background-color: rgba(255, 255, 255, 0.72);
  -webkit-backdrop-filter: blur(20px);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  padding: 8px 0;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
}

.tab {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  flex: 1;
  width: 25%;
  padding: 8px 4px;
  border-radius: 8px;
  transition: all 0.2s cubic-bezier(0.645, 0.045, 0.355, 1);
  cursor: pointer;
  color: #86868b;
}

.tab svg {
  width: 24px !important;
  height: 24px !important;
  margin-bottom: 4px;
}

.tab-label {
  font-size: 14px;
  font-weight: 500;
  font-weight: bold;
  margin-top: 2px;
  opacity: 0.8;
}

.tab.active {
  color: #0071e3;
}

.tab:hover {
  color: #0071e3;
  background-color: rgba(0, 113, 227, 0.05);
}

/* 内容区域 */
.tab-content {
  display: none;
  padding: 0 16px;
  margin: 30px auto 0px;
  width: 100%;
  background-color: #ffffff;
  overflow-y: auto;
  overflow-x: hidden;
}

.tab-content.active {
  display: block;
  animation: fadeIn 0.3s ease-in-out;
  position: relative;
} 
/* 表单控件 */
.form-group {
  margin-bottom: 14px;
}

.form-section {
  width: 100%;
  padding: 16px 0;
  margin-bottom: 0;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.form-section:last-child {
  border-bottom: none;
}

.form-section .form-group:last-child {
  margin-bottom: 0;
}

.section-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin: 0 0 16px 0;
  font-size: 14px;
  font-weight: 600;
  color: #1d1d1f;
}

.section-title {
  color: inherit;
}

label {
  display: block;
  font-size: 14px;
  font-weight: 500;
  color: #1d1d1f;
}

.row-layout label {
  flex: 0 0 auto;
  margin: 0 16px 0 0;
  min-width: 70px;
  width: 25%;
  max-width: 90px;
}

.non-interactive-label {
  pointer-events: none;
  cursor: default;
}

/* 输入控件 */
input[type="number"], 
input[type="color"], 
input[type="text"], 
.text-input, 
.text-area {
  width: 100%;
  padding: 10px 12px;
  font-size: 14px;
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  background-color: #ffffff;
  transition: all 0.2s;
  appearance: none;
  -webkit-appearance: none;
}

.text-area {
  min-height: 80px;
  resize: vertical;
  font-family: inherit;
  line-height: 1.5;
}

input:focus, .text-input:focus, .text-area:focus {
  outline: none;
  border-color: #0071e3;
  box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.2);
}

/* 颜色选择器 */
.color-input-group {
  display: flex;
  align-items: center;
  min-width: 120px;
  flex: 1;
}

input[type="color"] {
  width: 24px;
  height: 24px;
  padding: 0;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

input.color-value {
  margin-left: 8px;
  font-size: 13px;
  color: #666;
  width: 80px;
  padding: 4px 8px;
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 4px;
  background-color: #ffffff;
}

/* 下拉选择器 */
.dropdown-selector {
  position: relative;
  min-width: 120px;
  max-width: 140px;
  z-index: 10;
}

.dropdown-selector-wide {
  position: relative;
  min-width: 180px;
  max-width: 200px;
  z-index: 10;
  flex: 1;
  min-width: 200px;
  max-width: 100%;
}

.dropdown-selector-wide .section-dropdown {
  width: 100%;
}

.section-dropdown {
  appearance: none;
  -webkit-appearance: none;
  padding: 10px 12px;
  border-radius: 8px;
  border: 1px solid rgba(0, 0, 0, 0.1);
  font-family: inherit;
  font-size: 14px;
  font-weight: 500;
  color: #1d1d1f;
  background-color: #ffffff;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: none;
  min-height: 44px;
  box-sizing: border-box;
}

.section-dropdown:focus {
  outline: none;
  border-color: #0071e3;
  box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.2);
}

.section-dropdown:hover {
  border-color: rgba(0, 0, 0, 0.2);
} 
/* 按钮和控件 */
button {
  padding: 10px 20px;
  font-size: 14px;
  font-weight: 500;
  border-radius: 8px;
  border: none;
  cursor: pointer;
  transition: all 0.2s;
}

.control-btn {
  width: 22px;
  height: 22px;
  border-radius: 50%;
  border: 1px solid #e5e5e5;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0;
  font-size: 14px;
  color: #86868b;
  cursor: pointer;
  transition: all 0.2s;
  background-color: transparent;
}

.control-btn:hover {
  background-color: #f5f5f7;
}

.collapse-btn {
  transition: transform 0.3s ease, background-color 0.2s, border-color 0.2s, color 0.2s;
}

.collapse-btn svg, .chevron-icon {
  color: inherit;
  fill: currentColor;
  stroke: currentColor;
  transition: transform 0.3s ease;
}

.collapse-btn.collapsed svg,
.collapse-btn.collapsed .chevron-icon {
  transform: rotate(180deg);
}

.collapse-btn.collapsed {
  transform: rotate(180deg);
}

.add-btn {
  margin-right: 6px;
  font-size: 14px;
  font-weight: 500;
  line-height: 1;
}

.add-btn:hover {
  background-color: rgba(0, 113, 227, 0.1);
  border-color: #0071e3;
  color: #0071e3;
}

.add-btn[onclick*="removeModule"]:hover {
  background-color: rgba(255, 59, 48, 0.1);
  border-color: #ff3b30;
  color: #ff3b30;
}

/* 创建按钮 */
.create-btn-container {
  display: flex;
  justify-content: center;
  padding: 0 0 24px 0;
  width: 100%;
  margin: 0 auto;
}

.button-group {
  display: flex;
  gap: 12px;
  margin-top: 24px;
  justify-content: center;
  width: 100%;
  max-width: 320px;
}

button#create {
  background-color: #0071e3;
  color: white;
  min-width: 120px;
}

button#create:hover {
  background-color: #0077ed;
  transform: translateY(-1px);
  box-shadow: 0 2px 5px rgba(0, 113, 227, 0.2);
}

button#reset {
  background-color: #f5f5f7;
  color: #1d1d1f;
  min-width: 120px;
  border: 1px solid rgba(0, 0, 0, 0.1);
}

button#reset:hover {
  background-color: #e8e8ed;
  transform: translateY(-1px);
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

button#cancel {
  background-color: #f5f5f7;
  color: #1d1d1f;
}

button#cancel:hover {
  background-color: #e8e8ed;
}

.action-btn {
  background-color: #0071e3;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 20px;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.2s;
}

.action-btn:hover {
  background-color: #0077ed;
  transform: translateY(-1px);
}

.add-module-btn {
  min-width: 150px;
}

.wide-btn {
  width: 100% !important;
  min-width: 150px;
}

/* 主题切换按钮 */
.theme-btn {
  padding: 8px 16px;
  background-color: #ffffff;
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  color: #1d1d1f;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  display: flex;
  align-items: center;
  gap: 6px;
}

.theme-btn:hover {
  background-color: rgba(0, 113, 227, 0.1);
  border-color: #0071e3;
}

.theme-btn.active {
  background-color: #0071e3;
  color: #ffffff;
  border-color: #0071e3;
} 
/* 上传和预览组件 */
.file-upload-btn, 
.img-upload-wrapper {
  flex: 1;
  width: 100%;
}

.upload-btn {
  width: 100%;
  height: 60px;
  padding: 0;
  background-color: #f5f5f7;
  border: 1px dashed rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  color: #666;
  cursor: pointer;
  font-size: 14px;
  text-align: center;
  transition: all 0.2s;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.upload-btn:hover {
  background-color: #efefef;
  border-color: rgba(0, 0, 0, 0.2);
}

.upload-btn .img-preview-inline {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  border-radius: 8px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #fafafa;
}

.upload-btn .img-preview-inline img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  border-radius: 8px;
}

.upload-btn .img-preview-inline .upload-icon-inline {
  font-size: 20px;
  color: #86868b;
}

/* 图片预览 */
.img-preview-inline, 
.preview-container {
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0;
  left: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

.img-preview-inline {
  pointer-events: none;
  border-radius: 8px;
}

.img-preview-inline img, 
.preview-container img, 
.img-preview-container img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  border-radius: 8px;
}

.img-preview-btn {
  width: 100%;
  cursor: pointer;
  display: flex;
  justify-content: flex-start;
}

.img-preview-container {
  width: 80px;
  height: 80px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #f5f5f7;
  border: 1px dashed rgba(0, 0, 0, 0.2);
  position: relative;
  overflow: hidden;
  transition: all 0.2s;
}

.img-preview-container:hover {
  background-color: #efefef;
  border-color: rgba(0, 0, 0, 0.3);
}

.upload-icon, .upload-icon-text, .upload-icon-inline {
  font-size: 20px;
  color: #86868b;
}

.upload-icon {
  position: absolute;
  z-index: 1;
}

.upload-icon-text, .upload-icon-inline {
  font-size: 24px;
}

/* 图片上传容器 */
.img-upload-container {
  display: flex;          /* 使用弹性布局 */
  flex-direction: column; /* 设置主轴方向为垂直 */
  align-items: center;    /* 在交叉轴上居中对齐项目 */
  width: 100%;           /* 确保容器占满父元素宽度 */
}

/* 网格按钮样式 */
.grid-btn {
  width: 100%;                          /* 设置宽度为100% */
  aspect-ratio: 1/1;                    /* 设置宽高比为1:1，保持正方形 */
  display: flex;                        /* 使用弹性布局 */
  align-items: center;                  /* 垂直居中对齐 */
  justify-content: center;              /* 水平居中对齐 */
  background-color: #f5f5f7;            /* 设置背景颜色 */
  border: 1px dashed rgba(0, 0, 0, 0.2);/* 设置虚线边框 */
  border-radius: 6px;                   /* 设置圆角 */
  cursor: pointer;                      /* 鼠标悬停时显示手型光标 */
  position: relative;                   /* 设置相对定位 */
  overflow: hidden;                     /* 隐藏溢出内容 */
  padding: 0;                           /* 移除内边距 */
  transition: all 0.2s;                 /* 添加过渡效果 */
  box-sizing: border-box;               /* 包含边框在内的盒模型 */
}

.grid-btn:hover {
  background-color: #efefef;
  border-color: rgba(0, 0, 0, 0.3);
}

/* 自定义布局下的网格按钮 */
.prize-grid-custom .grid-btn {
  width: 100%;
  height: auto;
  aspect-ratio: 1/1;
  max-width: 100%;
  max-height: none;
  min-height: 50px;
} 
/* 模块管理相关样式 */
.module-management {
  margin-bottom: 20px;
}

/* 模块列表头部样式 */
.module-list-header {
  display: flex;                                /* 使用弹性布局 */
  justify-content: space-between;                /* 两端对齐 */
  align-items: center;                           /* 垂直居中对齐 */
  margin: 24px 0 12px 0;                         /* 设置上下外边距 */
  padding-bottom: 8px;                           /* 底部内边距 */
  font-weight: 600;                              /* 字体加粗 */
}

.module-count {
  font-size: 14px;
  color: #86868b;
  font-weight: normal;
}

.module-action-row {
  justify-content: center;
  margin-top: 10px;
}

.empty-modules-message {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 20px;
  text-align: center;
  color: #86868b;
  border: 2px dashed rgba(0,0,0,0.1);
  border-radius: 10px;
  margin: 20px 0;
}

.empty-modules-message svg {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-modules-message p {
  margin: 5px 0;
  font-size: 16px;
}

.empty-modules-message .hint-text {
  font-size: 14px;
  opacity: 0.7;
}

/* 模块相关样式 */
.module {
  border: 1px solid rgba(0,0,0,0.1);
  border-radius: 10px;
  margin-bottom: 16px;
  background-color: #ffffff;
  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  overflow: hidden;
  transition: all 0.3s ease;
}

.module-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px 16px;
  background-color: #f5f5f7;
  border-bottom: 1px solid rgba(0,0,0,0.05);
}

.module-title {
  font-weight: 600;
  font-size: 16px;
  color: #1d1d1f;
  font-size: 14px;
  font-weight: 600;
  color: #1d1d1f;
  margin-right: 4px;
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.module-controls {
  display: flex;
  gap: 8px;
}

.module-content {
  padding: 16px;
  transition: max-height 0.3s ease, opacity 0.2s ease;
}

.module-collapsed .module-content {
  max-height: 0;
  opacity: 0;
  padding: 0 16px;
  overflow: hidden;
}

.module-collapsed .collapse-btn i {
  transform: rotate(180deg);
}

.module-collapsed .collapse-btn svg,
.module-collapsed .collapse-btn .chevron-icon {
  transform: rotate(180deg);
}

.option-controls {
  display: flex;
  align-items: center;
}

/* 折叠内容区域 */
.version-content {
  max-height: 0;
  opacity: 0;
  overflow: hidden;
  transition: all 0.3s cubic-bezier(0.645, 0.045, 0.355, 1);
  padding-left: 24px;
}

.version-content.active {
  max-height: 800px;
  opacity: 1;
  padding-bottom: 15px;
}

.collapsible-content {
  max-height: 1000px;
  opacity: 1;
  overflow: hidden;
  transition: max-height 0.3s ease, opacity 0.3s ease;
}

.collapsible-content.collapsed {
  max-height: 0;
  opacity: 0;
}

/* 奖品网格 */
.prize-grid {
  display: flex;          /* 使用弹性布局 */
  flex-wrap: wrap;        /* 允许项目换行 */
  justify-content: space-between; /* 项目之间平均分配空间 */
  gap: 8px;               /* 设置网格项之间的间隙 */
  margin-top: 10px;       /* 顶部外边距 */
}

/* 自定义奖品网格布局 */
.prize-grid-custom {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 10px;
  width: 100%;
  max-width: 100%;
  overflow: hidden;
}

.prize-row {
  display: flex;
  align-items: center;
  width: 100%;
  max-width: 100%;
}

.prize-row.top-row {
  /* 第一行：3个奖品，均匀分布 */
  justify-content: space-between;
}

.prize-row.middle-row {
  /* 第二行：2个奖品，左右对齐 */
  justify-content: space-between;
}

.prize-row.bottom-row {
  /* 第三行：3个项目，均匀分布 */
  justify-content: space-between;
}

/* 网格项样式 */
.grid-item {
  flex: 0 0 calc(33.333% - 6px); /* 设置网格项宽度为33.333%（减去间隙），不允许伸缩 */
}

/* 自定义布局下的网格项 */
.prize-grid-custom .grid-item {
  display: flex;
  flex-direction: column;
  align-items: center;
}

/* 第一行和第三行的项目：每个占33.33%宽度 */
.prize-row.top-row .grid-item,
.prize-row.bottom-row .grid-item {
  flex: 0 0 calc(33.333% - 4px);
  max-width: calc(33.333% - 4px);
}

/* 第二行的项目：每个也占33.33%宽度，但只有两个 */
.prize-row.middle-row .grid-item {
  flex: 0 0 calc(33.333% - 4px);
  max-width: calc(33.333% - 4px);
}

.prize-label {
  margin-top: 4px;
  font-size: 11px;
  color: #86868b;
  text-align: center;
  width: 100%;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.2;
}
/* 渠道设置视图样式 */
.channel-settings-view {
  padding: 20px;
}

.settings-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.back-btn {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px 12px;
  background-color: transparent;
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  color: #1d1d1f;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
}

.back-btn:hover {
  background-color: rgba(0, 0, 0, 0.05);
}

.settings-title {
  font-size: 24px;
  font-weight: 600;
  color: #1d1d1f;
  margin: 0;
  text-align: center;
  flex: 1;
}

.settings-content {
  max-width: 1200px;
}

.setting-group {
  margin-bottom: 32px;
}

.setting-group:last-child {
  margin-bottom: 0;
}

.setting-group-title {
  font-size: 18px;
  font-weight: 600;
  color: #1d1d1f;
  margin-bottom: 16px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
  padding-bottom: 8px;
}

.setting-item {
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  gap: 20px;
  margin-bottom: 20px;
  padding: 16px;
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  background-color: #fafafa;
}

.setting-item:last-child {
  margin-bottom: 0;
}

.setting-header {
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  gap: 4px;
  flex: 1;
  min-width: 0;
}

.setting-main {
  display: flex;
  align-items: center;
  justify-content: center;
  flex: 1;
  min-width: 0;
}

.setting-main .setting-input {
  max-width: 300px;
}

.setting-footer {
  display: flex;
  align-items: center;
  justify-content: flex-start;
}

.setting-label {
  display: block;
  font-size: 14px;
  font-weight: 500;
  color: #1d1d1f;
  margin-bottom: 8px;
}

.setting-input {
  width: 100%;
  padding: 12px 16px;
  font-size: 14px;
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  background-color: #ffffff;
  transition: all 0.2s;
}

.setting-input:focus {
  outline: none;
  border-color: #0071e3;
  box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.2);
}

.setting-textarea {
  min-height: 80px;
  resize: vertical;
}

.setting-upload-group {
  display: flex;
  flex-direction: column;
  gap: 12px;
  align-items: center;
}

.setting-upload-btn {
  padding: 10px 16px;
  background-color: #f5f5f7;
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  color: #1d1d1f;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
}

.setting-upload-btn:hover {
  background-color: #e8e8ed;
}

.setting-preview {
  width: 120px;
  height: 80px;
  border: 2px dashed rgba(0, 0, 0, 0.2);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #ffffff;
  overflow: hidden;
  transition: all 0.2s ease;
}

.setting-preview.clickable-upload {
  cursor: pointer;
  border-color: #0071e3;
  background-color: #f0f8ff;
}

.setting-preview.clickable-upload:hover {
  border-color: #005bb5;
  background-color: #e6f3ff;
  transform: translateY(-1px);
  box-shadow: 0 2px 8px rgba(0, 113, 227, 0.2);
}

.setting-preview img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 6px;
  cursor: pointer;
}

.setting-preview-placeholder {
  font-size: 12px;
  color: #86868b;
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

.upload-icon {
  font-size: 20px;
  opacity: 0.7;
}

.upload-text {
  font-size: 11px;
  font-weight: 500;
}

.setting-description {
  font-size: 12px;
  color: #86868b;
  margin-top: 4px;
  line-height: 1.4;
}

/* 渠道容器样式 */
.channels-container {
  padding: 16 0;
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.channel-section {
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 10px;
  padding: 16px;
  background-color: #ffffff;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
  transition: all 0.3s ease;
}

.channel-section:hover {
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
}

.channel-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
  padding-bottom: 8px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

.channel-title {
  margin: 0;
  font-size: 16px;
  font-weight: 600;
  color: #1d1d1f;
  flex: 1;
}

.channel-settings-btn {
  width: 32px;
  height: 32px;
  background-color: transparent;
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 6px;
  color: #666;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  flex-shrink: 0;
  margin-left: 12px;
  position: relative;
  font-size: 14px;
  line-height: 1;
}

.channel-settings-btn:hover {
  background-color: #f5f5f7;
  border-color: #0071e3;
  color: #0071e3;
  transform: scale(1.05);
}

.channel-content {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.channel-preview-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.channel-preview-area {
  width: 100%;
  height: 140px;
  border: 2px dashed rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #f5f5f7;
  position: relative;
  transition: all 0.2s;
}

.channel-preview-area:hover {
  border-color: rgba(0, 0, 0, 0.2);
  background-color: #efefef;
}

.channel-preview-placeholder {
  color: #86868b;
  font-size: 14px;
  text-align: center;
  font-weight: 500;
}

.channel-preview-btn {
  background-color: #f5f5f7;
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  padding: 8px 16px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  color: #1d1d1f;
  transition: all 0.2s;
}

.channel-preview-btn:hover {
  background-color: #e8e8ed;
  border-color: rgba(0, 0, 0, 0.2);
}

.channel-generate-btn-group {
  display: flex;
  gap: 20px; /* 按钮间距可调整 */
  justify-content: center; /* 或 center/right/flex-start 根据需求 */
  margin-top: 10px; /* 可选：与上方内容间距 */
}

.channel-generate-btn {
  background-color: #0071e3;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 10px 20px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  transition: all 0.2s;
  min-width: 120px;
}

.channel-generate-btn:hover {
  background-color: #0077ed;
  transform: translateY(-1px);
  box-shadow: 0 2px 5px rgba(0, 113, 227, 0.2);
}

.channel-generate-btn:disabled {
  background-color: #86868b;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
} 
/* 工具集专属tab内容区布局修正（终极版） */
.tools-tab-content {
  padding: 0 !important;
  margin: 0 !important;
  background: none !important;
  width: 100%;
  height: 100%;
  min-width: 0;
  min-height: 0;
  overflow: visible !important;
  display: none; /* 默认隐藏tab内容 */
}

/* 激活状态的tab内容样式 */
.tools-tab-content.active {
  display: flex !important; /* 激活时显示为flex布局 */
  flex-direction: row;
  height: 100%;
  min-height: 0;
  width: 100%;
}

/* 工具面板容器 */
.tools-panel {
  display: flex;                /* 使用弹性布局 */
  flex-direction: row;          /* 设置主轴方向为水平 */
  height: 100%;                 /* 高度占满父容器 */
  min-height: 0;                /* 最小高度为0，允许内容溢出 */
  width: 100%;                  /* 宽度占满父容器 */
  max-width: 100%;              /* 最大宽度不超过父容器 */
  overflow: hidden;             /* 隐藏溢出内容 */
  background: var(--panel-bg);  /* 使用自定义背景颜色变量 */
  border-radius: 6px;           /* 设置圆角为6像素 */
  margin-top: 25;               /* 顶部外边距为25像素 */
}

/* 工具面板侧边栏 */
.tools-panel__sidebar {
  flex-shrink: 0;                /* 禁止侧边栏缩小 */
  width: 80px;                   /* 设置侧边栏宽度为80像素 */
  background: var(--panel-sidebar-bg);  /* 使用自定义侧边栏背景颜色变量 */
  border-right: 1px solid var(--panel-sidebar-border);  /* 添加右侧边框 */
  display: flex;                 /* 使用弹性布局 */
  flex-direction: column;        /* 设置主轴方向为垂直 */
  overflow: hidden;              /* 隐藏溢出内容 */
}

/* 工具菜单列表 */
.tools-menu {
  list-style: none;              /* 移除列表项的默认样式 */
  margin: 0;                     /* 移除外边距 */
  padding: 8px 0;                /* 设置上下内边距为8像素，左右为0 */
}

/* 工具菜单项 */
.tools-menu__item {
  display: flex;                /* 使用弹性布局 */
  align-items: center;          /* 垂直居中对齐 */
  padding: 20px 4px;            /* 设置内边距，上下20px，左右4px */
  cursor: pointer;              /* 鼠标悬停时显示手型光标 */
  color: var(--panel-menu-color); /* 使用自定义菜单项文字颜色变量 */
  transition: background 0.2s, color 0.2s; /* 添加背景和颜色的过渡效果 */
  font-size: 12px;              /* 设置字体大小为12像素 */
  flex-direction: column;       /* 将子元素垂直排列 */
  text-align: center;           /* 文本居中对齐 */
  gap: 10px;                    /* 设置子元素之间的间距为10像素 */
}

/* 活动状态和悬停状态的工具菜单项 */
.tools-menu__item--active,
.tools-menu__item:hover {
  background: var(--panel-menu-hover-bg);    /* 设置悬停或活动状态的背景颜色 */
  color: var(--panel-menu-hover-color);      /* 设置悬停或活动状态的文字颜色 */
}

/* 工具菜单图标 */
.tools-menu__icon {
  margin-right: 0;              /* 移除右侧外边距 */
  font-size: clamp(22px, 60%, 38px); /* 最小22px，最大38px，60%为自适应 */
  margin-bottom: 1px;           /* 底部外边距1像素 */
  display: block;               /* 设置为块级元素 */
  text-align: center;           /* 文本居中对齐 */
  line-height: 1;               /* 行高设置为1，确保图标垂直居中 */
}

/* 工具菜单标签 */
.tools-menu__label {
  font-size: 12px;      /* 设置字体大小为12像素 */
  font-weight: bold;    /* 设置字体为粗体 */
  line-height: 1.3;     /* 设置行高为1.3倍字体大小 */
  word-break: break-all; /* 允许在任意字符间断行 */
  white-space: normal;  /* 允许正常的空白字符处理和换行 */
  max-width: 75px;      /* 设置最大宽度为75像素 */
  text-align: center;   /* 文本居中对齐 */
  color: var(--panel-menu-color); /* 使用自定义菜单颜色变量 */
}

/* 工具面板内容区域 */
.tools-panel__content {
  flex: 1 1 0%;                    /* 允许内容区域灵活增长和收缩，但初始大小为0 */
  min-width: 0;                    /* 最小宽度为0，防止内容溢出 */
  min-height: 0;                   /* 最小高度为0，防止内容溢出 */
  max-width: calc(100% - 85px);    /* 最大宽度为容器宽度减去85像素（可能是侧边栏宽度） */
  overflow: auto;                  /* 内容溢出时显示滚动条 */
  display: flex;                   /* 使用弹性布局 */
  flex-direction: column;          /* 子元素垂直排列 */
  margin-top: 15;                  /* 顶部外边距为25像素 */
}

/* 工具卡片样式 */
.tool-card {
  display: none;                /* 默认隐藏工具卡片 */
  background: transparent;      /* 设置背景为透明 */
  border-radius: 0;             /* 移除边框圆角 */
  padding: 16px 20px;           /* 设置内边距，上下16px，左右20px */
  box-shadow: none;             /* 移除阴影效果 */
  width: 100%;                  /* 宽度占满父容器 */
  max-width: none;              /* 移除最大宽度限制 */
  margin: 0;                    /* 移除外边距 */
}

/* 活动状态的工具卡片 */
.tool-card--active {
  display: block;               /* 显示活动状态的工具卡片 */
}

/* 图像编辑器头部样式 */
.image-editor__header {
  display: flex;                /* 使用弹性布局 */
  justify-content: flex-start;  /* 子元素从起始位置开始排列 */
  margin-bottom: 20px;          /* 底部外边距20像素 */
  gap: 5px;                     /* 子元素之间的间隔为5像素 */
  flex-wrap: wrap;              /* 允许子元素在需要时换行 */
  align-items: center;          /* 垂直居中对齐子元素 */
}

.image-editor__preview-container {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.image-editor__preview-area {
  width: 100%;
  height: 140px;
  border: 2px dashed rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: #f5f5f7;
  position: relative;
  transition: all 0.2s;
  margin-bottom: 20px;
}

.image-editor__preview-area:hover {
  border-color: rgba(0, 0, 0, 0.2);
  background-color: #efefef;
}

.image-editor__preview-placeholder {
  color: #86868b;
  font-size: 14px;
  text-align: center;
  font-weight: 500;
}

.image-editor__preview-btn {
  background-color: #f5f5f7;
  border: 1px solid rgba(0, 0, 0, 0.1);
  border-radius: 8px;
  padding: 8px 16px;
  cursor: pointer;
  font-size: 48px;
  font-weight: 500;
  color: #1d1d1f;
  transition: all 0.2s;
}

.image-editor__preview-btn:hover {
  background-color: #e8e8ed;
  border-color: rgba(0, 0, 0, 0.2);
}

/* 图像编辑器画布样式 */
.image-editor__canvas {
  max-width: 100%;              /* 设置最大宽度为100%，确保不超过父容器 */
  max-height: 100%;             /* 设置最大高度为100%，确保不超过父容器 */
  display: block;               /* 将画布设置为块级元素 */
  margin: 0 auto;               /* 水平居中画布 */
  background: transparent;      /* 设置背景为透明 */
}

/* 图像编辑器控件容器样式 */
.image-editor__controls {
  margin-bottom: 10px;          /* 设置底部外边距为10像素，与其他元素保持间距 */
}

/* 图像编辑器模式切换容器样式 */
.image-editor__mode-switch {
  display: flex;                /* 使用弹性布局 */
  gap: 16px;                    /* 设置子元素之间的间距为16像素 */
  margin-bottom: 12px;          /* 底部外边距12像素 */
  align-items: center;          /* 垂直居中对齐子元素 */
}

/* 图像编辑器单选按钮样式 */
.image-editor__radio {
  display: flex;                /* 使用弹性布局 */
  align-items: center;          /* 垂直居中对齐子元素 */
  cursor: pointer;              /* 鼠标悬停时显示指针样式 */
  font-size: 13px;              /* 设置字体大小为13像素 */
  color: var(--primary-color, #2563eb);  /* 使用主色变量，默认为蓝色 */
  position: relative;           /* 设置相对定位 */
  -webkit-user-select: none;    /* 禁止WebKit浏览器中的文本选择 */
  user-select: none;            /* 禁止文本选择 */
  margin-right: 10px;           /* 右侧外边距10像素 */
}

/* 图像编辑器单选按钮输入样式 */
.image-editor__radio input[type="radio"] {
  opacity: 0;                   /* 设置透明度为0，隐藏原生单选按钮 */
  position: absolute;           /* 绝对定位 */
  left: 0;                      /* 左对齐 */
  top: 0;                       /* 顶部对齐 */
  width: 20px;                  /* 设置宽度为20像素 */
  height: 20px;                 /* 设置高度为20像素 */
  margin: 0;                    /* 移除外边距 */
  z-index: 2;                   /* 设置z-index为2，确保可点击 */
  cursor: pointer;              /* 鼠标悬停时显示指针样式 */
}

/* 自定义单选按钮样式 */
.image-editor__radio-custom {
  width: 16px;                  /* 设置宽度为16像素 */
  height: 16px;                 /* 设置高度为16像素 */
  border: 1px solid var(--primary-color, #2563eb);  /* 设置1像素实线边框，颜色使用主色变量或默认蓝色 */
  border-radius: 50%;           /* 设置边框为圆形 */
  margin-right: 8px;            /* 右侧外边距8像素 */
  background: #fff;             /* 背景色设为白色 */
  display: inline-block;        /* 设置为行内块级元素 */
  position: relative;           /* 相对定位 */
  transition: border-color 0.2s, background 0.2s;  /* 添加边框颜色和背景色的过渡效果 */
  flex-shrink: 0;               /* 防止在flex容器中缩小 */
}

/* 选中状态的单选按钮样式 */
.image-editor__radio input[type="radio"]:checked + .image-editor__radio-custom {
  border-color: var(--primary-color, #2563eb);  /* 设置选中状态的边框颜色，使用主色变量或默认蓝色 */
  background: var(--primary-color, #2563eb);    /* 设置选中状态的背景颜色，使用主色变量或默认蓝色 */
}

/* 单选按钮获得焦点时的自定义样式 */
.image-editor__radio input[type="radio"]:focus + .image-editor__radio-custom {
  outline: 2px solid #2563eb;  /* 添加2像素宽的蓝色实线轮廓，提高可访问性和视觉反馈 */
}

/* 图像编辑器滑块组样式 */
.image-editor__slider-group {
  display: flex;                /* 使用弹性布局 */
  flex-direction: column;       /* 设置主轴方向为垂直方向 */
  align-items: stretch;         /* 子元素在交叉轴方向上被拉伸以填满容器 */
  margin-bottom: 18px;          /* 底部外边距18像素，与其他元素保持间距 */
}

/* 图像编辑器滑块组标签样式 */
.image-editor__slider-group label {
  font-size: 13px;              /* 设置字体大小为13像素 */
  margin-bottom: 6px;           /* 底部外边距6像素，与滑块保持间距 */
  font-weight: normal;          /* 设置字体粗细为正常 */
  color: var(--editor-slider-label); /* 使用自定义变量设置标签颜色 */
}

/* 图像编辑器滑块样式 */
.image-editor__slider {
  width: 100%;                  /* 设置滑块宽度为100% */
  height: 3px;                  /* 设置滑块高度为3像素 */
  margin: 0;                    /* 移除外边距 */
  background: var(--editor-slider-track, #e0e0e0);  /* 设置滑块轨道背景色，使用自定义变量或默认灰色 */
  border-radius: 2px;           /* 设置边框圆角为2像素 */
  outline: none;                /* 移除焦点时的轮廓 */
  accent-color: var(--editor-slider-thumb, #2563eb);  /* 设置滑块拇指颜色，使用自定义变量或默认蓝色 */
  -webkit-appearance: none;     /* 移除WebKit浏览器的默认样式 */
  appearance: none;             /* 移除默认外观样式 */
}

/* 图像编辑器滑块拇指（WebKit浏览器）样式 */
.image-editor__slider::-webkit-slider-thumb {
  width: 16px;                  /* 设置拇指宽度为16像素 */
  height: 16px;                 /* 设置拇指高度为16像素 */
  border-radius: 50%;           /* 设置边框圆角为50%，使其呈现为圆形 */
  background: var(--editor-slider-thumb, #2563eb);  /* 设置背景色，使用自定义变量或默认蓝色 */
  border: 2px solid #fff;       /* 添加2像素宽的白色实线边框 */
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);  /* 添加轻微阴影效果 */
  cursor: pointer;              /* 鼠标悬停时显示指针样式 */
  transition: background 0.2s;  /* 添加背景色变化的过渡效果 */
  -webkit-appearance: none;     /* 移除WebKit浏览器的默认样式 */
  appearance: none;             /* 移除默认外观样式 */
  margin-top: -6.5px;           /* 调整拇指垂直位置，使其居中对齐 */
}

/* 图像编辑器滑块拇指获得焦点时的样式（WebKit浏览器） */
.image-editor__slider:focus::-webkit-slider-thumb {
  outline: 2px solid #2563eb;   /* 添加2像素宽的蓝色实线轮廓，提高可访问性和视觉反馈 */
}

/* 图像编辑器滑块拇指（Mozilla Firefox浏览器）样式 */
.image-editor__slider::-moz-range-thumb {
  width: 16px;                  /* 设置拇指宽度为16像素 */
  height: 16px;                 /* 设置拇指高度为16像素 */
  border-radius: 50%;           /* 设置边框圆角为50%，使其呈现为圆形 */
  background: var(--editor-slider-thumb, #2563eb);  /* 设置背景色，使用自定义变量或默认蓝色 */
  border: 2px solid #fff;       /* 添加2像素宽的白色实线边框 */
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);  /* 添加轻微阴影效果 */
  cursor: pointer;              /* 鼠标悬停时显示指针样式 */
  -moz-appearance: none;        /* 移除Firefox浏览器的默认样式 */
  appearance: none;             /* 移除默认外观样式 */
}

/* 图像编辑器滑块拇指（Microsoft Internet Explorer浏览器）样式 */
.image-editor__slider::-ms-thumb {
  width: 16px;                  /* 设置拇指宽度为16像素 */
  height: 16px;                 /* 设置拇指高度为16像素 */
  border-radius: 50%;           /* 设置边框圆角为50%，使其呈现为圆形 */
  background: var(--editor-slider-thumb, #2563eb);  /* 设置背景色，使用自定义变量或默认蓝色 */
  border: 2px solid #fff;       /* 添加2像素宽的白色实线边框 */
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);  /* 添加轻微阴影效果 */
  cursor: pointer;              /* 鼠标悬停时显示指针样式 */
}

/* 图像编辑器滑块轨道（WebKit浏览器）样式 */
.image-editor__slider::-webkit-slider-runnable-track {
  height: 3px;                  /* 设置轨道高度为3像素 */
  border-radius: 2px;           /* 设置边框圆角为2像素 */
  background: var(--editor-slider-track, #e0e0e0);  /* 设置背景色，使用自定义变量或默认浅灰色 */
}

/* 图像编辑器滑块填充区域（Microsoft Internet Explorer浏览器）样式 */
.image-editor__slider::-ms-fill-lower,
.image-editor__slider::-ms-fill-upper {
  background: var(--editor-slider-track, #e0e0e0);  /* 设置填充区域背景色，使用自定义变量或默认浅灰色 */
  border-radius: 2px;                               /* 设置边框圆角为2像素 */
}

/* 图像编辑器滑块获得焦点时的样式 */
.image-editor__slider:focus {
  outline: none;                /* 移除默认的焦点轮廓，保持滑块外观的一致性 */
}

/* 图像编辑器操作按钮容器样式 */
.image-editor__actions {
  display: flex;                /* 使用弹性布局 */
  justify-content: flex-end;    /* 将内容对齐到容器的右端 */
  gap: 6px;                     /* 设置子元素之间的间距为6像素 */
}

/* 图像编辑器重置和确认按钮的通用样式 */
.image-editor__reset-btn,
.image-editor__confirm-btn {
  font-size: 14px;              /* 设置字体大小为14像素 */
  height: 36px;                 /* 设置按钮高度为36像素 */
  padding: 0 24px;              /* 设置内边距，左右各24像素，上下为0 */
  min-width: 80px;              /* 设置最小宽度为80像素 */
  border-radius: 6px;           /* 设置边框圆角为6像素 */
  border: none;                 /* 移除边框 */
  cursor: pointer;              /* 鼠标悬停时显示指针样式 */
  transition: background 0.2s, color 0.2s;  /* 添加背景色和文字颜色的过渡效果，持续0.2秒 */
}

.image-editor__reset-btn {
  background: var(--editor-reset-bg);
  color: var(--editor-reset-color);
}

.image-editor__reset-btn:hover {
  background: var(--editor-reset-hover-bg);
  color: var(--editor-reset-hover-color);
}

.image-editor__confirm-btn {
  background: var(--editor-confirm-bg);
  color: #fff;
}

.image-editor__confirm-btn:hover {
  background: var(--editor-confirm-hover-bg);
}

.image-editor__actions--centered {
  justify-content: center !important;
  margin-top: 24px;
  margin-bottom: 8px;
}

/* 深色主题样式 */
body.dark-theme {
  color: #f5f5f7;
  background-color: #1d1d1f;
  --panel-bg: #232323;
  --panel-sidebar-bg: #181818;
  --panel-sidebar-border: #2c2c2c;
  --panel-menu-color: #bbb;
  --panel-menu-hover-bg: #282828;
  --panel-menu-hover-color: #fff;
  --tool-card-bg: #222;
  --tool-card-shadow: 0 2px 8px rgba(0,0,0,0.08);
  --editor-preview-bg: #111;
  --editor-placeholder-color: #666;
  --editor-slider-label: #aaa;
  --editor-slider-track: #48484a;
  --editor-slider-thumb: #4f8cff;
  --editor-reset-bg: #333;
  --editor-reset-color: #bbb;
  --editor-reset-hover-bg: #444;
  --editor-reset-hover-color: #fff;
  --editor-confirm-bg: #4f8cff;
  --editor-confirm-hover-bg: #357ae8;
}

/* 标签页深色主题 */
body.dark-theme .tab-container {
  background-color: rgba(30, 30, 32, 0.72);
  border-bottom-color: rgba(255, 255, 255, 0.1);
}

body.dark-theme .tab:hover {
  background-color: rgba(255, 255, 255, 0.05);
}

body.dark-theme .tab-content {
  background-color: #1d1d1f;
}

/* 表单深色主题 */
body.dark-theme .form-section,
body.dark-theme .module {
  border-bottom-color: rgba(255, 255, 255, 0.1);
}

body.dark-theme .section-header,
body.dark-theme .section-title,
body.dark-theme label,
body.dark-theme .module-title {
  color: #f5f5f7;
}

body.dark-theme input[type="number"],
body.dark-theme input[type="text"],
body.dark-theme .text-input,
body.dark-theme .text-area {
  background-color: #2c2c2e;
  border-color: rgba(255, 255, 255, 0.1);
  color: #f5f5f7;
}

body.dark-theme input:focus,
body.dark-theme .text-input:focus,
body.dark-theme .text-area:focus {
  border-color: #0071e3;
  box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.15);
}

body.dark-theme .section-dropdown {
  background-color: #2c2c2e;
  border-color: rgba(255, 255, 255, 0.1);
  color: #f5f5f7;
}

body.dark-theme .section-dropdown:focus {
  border-color: #0071e3;
  box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.15);
}

body.dark-theme .section-dropdown:hover {
  border-color: rgba(255, 255, 255, 0.2);
}

/* 上传组件深色主题 */
body.dark-theme .upload-btn,
body.dark-theme .grid-btn,
body.dark-theme .img-preview-container,
body.dark-theme .add-btn,
body.dark-theme .theme-btn:not(.active),
body.dark-theme button#cancel {
  background-color: #2c2c2e;
  border-color: rgba(255, 255, 255, 0.1);
  color: #f5f5f7;
}

body.dark-theme .upload-btn:hover,
body.dark-theme .grid-btn:hover,
body.dark-theme .img-preview-container:hover,
body.dark-theme .theme-btn:hover:not(.active),
body.dark-theme button#cancel:hover {
  background-color: #3a3a3c;
  border-color: rgba(255, 255, 255, 0.2);
}

body.dark-theme .upload-btn .img-preview-inline {
  background-color: #1c1c1e;
}

body.dark-theme .upload-btn .img-preview-inline .upload-icon-inline {
  color: #a1a1a6;
}

/* 控件深色主题 */
body.dark-theme .control-btn {
  border-color: #3a3a3c;
  color: #a1a1a6;
}

body.dark-theme .control-btn:hover {
  background-color: #2c2c2e;
}

body.dark-theme .add-btn:hover {
  background-color: rgba(0, 113, 227, 0.2);
  border-color: #0071e3;
  color: #0071e3;
}

body.dark-theme .add-btn[onclick*="removeModule"]:hover {
  background-color: rgba(255, 69, 58, 0.1);
  border-color: #ff453a;
  color: #ff453a;
}

body.dark-theme button#reset {
  background-color: #2c2c2e;
  border-color: rgba(255, 255, 255, 0.1);
  color: #f5f5f7;
}

body.dark-theme button#reset:hover {
  background-color: #3a3a3c;
  border-color: rgba(255, 255, 255, 0.2);
}

/* 模块管理深色主题 */
body.dark-theme .module {
  background-color: #1d1d1f;
  border-color: rgba(255,255,255,0.1);
}

body.dark-theme .module-header {
  background-color: #2c2c2e;
  border-color: rgba(255,255,255,0.05);
}

body.dark-theme .module-title {
  color: #f5f5f7;
}

body.dark-theme .empty-modules-message {
  border-color: rgba(255,255,255,0.1);
  color: #a1a1a6;
}

/* 布局深色主题 */
body.dark-theme .page-footer {
  background-color: rgba(30, 30, 32, 0.72);
  border-top-color: rgba(255, 255, 255, 0.1);
}

body.dark-theme .theme-switcher {
  background-color: #2c2c2e;
}

body.dark-theme .theme-switcher label {
  color: #f5f5f7;
}

body.dark-theme .theme-btn {
  background-color: #2c2c2e;
  border-color: rgba(255, 255, 255, 0.1);
  color: #f5f5f7;
}

body.dark-theme .theme-btn:hover {
  background-color: rgba(0, 113, 227, 0.2);
  border-color: #0071e3;
}

body.dark-theme .theme-btn.active {
  background-color: #0071e3;
  color: #ffffff;
  border-color: #0071e3;
}

/* 渠道深色主题 */
body.dark-theme .channel-section {
  background-color: #1d1d1f;
  border-color: rgba(255, 255, 255, 0.1);
}

body.dark-theme .channel-header {
  border-bottom-color: rgba(255, 255, 255, 0.1);
}

body.dark-theme .channel-title {
  color: #f5f5f7;
}

body.dark-theme .channel-settings-btn {
  border-color: rgba(255, 255, 255, 0.2);
  color: #a1a1a6;
}

body.dark-theme .channel-settings-btn:hover {
  background-color: #2c2c2e;
  border-color: #0071e3;
  color: #0071e3;
  transform: scale(1.05);
}

body.dark-theme .channel-preview-area {
  background-color: #2c2c2e;
  border-color: rgba(255, 255, 255, 0.1);
}

body.dark-theme .channel-preview-area:hover {
  background-color: #3a3a3c;
  border-color: rgba(255, 255, 255, 0.2);
}

body.dark-theme .channel-preview-placeholder {
  color: #a1a1a6;
}

body.dark-theme .channel-preview-btn {
  background-color: #2c2c2e;
  border-color: rgba(255, 255, 255, 0.1);
  color: #f5f5f7;
}

body.dark-theme .channel-preview-btn:hover {
  background-color: #3a3a3c;
  border-color: rgba(255, 255, 255, 0.2);
}

body.dark-theme .channel-generate-btn:disabled {
  background-color: #48484a;
  color: #a1a1a6;
}

/* 渠道设置深色主题 */
body.dark-theme .settings-header {
  border-bottom-color: rgba(255, 255, 255, 0.1);
}

body.dark-theme .back-btn {
  border-color: rgba(255, 255, 255, 0.1);
  color: #f5f5f7;
}

body.dark-theme .back-btn:hover {
  background-color: rgba(255, 255, 255, 0.05);
}

body.dark-theme .settings-title,
body.dark-theme .setting-group-title,
body.dark-theme .setting-label {
  color: #f5f5f7;
}

body.dark-theme .setting-group-title {
  border-bottom-color: rgba(255, 255, 255, 0.1);
}

body.dark-theme .setting-input {
  background-color: #2c2c2e;
  border-color: rgba(255, 255, 255, 0.1);
  color: #f5f5f7;
}

body.dark-theme .setting-input:focus {
  border-color: #0071e3;
  box-shadow: 0 0 0 4px rgba(0, 113, 227, 0.15);
}

body.dark-theme .setting-upload-btn {
  background-color: #2c2c2e;
  border-color: rgba(255, 255, 255, 0.1);
  color: #f5f5f7;
}

body.dark-theme .setting-upload-btn:hover {
  background-color: #3a3a3c;
}

body.dark-theme .setting-preview {
  background-color: #2c2c2e;
  border-color: rgba(255, 255, 255, 0.2);
}

body.dark-theme .setting-preview.clickable-upload {
  background-color: #1a1d29;
  border-color: #0071e3;
}

body.dark-theme .setting-preview.clickable-upload:hover {
  background-color: #232844;
  border-color: #0084ff;
  box-shadow: 0 2px 8px rgba(0, 132, 255, 0.3);
}

body.dark-theme .setting-preview-placeholder {
  color: #a1a1a6;
}

body.dark-theme .setting-item {
  background-color: #2c2c2e;
  border-color: rgba(255, 255, 255, 0.1);
}

body.dark-theme .setting-header .setting-label,
body.dark-theme .setting-footer .setting-description {
  color: #f5f5f7;
}

body.dark-theme .setting-description {
  color: #a1a1a6;
}

/* 空状态深色主题 */
body.dark-theme .empty-state {
  color: #a1a1a6;
}

body.dark-theme .empty-state h3 {
  color: #f5f5f7;
}

body.dark-theme .gray-text {
  color: #86868b;
}

/* 其他元素深色主题 */
body.dark-theme .prize-label,
body.dark-theme .upload-icon,
body.dark-theme .upload-icon-text,
body.dark-theme .upload-icon-inline {
  color: #a1a1a6;
}
</style>

</head>
<body>
  <!-- SVG Sprite 定义 -->
  <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
    <symbol id="icon-chevron" viewBox="0 0 16 11">
      <path d="M0.130121 2.33086L7.44223 9.90667C7.67195 10.1374 8.03601 10.151 8.28153 9.94739L8.32611 9.90667L15.8682 2.3312C15.8992 2.29996 15.9167 2.25768 15.9167 2.21361V0.910808C15.9167 0.81876 15.8421 0.744141 15.75 0.744141C15.7057 0.744141 15.6632 0.7618 15.6319 0.793213L7.90908 8.54978L0.369491 0.801243C0.3053 0.735272 0.199782 0.73383 0.133811 0.798022C0.101565 0.829398 0.083374 0.87248 0.083374 0.917472V2.21512C0.083374 2.2583 0.100133 2.29979 0.130121 2.33086Z"/>
    </symbol>
    <symbol id="icon-move-up" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M8 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L7.5 2.707V14.5a.5.5 0 0 0 .5.5z"/>
    </symbol>
    <symbol id="icon-move-down" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1z"/>
    </symbol>
    <symbol id="icon-delete" viewBox="0 0 16 16">
      <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
      <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
    </symbol>
  </svg>

  <!-- 主容器 -->
  <div class="container">
    <!-- 标签页容器 -->
    <div class="tab-container">
      <!-- 创建原型标签页 -->
      <div class="tab active" data-tab="prototype">
        <span class="tab-bar__icon">
          <svg width="24" height="24" viewBox="0 0 1024 1024" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M436.992 140.288a153.7024 153.7024 0 0 1 146.5856 0l9.6256 5.632 352.6144 226.2528a51.2 51.2 0 0 1-55.296 86.1696L870.4 445.44V870.4a51.2 51.2 0 0 1-51.2 51.2H204.8a51.2 51.2 0 0 1-51.2-51.2V443.1872l-23.552 15.1552-4.5568 2.6112a51.2 51.2 0 0 1-54.9888-85.76l4.2496-3.072 352.6144-226.1504 9.6256-5.7344zM409.6 716.8a51.2 51.2 0 1 0 0 102.4h204.8a51.2 51.2 0 1 0 0-102.4H409.6z"/></svg>
        </span>
        <span class="tab-label">创建原型</span>
      </div>

      <!-- 延展渠道标签页 -->
      <div class="tab" data-tab="extension">
        <span class="tab-bar__icon">
          <svg width="24" height="24" viewBox="0 0 1024 1024" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M955.6992 54.272c-16.7936-8.3968-33.536-8.3968-41.9328 0L75.9808 473.088c-16.7424 0-25.1392 16.7424-25.1392 33.536 0 16.7424 8.3968 33.4848 16.7424 33.4848l201.0624 125.6448c16.7936 8.3968 33.536 8.3968 50.2784-8.3456l444.0576-402.1248 16.7424 8.3456-402.1248 427.3152c-8.3968 8.3456-8.3968 16.7424-8.3968 25.088v184.32a46.08 46.08 0 0 0 25.1392 41.8816c16.7424 8.3968 33.536 0 41.8816-8.3456l100.5568-100.5568 201.0624 134.0928c8.3968 8.3456 16.7424 8.3456 25.1392 8.3456h16.7424c16.7936-8.3456 25.1392-16.7424 25.1392-33.4848L972.4416 104.448c0-25.088 0-41.8816-16.7424-50.2784z"/></svg>
        </span>
        <span class="tab-label">延展渠道</span>
      </div>

      <!-- 工具集标签页 -->
      <div class="tab" data-tab="tools">
        <span class="tab-bar__icon">
          <svg width="24" height="24" viewBox="0 0 1024 1024" fill="currentColor" stroke="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M628.5312 579.6864h207.9232a92.672 92.672 0 0 1 92.7232 92.672v207.7696c0 24.7296-9.7792 47.7696-27.0848 65.6384a92.8768 92.8768 0 0 1-65.6384 27.0336h-207.9232c-24.7808 0-47.8208-9.7792-65.6384-27.0336a92.7744 92.7744 0 0 1-27.136-65.6384v-207.7696c0-24.7296 9.8304-47.7696 27.136-65.5872 17.8176-17.3056 41.472-27.0848 65.6384-27.0848z m-276.992-92.672H143.5136c-24.7296 0-47.7696-9.728-65.6384-27.0336a92.416 92.416 0 0 1-27.0848-65.024v-208.384c0-24.7296 9.7792-47.7696 27.0848-65.5872a92.8768 92.8768 0 0 1 65.6384-27.0848h207.9232a92.672 92.672 0 0 1 92.7232 92.672v207.7696c0 24.7808-9.728 47.7696-27.0336 65.6384-17.92 17.2544-41.472 27.0336-65.6896 27.0336z m0 485.2224H143.5136c-24.7296 0-47.7696-9.7792-65.6384-27.0848a90.368 90.368 0 0 1-27.0848-65.5872V671.744c0-24.7808 9.7792-47.7696 27.0848-65.6384a92.8768 92.8768 0 0 1 65.6384-27.0336h207.9232a92.672 92.672 0 0 1 92.7232 92.672v207.7696c0 24.7296-9.728 47.7696-27.0336 65.5872-17.92 17.3056-41.472 27.0848-65.6896 27.0848z m593.7664-616.448l-146.8928 146.7904a92.16 92.16 0 0 1-130.7136 0l-147.456-146.7904a92.0576 92.0576 0 0 1 0-130.6624l146.8928-146.7392a92.16 92.16 0 0 1 130.7136 0l146.8928 146.7392c36.864 36.3008 36.864 94.976 0.5632 130.6624z"/></svg>
        </span>
        <span class="tab-label">工具集</span>
      </div>
      
      <!-- 设置标签页 -->
      <div class="tab" data-tab="settings">
        <span class="tab-bar__icon">
          <svg width="24" height="24" viewBox="0 0 1024 1024" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M421.7856 60.5696c-11.264 2.56-18.432 13.312-18.432 25.088a137.6256 137.6256 0 0 1-68.608 119.296 137.5232 137.5232 0 0 1-138.24-0.512 27.4432 27.4432 0 0 0-33.28 6.144 464.7424 464.7424 0 0 0-87.04 151.552c-3.584 11.264 0.512 24.064 10.752 29.696 41.984 24.064 70.656 68.608 70.656 120.32a136.7552 136.7552 0 0 1-70.144 119.808c-10.752 5.632-14.848 18.944-11.264 29.696a464.7424 464.7424 0 0 0 87.04 151.552c8.192 9.216 22.528 12.8 33.28 6.144a138.8032 138.8032 0 0 1 138.24 0 137.6256 137.6256 0 0 1 68.608 119.296c0 11.776 7.168 22.528 18.432 25.088 29.5936 6.144 59.8016 9.2672 90.112 9.216 30.72 0 60.928-3.584 90.112-9.216 11.264-2.56 18.432-13.312 18.432-25.088 0-47.616 24.576-94.208 68.608-119.808a137.5744 137.5744 0 0 1 138.24 0.512c10.752 6.144 25.088 3.072 33.28-6.144a464.64 464.64 0 0 0 87.04-151.552c3.584-11.264-0.512-24.064-10.752-29.696a136.704 136.704 0 0 1-70.144-119.808c0-51.712 28.16-96.256 70.144-119.808a24.4736 24.4736 0 0 0 10.752-29.696 464.64 464.64 0 0 0-87.04-151.552c-8.192-9.216-22.528-12.8-33.28-6.144a137.5232 137.5232 0 0 1-138.24 0.512 138.4448 138.4448 0 0 1-68.608-119.808c0-11.776-7.168-22.528-18.432-25.088a437.4016 437.4016 0 0 0-90.112-9.216c-30.72 0-60.928 3.072-90.112 9.216z m227.84 451.584a137.728 137.728 0 0 1-275.456 0 138.0864 138.0864 0 0 1 190.464-127.3344 137.4208 137.4208 0 0 1 84.992 127.3344z"/></svg>
        </span>
        <span class="tab-label">设置</span>
      </div>
    </div>

    <!-- 创建原型内容 -->
    <div class="tab-content active" id="prototype-content">
      <!-- 页面基础设置板块 -->
      <div class="form-section">
        <div class="form-group row-layout">
          <label class="non-interactive-label">页面底色</label>
          <div class="color-input-group">
            <input type="color" id="pageColor" value="#FFFFFF" title="选择页面底色" aria-label="页面底色选择器">
            <input type="text" class="color-value" value="#FFFFFF" maxlength="7" title="页面底色十六进制值" aria-label="页面底色色值输入框" placeholder="#FFFFFF">
          </div>
        </div>
        
        <div class="form-group row-layout">
          <label class="non-interactive-label">页面背景</label>
          <div class="file-upload-btn">
            <input type="file" id="pageBackground" accept="image/*" class="hidden-file-input" onchange="previewImage(this, this.nextElementSibling.querySelector('.img-preview-inline'))" title="选择页面背景图片" aria-label="页面背景图片上传">
            <button class="upload-btn" onclick="document.getElementById('pageBackground').click()" title="上传页面背景图片" aria-label="上传页面背景图片">
              <div class="img-preview-inline">
                <span class="upload-icon-inline">+</span>
              </div>
            </button>
          </div>
        </div>
      </div>
      
      <!-- 头图板块 -->
      <div class="form-section">
        <!-- 头图 -->
        <div class="form-group row-layout">
          <label class="non-interactive-label">头图</label>
          <div class="file-upload-btn">
            <input type="file" id="headerImage" accept="image/*" class="hidden-file-input" title="选择头图" aria-label="头图上传">
            <button class="upload-btn" onclick="document.getElementById('headerImage').click()" title="上传头图" aria-label="上传头图">
              <div class="img-preview-inline">
                <span class="upload-icon-inline">+</span>
              </div>
            </button>
          </div>
        </div>
    
        <!-- 标题 -->
        <div class="form-group row-layout">
          <label class="non-interactive-label">标题</label>
          <div class="file-upload-btn">
            <input type="file" id="titleUpload" accept="image/*" class="hidden-file-input" onchange="previewImage(this, this.nextElementSibling.querySelector('.img-preview-inline'))" title="选择标题图片" aria-label="标题图片上传">
            <button class="upload-btn" onclick="document.getElementById('titleUpload').click()" title="上传标题图片" aria-label="上传标题图片">
              <div class="img-preview-inline">
                <span class="upload-icon-inline">+</span>
              </div>
            </button>
          </div>
        </div>
      </div>
      
      <!-- 游戏信息板块 -->
      <div class="form-section">
        <!-- 游戏信息板块标题 -->
        <div class="section-header">
          <div class="dropdown-selector">
            <select id="buttonVersionSelect" class="section-dropdown" title="选择游戏信息版本" aria-label="游戏信息版本选择器">
              <option value="imageButton">游戏信息-带icon版</option>
              <option value="singleButton">游戏信息-单按钮版</option>
              <option value="doubleButton">游戏信息-双按钮版</option>
            </select>
          </div>
          <div class="option-controls">
            <button class="control-btn collapse-btn" data-target="buttonVersionContent" title="折叠/展开游戏信息板块" aria-label="折叠/展开游戏信息板块">
              <svg width="12" height="7" class="chevron-icon">
                <use href="#icon-chevron"/>
              </svg>
            </button>
          </div>
        </div>
        
        <!-- 按钮内容容器 -->
        <div id="buttonVersionContent" class="collapsible-content">
          <!-- 游戏icon版内容 (默认显示) -->
          <div class="version-content active" id="imageButtonContent">
            <div class="form-group row-layout">
              <label class="non-interactive-label">游戏icon</label>
              <div class="img-upload-wrapper">
                <input type="file" id="gameIconUpload" accept="image/*" class="game-icon-upload hidden-file-input" title="选择游戏icon" aria-label="游戏icon上传">
                <div class="img-preview-btn" onclick="document.getElementById('gameIconUpload').click()">
                  <div class="img-preview-container" id="gameIconPreview">
                    <span class="upload-icon-text">+</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="form-group row-layout">
              <label for="gameNameInput">游戏名称</label>
              <input type="text" id="gameNameInput" class="text-input" placeholder="请输入游戏名称">
            </div>

            <div class="form-group row-layout">
              <label for="gameCopyInput">游戏描述</label>
              <textarea id="gameCopyInput" class="text-area" placeholder="请输入游戏宣传文案"></textarea>
            </div>
            
            <div class="form-group row-layout">
              <label class="non-interactive-label">文案颜色</label>
              <div class="color-input-group">
                <input type="color" id="gameCopyTextColor" value="#FFFFFF" title="选择游戏文案颜色" aria-label="游戏文案颜色选择器">
                <input type="text" class="color-value" value="#FFFFFF" maxlength="7" title="游戏文案颜色十六进制值" aria-label="游戏文案颜色色值输入框" placeholder="#FFFFFF">
              </div>
            </div>

            <div class="form-group row-layout">
              <label for="iconButtonText">按钮文本</label>
              <input type="text" id="iconButtonText" class="text-input" placeholder="请输入按钮文案" value="立即下载">
            </div>

            <div class="form-group row-layout">
              <label class="non-interactive-label">文本颜色</label>
              <div class="color-input-group">
                <input type="color" id="iconButtonTextColor" value="#FFFFFF" title="选择按钮文本颜色" aria-label="按钮文本颜色选择器">
                <input type="text" class="color-value" value="#FFFFFF" maxlength="7" title="按钮文本颜色十六进制值" aria-label="按钮文本颜色色值输入框" placeholder="#FFFFFF">
              </div>
            </div>

            <div class="form-group row-layout">
              <label class="non-interactive-label">按钮底</label>
              <div class="file-upload-btn">
                <input type="file" id="iconButtonBgUpload" accept="image/*" class="hidden-file-input" onchange="previewImage(this, this.nextElementSibling.querySelector('.img-preview-inline'))" title="选择按钮背景图片" aria-label="按钮背景图片上传">
                <button class="upload-btn" onclick="document.getElementById('iconButtonBgUpload').click()" title="上传按钮背景图片" aria-label="上传按钮背景图片">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>

          </div>
          
          <!-- 单按钮版内容 -->
          <div class="version-content" id="singleButtonContent">

            <div class="form-group row-layout">
              <label for="singleButtonText">按钮文本</label>
              <input type="text" id="singleButtonText" class="text-input" placeholder="请输入按钮文案" value="立即下载">
            </div>

            <div class="form-group row-layout">
              <label class="non-interactive-label">文本颜色</label>
              <div class="color-input-group">
                <input type="color" id="singleButtonTextColor" value="#FFFFFF" title="选择单按钮文本颜色" aria-label="单按钮文本颜色选择器">
                <input type="text" class="color-value" value="#FFFFFF" maxlength="7" title="单按钮文本颜色十六进制值" aria-label="单按钮文本颜色色值输入框" placeholder="#FFFFFF">
              </div>
            </div>

            <div class="form-group row-layout">
              <label class="non-interactive-label">按钮底</label>
              <div class="file-upload-btn">
                <input type="file" id="singleButtonBgUpload" accept="image/*" class="hidden-file-input" title="选择单按钮背景图片" aria-label="单按钮背景图片上传">
                <button class="upload-btn" onclick="document.getElementById('singleButtonBgUpload').click()" title="上传单按钮背景图片" aria-label="上传单按钮背景图片">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>
          </div>
          
          <!-- 双按钮版内容 -->
          <div class="version-content" id="doubleButtonContent">

            <div class="form-group row-layout">
              <label for="leftButtonText">左侧按钮文本</label>
              <input type="text" id="leftButtonText" class="text-input" placeholder="请输入按钮文案" value="左侧按钮">
            </div>

            <div class="form-group row-layout">
              <label class="non-interactive-label">文本颜色</label>
              <div class="color-input-group">
                <input type="color" id="leftButtonTextColor" value="#FFFFFF" title="选择左侧按钮文本颜色" aria-label="左侧按钮文本颜色选择器">
                <input type="text" class="color-value" value="#FFFFFF" maxlength="7" title="左侧按钮文本颜色十六进制值" aria-label="左侧按钮文本颜色色值输入框" placeholder="#FFFFFF">
              </div>
            </div>

            <div class="form-group row-layout">
              <label class="non-interactive-label">左侧按钮底</label>
              <div class="file-upload-btn">
                <input type="file" id="leftButtonBgUpload" accept="image/*" class="hidden-file-input" title="选择左侧按钮背景图片" aria-label="左侧按钮背景图片上传">
                <button class="upload-btn" onclick="document.getElementById('leftButtonBgUpload').click()" title="上传左侧按钮背景图片" aria-label="上传左侧按钮背景图片">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>

            <div class="form-group row-layout">
              <label for="rightButtonText">右侧按钮文本</label>
              <input type="text" id="rightButtonText" class="text-input" placeholder="请输入按钮文案" value="右侧按钮">
            </div>

            <div class="form-group row-layout">
              <label class="non-interactive-label">文本颜色</label>
              <div class="color-input-group">
                <input type="color" id="rightButtonTextColor" value="#FFFFFF" title="选择右侧按钮文本颜色" aria-label="右侧按钮文本颜色选择器">
                <input type="text" class="color-value" value="#FFFFFF" maxlength="7" title="右侧按钮文本颜色十六进制值" aria-label="右侧按钮文本颜色色值输入框" placeholder="#FFFFFF">
              </div>
            </div>
            
            <div class="form-group row-layout">
              <label class="non-interactive-label">右侧按钮底</label>
              <div class="file-upload-btn">
                <input type="file" id="rightButtonBgUpload" accept="image/*" class="hidden-file-input" title="选择右侧按钮背景图片" aria-label="右侧按钮背景图片上传">
                <button class="upload-btn" onclick="document.getElementById('rightButtonBgUpload').click()" title="上传右侧按钮背景图片" aria-label="上传右侧按钮背景图片">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>
            
            <div class="form-group row-layout">
              <label for="btnSpacing">按钮间距</label>
              <input type="number" id="btnSpacing" value="10" min="0" max="50" class="number-input">
            </div>
          </div>
          
        </div>
      </div>

      <!-- 模块管理区域 -->
      <div class="form-section module-management">
        <!-- 模块选择和添加区域 -->
        <div class="section-header">
          <span class="section-title">自定义模块</span>
        </div>
        <div class="module-selection-content">
          <div class="form-group row-layout">
            <label for="moduleTypeSelect">模块类型</label>
            <div class="dropdown-selector-wide">
            <select id="moduleTypeSelect" class="section-dropdown">
              <option value="">请选择模块类型</option>
              <option value="lotteryModule">九宫格抽奖</option>
              <option value="signInModule">签到模块</option>
              <option value="collectModule">集卡模块</option>
              <option value="activityContentModule">活动详情</option>
              <option value="carouselModule">图片轮播（横版）</option>
              <option value="verticalCarouselModule">图片轮播（竖版）</option>
            </select>
            </div>
          </div>
          <div class="form-group row-layout module-action-row">
            <button id="addModuleBtn" class="action-btn add-module-btn">
              添加模块
            </button>
          </div>
        </div>
        
        <!-- 已添加模块列表 -->
        <div class="module-list-header">
          <span>已添加模块</span>
          <div class="module-count"><span id="moduleCounter">0</span> 个模块</div>
        </div>
        
        <div id="modulesContainer">
          <!-- 模块将动态添加到此处 -->
          <div class="empty-modules-message" id="emptyModulesMessage">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" viewBox="0 0 16 16" style="margin-bottom: 16px; opacity: 0.5;">
              <path d="M7.752.066a.5.5 0 0 1 .496 0l3.75 2.143a.5.5 0 0 1 .252.434v3.995l3.498 2A.5.5 0 0 1 16 9.07v4.286a.5.5 0 0 1-.252.434l-3.75 2.143a.5.5 0 0 1-.496 0l-3.502-2-3.502 2a.5.5 0 0 1-.496 0l-3.75-2.143A.5.5 0 0 1 0 13.357V9.071a.5.5 0 0 1 .252-.434L3.75 6.638V2.643a.5.5 0 0 1 .252-.434L7.752.066ZM4.25 7.504 1.508 9.071l2.742 1.567 2.742-1.567L4.25 7.504ZM7.5 9.933l-2.75 1.571v3.134l2.75-1.571V9.933Zm1 3.134 2.75 1.571v-3.134L8.5 9.933v3.134Zm.508-3.996 2.742 1.567 2.742-1.567-2.742-1.567-2.742 1.567Zm2.242-2.433V3.504L8.5 5.076V8.21l2.75-1.572ZM7.5 8.21V5.076L4.75 3.504v3.134L7.5 8.21ZM5.258 2.643 8 4.21l2.742-1.567L8 1.076 5.258 2.643ZM15 9.933l-2.75 1.571v3.134L15 13.067V9.933ZM3.75 14.638v-3.134L1 9.933v3.134l2.75 1.571Z"/>
            </svg>
            <p>尚未添加任何模块</p>
            <p class="hint-text">请从上方选择模块类型并添加</p>
          </div>
        </div>
      </div>

      <!-- 模块模板库 (隐藏) -->
      <div id="moduleTemplates" class="visually-hidden">
        <!-- 固定模块-九宫格抽奖模板 -->
        <div class="module-template" id="lotteryModuleTemplate">
          <div class="module-header">
            <div class="module-title">九宫格抽奖</div>
            <div class="module-controls">
              <button class="control-btn move-up-btn" title="上移">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-move-up"/>
                </svg>
              </button>
              <button class="control-btn move-down-btn" title="下移">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-move-down"/>
                </svg>
              </button>
              <button class="control-btn collapse-btn" title="展开/收起">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-chevron"/>
                </svg>
              </button>
              <button class="control-btn delete-btn" title="删除">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-delete"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="module-content">
            <!-- 大标题 -->
            <div class="form-group row-layout">
              <label for="bigTitleInput">大标题</label>
              <input type="text" id="bigTitleInput" class="text-input big-title-input" placeholder="请输入大标题文本">
            </div>
            
            <!-- 标题背景 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">大标题背景</label>
              <div class="file-upload-btn">
                <input type="file" class="derived-item-upload hidden-file-input" accept="image/*" title="选择大标题背景图片" aria-label="大标题背景图片上传">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>
            
            <!-- 九宫格背景 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">九宫格背景</label>
              <div class="file-upload-btn">
                <input type="file" class="nine-grid-bg hidden-file-input" accept="image/*" title="选择九宫格背景图片" aria-label="九宫格背景图片上传">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>

            <!-- 抽奖按钮 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">抽奖按钮</label>
              <div class="file-upload-btn">
                <input type="file" class="draw-btn hidden-file-input" accept="image/*" title="选择抽奖按钮图片" aria-label="抽奖按钮图片上传">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>

            <!-- 奖品背景 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">奖品背景</label>
              <div class="file-upload-btn">
                <input type="file" class="prize-bg hidden-file-input" accept="image/*" title="选择奖品背景图片" aria-label="奖品背景图片上传">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>
            
            <!-- 奖品图 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">奖品图</label>
              <div class="prize-grid-custom">
                <!-- 第一行：3个奖品 -->
                <div class="prize-row top-row">
                  <div class="grid-item">
                    <div class="img-upload-container">
                      <input type="file" accept="image/*" class="prize-upload hidden-file-input" title="选择奖品01图片" aria-label="奖品01图片上传" onchange="previewImage(this, this.nextElementSibling.querySelector('.preview-container'))">
                      <button class="grid-btn" onclick="this.previousElementSibling.click()">
                        <div class="preview-container"></div>
                        <span class="upload-icon">+</span>
                      </button>
                      <div class="prize-label">奖品01</div>
                    </div>
                  </div>
                  <div class="grid-item">
                    <div class="img-upload-container">
                      <input type="file" accept="image/*" class="prize-upload hidden-file-input" title="选择奖品02图片" aria-label="奖品02图片上传" onchange="previewImage(this, this.nextElementSibling.querySelector('.preview-container'))">
                      <button class="grid-btn" onclick="this.previousElementSibling.click()">
                        <div class="preview-container"></div>
                        <span class="upload-icon">+</span>
                      </button>
                      <div class="prize-label">奖品02</div>
                    </div>
                  </div>
                  <div class="grid-item">
                    <div class="img-upload-container">
                      <input type="file" accept="image/*" class="prize-upload hidden-file-input" title="选择奖品03图片" aria-label="奖品03图片上传" onchange="previewImage(this, this.nextElementSibling.querySelector('.preview-container'))">
                      <button class="grid-btn" onclick="this.previousElementSibling.click()">
                        <div class="preview-container"></div>
                        <span class="upload-icon">+</span>
                      </button>
                      <div class="prize-label">奖品03</div>
                    </div>
                  </div>
                </div>
                
                <!-- 第二行：2个奖品 -->
                <div class="prize-row middle-row">
                  <div class="grid-item">
                    <div class="img-upload-container">
                      <input type="file" accept="image/*" class="prize-upload hidden-file-input" title="选择奖品04图片" aria-label="奖品04图片上传" onchange="previewImage(this, this.nextElementSibling.querySelector('.preview-container'))">
                      <button class="grid-btn" onclick="this.previousElementSibling.click()">
                        <div class="preview-container"></div>
                        <span class="upload-icon">+</span>
                      </button>
                      <div class="prize-label">奖品04</div>
                    </div>
                  </div>
                  <div class="grid-item">
                    <div class="img-upload-container">
                      <input type="file" accept="image/*" class="prize-upload hidden-file-input" title="选择奖品05图片" aria-label="奖品05图片上传" onchange="previewImage(this, this.nextElementSibling.querySelector('.preview-container'))">
                      <button class="grid-btn" onclick="this.previousElementSibling.click()">
                        <div class="preview-container"></div>
                        <span class="upload-icon">+</span>
                      </button>
                      <div class="prize-label">奖品05</div>
                    </div>
                  </div>
                </div>
                
                <!-- 第三行：2个奖品 + 谢谢参与 -->
                <div class="prize-row bottom-row">
                  <div class="grid-item">
                    <div class="img-upload-container">
                      <input type="file" accept="image/*" class="prize-upload hidden-file-input" title="选择奖品06图片" aria-label="奖品06图片上传" onchange="previewImage(this, this.nextElementSibling.querySelector('.preview-container'))">
                      <button class="grid-btn" onclick="this.previousElementSibling.click()">
                        <div class="preview-container"></div>
                        <span class="upload-icon">+</span>
                      </button>
                      <div class="prize-label">奖品06</div>
                    </div>
                  </div>
                  <div class="grid-item">
                    <div class="img-upload-container">
                      <input type="file" accept="image/*" class="prize-upload hidden-file-input" title="选择奖品07图片" aria-label="奖品07图片上传" onchange="previewImage(this, this.nextElementSibling.querySelector('.preview-container'))">
                      <button class="grid-btn" onclick="this.previousElementSibling.click()">
                        <div class="preview-container"></div>
                        <span class="upload-icon">+</span>
                      </button>
                      <div class="prize-label">奖品07</div>
                    </div>
                  </div>
                  <div class="grid-item">
                    <div class="img-upload-container">
                      <input type="file" accept="image/*" class="prize-upload hidden-file-input" title="选择谢谢参与图片" aria-label="谢谢参与图片上传" onchange="previewImage(this, this.nextElementSibling.querySelector('.preview-container'))">
                      <button class="grid-btn" onclick="this.previousElementSibling.click()">
                        <div class="preview-container"></div>
                        <span class="upload-icon">+</span>
                      </button>
                      <div class="prize-label">谢谢参与</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 固定模块-图片轮播（横版）模板 -->
        <div class="module-template" id="carouselModuleTemplate">
          <div class="module-header">
            <div class="module-title">图片轮播（横版）</div>
            <div class="module-controls">
              <button class="control-btn move-up-btn" title="上移">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-move-up"/>
                </svg>
              </button>
              <button class="control-btn move-down-btn" title="下移">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-move-down"/>
                </svg>
              </button>
              <button class="control-btn collapse-btn" title="展开/收起">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-chevron"/>
                </svg>
              </button>
              <button class="control-btn delete-btn" title="删除">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-delete"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="module-content">
            <!-- 标题文案 -->
            <div class="form-group row-layout">
              <label>标题</label>
              <input type="text" name="carousel-title" class="carousel-title-input text-input" placeholder="请输入标题文本">
            </div>
            
            <!-- 标题背景 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">标题背景</label>
              <div class="file-upload-btn">
                <input type="file" class="carousel-title-bg-upload" data-storage-key="carousel-title-bg" accept="image/*" style="display:none">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>

            <!-- 轮播图 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">轮播图</label>
              <div class="file-upload-btn">
                <input type="file" class="carousel-image-upload" data-storage-key="carousel-image" accept="image/*" style="display:none">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>

            <!-- 轮播图背景 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">轮播图背景</label>
              <div class="file-upload-btn">
                <input type="file" class="carousel-image-bg-upload" data-storage-key="carousel-image-bg" accept="image/*" style="display:none">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- 固定模块-图片轮播（竖版）模板 -->
        <div class="module-template" id="verticalCarouselModuleTemplate">
          <div class="module-header">
            <div class="module-title">图片轮播（竖版）</div>
            <div class="module-controls">
              <button class="control-btn move-up-btn" title="上移">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-move-up"/>
                </svg>
              </button>
              <button class="control-btn move-down-btn" title="下移">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-move-down"/>
                </svg>
              </button>
              <button class="control-btn collapse-btn" title="展开/收起">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-chevron"/>
                </svg>
              </button>
              <button class="control-btn delete-btn" title="删除">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-delete"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="module-content">
            <!-- 标题文案 -->
            <div class="form-group row-layout">
              <label>标题</label>
              <input type="text" name="vertical-carousel-title" class="vertical-carousel-title-input text-input" placeholder="请输入标题文本">
            </div>
            
            <!-- 标题背景 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">标题背景</label>
              <div class="file-upload-btn">
                <input type="file" class="vertical-carousel-title-bg-upload" data-storage-key="vertical-title-bg" accept="image/*" style="display:none">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>

            <!-- 轮播图01 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">轮播图01</label>
              <div class="file-upload-btn">
                                  <input type="file" class="vertical-carousel-image-upload-1" data-storage-key="vertical-image-1" accept="image/*" style="display:none">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>

            <!-- 轮播图02 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">轮播图02</label>
              <div class="file-upload-btn">
                                  <input type="file" class="vertical-carousel-image-upload-2" data-storage-key="vertical-image-2" accept="image/*" style="display:none">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>

            <!-- 轮播图03 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">轮播图03</label>
              <div class="file-upload-btn">
                                  <input type="file" class="vertical-carousel-image-upload-3" data-storage-key="vertical-image-3" accept="image/*" style="display:none">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>
          </div>
        </div>


        <!-- 固定模块-签到模板 -->
        <div class="module-template" id="signInModuleTemplate">
          <div class="module-header">
            <div class="module-title">每日签到</div>
            <div class="module-controls">
              <button class="control-btn move-up-btn" title="上移">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-move-up"/>
                </svg>
              </button>
              <button class="control-btn move-down-btn" title="下移">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-move-down"/>
                </svg>
              </button>
              <button class="control-btn collapse-btn" title="展开/收起">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-chevron"/>
                </svg>
              </button>
              <button class="control-btn delete-btn" title="删除">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-delete"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="module-content">
            <!-- 签到标题 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">标题图片</label>
              <div class="file-upload-btn">
                <input type="file" class="sign-in-title-upload" accept="image/*" title="选择图片文件" aria-label="图片文件上传">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>
            
            <!-- 签到背景 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">背景图片</label>
              <div class="file-upload-btn">
                <input type="file" class="sign-in-bg-upload" accept="image/*" title="选择图片文件" aria-label="图片文件上传">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>
            
            <!-- 签到天数 -->
            <div class="form-group row-layout">
              <label for="signInDaysCount">签到天数</label>
              <input type="number" id="signInDaysCount" class="days-count number-input" value="7" min="3" max="31" title="设置签到活动天数" aria-label="签到天数输入框">
            </div>
            
            <!-- 日期图标 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">日期图标</label>
              <div class="file-upload-btn">
                <input type="file" class="day-icon-upload" accept="image/*" title="选择图片文件" aria-label="图片文件上传">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>
            
            <!-- 签到按钮 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">签到按钮</label>
              <div class="file-upload-btn">
                <input type="file" class="sign-in-btn-upload" accept="image/*" title="选择图片文件" aria-label="图片文件上传">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- 固定模块-集卡模板 -->
        <div class="module-template" id="collectModuleTemplate">
          <div class="module-header">
            <div class="module-title">集卡活动</div>
            <div class="module-controls">
              <button class="control-btn move-up-btn" title="上移">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-move-up"/>
                </svg>
              </button>
              <button class="control-btn move-down-btn" title="下移">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-move-down"/>
                </svg>
              </button>
              <button class="control-btn collapse-btn" title="展开/收起">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-chevron"/>
                </svg>
              </button>
              <button class="control-btn delete-btn" title="删除">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-delete"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="module-content">
            <!-- 集卡标题 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">集卡标题</label>
              <div class="file-upload-btn">
                <input type="file" class="collect-title-upload" accept="image/*" title="选择图片文件" aria-label="图片文件上传">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>
            
            <!-- 集卡背景 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">背景图片</label>
              <div class="file-upload-btn">
                <input type="file" class="collect-bg-upload" accept="image/*" title="选择图片文件" aria-label="图片文件上传">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>
            
            <!-- 卡片数量 -->
            <div class="form-group row-layout">
              <label for="collectCardsCount">卡片数量</label>
              <input type="number" id="collectCardsCount" class="cards-count number-input" value="5" min="3" max="12" title="设置集卡活动卡片数量" aria-label="卡片数量输入框">
            </div>
            
            <!-- 卡片样式 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">卡片样式</label>
              <div class="radio-group row-layout">
                <div class="radio-item">
                  <input type="radio" id="cardStyle1" name="cardStyle" value="style1" checked title="选择方形卡片样式" aria-label="方形卡片样式">
                  <label for="cardStyle1">方形</label>
                </div>
                <div class="radio-item">
                  <input type="radio" id="cardStyle2" name="cardStyle" value="style2" title="选择圆角卡片样式" aria-label="圆角卡片样式">
                  <label for="cardStyle2">圆角</label>
                </div>
                <div class="radio-item">
                  <input type="radio" id="cardStyle3" name="cardStyle" value="style3" title="选择自定义卡片样式" aria-label="自定义卡片样式">
                  <label for="cardStyle3">自定义</label>
                </div>
              </div>
            </div>
            
            <!-- 卡片背景 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">卡片背景</label>
              <div class="file-upload-btn">
                <input type="file" class="card-bg-upload" accept="image/*" title="选择图片文件" aria-label="图片文件上传">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>
            
            <!-- 合成按钮 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">合成按钮</label>
              <div class="file-upload-btn">
                <input type="file" class="combine-button-upload" accept="image/*" title="选择图片文件" aria-label="图片文件上传">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- 活动详情模板 -->
        <div class="module-template" id="activityContentModuleTemplate">
          <div class="module-header">
            <div class="module-title">活动详情</div>
            <div class="module-controls">
              <button class="control-btn move-up-btn" title="上移">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-move-up"/>
                </svg>
              </button>
              <button class="control-btn move-down-btn" title="下移">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-move-down"/>
                </svg>
              </button>
              <button class="control-btn collapse-btn" title="展开/收起">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-chevron"/>
                </svg>
              </button>
              <button class="control-btn delete-btn" title="删除">
                <svg width="14" height="14" fill="currentColor">
                  <use href="#icon-delete"/>
                </svg>
              </button>
            </div>
          </div>
          <div class="module-content">
            <!-- 大标题文案 -->
            <div class="form-group row-layout">
              <label>大标题</label>
              <input type="text" class="activity-content-main-title-input text-input" placeholder="请输入大标题文本">
            </div>
            
            <!-- 大标题背景 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">大标题背景</label>
              <div class="file-upload-btn">
                <input type="file" class="activity-content-main-title-bg-upload hidden-file-input" accept="image/*" title="选择大标题背景图片" aria-label="大标题背景图片上传">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>

            <!-- 小标题文案 -->
            <div class="form-group row-layout">
              <label>小标题</label>
              <input type="text" class="activity-content-sub-title-input text-input" placeholder="请输入小标题文本">
            </div>

            <!-- 小标题背景 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">小标题背景</label>
              <div class="file-upload-btn">
                <input type="file" class="activity-content-sub-title-bg-upload hidden-file-input" accept="image/*" title="选择小标题背景图片" aria-label="小标题背景图片上传">
                <button class="upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>
            
            <!-- 正文内容 -->
            <div class="form-group row-layout">
              <label>正文</label>
              <textarea class="activity-content-text-input text-area" placeholder="请输入活动详情内容"></textarea>
            </div>

            <!-- 插图 -->
            <div class="form-group row-layout">
              <label class="non-interactive-label">插图</label>
              <div class="file-upload-btn">
                <input type="file" class="activity-content-image-upload hidden-file-input" accept="image/*" title="选择插图图片" aria-label="插图图片上传">
                <button class="upload-btn activity-content-image-upload-btn" onclick="this.previousElementSibling.click()">
                  <div class="img-preview-inline">
                    <span class="upload-icon-inline">+</span>
                  </div>
                </button>
              </div>
            </div>
          </div>
        </div>
        <!-- 更多模板可继续添加 -->
      </div>

      <!-- 活动规则板块 -->
      <div class="form-section">
        <!-- 活动规则标题 -->
        <div class="section-header">
          <span class="section-title">活动规则</span>
          <div class="option-controls">
            <button class="control-btn collapse-btn" data-target="rulesContent" title="折叠/展开活动规则板块" aria-label="折叠/展开活动规则板块">
              <svg width="12" height="7" class="chevron-icon">
                <use href="#icon-chevron"/>
              </svg>
            </button>
          </div>
        </div>
        
        <!-- 活动规则内容容器 -->
        <div id="rulesContent" class="collapsible-content">

          <!-- 标题文案 -->
          <div class="form-group row-layout">
            <label class="non-interactive-label">标题文案</label>
            <input type="text" id="rulesTitle" class="text-input" placeholder="请输入标题文案">
          </div>

          <!-- 标题背景 -->
          <div class="form-group row-layout">
            <label class="non-interactive-label">标题背景</label>
            <div class="file-upload-btn">
              <input type="file" id="rulesBgUpload" accept="image/*" class="hidden-file-input" title="选择活动规则标题背景图片" aria-label="活动规则标题背景图片上传">
              <button class="upload-btn" onclick="document.getElementById('rulesBgUpload').click()">
                <div class="img-preview-inline">
                  <span class="upload-icon-inline">+</span>
                </div>
              </button>
            </div>
          </div>
          
          <!-- 活动规则内容 -->
          <div class="form-group row-layout">
            <label for="rulesTextarea">活动规则</label>
            <textarea id="rulesTextarea" class="text-area" placeholder="请输入活动规则内容" title="输入活动规则内容" aria-label="活动规则内容输入框"></textarea>
          </div>
          
        </div>
      </div>

      <!-- 尾版板块 -->
      <div class="form-section">
        <!-- 尾版标题 -->
        <div class="section-header">
          <span class="section-title">尾版</span>
          <div class="option-controls">
            <button class="control-btn collapse-btn" data-target="footerAreaContent" title="折叠/展开尾版板块" aria-label="折叠/展开尾版板块">
              <svg width="12" height="7" class="chevron-icon">
                <use href="#icon-chevron"/>
              </svg>
            </button>
          </div>
        </div>
        
        <!-- 尾版内容容器 -->
        <div id="footerAreaContent" class="collapsible-content">
          <!-- LOGO -->
          <div class="form-group row-layout">
            <label class="non-interactive-label">LOGO</label>
            <div class="file-upload-btn">
              <input type="file" id="footerLogoUpload" accept="image/*" class="hidden-file-input" title="选择尾版LOGO图片" aria-label="尾版LOGO图片上传" onchange="previewImage(this, this.nextElementSibling.querySelector('.img-preview-inline'))">
              <button class="upload-btn" onclick="document.getElementById('footerLogoUpload').click()">
                <div class="img-preview-inline">
                  <span class="upload-icon-inline">+</span>
                </div>
              </button>
            </div>
          </div>
          
          <!-- 尾版背景 -->
          <div class="form-group row-layout">
            <label class="non-interactive-label">尾版背景</label>
            <div class="file-upload-btn">
              <input type="file" id="footerBgUpload" accept="image/*" class="hidden-file-input" title="选择尾版背景图片" aria-label="尾版背景图片上传">
              <button class="upload-btn" onclick="document.getElementById('footerBgUpload').click()">
                <div class="img-preview-inline">
                  <span class="upload-icon-inline">+</span>
                </div>
              </button>
            </div>
          </div>
          
        </div>
      </div>

      <!-- 创建按钮容器 -->
      <div class="create-btn-container">
        <div class="button-group">
          <button class="create-btn" id="create">创建原型</button>
          <button class="reset-btn" id="reset">重置</button>
        </div>
      </div>
    </div>

    <!-- 延展渠道内容 -->
    <div class="tab-content" id="extension-content">
      <!-- 渠道列表视图 -->
      <div class="channels-container" id="channelsMainView">
        <!-- OPPO渠道 -->
        <div class="channel-section">
          <div class="channel-header">
            <h3 class="channel-title">OPPO</h3>
            <button class="channel-settings-btn" onclick="showChannelSettings('oppo')" title="渠道设置">
              ⚙️
            </button>
          </div>
          <div class="channel-content">
            <div class="channel-preview-container">
              <div class="channel-preview-area" id="oppo-preview">
                <div class="channel-preview-placeholder">
                  <span>预览内容将在此显示</span>
                </div>
              </div>
              <button class="channel-preview-btn" onclick="previewChannel('oppo')">预览</button>
            </div>
            <div class="channel-generate-btn-group">
              <button class="channel-generate-btn" onclick="generateChannel('oppo')">生成 OPPO 版本</button>
              <button class="channel-generate-btn" onclick="">导出切图</button>
            </div>
          </div>
        </div>

        <!-- VIVO渠道 -->
        <div class="channel-section">
          <div class="channel-header">
            <h3 class="channel-title">VIVO</h3>
            <button class="channel-settings-btn" onclick="showChannelSettings('vivo')" title="渠道设置">
              ⚙️
            </button>
          </div>
          <div class="channel-content">
            <div class="channel-preview-container">
              <div class="channel-preview-area" id="vivo-preview">
                <div class="channel-preview-placeholder">
                  <span>预览内容将在此显示</span>
                </div>
              </div>
              <button class="channel-preview-btn" onclick="previewChannel('vivo')">预览</button>
            </div>
            <div class="channel-generate-btn-group">
              <button class="channel-generate-btn" onclick="generateChannel('vivo')">生成 VIVO 版本</button>
              <button class="channel-generate-btn" onclick="">导出切图</button>
            </div>
          </div>
        </div>

        <!-- 华为渠道 -->
        <div class="channel-section">
          <div class="channel-header">
            <h3 class="channel-title">华为</h3>
            <button class="channel-settings-btn" onclick="showChannelSettings('huawei')" title="渠道设置">
              ⚙️
            </button>
          </div>
          <div class="channel-content">
            <div class="channel-preview-container">
              <div class="channel-preview-area" id="huawei-preview">
                <div class="channel-preview-placeholder">
                  <span>预览内容将在此显示</span>
                </div>
              </div>
              <button class="channel-preview-btn" onclick="previewChannel('huawei')">预览</button>
            </div>
            <div class="channel-generate-btn-group">
              <button class="channel-generate-btn" onclick="generateChannel('huawei')">生成华为版本</button>
              <button class="channel-generate-btn" onclick="">导出切图</button>
            </div>
          </div>
        </div>

        <!-- 小米渠道 -->
        <div class="channel-section">
          <div class="channel-header">
            <h3 class="channel-title">小米</h3>
            <button class="channel-settings-btn" onclick="showChannelSettings('xiaomi')" title="渠道设置">
              ⚙️
            </button>
          </div>
          <div class="channel-content">
            <div class="channel-preview-container">
              <div class="channel-preview-area" id="xiaomi-preview">
                <div class="channel-preview-placeholder">
                  <span>预览内容将在此显示</span>
                </div>
              </div>
              <button class="channel-preview-btn" onclick="previewChannel('xiaomi')">预览</button>
            </div>
            <div class="channel-generate-btn-group">
              <button class="channel-generate-btn" onclick="generateChannel('xiaomi')">生成小米版本</button>
              <button class="channel-generate-btn" onclick="">导出切图</button>
            </div>
          </div>
        </div>
      </div>

      <!-- 渠道设置视图 -->
      <div class="channel-settings-view hidden" id="channelSettingsView">
        <!-- 设置页头部 -->
        <div class="settings-header">
          <button class="back-btn" onclick="backToChannelsList()" title="返回渠道列表" aria-label="返回渠道列表">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
              <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
            </svg>
          </button>
          <h2 class="settings-title" id="settingsTitle">渠道设置</h2>
          <div></div> <!-- 占位元素保持居中平衡 -->
        </div>

        <!-- 设置内容区域 -->
        <div class="settings-content" id="settingsContent">
          <!-- 动态内容将在这里插入 -->
        </div>
      </div>
    </div>
    
    <!-- 工具集内容 -->
    <div class="tab-content  active tools-tab-content" id="tools-content">
      <div class="tools-panel">
        <!-- 左侧菜单栏 -->
        <aside class="tools-panel__sidebar">
          <ul class="tools-menu">
            <li class="tools-menu__item tools-menu__item--active" data-tool="image-editor">
              <span class="tools-menu__icon">🎨</span>
              <span class="tools-menu__label">调整图像</span>
            </li>
            <!-- 未来可扩展更多工具 -->
            <!-- <li class="tools-menu__item" data-tool="other-tool">...</li> -->
          </ul>
        </aside>
      
        <!-- 右侧内容区 -->
        <section class="tools-panel__content">
          <!-- 图片调色工具卡片 -->
          <div class="tool-card tool-card--active" id="image-editor-tool">
            <div class="image-editor__header image-editor__mode-switch">
              <label class="image-editor__radio">
                <input type="radio" name="image-mode" value="upload" checked>
                <span class="image-editor__radio-custom"></span>
                上传图片
              </label>
              <label class="image-editor__radio">
                <input type="radio" name="image-mode" value="figma">
                <span class="image-editor__radio-custom"></span>
                加载图片
              </label>
            </div>
            <div class="image-editor__preview-area" id="image-preview-area">
              <input type="file" accept="image/*" class="image-editor__file-input" id="image-upload-input" hidden title="上传图片" aria-label="上传图片">
              <div class="image-editor__preview-placeholder" id="image-preview-placeholder">
                <span>点击上传或点击加载<br>（请先在Figma中选中图片）</span>
              </div>
              <canvas class="image-editor__canvas" id="image-preview-canvas" style="display:none;"></canvas>
            </div>
            <div class="image-editor__controls">
              <div class="image-editor__slider-group">
                <label style="font-size:13px;margin-bottom:6px;">曝光</label>
                <input type="range" min="-100" max="100" value="0" class="image-editor__slider" data-prop="brightness" title="曝光" aria-label="曝光">
              </div>
              <div class="image-editor__slider-group">
                <label style="font-size:13px;margin-bottom:6px;">对比度</label>
                <input type="range" min="-100" max="100" value="0" class="image-editor__slider" data-prop="contrast" title="对比度" aria-label="对比度">
              </div>
              <div class="image-editor__slider-group">
                <label style="font-size:13px;margin-bottom:6px;">饱和度</label>
                <input type="range" min="-100" max="100" value="0" class="image-editor__slider" data-prop="saturate" title="饱和度" aria-label="饱和度">
              </div>
              <div class="image-editor__slider-group">
                <label style="font-size:13px;margin-bottom:6px;">白平衡</label>
                <input type="range" min="-100" max="100" value="0" class="image-editor__slider" data-prop="temperature" title="白平衡" aria-label="白平衡">
              </div>
              <div class="image-editor__slider-group">
                <label style="font-size:13px;margin-bottom:6px;">色相</label>
                <input type="range" min="-180" max="180" value="0" class="image-editor__slider" data-prop="hue" title="色相" aria-label="色相">
              </div>
              <div class="image-editor__slider-group">
                <label style="font-size:13px;margin-bottom:6px;">高光</label>
                <input type="range" min="-100" max="100" value="0" class="image-editor__slider" data-prop="highlight" title="高光" aria-label="高光">
              </div>
              <div class="image-editor__slider-group" style="margin-bottom:18px;">
                <label style="font-size:13px;margin-bottom:6px;">阴影</label>
                <input type="range" min="-100" max="100" value="0" class="image-editor__slider" data-prop="shadow" title="阴影" aria-label="阴影">
              </div>
            </div>
            <div class="image-editor__actions image-editor__actions--centered">
              <button class="image-editor__reset-btn">重置</button>
              <button class="image-editor__confirm-btn">确认</button>
            </div>
          </div>
          <!-- 未来可扩展更多工具卡片 -->
        </section>
      </div>
    </div>

    <!-- 设置内容 -->
    <div class="tab-content" id="settings-content">
      <div class="form-section">
        <!-- 主题切换 -->
        <div class="form-group row-layout theme-switcher">
          <label>切换主题</label>
          <div class="theme-buttons">
            <button id="lightTheme" class="theme-btn active" data-theme="light">
              <!-- <i class="bi bi-sun"></i> -->
              <span>浅色模式</span>
            </button>
            <button id="darkTheme" class="theme-btn" data-theme="dark">
              <!-- <i class="bi bi-moon"></i> -->
              <span>深色模式</span>
            </button>
          </div>
        </div>
      </div>

    </div>

  </div>
  
  <!-- 页脚版本信息 -->
  <div class="page-footer">
    <div class="version-info">
      <span class="version-number">1.0.0</span>
      <span class="version-author">渠道美术制作</span>
    </div>
  </div>

  <script>
/* === utility-functions.js === */
// ==================== 存储适配器 ====================
// 解决Figma插件沙盒环境中localStorage被禁用的问题
class StorageAdapter {
  constructor() {
    // 更严格的Figma环境检测
    this.isFigmaEnvironment = this.checkFigmaEnvironment();
    this.cache = new Map(); // 内存缓存
    this.defaults = {
      theme: 'light',
      autoTheme: false
    };
    
    // 输出环境检测结果
    console.log('StorageAdapter 环境检测:', {
      isFigmaEnvironment: this.isFigmaEnvironment,
      hasFigma: typeof figma !== 'undefined',
      hasClientStorage: typeof figma !== 'undefined' && !!figma.clientStorage,
      isDataURL: window.location.protocol === 'data:',
      userAgent: navigator.userAgent.includes('Figma')
    });
  }

  // 检测是否在Figma环境中
  checkFigmaEnvironment() {
    // 关键修复：在Figma插件UI中，figma对象不可用！
    // 我们需要通过其他方式检测Figma环境
    const isDataURL = window.location.protocol === 'data:';
    const isFigmaUA = navigator.userAgent.includes('Figma') || window.location.href.includes('figma');
    const hasFigmaParent = window.parent !== window; // 插件运行在iframe中
    
    // 🚨 重要修复：在Figma插件UI线程中，figma对象是undefined！
    // 但我们仍在Figma环境中，需要使用data:协议作为主要判断依据
    const result = isDataURL || isFigmaUA;
    
    console.log('🔧 Figma环境检测详情:', {
      isDataURL,
      isFigmaUA,
      hasFigmaParent,
      protocol: window.location.protocol,
      href: window.location.href,
      userAgent: navigator.userAgent,
      result: result ? '✅ Figma环境' : '❌ 非Figma环境'
    });
    
    return result;
  }

  async setItem(key, value) {
    try {
      if (this.isFigmaEnvironment) {
        // 🚨 重要修复：在Figma UI线程中，不能直接访问figma.clientStorage
        // 需要通过postMessage与插件主线程通信
        console.log(`📤 向插件发送存储设置请求: ${key}`);
        
        // 发送消息到插件主线程
        window.parent.postMessage({
          pluginMessage: {
            type: 'storage-set',
            key: key,
            value: value
          }
        }, '*');
        
        // 同时保存到内存缓存
        this.cache.set(key, value);
        console.log(`✅ 缓存设置成功: ${key}`);
      } else {
        // 在非Figma环境中，尝试使用localStorage
        try {
          localStorage.setItem(key, value);
          console.log(`✅ localStorage设置成功: ${key}`);
        } catch (localStorageError) {
          console.warn(`localStorage不可用，使用内存存储: ${key}`, localStorageError);
          this.cache.set(key, value);
        }
      }
    } catch (error) {
      console.warn(`存储设置失败 ${key}:`, error);
      this.cache.set(key, value); // 回退到内存存储
    }
  }

  async getItem(key) {
    try {
      // 先检查缓存
      if (this.cache.has(key)) {
        console.log('📦 从缓存获取:', key);
        return this.cache.get(key);
      }

      let value;
      
      if (this.isFigmaEnvironment) {
        // 发送消息给插件获取存储值
        window.pluginComm.postMessage('storage-get', { key });
        value = await new Promise((resolve) => {
          const handler = (message) => {
            if (message.type === 'storage-get-response' && message.key === key) {
              window.pluginComm.off('storage-get-response', handler);
              resolve(message.value);
            }
          };
          window.pluginComm.on('storage-get-response', handler);
          // 5秒超时
          setTimeout(() => resolve(this.defaults[key]), 5000);
        });
      } else {
        value = localStorage.getItem(key);
      }

      // 如果值不存在，使用默认值
      if (value === null || value === undefined) {
        value = this.defaults[key];
        if (value === undefined) {
          console.warn(`⚠️ 缓存中没有找到 ${key}，返回默认值`);
        }
      }

      // 更新缓存
      if (value !== undefined) {
        this.cache.set(key, value);
      }

      return value;
    } catch (error) {
      console.error(`获取存储值失败 ${key}:`, error);
      return this.defaults[key];
    }
  }

  async removeItem(key) {
    try {
      if (this.isFigmaEnvironment) {
        // 🚨 重要修复：在Figma UI线程中，不能直接访问figma.clientStorage
        // 需要通过postMessage与插件主线程通信
        console.log(`📤 向插件发送存储删除请求: ${key}`);
        
        // 发送消息到插件主线程
        window.parent.postMessage({
          pluginMessage: {
            type: 'storage-delete',
            key: key
          }
        }, '*');
        
        // 同时从内存缓存中删除
        this.cache.delete(key);
        console.log(`✅ 缓存删除成功: ${key}`);
      } else {
        // 在非Figma环境中，检测localStorage是否可用
        // 添加额外的data:协议检查，防止在Figma沙盒中误调用localStorage
        if (window.location.protocol === 'data:') {
          console.warn(`检测到data:协议，跳过localStorage，使用内存存储: ${key}`);
          this.cache.delete(key);
          return;
        }
        
        try {
          localStorage.removeItem(key);
          console.log(`✅ localStorage删除成功: ${key}`);
        } catch (localStorageError) {
          console.warn(`localStorage不可用，使用内存存储: ${key}`, localStorageError);
          this.cache.delete(key);
        }
      }
    } catch (error) {
      console.warn(`存储删除失败 ${key}:`, error);
      this.cache.delete(key); // 回退到内存存储
    }
  }

  async getAllKeys() {
    try {
      if (this.isFigmaEnvironment) {
        // 🚨 重要修复：在Figma UI线程中，不能直接访问figma.clientStorage
        // 优先返回内存缓存的键，避免复杂的异步通信
        console.log(`📦 返回缓存中的存储键`);
        return Array.from(this.cache.keys());
      } else {
        // 在非Figma环境中，检测localStorage是否可用
        // 添加额外的data:协议检查，防止在Figma沙盒中误调用localStorage
        if (window.location.protocol === 'data:') {
          console.warn(`检测到data:协议，跳过localStorage，使用内存存储`);
          return Array.from(this.cache.keys());
        }
        
        try {
          const keys = Object.keys(localStorage);
          console.log(`✅ localStorage键获取成功: ${keys.length}个`);
          return keys;
        } catch (localStorageError) {
          console.warn(`localStorage不可用，使用内存存储`, localStorageError);
          return Array.from(this.cache.keys());
        }
      }
    } catch (error) {
      console.warn('获取存储键失败:', error);
      return Array.from(this.cache.keys()); // 回退到内存存储
    }
  }
}


// 创建全局存储适配器实例
const storageAdapter = new StorageAdapter();

// 导出到全局
window.storageAdapter = storageAdapter;

// ==================== 工具函数模块 ====================

// 标签页切换功能
function switchTab(tabName) {
  // 移除所有标签页的激活状态
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(tab => {
    tab.classList.remove('active');
  });
  
  // 隐藏所有标签页内容
  const tabContents = document.querySelectorAll('.tab-content');
  tabContents.forEach(content => {
    content.classList.remove('active');
  });
  
  // 激活目标标签页
  const targetTab = document.querySelector(`[data-tab="${tabName}"]`);
  if (targetTab) {
    targetTab.classList.add('active');
  }
  
  // 显示目标标签页内容
  const targetContent = document.getElementById(`${tabName}-content`);
  if (targetContent) {
    targetContent.classList.add('active');
  }
}

// 按钮版本切换功能
function switchButtonVersion() {
  const selector = document.getElementById('buttonVersionSelect');
  if (!selector) return;
  
  // 隐藏所有版本内容
  const contents = document.querySelectorAll('#buttonVersionContent .version-content');
  contents.forEach(content => content.classList.remove('active'));
  
  // 显示选中的版本内容
  const selectedValue = selector.value;
  const targetContent = document.getElementById(`${selectedValue}Content`);
  if (targetContent) {
    targetContent.classList.add('active');
  }
}

// 创建原型功能
function createPrototype() {
  try {
    console.log('开始创建原型...');
    
    // 收集表单数据
    const config = window.dataCollector.collectFormData();
    
    // 发送到插件主线程
    window.pluginComm.postMessage('create-prototype', { config });
    
  } catch (error) {
    console.error('创建原型失败:', error);
    window.notificationSystem.show(`创建失败: ${error.message}`, 'error');
  }
}

// 获取图片数据
async function getImageData(inputId) {
  try {
    const input = document.getElementById(inputId);
    if (!input || !input.files || input.files.length === 0) {
      return null;
    }
    
    const file = input.files[0];
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => resolve(e.target.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
    
  } catch (error) {
    console.error(`获取图片数据失败 (${inputId}):`, error);
    return null;
  }
}

// 收集模块数据
function collectModuleData() {
  const modules = document.querySelectorAll('#modulesContainer .module');
  const moduleData = [];
  
  modules.forEach(moduleEl => {
    const moduleType = moduleEl.dataset.moduleType;
    const moduleId = moduleEl.id;
    
    if (moduleType && moduleId) {
      const moduleContent = collectModuleContent(moduleEl, moduleType);
      if (moduleContent) {
        moduleData.push({
          id: moduleId,
          type: moduleType,
          content: moduleContent
        });
      }
    }
  });
  
  return moduleData;
}

// 收集模块内容
function collectModuleContent(container, moduleType) {
  switch (moduleType) {
    case 'nineGrid':
      return collectNineGridData(container);
    case 'signIn':
      return collectSignInData(container, container.id);
    case 'collectCards':
      return collectCardsData(container, container.id);
    case 'activityContent':
      return collectActivityContentData(container, container.id);
    default:
      console.warn(`未知的模块类型: ${moduleType}`);
      return null;
  }
}

// 收集九宫格数据
function collectNineGridData(container) {
  const data = {
    prizes: []
  };
  
  // 收集奖品信息
  const prizeElements = container.querySelectorAll('.prize-item');
  prizeElements.forEach((prizeEl, index) => {
    const nameInput = prizeEl.querySelector('.prize-name');
    const imageInput = prizeEl.querySelector('.prize-upload');
    
    if (nameInput || imageInput) {
      const prize = {
        position: getPrizePosition(index),
        name: nameInput ? nameInput.value : '',
        image: imageInput && imageInput.files[0] ? imageInput.files[0] : null
      };
      data.prizes.push(prize);
    }
  });
  
  return data;
}

// 收集签到数据
function collectSignInData(container, moduleId) {
  const data = {};
  
  // 收集基本信息
  const titleInput = container.querySelector('.sign-in-title');
  if (titleInput) data.title = titleInput.value;
  
  const descInput = container.querySelector('.sign-in-description');
  if (descInput) data.description = descInput.value;
  
  // 收集图片
  const images = ['title', 'bg', 'dayicon', 'signbtn'];
  images.forEach(imageType => {
    const imageData = window.imageManager.getModule(`${moduleId}-${imageType}`);
    if (imageData) {
      data[`${imageType}Image`] = imageData;
    }
  });
  
  return data;
}

// 收集集卡数据
function collectCardsData(container, moduleId) {
  const data = {};
  
  // 收集基本信息
  const titleInput = container.querySelector('.collect-title');
  if (titleInput) data.title = titleInput.value;
  
  const descInput = container.querySelector('.collect-description');
  if (descInput) data.description = descInput.value;
  
  // 收集图片
  const images = ['title', 'bg', 'cardbg', 'combinebtn'];
  images.forEach(imageType => {
    const imageData = window.imageManager.getModule(`${moduleId}-${imageType}`);
    if (imageData) {
      data[`${imageType}Image`] = imageData;
    }
  });
  
  return data;
}

// 收集活动内容数据
function collectActivityContentData(container, moduleId) {
  const data = {};
  
  // 收集文本内容
  const mainTitleInput = container.querySelector('.activity-main-title');
  if (mainTitleInput) data.mainTitle = mainTitleInput.value;
  
  const subTitleInput = container.querySelector('.activity-sub-title');
  if (subTitleInput) data.subTitle = subTitleInput.value;
  
  const contentInput = container.querySelector('.activity-content-text');
  if (contentInput) data.content = contentInput.value;
  
  // 收集图片
  const images = ['main-title-bg', 'sub-title-bg', 'image'];
  images.forEach(imageType => {
    const imageData = window.imageManager.getModule(`${moduleId}-${imageType}`);
    if (imageData) {
      data[`${imageType.replace('-', '')}Image`] = imageData;
    }
  });
  
  return data;
}

// 获取奖品位置
function getPrizePosition(index) {
  // 九宫格位置映射 (3x3网格)
  const positions = [
    { row: 0, col: 0 }, // 位置0: 左上
    { row: 0, col: 1 }, // 位置1: 上中
    { row: 0, col: 2 }, // 位置2: 右上
    { row: 1, col: 2 }, // 位置3: 右中
    { row: 2, col: 2 }, // 位置4: 右下
    { row: 2, col: 1 }, // 位置5: 下中
    { row: 2, col: 0 }, // 位置6: 左下
    { row: 1, col: 0 }, // 位置7: 左中
    { row: 1, col: 1 }  // 位置8: 中心(抽奖按钮位置)
  ];
  
  return positions[index] || { row: 0, col: 0 };
}

// 通用图片预览函数
function previewImage(input, previewElement) {
  if (!input.files || input.files.length === 0) return;
  
  const file = input.files[0];
  if (!file.type.startsWith('image/')) {
    alert('请选择有效的图片文件');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    if (previewElement) {
      previewElement.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: contain;">`;
    }
  };
  reader.readAsDataURL(file);
  
  // 处理模块图片上传
  if (input.closest('.module')) {
    window.fileProcessor.handleModuleImageUpload({ target: input });
  }
}

// 主题系统功能（简化版 - 仅监听系统主题变化）
function setupSystemThemeListener() {
  if (window.matchMedia) {
    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
    
    const handleThemeChange = async (e) => {
      const isDark = e.matches;
      const newTheme = isDark ? 'dark' : 'light';
      
      // 检查当前主题，避免不必要的切换
      const currentTheme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
      if (currentTheme !== newTheme) {
        applyTheme(newTheme);
        console.log(`✅ 系统主题变化，已切换到${isDark ? '深色' : '浅色'}主题`);
      }
    };
    
    // 监听系统主题变化
    if (mediaQuery.addEventListener) {
      mediaQuery.addEventListener('change', handleThemeChange);
    } else {
      // 兼容旧版浏览器
      mediaQuery.addListener(handleThemeChange);
    }
    
    console.log('✅ 系统主题监听器已设置');
  }
}

// 注意：主题缓存机制已被移除，不再保存/读取主题偏好
// 现在直接应用系统主题或默认主题

// 检测并应用系统主题（防重复调用）
function detectAndApplySystemTheme() {
  // 防止重复调用
  if (window._h5ToolsThemeInitialized) {
    console.log('⚠️ 主题已经初始化，跳过重复应用');
    return;
  }
  
  try {
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const systemTheme = prefersDark ? 'dark' : 'light';
    applyTheme(systemTheme);
    console.log('✅ 已应用系统主题:', systemTheme);
    
    // 标记主题已初始化
    window._h5ToolsThemeInitialized = true;
  } catch (error) {
    console.error('检测系统主题失败:', error);
    applyTheme('light');
    window._h5ToolsThemeInitialized = true;
  }
}

// 应用主题（简化版）
async function applyTheme(theme) {
  try {
    // 移除现有主题类
    document.body.classList.remove('light-theme', 'dark-theme');
    
    // 应用新主题
    document.body.classList.add(`${theme}-theme`);
    
    // 更新主题按钮状态
    updateThemeButtonsState(theme);
  } catch (error) {
    console.error('应用主题失败:', error);
  }
}

// 更新主题按钮状态
function updateThemeButtonsState(activeTheme) {
  try {
    const lightBtn = document.getElementById('lightTheme');
    const darkBtn = document.getElementById('darkTheme');
    
    if (lightBtn && darkBtn) {
      // 更新按钮状态
      lightBtn.classList.toggle('active', activeTheme === 'light');
      darkBtn.classList.toggle('active', activeTheme === 'dark');
      
      // 更新按钮文本或图标（如果需要）
      // lightBtn.setAttribute('aria-pressed', activeTheme === 'light');
      // darkBtn.setAttribute('aria-pressed', activeTheme === 'dark');
    }
  } catch (error) {
    console.error('更新主题按钮状态失败:', error);
  }
}

// 切换主题（简化版）
async function switchTheme(theme) {
  try {
    await applyTheme(theme);
    console.log(`✅ 手动切换到${theme === 'dark' ? '深色' : '浅色'}主题`);
  } catch (error) {
    console.error('切换主题失败:', error);
  }
}

// 绑定主题按钮事件（防重复绑定）
function bindThemeButtonEvents() {
  // 防止重复绑定
  if (window._h5ToolsThemeEventsInitialized) {
    console.log('⚠️ 主题按钮事件已经绑定，跳过重复绑定');
    return;
  }
  
  try {
    const lightBtn = document.getElementById('lightTheme');
    const darkBtn = document.getElementById('darkTheme');
    
    if (lightBtn && !lightBtn._themeEventBound) {
      lightBtn.addEventListener('click', () => switchTheme('light'));
      lightBtn._themeEventBound = true;
    }
    
    if (darkBtn && !darkBtn._themeEventBound) {
      darkBtn.addEventListener('click', () => switchTheme('dark'));
      darkBtn._themeEventBound = true;
    }
    
    // 可选：添加键盘快捷键支持（防重复绑定）
    if (!window._h5ToolsKeyboardShortcutBound) {
      document.addEventListener('keydown', (e) => {
        // Ctrl/Cmd + Shift + T 切换主题
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'T') {
          e.preventDefault();
          const currentTheme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          switchTheme(newTheme);
        }
      });
      window._h5ToolsKeyboardShortcutBound = true;
    }
    
    console.log('✅ 主题按钮事件已绑定');
    window._h5ToolsThemeEventsInitialized = true;
  } catch (error) {
    console.error('绑定主题按钮事件失败:', error);
  }
}

// 全局点击处理器
function globalClickHandler(e) {
  // 处理标签页点击
  if (e.target.classList.contains('tab')) {
    const tabName = e.target.dataset.tab;
    if (tabName) {
      switchTab(tabName);
    }
  }
  
  // 🚨 修复：移除重复的主题按钮处理，避免与bindThemeButtonEvents重复
  // 主题按钮点击已在bindThemeButtonEvents中单独处理
  // if (e.target.id === 'lightTheme') {
  //   switchTheme('light');
  // } else if (e.target.id === 'darkTheme') {
  //   switchTheme('dark');
  // }
  
  // 创建按钮已由UI控制器处理，避免重复绑定
  
  // 处理重置按钮点击
  if (e.target.id === 'reset') {
    if (confirm('确定要重置所有设置吗？此操作无法撤销。')) {
      window.formResetter.resetAll();
    }
  }
}

// 全局change处理器
function globalChangeHandler(e) {
  // 处理按钮版本选择器
  if (e.target.id === 'buttonVersionSelect') {
    switchButtonVersion();
  }
  
  // 处理文件上传
  if (e.target.type === 'file') {
    handleFileUpload(e.target);
  }
}

// 全局input处理器
function globalInputHandler(e) {
  // 处理颜色输入同步
  if (e.target.type === 'color') {
    const textInput = e.target.nextElementSibling;
    if (textInput && textInput.classList.contains('color-value')) {
      textInput.value = e.target.value.toUpperCase();
    }
  }
  
  // 处理颜色文本输入
  if (e.target.classList.contains('color-value')) {
    const colorInput = e.target.previousElementSibling;
    if (colorInput && colorInput.type === 'color' && /^#[0-9A-F]{6}$/i.test(e.target.value)) {
      colorInput.value = e.target.value;
    }
  }
}

// 处理文件上传
function handleFileUpload(input) {
  if (!input.files || input.files.length === 0) return;
  
  // 查找预览容器
  const previewContainer = input.nextElementSibling?.querySelector('.img-preview-inline, .preview-container');
  if (previewContainer) {
    previewImage(input, previewContainer);
  }
  
  // 特殊处理游戏图标
  if (input.id === 'gameIconUpload') {
    const gameIconPreview = document.getElementById('gameIconPreview');
    if (gameIconPreview) {
      previewImage(input, gameIconPreview);
    }
  }
}

// 重置表单
function resetForm() {
  if (window.formResetter) {
    window.formResetter.resetAll();
  }
}

// 导出供其他模块使用（已移除loadThemePreference）
window.utilityFunctions = {
  switchTab,
  switchButtonVersion,
  createPrototype,
  getImageData,
  collectModuleData,
  previewImage,
  setupSystemThemeListener,
  detectAndApplySystemTheme,
  applyTheme,
  switchTheme,
  bindThemeButtonEvents,
  globalClickHandler,
  globalChangeHandler,
  globalInputHandler,
  handleFileUpload,
  resetForm
};


/* === plugin-communicator.js === */
// ==================== 插件通信管理 ====================

class PluginCommunicator {
  constructor() {
    console.log('🔧 准备创建PluginCommunicator实例...');
    
    // 初始化消息处理器映射
    this.messageHandlers = new Map();
    
    // 消息状态跟踪
    this.messageStatus = new Map();
    
    // 初始化事件监听器
    this.initEventListener();
    
    // 标记初始化完成
    this.initialized = true;
    console.log('插件通信器已初始化');
  }
  
  initEventListener() {
    window.onmessage = (event) => {
      const pluginMessage = event.data.pluginMessage;
      if (!pluginMessage) return;
      
      const handler = this.messageHandlers.get(pluginMessage.type);
      if (handler) {
        handler(pluginMessage);
      }
    };
  }
  
  // 注册消息处理器
  registerHandler(messageType, handler) {
    console.log('注册消息处理器:', messageType);
    this.messageHandlers.set(messageType, handler);
  }
  
  // on方法是registerHandler的别名，提供事件监听器风格的API
  on(messageType, handler) {
    return this.registerHandler(messageType, handler);
  }
  
  // 移除消息处理器
  removeHandler(messageType) {
    console.log('移除消息处理器:', messageType);
    return this.messageHandlers.delete(messageType);
  }
  
  // off方法是removeHandler的别名，提供事件监听器风格的API
  off(messageType, handler) {
    // 如果提供了具体的handler，进行匹配检查
    if (handler) {
      const existingHandler = this.messageHandlers.get(messageType);
      if (existingHandler === handler) {
        return this.removeHandler(messageType);
      }
      return false;
    }
    // 如果没有提供handler，直接移除该类型的所有处理器
    return this.removeHandler(messageType);
  }
  
  // 发送消息到插件
  postMessage(type, data = {}) {
    // 生成消息ID
    const messageId = `${type}-${Date.now()}`;
    
    // 检查是否是状态类消息（如ui-loaded, ui-ready）
    if (type.startsWith('ui-')) {
      // 检查是否已经发送过
      const lastStatus = this.messageStatus.get(type);
      if (lastStatus) {
        const timeSinceLastMessage = Date.now() - lastStatus.timestamp;
        // 如果距离上次发送不到1秒，则跳过
        if (timeSinceLastMessage < 1000) {
          console.log(`⚠️ 跳过重复的${type}消息，距上次发送: ${timeSinceLastMessage}ms`);
          return;
        }
      }
      
      // 更新消息状态
      this.messageStatus.set(type, {
        timestamp: Date.now(),
        data: data
      });
    }
    
    // 构建消息对象
    const message = {
      type,
      ...data,
      _messageId: messageId,
      _timestamp: Date.now()
    };
    
    console.log('发送消息到插件:', type, message);
    
    // 发送消息
    parent.postMessage({ pluginMessage: message }, '*');
  }
  
  // 清理消息状态
  clearMessageStatus(type) {
    this.messageStatus.delete(type);
  }
  
  // 测试通信连接
  testConnection() {
    this.postMessage('ping', { timestamp: Date.now() });
  }
}

// 创建全局实例
try {
  const success = window.pluginComm = new PluginCommunicator();
  console.log('✅ PluginCommunicator实例创建成功:', !!success);
} catch (error) {
  console.error('❌ PluginCommunicator创建失败:', error);
}

// 注册图片切片消息处理器
window.pluginComm.registerHandler('slice-large-image', async (message) => {
  try {
    console.log('收到图片切片请求:', message.imageData?.name);
    await window.imageSliceHandler.handleSliceRequest(message);
  } catch (error) {
    console.error('处理图片切片请求失败:', error);
    // 发送失败响应
    window.pluginComm.postMessage('slice-image-response', {
      success: false,
      imageName: message.imageData?.name || '未知图片',
      error: error.message
    });
  }
}); 

/* === notification-system.js === */
// ==================== UI 通知系统 ====================

class NotificationSystem {
  constructor() {
    this.notifications = new Set();
    this.loadingElement = null;
    this.init();
  }
  
  init() {
    // 创建加载状态元素
    this.createLoadingElement();
  }
  
  createLoadingElement() {
    if (document.getElementById('loadingOverlay')) return;
    
    const overlay = document.createElement('div');
    overlay.id = 'loadingOverlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    `;
    
    const spinner = document.createElement('div');
    spinner.style.cssText = `
      width: 40px;
      height: 40px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    `;
    
    // 添加旋转动画
    const style = document.createElement('style');
    style.textContent = `
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `;
    document.head.appendChild(style);
    
    overlay.appendChild(spinner);
    document.body.appendChild(overlay);
    this.loadingElement = overlay;
  }
  
  show(message, type = 'info', duration = 5000) {
    const notification = this.createElement(message, type);
    this.notifications.add(notification);
    
    document.body.appendChild(notification);
    
    // 使用 requestAnimationFrame 确保平滑动画
    requestAnimationFrame(() => {
      notification.style.opacity = '1';
      notification.style.transform = 'translateY(0)';
    });
    
    // 自动移除
    setTimeout(() => this.hide(notification), duration);
    
    return notification;
  }
  
  createElement(message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    notification.style.opacity = '0';
    notification.style.transform = 'translateY(-20px)';
    return notification;
  }
  
  hide(notification) {
    notification.style.opacity = '0';
    notification.style.transform = 'translateY(-20px)';
    
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
      this.notifications.delete(notification);
    }, 300);
  }
  
  clear() {
    this.notifications.forEach(notification => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    });
    this.notifications.clear();
  }
  
  showLoading() {
    if (this.loadingElement) {
      this.loadingElement.style.display = 'flex';
    }
  }
  
  hideLoading() {
    if (this.loadingElement) {
      this.loadingElement.style.display = 'none';
    }
  }
}

// 创建全局通知系统实例并挂载到window对象
window.notificationSystem = new NotificationSystem();

// ==================== 加载状态管理 ====================

// 显示加载状态 - 供其他模块使用
window.showLoading = function(message = '正在处理...') {
  window.notificationSystem.showLoading();
  console.log('显示加载状态:', message);
};

// 隐藏加载状态 - 供其他模块使用
window.hideLoading = function() {
  window.notificationSystem.hideLoading();
  console.log('隐藏加载状态');
};

// 兼容函数 - 供其他模块使用
window.showNotification = function(message, type) {
  window.notificationSystem.show(message, type);
}; 

/* === theme-manager.js === */
// ==================== 主题管理器模块 ====================

class ThemeManager {
  init() {
    this.checkSystemTheme();
    this.bindThemeButtons();
    this.watchSystemTheme();
  }
  
  checkSystemTheme() {
    const prefersDark = window.matchMedia?.('(prefers-color-scheme: dark)').matches;
    this.applyTheme(prefersDark ? 'dark' : 'light');
  }
  
  applyTheme(theme) {
    document.body.className = document.body.className.replace(/\b(light|dark)-theme\b/g, '');
    document.body.classList.add(`${theme}-theme`);
    
    this.updateThemeButtons(theme);
  }
  
  updateThemeButtons(theme) {
    const lightBtn = document.getElementById('lightTheme');
    const darkBtn = document.getElementById('darkTheme');
    
    if (lightBtn && darkBtn) {
      lightBtn.classList.toggle('active', theme === 'light');
      darkBtn.classList.toggle('active', theme === 'dark');
    }
  }
  
  bindThemeButtons() {
    const lightBtn = document.getElementById('lightTheme');
    const darkBtn = document.getElementById('darkTheme');
    
    if (lightBtn) {
      lightBtn.addEventListener('click', () => this.applyTheme('light'));
    }
    
    if (darkBtn) {
      darkBtn.addEventListener('click', () => this.applyTheme('dark'));
    }
  }
  
  watchSystemTheme() {
    if (window.matchMedia) {
      window.matchMedia('(prefers-color-scheme: dark)')
        .addEventListener('change', () => this.checkSystemTheme());
    }
  }
}

// 创建全局主题管理器实例
const themeManager = new ThemeManager();

// 导出供其他模块使用
window.themeManager = themeManager; 

/* === file-processor.js === */
// ==================== 文件处理器 ====================

class FileProcessor {
  // 处理图片文件上传
  async processImageFile(file, storageKey, isModule = false) {
    if (!this.isValidImageFile(file)) {
      throw new Error('请上传有效的图片文件');
    }
    
    try {
      const uint8Array = await this.fileToUint8Array(file);
      
      // 获取图片尺寸
      const imageDimensions = await this.getImageDimensions(file);
      console.log(`图片上传成功: ${storageKey}, 大小: ${uint8Array.length} bytes, 尺寸: ${imageDimensions.width}x${imageDimensions.height}`);
      
      // 存储图片数据和尺寸信息
      const imageData = {
        data: uint8Array,
        width: imageDimensions.width,
        height: imageDimensions.height,
        name: file.name,
        type: file.type
      };
      
      if (isModule) {
        window.imageManager.setModule(storageKey, imageData);
      } else {
        window.imageManager.set(storageKey, imageData);
      }
      
      return imageData;
    } catch (error) {
      console.error(`图片处理失败: ${storageKey}`, error);
      throw new Error(`图片处理失败: ${error.message}`);
    }
  }

  async handleImageUpload(e, storageKey) {
    try {
      await this.handleUpload(e.target, storageKey, false);
    } catch (error) {
      console.error(`基础图片上传失败 ${storageKey}:`, error);
      window.notificationSystem.show(`上传失败: ${error.message}`, 'error');
    }
  }
  
  async handleUpload(input, storageKey, isModule = false) {
    if (!input.files?.[0]) return;
    
    console.log(`开始处理图片上传: ${storageKey}, 文件:`, input.files[0].name);
    
    try {
      await this.processImageFile(input.files[0], storageKey, isModule);
      
      // 验证图片是否正确存储
      const storedData = isModule ? window.imageManager.getModule(storageKey) : window.imageManager.get(storageKey);
      console.log(`图片存储验证 ${storageKey}:`, storedData ? '成功' : '失败');
      
      window.notificationSystem.show('图片上传成功', 'success');
    } catch (error) {
      console.error(`图片上传失败 ${storageKey}:`, error);
      window.notificationSystem.show(`上传失败: ${error.message}`, 'error');
    }
  }

  async handleModuleImageUpload(e) {
    try {
      const input = e.target;
      const moduleEl = input.closest('.module');
      if (!moduleEl) return;
      
      const moduleId = moduleEl.id;
      const storageKey = this.getModuleStorageKey(input, moduleId);
      
      if (storageKey) {
        await this.handleUpload(input, storageKey, true);
      }
    } catch (error) {
      console.error('模块图片上传失败:', error);
      window.notificationSystem.show(`模块图片上传失败: ${error.message}`, 'error');
    }
  }
  
  getModuleStorageKey(input, moduleId) {
    const classMap = {
      'derived-item-upload': `${moduleId}-titlebg`,
      'nine-grid-bg': `${moduleId}-gridbg`,
      'draw-btn': `${moduleId}-drawbtn`,
      'prize-bg': `${moduleId}-prizebg`,
      'sign-in-title-upload': `${moduleId}-title`,
      'sign-in-bg-upload': `${moduleId}-bg`,
      'day-icon-upload': `${moduleId}-dayicon`,
      'sign-in-btn-upload': `${moduleId}-signbtn`,
      'collect-title-upload': `${moduleId}-title`,
      'collect-bg-upload': `${moduleId}-bg`,
      'card-bg-upload': `${moduleId}-cardbg`,
      'combine-button-upload': `${moduleId}-combinebtn`,
      'activity-content-main-title-bg-upload': `${moduleId}-main-title-bg`,
      'activity-content-sub-title-bg-upload': `${moduleId}-sub-title-bg`,
      'activity-content-image-upload': `${moduleId}-image`,
      'carousel-title-bg-upload': `${moduleId}-carousel-title-bg`,
      'carousel-image-upload': `${moduleId}-carousel-image`,
      'carousel-image-bg-upload': `${moduleId}-carousel-image-bg`,
      'vertical-carousel-title-bg-upload': `${moduleId}-vertical-title-bg`,
      'vertical-carousel-image-upload-1': `${moduleId}-vertical-image-1`,
      'vertical-carousel-image-upload-2': `${moduleId}-vertical-image-2`,
      'vertical-carousel-image-upload-3': `${moduleId}-vertical-image-3`
    };
    
    // 特殊处理奖品图片上传
    if (input.classList.contains('prize-upload')) {
      const prizeIndex = this.getPrizeIndex(input);
      return `${moduleId}-prize-${prizeIndex}`;
    }
    
    // 检查所有可能的类名匹配
    for (const [className, key] of Object.entries(classMap)) {
      if (input.classList.contains(className)) {
        return key;
      }
    }
    
    // 调试信息
    console.log(`未找到匹配的存储键，输入类名:`, input.className, `模块ID: ${moduleId}`);
    return null;
  }
  
  // 获取奖品在九宫格中的索引
  getPrizeIndex(input) {
    const moduleEl = input.closest('.module');
    if (!moduleEl) return 0;
    
    const prizeInputs = Array.from(moduleEl.querySelectorAll('.prize-upload'));
    return prizeInputs.indexOf(input);
  }

  // 获取图片尺寸
  async getImageDimensions(file) {
    return new Promise((resolve, reject) => {
      const img = new Image();
      
      img.onload = () => {
        resolve({
          width: img.naturalWidth,
          height: img.naturalHeight
        });
        // 清理URL对象
        URL.revokeObjectURL(img.src);
      };
      
      img.onerror = () => {
        URL.revokeObjectURL(img.src);
        reject(new Error('无法读取图片尺寸'));
      };
      
      // 创建临时URL
      img.src = URL.createObjectURL(file);
    });
  }
  
  // 验证是否为有效图片文件
  isValidImageFile(file) {
    return file && file.type.startsWith('image/');
  }
  
  // 将文件转换为 Uint8Array
  fileToUint8Array(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        const arrayBuffer = e.target.result;
        const uint8Array = new Uint8Array(arrayBuffer);
        resolve(uint8Array);
      };
      reader.onerror = () => reject(new Error('文件读取失败'));
      reader.readAsArrayBuffer(file);
    });
  }
  
  // 切片大图方法 - 使用智能切片策略
  async sliceLargeImage(imageData, sliceWidth = null, sliceHeight = null) {
    try {
      console.log(`开始切片图片: ${imageData.name || '未知图片'}`);
      
      // 🚨 修复：使用传入的切片策略，如果没有则使用智能策略
      let finalSliceWidth = sliceWidth;
      let finalSliceHeight = sliceHeight;
      
      // 如果没有指定切片尺寸，使用智能策略计算
      if (!sliceWidth || !sliceHeight) {
        const tempImg = new Image();
        const tempBlob = new Blob([new Uint8Array(imageData.bytes || imageData.data)], { type: imageData.type });
        const tempUrl = URL.createObjectURL(tempBlob);
        
        await new Promise((resolve, reject) => {
          tempImg.onload = resolve;
          tempImg.onerror = reject;
          tempImg.src = tempUrl;
        });
        
        // 使用智能策略计算切片尺寸
        const strategy = this.calculateSliceStrategy(tempImg.width, tempImg.height, 4096);
        finalSliceWidth = strategy.sliceWidth;
        finalSliceHeight = strategy.sliceHeight;
        
        console.log(`智能策略: ${strategy.description}`);
        console.log(`计算得出切片尺寸: ${finalSliceWidth}x${finalSliceHeight}`);
        
        URL.revokeObjectURL(tempUrl);
      }
      
      console.log(`目标切片尺寸: ${finalSliceWidth}x${finalSliceHeight}`);
      
      // 🚨 修复：确保图片数据格式正确
      let uint8ArrayData;
      if (imageData.bytes && Array.isArray(imageData.bytes)) {
        // 从插件传来的是Array格式，需要转换为Uint8Array
        console.log('检测到Array格式的图片数据，正在转换为Uint8Array...');
        uint8ArrayData = new Uint8Array(imageData.bytes);
      } else if (imageData.data instanceof Uint8Array) {
        // 已经是Uint8Array格式
        uint8ArrayData = imageData.data;
      } else if (imageData.data && Array.isArray(imageData.data)) {
        // data字段是Array格式
        console.log('检测到data字段为Array格式，正在转换为Uint8Array...');
        uint8ArrayData = new Uint8Array(imageData.data);
      } else {
        throw new Error('图片数据格式不正确，无法处理');
      }
      
      // 验证数据完整性
      if (!uint8ArrayData || uint8ArrayData.length === 0) {
        throw new Error('图片数据为空或损坏');
      }
      
      console.log(`图片数据大小: ${uint8ArrayData.length} bytes`);
      
      // 创建画布来处理图片
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      if (!ctx) {
        throw new Error('无法创建 Canvas 上下文');
      }
      
      // 从 Uint8Array 创建图片
      const blob = new Blob([uint8ArrayData], { type: imageData.type || 'image/png' });
      const img = new Image();
      const imgUrl = URL.createObjectURL(blob);
      
      console.log(`创建图片URL: ${imgUrl}`);
      console.log(`图片类型: ${imageData.type || 'image/png'}`);
      
      return new Promise((resolve, reject) => {
        const timeoutId = setTimeout(() => {
          URL.revokeObjectURL(imgUrl);
          reject(new Error('图片加载超时'));
        }, 30000); // 30秒超时
        
        img.onload = () => {
          console.log('图片加载成功');
          clearTimeout(timeoutId);
          
          try {
            const originalWidth = img.width;
            const originalHeight = img.height;
            
            console.log(`原图尺寸: ${originalWidth}x${originalHeight}`);
            console.log(`切片尺寸: ${finalSliceWidth}x${finalSliceHeight}`);
            
            // 计算需要切片的数量
            const cols = Math.ceil(originalWidth / finalSliceWidth);
            const rows = Math.ceil(originalHeight / finalSliceHeight);
            const totalSlices = cols * rows;
            
            console.log(`切片数量: ${cols}列 x ${rows}行 = ${totalSlices}片`);
            
            const slices = [];
            let completedSlices = 0;
            
            // 处理完成检查函数
            const checkCompletion = () => {
              if (completedSlices === totalSlices) {
                // 按行列顺序排序
                slices.sort((a, b) => {
                  if (a.row !== b.row) return a.row - b.row;
                  return a.col - b.col;
                });
                
                URL.revokeObjectURL(imgUrl);
                console.log(`图片切片完成，共 ${slices.length} 片`);
                
                resolve({
                  slices: slices,
                  originalWidth: originalWidth,
                  originalHeight: originalHeight,
                  sliceWidth: finalSliceWidth,
                  sliceHeight: finalSliceHeight,
                  cols: cols,
                  rows: rows
                });
              }
            };
            
            // 生成每个切片
            for (let row = 0; row < rows; row++) {
              for (let col = 0; col < cols; col++) {
                // 计算当前切片的位置和尺寸
                  const x = col * finalSliceWidth;
                  const y = row * finalSliceHeight;
                  const currentSliceWidth = Math.min(finalSliceWidth, originalWidth - x);
                  const currentSliceHeight = Math.min(finalSliceHeight, originalHeight - y);
                
                // 设置画布尺寸
                canvas.width = currentSliceWidth;
                canvas.height = currentSliceHeight;
                
                // 清空画布
                ctx.clearRect(0, 0, currentSliceWidth, currentSliceHeight);
                
                // 绘制图片的对应部分
                ctx.drawImage(
                  img,
                  x, y, currentSliceWidth, currentSliceHeight,
                  0, 0, currentSliceWidth, currentSliceHeight
                );
                
                // 转换为 Uint8Array（使用立即执行函数保持作用域）
                ((currentRow, currentCol, sliceX, sliceY, width, height) => {
                  canvas.toBlob((blob) => {
                    if (!blob) {
                      completedSlices++;
                      console.warn(`切片 ${currentRow}_${currentCol} 创建失败`);
                      checkCompletion();
                      return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                      try {
                        const sliceData = new Uint8Array(e.target.result);
                        slices.push({
                          data: sliceData,
                          width: width,
                          height: height,
                          row: currentRow,
                          col: currentCol,
                          x: sliceX,
                          y: sliceY,
                          name: `slice_${currentRow}_${currentCol}.png`
                        });
                        
                        completedSlices++;
                        console.log(`切片进度: ${completedSlices}/${totalSlices}`);
                        checkCompletion();
                      } catch (sliceError) {
                        console.error(`切片 ${currentRow}_${currentCol} 处理失败:`, sliceError);
                        completedSlices++;
                        checkCompletion();
                      }
                    };
                    
                    reader.onerror = () => {
                      console.error(`切片 ${currentRow}_${currentCol} 读取失败`);
                      completedSlices++;
                      checkCompletion();
                    };
                    
                    reader.readAsArrayBuffer(blob);
                  }, 'image/png', 0.9); // 添加质量参数
                })(row, col, x, y, currentSliceWidth, currentSliceHeight);
              }
            }
            
          } catch (error) {
            clearTimeout(timeoutId);
            URL.revokeObjectURL(imgUrl);
            reject(error);
          }
        };
        
        img.onerror = (errorEvent) => {
          console.error('图片加载失败事件:', errorEvent);
          console.error('图片URL:', imgUrl);
          console.error('图片类型:', imageData.type);
          console.error('Blob大小:', blob.size);
          clearTimeout(timeoutId);
          URL.revokeObjectURL(imgUrl);
          reject(new Error('图片加载失败'));
        };
        
        img.src = imgUrl;
      });
    } catch (error) {
      console.error('图片切片失败:', error);
      throw error;
    }
  }

  // 🚨 新增：智能切片策略计算方法（与核心库保持一致）
  calculateSliceStrategy(width, height, maxSize = 4096) {
    const strategy = {
      direction: 'none',
      sliceWidth: width,
      sliceHeight: height,
      slicesCount: 1,
      description: '',
      cols: 1,
      rows: 1,
      totalSlices: 1
    };

    const widthExceeds = width > maxSize;
    const heightExceeds = height > maxSize;

    if (!widthExceeds && !heightExceeds) {
      // 不需要切割
      strategy.description = '图片尺寸正常，无需切割';
      return strategy;
    }

    if (widthExceeds && !heightExceeds) {
      // 只有宽度超限：垂直切割（保持高度）
      strategy.direction = 'vertical';
      strategy.sliceWidth = Math.floor(maxSize * 0.9); // 留10%安全边距
      strategy.sliceHeight = height;
      strategy.cols = Math.ceil(width / strategy.sliceWidth);
      strategy.rows = 1;
      strategy.slicesCount = strategy.cols;
      strategy.totalSlices = strategy.cols;
      strategy.description = `宽度超限，垂直切割为${strategy.slicesCount}片，每片${strategy.sliceWidth}×${height}`;
    } else if (!widthExceeds && heightExceeds) {
      // 只有高度超限：水平切割（保持宽度）
      strategy.direction = 'horizontal';
      strategy.sliceWidth = width;
      strategy.sliceHeight = Math.floor(maxSize * 0.9); // 留10%安全边距
      strategy.cols = 1;
      strategy.rows = Math.ceil(height / strategy.sliceHeight);
      strategy.slicesCount = strategy.rows;
      strategy.totalSlices = strategy.rows;
      strategy.description = `高度超限，水平切割为${strategy.slicesCount}片，每片${width}×${strategy.sliceHeight}`;
    } else {
      // 宽度和高度都超限：网格切割
      strategy.direction = 'both';
      strategy.sliceWidth = Math.floor(maxSize * 0.9);
      strategy.sliceHeight = Math.floor(maxSize * 0.9);
      strategy.cols = Math.ceil(width / strategy.sliceWidth);
      strategy.rows = Math.ceil(height / strategy.sliceHeight);
      strategy.slicesCount = strategy.cols * strategy.rows;
      strategy.totalSlices = strategy.cols * strategy.rows;
      strategy.description = `宽高都超限，网格切割为${strategy.cols}×${strategy.rows}=${strategy.slicesCount}片`;
    }

    return strategy;
  }
}

// 创建文件处理器实例并挂载到window对象
window.fileProcessor = new FileProcessor(); 

/* === data-collector.js === */
// ==================== 数据收集器 ====================

class DataCollector {
  constructor() {
    this.moduleDataCollectors = {
      carousel: this.collectCarouselData.bind(this),
      verticalCarousel: this.collectVerticalCarouselData.bind(this)
    };
    
    // 存储键映射
    this.storageKeyMap = {
      'carousel-title-bg-upload': 'titleBgImage',
      'carousel-image-upload': 'carouselImage',
      'carousel-image-bg-upload': 'carouselBgImage',
      'vertical-carousel-title-bg-upload': 'titleBackground',
      'vertical-carousel-image-upload': 'carouselImage'
    };
  }

  // 收集表单数据
  collectFormData() {
    const config = {
      // 页面基础设置
      pageBgColor: document.getElementById('pageColor')?.value || '#FFFFFF',
      pageBgImage: window.imageManager.get('pageBackground'),
      headerImage: window.imageManager.get('headerImage'),
      titleUpload: window.imageManager.get('titleUpload'),
      gameIcon: window.imageManager.get('gameIcon'),
      
      // 游戏信息
      buttonVersion: document.getElementById('buttonVersionSelect')?.value || 'imageButton',
      
      // 游戏信息 - 带icon版
      gameName: document.getElementById('gameNameInput')?.value || '',
      gameDesc: document.getElementById('gameCopyInput')?.value || '',
      gameTextColor: document.getElementById('gameCopyTextColor')?.value || '#FFFFFF',
      iconButtonText: document.getElementById('iconButtonText')?.value || '立即下载',
      iconButtonTextColor: document.getElementById('iconButtonTextColor')?.value || '#FFFFFF',
      iconButtonBg: window.imageManager.get('iconButtonBg'),
      
      // 游戏信息 - 单按钮版
      singleButtonText: document.getElementById('singleButtonText')?.value || '立即下载',
      singleButtonTextColor: document.getElementById('singleButtonTextColor')?.value || '#FFFFFF',
      singleButtonBg: window.imageManager.get('singleButtonBg'),
      
      // 游戏信息 - 双按钮版
      leftButtonText: document.getElementById('leftButtonText')?.value || '左侧按钮',
      leftButtonBg: window.imageManager.get('leftButtonBg'),
      leftButtonTextColor: document.getElementById('leftButtonTextColor')?.value || '#FFFFFF',
      rightButtonText: document.getElementById('rightButtonText')?.value || '右侧按钮',
      rightButtonBg: window.imageManager.get('rightButtonBg'),
      rightButtonTextColor: document.getElementById('rightButtonTextColor')?.value || '#FFFFFF',
      btnSpacing: parseInt(document.getElementById('btnSpacing')?.value) || 10,
      
      // 活动规则
      rulesTitle: document.getElementById('rulesTitle')?.value || '',
      rulesBgImage: window.imageManager.get('rulesBg'),
      rulesContent: document.getElementById('rulesContent')?.value || '',
      footerLogo: window.imageManager.get('footerLogo'),
      footerBg: window.imageManager.get('footerBg'),
      
      // 模块数据
      modules: this.collectModuleData()
    };
    
    console.log('收集到的表单数据:', config);
    return config;
  }
  
  // 收集模块数据
  collectModuleData() {
    const modules = document.querySelectorAll('#modulesContainer .module');
    const moduleData = [];
    
    modules.forEach(moduleEl => {
      const moduleType = moduleEl.dataset.moduleType;
      const moduleId = moduleEl.id;
      
      if (moduleType && moduleId) {
        const moduleContent = this.collectModuleContent(moduleEl, moduleType, moduleId);
        if (moduleContent) {
          // 获取模块标题
          const moduleTitle = this.getModuleTitle(moduleType);
          
          moduleData.push({
            id: moduleId,
            type: moduleType,  // 保持字符串格式，在后端处理类型转换
            title: moduleTitle, // 添加标题字段
            content: moduleContent
          });
          
          console.log('📊 [模块数据收集]', {
            moduleId,
            moduleType,
            moduleTitle,
            收集内容: moduleContent
          });
        }
      }
    });
    
    console.log('🎯 [所有模块数据收集完成]', moduleData);
    return moduleData;
  }
  
  // 获取模块标题
  getModuleTitle(moduleType) {
    const titleMap = {
      'nineGrid': '九宫格抽奖',
      'signIn': '每日签到',
      'collectCards': '集卡活动',
      'activityContent': '活动详情',
      'carousel': '图片轮播（横版）',
      'verticalCarousel': '图片轮播（竖版）'
    };
    return titleMap[moduleType] || '未知模块';
  }
  
  // 收集模块内容
  collectModuleContent(container, moduleType, moduleId) {
    switch (moduleType) {
      case 'nineGrid':
        return this.collectLotteryData(container, moduleId);
      case 'lotteryModule':
        return this.collectLotteryData(container, moduleId);
      case 'signInModule':
        return this.collectSignInData(container, moduleId);
      case 'collectModule':
        return this.collectCardsData(container, moduleId);
      case 'activityContent':
        return this.collectActivityContentData(container, moduleId);
      case 'carousel':
        return this.collectCarouselData(moduleId);
      case 'verticalCarousel':
        return this.collectVerticalCarouselData(moduleId);
      default:
        console.warn(`未知的模块类型: ${moduleType}`);
        return null;
    }
  }
  
  // 收集九宫格抽奖数据
  collectLotteryData(container, moduleId) {
    const data = {
      mainTitle: container.querySelector('.big-title-input')?.value || "抽奖活动",
      // 类型保护：只允许ImageInfo类型
      titleBgImage: window.imageManager.getModule(`${moduleId}-titlebg`),
      gridBgImage: window.imageManager.getModule(`${moduleId}-gridbg`),
      drawButtonImage: window.imageManager.getModule(`${moduleId}-drawbtn`),
      prizeBgImage: window.imageManager.getModule(`${moduleId}-prizebg`),
      prizes: this.collectNineGridPrizes(container, moduleId)
    };
    
    return data;
  }
  
  // 收集签到数据
  collectSignInData(container, moduleId) {
    const data = {
      titleImage: window.imageManager.getModule(`${moduleId}-title`),
      bgImage: window.imageManager.getModule(`${moduleId}-bg`),
      daysCount: parseInt(container.querySelector('.days-count')?.value) || 7,
      dayIcon: window.imageManager.getModule(`${moduleId}-dayicon`),
      signButton: window.imageManager.getModule(`${moduleId}-signbtn`)
    };
    
    return data;
  }
  
  // 收集集卡数据
  collectCardsData(container, moduleId) {
    const data = {
      titleImage: window.imageManager.getModule(`${moduleId}-title`),
      bgImage: window.imageManager.getModule(`${moduleId}-bg`),
      cardsCount: parseInt(container.querySelector('.cards-count')?.value) || 5,
      cardStyle: container.querySelector('input[name="cardStyle"]:checked')?.value || 'style1',
      cardBg: window.imageManager.getModule(`${moduleId}-cardbg`),
      combineButton: window.imageManager.getModule(`${moduleId}-combinebtn`)
    };
    
    return data;
  }
  
  // 收集活动内容数据
  collectActivityContentData(container, moduleId) {
    const data = {
      mainTitle: container.querySelector('.activity-content-main-title-input')?.value || '',
      mainTitleBg: window.imageManager.getModule(`${moduleId}-main-title-bg`),
      subTitle: container.querySelector('.activity-content-sub-title-input')?.value || '',
      subTitleBg: window.imageManager.getModule(`${moduleId}-sub-title-bg`),
      text: container.querySelector('.activity-content-text-input')?.value || '',
      image: window.imageManager.getModule(`${moduleId}-image`)
    };
    
    console.log('🔍 [活动内容数据收集]', {
      moduleId,
      data,
      主标题: data.mainTitle,
      副标题: data.subTitle,
      正文: data.text,
      图片: !!data.image
    });
    
    return data;
  }
  
  // 收集图片轮播数据
  collectCarouselData(moduleId) {
    try {
      const titleInput = document.querySelector(`#${moduleId} input[name="carousel-title"]`);

      const data = {
        title: titleInput?.value || '',
        titleBackground: window.imageManager.getModule(`${moduleId}-carousel-title-bg`),
        carouselImage: window.imageManager.getModule(`${moduleId}-carousel-image`),
        carouselBackground: window.imageManager.getModule(`${moduleId}-carousel-image-bg`)
      };
    
      console.log('🔍 [图片轮播数据收集]', {
        moduleId,
        data,
        标题: data.title,
        轮播图片: !!data.carouselImage,
        标题背景: !!data.titleBackground,
        轮播背景: !!data.carouselBackground
      });
    
      return data;
    } catch (error) {
      console.error('收集轮播图数据失败:', error);
      return null;
    }
  }

  // 收集图片轮播（竖版）数据
  collectVerticalCarouselData(moduleId) {
    try {
      const titleInput = document.querySelector(`#${moduleId} input[name="vertical-carousel-title"]`);

      // 收集轮播图片数据 - 确保返回3元素元组格式
      const carouselImages = [
        window.imageManager.getModule(`${moduleId}-vertical-image-1`) || null,  // 主图
        window.imageManager.getModule(`${moduleId}-vertical-image-2`) || null,  // 右上图
        window.imageManager.getModule(`${moduleId}-vertical-image-3`) || null   // 右下图
      ];

      const data = {
        title: titleInput?.value || '',
        titleBackground: window.imageManager.getModule(`${moduleId}-vertical-title-bg`),
        carouselImages: carouselImages
      };
      
      console.log('🔍 [图片轮播（竖版）数据收集]', {
        moduleId,
        data,
        标题: data.title,
        轮播图片: `[主图: ${!!carouselImages[0]}, 右上: ${!!carouselImages[1]}, 右下: ${!!carouselImages[2]}]`,
        标题背景: !!data.titleBackground
      });
      
      return data;
    } catch (error) {
      console.error('收集图片轮播（竖版）数据失败:', error);
      return null;
    }
  }
  
  // 获取存储键
  getStorageKey(className, moduleId) {
    const baseKey = this.storageKeyMap[className];
    if (!baseKey) {
      return null;
    }
    return `${moduleId}-${baseKey}`;
  }
  
  // 获取奖品位置
  getPrizePosition(index) {
    // 九宫格位置映射 (3x3网格)
    const positions = [
      { row: 0, col: 0 }, // 位置0: 左上
      { row: 0, col: 1 }, // 位置1: 上中
      { row: 0, col: 2 }, // 位置2: 右上
      { row: 1, col: 2 }, // 位置3: 右中
      { row: 2, col: 2 }, // 位置4: 右下
      { row: 2, col: 1 }, // 位置5: 下中
      { row: 2, col: 0 }, // 位置6: 左下
      { row: 1, col: 0 }, // 位置7: 左中
      { row: 1, col: 1 }  // 位置8: 中心(抽奖按钮位置)
    ];
    
    return positions[index] || { row: 0, col: 0 };
  }
  
  // 收集九宫格奖品数据（专门处理3-2-3布局）
  collectNineGridPrizes(container, moduleId) {
    const prizes = [];
    const prizeElements = container.querySelectorAll('.prize-grid-custom .grid-item');
    
    prizeElements.forEach((prizeEl, index) => {
      const prizeLabel = prizeEl.querySelector('.prize-label')?.textContent || `奖品${String(index + 1).padStart(2, '0')}`;
      
      console.log(`🔍 [奖品${index}] 标签: "${prizeLabel}"`);
      
      prizes.push({
        image: window.imageManager.getModule(`${moduleId}-prize-${index}`),
        name: prizeLabel,
        position: index
      });
    });
    
    console.log('🔍 [九宫格奖品数据收集完成]', {
      moduleId,
      奖品数量: prizes.length,
      奖品名称: prizes.map(p => p.name)
    });
    
    return prizes;
  }
  
  // 收集奖品数据（备用方法）
  collectPrizeData(container, moduleId) {
    const prizes = [];
    const prizeElements = container.querySelectorAll('.grid-item');
    
    prizeElements.forEach((prizeEl, index) => {
      const prize = {
        position: this.getPrizePosition(index),
        image: window.imageManager.getModule(`${moduleId}-prize-${index}`),
      };
      prizes.push(prize);
    });
    
    return prizes;
  }
  
  // 验证收集的数据
  validateData(config) {
    const errors = [];
    
    // 基础验证
    if (!config.pageBgColor) {
      errors.push('页面颜色不能为空');
    }
    
    // 按钮版本验证
    if (!config.buttonVersion) {
      errors.push('必须选择按钮版本');
    }
    
    return errors;
  }
}

// 创建全局数据收集器实例并挂载到window对象
window.dataCollector = new DataCollector(); 

/* === data-manager.js === */
// ==================== 核心数据管理 ====================

// 图片数据存储管理
class ImageDataManager {
    constructor() {
      this.data = {
        pageBackground: null,
        headerImage: null,
        titleUpload: null,
        gameIcon: null,
        btnImage: null,
        footerLogo: null,
        footerBg: null,
        rulesBg: null
      };
      this.moduleData = {};
    }
    
    set(key, value) {
      // 类型保护：只允许存储ImageInfo类型，禁止Uint8Array
      this.data[key] = value;
    }
    
    get(key) {
      return this.data[key];
    }
    
    setModule(key, value) {
      // 类型保护：只允许存储ImageInfo类型，禁止Uint8Array
      this.moduleData[key] = value;
    }
    
    getModule(key) {
      return this.moduleData[key];
    }
    
    clear() {
      // 重置为初始状态，保持数据结构
      this.data = {
        pageBackground: null,
        headerImage: null,
        titleUpload: null,
        gameIcon: null,
        btnImage: null,
        footerLogo: null,
        footerBg: null,
        rulesBg: null
      };
      this.moduleData = {};
      console.log('图片管理器已清理');
    }
  }
  
  // 注意：实例创建现在在global-init.js中统一管理 

/* === channel-manager.js === */
// ==================== 渠道管理器模块 ====================

// 使用全局存储适配器（已在utility-functions.js中声明）
// 注意：不要重复声明storageAdapter，避免Figma沙盒环境中的重复声明错误

class ChannelManager {
  constructor() {
    this.channelImages = {};
  }

  // 渠道预览功能
  previewChannel(channel) {
    const previewArea = document.getElementById(`${channel}-preview`);
    
    // 显示加载状态
    previewArea.innerHTML = `
      <div class="preview-placeholder">
        <span>正在生成预览...</span>
      </div>
    `;

    // 模拟预览生成过程（后续完善）
    setTimeout(() => {
      previewArea.innerHTML = `
        <div class="preview-placeholder">
          <span>${channel.toUpperCase()} 版本预览</span>
          <div style="margin-top: 8px; font-size: 12px; color: #666;">
            预览功能正在开发中
          </div>
        </div>
      `;
    }, 1000);
  }

  // 渠道生成功能
  generateChannel(channel) {
    try {
      // 显示加载状态
      window.notificationSystem.showLoading();
      
      // 发送消息到插件主线程
      parent.postMessage({
        pluginMessage: {
          type: 'channel-generate',
          channel: channel,
          images: this.channelImages[channel] || {}
        }
      }, '*');
      
    } catch (error) {
      console.error('生成渠道版本失败:', error);
              window.notificationSystem.hideLoading();
        window.notificationSystem.show(`生成 ${channel.toUpperCase()} 版本失败`, 'error');
    }
  }

  // 渠道设置功能
  showChannelSettings(channel) {
    try {
      console.log(`打开 ${channel.toUpperCase()} 渠道设置`);
      
      // 隐藏主视图，显示设置视图
      const mainView = document.getElementById('channelsMainView');
      const settingsView = document.getElementById('channelSettingsView');
      
      if (mainView) {
        mainView.style.display = 'none';
      }
      
      if (settingsView) {
        // 🔧 关键修复：移除hidden类并确保显示
        settingsView.classList.remove('hidden');
        settingsView.style.display = 'block';
        settingsView.style.visibility = 'visible';
        console.log('🔧 设置视图显示状态已更新');
      } else {
        console.error('❌ 找不到channelSettingsView元素');
        return;
      }
      
      // 更新设置标题
      const settingsTitle = document.getElementById('settingsTitle');
      if (settingsTitle) {
        settingsTitle.textContent = `${this.getChannelDisplayName(channel)} 设置`;
      }
      
      // 生成设置内容
      this.generateChannelSettingsContent(channel);
      
      // 滚动到页面顶部 - 针对Figma插件环境
      requestAnimationFrame(() => {
        try {
          // 查找并滚动所有可能的滚动容器
          const scrollableContainers = [
            document.documentElement,
            document.body,
            document.querySelector('.container'),
            document.querySelector('.main-content'),
            document.querySelector('#app'),
            document.getElementById('channelSettingsView')
          ].filter(Boolean);
          
          scrollableContainers.forEach(container => {
            if (container) {
              container.scrollTop = 0;
              // 也尝试scrollLeft以防万一
              if (container.scrollLeft !== undefined) {
                container.scrollLeft = 0;
              }
            }
          });
          
          // 尝试将设置标题滚动到视图中
          const settingsTitle = document.getElementById('settingsTitle');
          if (settingsTitle) {
            settingsTitle.scrollIntoView({
              behavior: 'auto',
              block: 'start'
            });
          }
          
          console.log('已尝试滚动到顶部');
        } catch (scrollError) {
          console.warn('滚动操作失败:', scrollError);
        }
      });
      
      // 显示成功提示
      if (window.notificationSystem) {
        window.notificationSystem.show(`已进入 ${this.getChannelDisplayName(channel)} 设置页面`, 'info');
      }
      
    } catch (error) {
      console.error('打开渠道设置失败:', error);
      if (window.notificationSystem) {
        window.notificationSystem.show(`打开 ${this.getChannelDisplayName(channel)} 设置失败`, 'error');
      }
    }
  }

  // 返回渠道列表
  backToChannelsList() {
    const mainView = document.getElementById('channelsMainView');
    const settingsView = document.getElementById('channelSettingsView');
    
    if (settingsView) {
      settingsView.style.display = 'none';
      settingsView.classList.add('hidden');
    }
    
    if (mainView) {
      mainView.style.display = 'block';
    }
  }

  // 获取渠道显示名称
  getChannelDisplayName(channel) {
    const channelNames = {
      'oppo': 'OPPO',
      'vivo': 'VIVO', 
      'huawei': '华为',
      'xiaomi': '小米'
    };
    return channelNames[channel] || channel.toUpperCase();
  }

  // 生成渠道设置内容
  generateChannelSettingsContent(channel) {
    const settingsContainer = document.getElementById('settingsContent');
    if (!settingsContainer) {
      console.error('❌ 找不到settingsContent元素');
      return;
    }
    const config = this.getChannelSettingsConfig(channel);
    let html = '';
    config.forEach((item, index) => {
      const itemHTML = this.generateSettingItemHTML(item, channel);
      html += itemHTML;
    });
    settingsContainer.innerHTML = html;
    // 自动回显已上传图片
    const images = this.channelImages[channel] || {};
    Object.keys(images).forEach(key => {
      const imageData = images[key];
      if (imageData && imageData.data) {
        const previewElement = document.getElementById(`${channel}-${key}-preview`);
        if (previewElement) {
          let src;
          if (typeof imageData.data === 'string') {
            src = 'data:' + (imageData.type || 'image/png') + ';base64,' + imageData.data;
          } else {
            const uint8Arr = new Uint8Array(imageData.data);
            let binary = '';
            for (let i = 0; i < uint8Arr.length; i++) {
              binary += String.fromCharCode(uint8Arr[i]);
            }
            const base64 = btoa(binary);
            src = 'data:' + (imageData.type || 'image/png') + ';base64,' + base64;
          }
          previewElement.innerHTML = `<img src="${src}" style="width: 100%; height: 100%; object-fit: contain;" onclick="document.getElementById('${channel}-${key}-input').click()">`;
        }
      }
    });
    // 绑定事件
    this.bindSettingsEvents(channel);
    // 注意：渠道设置图片不再自动加载，仅在当前会话中有效
  }

  // 获取渠道设置配置
  getChannelSettingsConfig(channel) {
    const configs = {
      'oppo': [
        { type: 'image', key: 'eggBreaking', label: '砸蛋样式', description: '推荐尺寸<br>864x512px' },
        { type: 'image', key: 'footerStyle', label: '尾版样式', description: '推荐尺寸<br>1080x289px' }
      ],
      'vivo': [
        { type: 'image', key: 'footerStyle', label: '尾版样式', description: '推荐尺寸<br>1080x289px' }
      ],
      'huawei': [
        { type: 'image', key: 'footerStyle', label: '尾版样式', description: '推荐尺寸<br>1080x289px' }
      ],
      'xiaomi': [

      ]
    };
    
    return configs[channel] || [];
  }

  // 生成设置项HTML
  generateSettingItemHTML(item, channel) {
    const { type, key, label, placeholder, description } = item;
    
    if (type === 'text') {
      return `
        <div class="setting-item">
          <div class="setting-header">
            <label class="setting-label">${label}</label>
          </div>
          <div class="setting-main">
            <input type="text" class="setting-input" id="${channel}-${key}" placeholder="${placeholder || ''}" data-key="${key}">
          </div>
          ${description ? `<div class="setting-footer"><div class="setting-description">${description}</div></div>` : ''}
        </div>
      `;
    } else if (type === 'textarea') {
      return `
        <div class="setting-item">
          <div class="setting-header">
            <label class="setting-label">${label}</label>
          </div>
          <div class="setting-main">
            <textarea class="setting-input setting-textarea" id="${channel}-${key}" placeholder="${placeholder || ''}" data-key="${key}"></textarea>
          </div>
          ${description ? `<div class="setting-footer"><div class="setting-description">${description}</div></div>` : ''}
        </div>
      `;
    } else if (type === 'image') {
      return `
        <div class="setting-item">
          <div class="setting-header">
            <label class="setting-label">${label}</label>
            ${description ? `<div class="setting-description">${description}</div>` : ''}
          </div>
          <div class="setting-main">
        <div class="setting-upload-group">
          <input type="file" accept="image/*" style="display:none" id="${channel}-${key}-input" data-key="${key}">
              <div class="setting-preview clickable-upload" id="${channel}-${key}-preview" onclick="document.getElementById('${channel}-${key}-input').click()">
                <div class="setting-preview-placeholder">
                  
                  <div class="upload-text">+</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    return '';
  }

  // 绑定设置事件
  bindSettingsEvents(channel) {
    // 绑定文本输入事件
    const textInputs = document.querySelectorAll(`#settingsContent input[type="text"], #settingsContent textarea`);
    textInputs.forEach(input => {
      input.addEventListener('change', (e) => {
        const key = e.target.dataset.key;
        const value = e.target.value;
        this.saveChannelSetting(channel, key, value);
      });
    });

    // 绑定图片上传事件
    const imageInputs = document.querySelectorAll(`#settingsContent input[type="file"]`);
    imageInputs.forEach(input => {
      input.addEventListener('change', async (e) => {
        const key = e.target.dataset.key;
        const file = e.target.files[0];
        if (file) {
          try {
            // 处理图片文件（仅用于当前会话，不保存到存储）
            const storageKey = `${channel}-${key}`;
            const imageData = await window.fileProcessor.processImageFile(file, storageKey, true);
            
            // 更新预览
            this.updateImagePreview(channel, key, file);
            
            // 仅保存到内存中用于当前会话
            if (!this.channelImages[channel]) {
              this.channelImages[channel] = {};
            }
            this.channelImages[channel][key] = imageData;
            
            // 通知主程序图片已上传
            window.pluginComm.postMessage('channel-image-uploaded', {
              channel: channel,
              imageType: key,
              imageData: {
                data: Array.from(imageData.data), // 转换为数组以便传输
                width: imageData.width,
                height: imageData.height,
                name: imageData.name,
                type: imageData.type
              }
            });
            
            window.notificationSystem.show(`${key === 'eggBreaking' ? '砸蛋样式' : '尾版样式'}上传成功（仅当前会话有效）`, 'success');
          } catch (error) {
            console.error(`${channel}-${key} 图片上传失败:`, error);
            window.notificationSystem.show(`图片上传失败: ${error.message}`, 'error');
          }
        }
      });
    });
    
    // 注意：渠道设置图片不再从存储中加载，仅在当前会话中有效
  }

  // 更新图片预览
  updateImagePreview(channel, key, file) {
    const previewElement = document.getElementById(`${channel}-${key}-preview`);
    if (previewElement && file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        previewElement.innerHTML = `<img src="${e.target.result}" style="width: 100%; height: 100%; object-fit: contain;" onclick="document.getElementById('${channel}-${key}-input').click()">`;
      };
      reader.readAsDataURL(file);
    }
  }

  // 保存渠道设置
  async saveChannelSetting(channel, key, value) {
    try {
      const storageKey = `channel-settings-${channel}`;
      let settings = {};
      
      try {
        const stored = await window.storageAdapter.getItem(storageKey);
        if (stored) {
          settings = JSON.parse(stored);
        }
      } catch (e) {
        console.warn('读取渠道设置失败，使用默认设置');
      }
      
      settings[key] = value;
      await window.storageAdapter.setItem(storageKey, JSON.stringify(settings));
      
      console.log(`${channel} 渠道设置已保存:`, { [key]: value });
      
    } catch (error) {
      console.error('保存渠道设置失败:', error);
      if (window.notificationSystem) {
        window.notificationSystem.show('设置保存失败', 'error');
      }
    }
  }

  // 注意：saveChannelImageToLocal 函数已删除
  // 原因：渠道设置图片不再进行持久化保存

  // 注意：loadSavedChannelImages 函数已删除
  // 原因：渠道设置图片不再进行持久化保存，无需加载已保存的图片

  // 注意：clearOldChannelImages 函数已删除
  // 原因：渠道设置图片不再进行持久化保存，无需清理旧图片数据

  // 注意：updateImagePreviewFromData 函数已删除
  // 原因：仅在 loadSavedChannelImages 中被调用，现在不再需要
}

// 创建全局渠道管理器实例
const channelManager = new ChannelManager();

// 导出供其他模块使用
window.channelManager = channelManager;

// 兼容性函数 - 供HTML onclick事件使用
window.previewChannel = function(channel) {
  channelManager.previewChannel(channel);
};

window.generateChannel = function(channel) {
  channelManager.generateChannel(channel);
};

window.showChannelSettings = function(channel) {
  channelManager.showChannelSettings(channel);
};

window.backToChannelsList = function() {
  channelManager.backToChannelsList();
}; 

/* === image-uploader.js === */
// ==================== 图片上传管理器模块 ====================

// 图片上传处理类
class ImageUploader {
  init() {
    this.bindImageUploaders();
    this.bindModuleImageUploaders();
  }
  
  bindImageUploaders() {
    // 绑定基础图片上传
    const uploaders = [
      { id: 'pageBackground', key: 'pageBackground' },
      { id: 'headerImage', key: 'headerImage' },
      { id: 'titleUpload', key: 'titleUpload' },
      { id: 'gameIconUpload', key: 'gameIcon' },
      { id: 'iconButtonBgUpload', key: 'iconButtonBg' },
      { id: 'singleButtonBgUpload', key: 'singleButtonBg' },
      { id: 'leftButtonBgUpload', key: 'leftButtonBg' },
      { id: 'rightButtonBgUpload', key: 'rightButtonBg' },
      { id: 'footerLogoUpload', key: 'footerLogo' },
      { id: 'footerBgUpload', key: 'footerBg' },
      { id: 'rulesBgUpload', key: 'rulesBgImage' }
    ];
    
    uploaders.forEach(uploader => {
      const input = document.getElementById(uploader.id);
      if (input) {
        input.addEventListener('change', (e) => this.handleImageUpload(e, uploader.key));
      }
    });
  }

  handleImageUpload(e, storageKey) {
    this.handleUpload(e.target, storageKey, false);
  }      
  
  bindModuleImageUploaders() {
    // 🔧 统一使用事件委托处理模块内的图片上传，避免重复绑定
    document.addEventListener('change', (e) => {
      if (e.target.type === 'file' && e.target.accept === 'image/*' && e.target.closest('.module')) {
        // 防止重复处理
        if (e.target.dataset.processing === 'true') return;
        e.target.dataset.processing = 'true';
        
        // 异步处理完成后清除标记
        setTimeout(() => {
          e.target.dataset.processing = 'false';
        }, 100);
        
        window.fileProcessor.handleModuleImageUpload(e);
      }
    });
  }
  
  // 🚨 移除重复的bindModuleUploaders方法，使用统一的事件委托
  
  getModuleStorageKey(input, moduleId) {
    const classMap = {
      'derived-item-upload': `${moduleId}-titlebg`,
      'nine-grid-bg': `${moduleId}-gridbg`,
      'draw-btn': `${moduleId}-drawbtn`,
      'prize-bg': `${moduleId}-prizebg`,
      'sign-in-title-upload': `${moduleId}-title`,
      'sign-in-bg-upload': `${moduleId}-bg`,
      'day-icon-upload': `${moduleId}-dayicon`,
      'sign-in-btn-upload': `${moduleId}-signbtn`,
      'collect-title-upload': `${moduleId}-title`,
      'collect-bg-upload': `${moduleId}-bg`,
      'card-bg-upload': `${moduleId}-cardbg`,
      'combine-button-upload': `${moduleId}-combinebtn`,
      'activity-content-main-title-bg-upload': `${moduleId}-main-title-bg`,
      'activity-content-sub-title-bg-upload': `${moduleId}-sub-title-bg`,
      'activity-content-image-upload': `${moduleId}-image`,
      'carousel-title-bg-upload': `${moduleId}-carousel-title-bg`,
      'carousel-image-upload': `${moduleId}-carousel-image`,
      'carousel-image-bg-upload': `${moduleId}-carousel-image-bg`,
      'vertical-carousel-title-bg-upload': `${moduleId}-vertical-title-bg`,
      'vertical-carousel-image-upload-1': `${moduleId}-vertical-image-1`,
      'vertical-carousel-image-upload-2': `${moduleId}-vertical-image-2`,
      'vertical-carousel-image-upload-3': `${moduleId}-vertical-image-3`
    };
    
    // 特殊处理奖品图片上传
    if (input.classList.contains('prize-upload')) {
      const prizeIndex = this.getPrizeIndex(input);
      return `${moduleId}-prize-${prizeIndex}`;
    }
    
    for (const [className, key] of Object.entries(classMap)) {
      if (input.classList.contains(className)) {
        return key;
      }
    }
    return null;
  }
  
  // 获取奖品在九宫格中的索引
  getPrizeIndex(input) {
    const moduleEl = input.closest('.module');
    if (!moduleEl) return 0;
    
    const prizeInputs = Array.from(moduleEl.querySelectorAll('.prize-upload'));
    return prizeInputs.indexOf(input);
  }
  
  async handleUpload(input, storageKey, isModule = false) {
    if (!input.files?.[0]) return;
    
    console.log(`开始处理图片上传: ${storageKey}, 文件:`, input.files[0].name);
    
    try {
      await window.fileProcessor.processImageFile(input.files[0], storageKey, isModule);
      
      // 更新预览
      this.updatePreview(input, storageKey);
      
      // 验证图片是否正确存储
      const storedData = isModule ? window.imageManager.getModule(storageKey) : window.imageManager.get(storageKey);
      console.log(`图片存储验证 ${storageKey}:`, storedData ? '成功' : '失败');
      
      window.notificationSystem.show('图片上传成功', 'success');
    } catch (error) {
      console.error(`图片上传失败 ${storageKey}:`, error);
      window.notificationSystem.show(`上传失败: ${error.message}`, 'error');
    }
  }
  
  updatePreview(input, storageKey) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
      const previewContainer = this.findPreviewContainer(input, storageKey);
      if (previewContainer) {
        this.renderPreview(previewContainer, e.target.result, storageKey);
      }
    };
    reader.readAsDataURL(file);
  }
  
  findPreviewContainer(input, storageKey) {
    // 特殊处理游戏icon预览
    if (storageKey === 'gameIcon') {
      return document.getElementById('gameIconPreview');
    }
    
    const uploadBtn = input.nextElementSibling;
    if (!uploadBtn) return null;
    
    if (input.classList.contains('prize-upload')) {
      return uploadBtn.querySelector('.preview-container');
    }
    
    return uploadBtn.querySelector('.img-preview-inline');
  }
  
  renderPreview(container, src, storageKey) {
    container.innerHTML = '';
    const img = document.createElement('img');
    img.src = src;
    img.alt = "Preview";
    
    // 游戏icon使用特殊样式
    if (storageKey === 'gameIcon') {
      img.style.cssText = 'width:100%;height:100%;object-fit:cover;border-radius:8px';
      container.style.border = '1px solid rgba(0, 113, 227, 0.5)';
    } else {
      img.style.cssText = 'width:100%;height:100%;object-fit:contain;border-radius:8px';
    }
    
    container.appendChild(img);
    
    // 更新按钮样式
    const btn = container.closest('.upload-btn, .grid-btn');
    if (btn) {
      btn.style.border = '1px solid rgba(0, 113, 227, 0.5)';
    }
  }
}

// 创建全局图片上传管理器实例
const imageUploader = new ImageUploader();

// 导出供其他模块使用
window.imageUploader = imageUploader; 

/* === image-slice-handler.js === */
// ==================== 图片切片处理器 ====================

class ImageSliceHandler {
  async handleSliceRequest(message) {
    try {
      const { imageData, sliceWidth, sliceHeight, sliceStrategy } = message;
      
      if (!imageData) {
        throw new Error('缺少图片数据');
      }
      
      console.log(`开始处理图片切片: ${imageData.name}`);
      if (sliceStrategy) {
        console.log(`使用智能切片策略: ${sliceStrategy.description}`);
      }
      
      // 执行切片操作 - 传递策略计算的尺寸
      const result = await window.fileProcessor.sliceLargeImage(imageData, sliceWidth, sliceHeight);
      
      if (!result || !result.slices || result.slices.length === 0) {
        throw new Error('图片切片失败，未生成切片数据');
      }
      
      console.log(`图片切片完成: ${imageData.name}, 生成 ${result.slices.length} 个切片`);
      
      // 🚨 修复：转换切片数据格式为插件可处理的格式
      const processedSlices = result.slices.map((slice, index) => {
        try {
          return {
            bytes: Array.from(slice.data), // 转换Uint8Array为Array
            width: slice.width,
            height: slice.height,
            x: slice.x,
            y: slice.y,
            row: slice.row,
            col: slice.col,
            name: slice.name || `slice_${index}.png`
          };
        } catch (error) {
          console.error(`处理切片 ${index} 数据时出错:`, error);
          return null;
        }
      }).filter(slice => slice !== null); // 过滤掉处理失败的切片
      
      console.log(`成功处理 ${processedSlices.length}/${result.slices.length} 个切片`);
      
      // 发送成功响应
      window.pluginComm.postMessage('slice-image-response', {
        success: true,
        imageName: imageData.name,
        slices: processedSlices,
        originalWidth: result.originalWidth,
        originalHeight: result.originalHeight,
        sliceWidth: result.sliceWidth,
        sliceHeight: result.sliceHeight,
        cols: result.cols,
        rows: result.rows
      });
      
    } catch (error) {
      console.error('图片切片处理失败:', error);
      
      // 发送失败响应
      window.pluginComm.postMessage('slice-image-response', {
        success: false,
        imageName: message.imageData?.name || '未知图片',
        error: error.message
      });
    }
  }
}

// 创建全局图片切片处理器实例并挂载到window对象
window.imageSliceHandler = new ImageSliceHandler(); 

/* === module-manager.js === */
// ==================== 模块管理器模块 ====================

class ModuleManager {
  constructor() {
    this.moduleCounter = 0;
  }
  
  init() {
    this.bindAddModuleEvent();
    this.updateModuleCount();
  }
  
  bindAddModuleEvent() {
    const addBtn = document.getElementById('addModuleBtn');
    const typeSelect = document.getElementById('moduleTypeSelect');
    
    if (addBtn) {
      addBtn.addEventListener('click', () => {
        const moduleType = typeSelect?.value;
        if (moduleType) {
          this.addModule(moduleType);
        }
      });
    }
  }
  
  addModule(moduleType) {
    // 统一使用 moduleType + "Template" 的命名规则
    const templateId = `${moduleType}Template`;
    const template = document.getElementById(templateId);
    
    if (!template) {
      console.error(`找不到模板: ${templateId}`);
      window.notificationSystem.show(`模板 ${templateId} 不存在`, 'error');
      return;
    }
    
    // 创建新模块
    this.moduleCounter++;
    const moduleId = `module-${this.moduleCounter}`;
    const newModule = template.cloneNode(true);
    
    newModule.id = moduleId;
    newModule.className = 'module';
    newModule.style.display = 'block';
    
    // 统一模块类型标识符
    const moduleTypeMapping = {
      'lotteryModule': 'nineGrid',
      'signInModule': 'signIn', 
      'collectModule': 'collectCards',
      'activityContentModule': 'activityContent',
      'carouselModule': 'carousel',
      'verticalCarouselModule': 'verticalCarousel'
    };
    
    newModule.dataset.moduleType = moduleTypeMapping[moduleType] || moduleType;
    
    this.bindModuleEvents(newModule);
    
    const container = document.getElementById('modulesContainer');
    const emptyMessage = container.querySelector('.empty-modules-message');
    if (emptyMessage) {
      emptyMessage.style.display = 'none';
    }
    
    container.appendChild(newModule);
    
    this.updateModuleCount();
    
    // 滚动到新模块
    requestAnimationFrame(() => {
      newModule.scrollIntoView({ behavior: 'smooth', block: 'center' });
    });
    
    // 触发模块添加事件
    document.dispatchEvent(new CustomEvent('moduleAdded', { 
      detail: { moduleId } 
    }));
  }
  
  // 模块类型映射
  getModuleTypeMapping(templateType) {
    const typeMap = {
      'lotteryModule': 'nineGrid',
      'signInModule': 'signIn', 
      'collectModule': 'collectCards',
      'activityContentModule': 'activityContent',
      'carouselModule': 'carousel',
      'verticalCarouselModule': 'verticalCarousel'
    };
    return typeMap[templateType] || templateType;
  }
  
  bindModuleEvents(moduleEl) {
    const deleteBtn = moduleEl.querySelector('.delete-btn');
    const collapseBtn = moduleEl.querySelector('.collapse-btn');
    const moveUpBtn = moduleEl.querySelector('.move-up-btn');
    const moveDownBtn = moduleEl.querySelector('.move-down-btn');
    
    // 为删除按钮添加事件监听器
    if (deleteBtn) {
      deleteBtn.addEventListener('click', (e) => {
        e.preventDefault(); // 阻止默认行为
        e.stopPropagation(); // 阻止事件冒泡
        this.deleteModule(moduleEl); // 调用删除模块方法
      });
    }
    
    if (collapseBtn) {
      collapseBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        moduleEl.classList.toggle('module-collapsed');
        collapseBtn.classList.toggle('collapsed');
      });
    }
    
    if (moveUpBtn) {
      moveUpBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        this.moveModuleUp(moduleEl);
      });
    }
    
    if (moveDownBtn) {
      moveDownBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        this.moveModuleDown(moduleEl);
      });
    }
    
    // 绑定图片上传事件
    this.bindModuleImageUploads(moduleEl);
  }     

  // 绑定模块内的图片上传事件
  bindModuleImageUploads(moduleEl) {
    const imageInputs = moduleEl.querySelectorAll('input[type="file"][accept="image/*"]');
    imageInputs.forEach(input => {
      // 移除现有的事件监听器（如果有）
      const newInput = input.cloneNode(true);
      input.parentNode.replaceChild(newInput, input);
      
      // 重新绑定 onchange 事件
      if (newInput.classList.contains('prize-upload')) {
        newInput.addEventListener('change', () => window.utilityFunctions.previewImage(newInput));
      } else {
        // 对于其他类型的图片上传，使用标准预览函数
        newInput.addEventListener('change', () => {
          const previewContainer = newInput.nextElementSibling?.querySelector('.img-preview-inline');
          if (previewContainer) {
            window.utilityFunctions.previewImage(newInput, previewContainer);
          }
        });
      }
    });
  }
  
  deleteModule(moduleEl) {
    if (confirm('确定要删除这个模块吗？')) {
      const moduleId = moduleEl.id;
      
      // 一步完成：DOM + 数据 + 更新
      moduleEl.remove();
      this.cleanupModuleData(moduleId);
      this.updateModuleCount();
    }
  }
  
  // 极简高效清理
  cleanupModuleData(moduleId) {
    if (!moduleId || !window.imageManager?.moduleData) return;
    
    // 直接过滤重建，比逐个删除更高效
    const newData = {};
    for (const key in window.imageManager.moduleData) {
      if (!key.startsWith(moduleId)) {
        newData[key] = window.imageManager.moduleData[key];
      }
    }
    window.imageManager.moduleData = newData;
  }
  
  moveModuleUp(moduleEl) {
    const prevModule = moduleEl.previousElementSibling;
    if (prevModule && !prevModule.classList.contains('empty-modules-message')) {
      moduleEl.parentNode.insertBefore(moduleEl, prevModule);
    }
  }
  
  moveModuleDown(moduleEl) {
    const nextModule = moduleEl.nextElementSibling;
    if (nextModule) {
      moduleEl.parentNode.insertBefore(nextModule, moduleEl);
    }
  }
  
  updateModuleCount() {
    const counter = document.getElementById('moduleCounter');
    const modules = document.querySelectorAll('#modulesContainer .module');
    const emptyMessage = document.getElementById('emptyModulesMessage');
    
    if (counter) {
      counter.textContent = modules.length;
    }
    
    // 显示或隐藏空状态消息
    if (emptyMessage) {
      emptyMessage.style.display = modules.length === 0 ? 'block' : 'none';
    }
  }
}

// 创建全局模块管理器实例
const moduleManager = new ModuleManager();

// 导出供其他模块使用
window.moduleManager = moduleManager; 

/* === form-resetter.js === */
// ==================== 表单重置器模块 ====================

class FormResetter {
  resetAll() {
    try {
      console.log('开始重置表单...');
      
      // 1. 清理图片管理器数据
      if (window.imageManager) {
        window.imageManager.clear();
      }
      
      // 2. 立即重置表单输入
      this.resetInputs();
      
      // 3. 立即重置模块
      this.resetModules();
      
      // 4. 立即重置预览
      this.resetPreviews();
      
      console.log('表单重置完成');
      return true;
    } catch (error) {
      console.error('重置过程中发生错误:', error);
      window.notificationSystem.show('重置时发生错误，请刷新页面', 'error');
      return false;
    }
  }
  
  resetInputs() {
    try {
      // 立即重置所有输入，保持原有功能
      // 重置文本输入框
      document.querySelectorAll('input[type="text"], textarea').forEach(input => {
        input.value = '';
      });
      
      // 重置文件输入框
      document.querySelectorAll('input[type="file"]').forEach(input => {
        input.value = '';
      });
      
      // 重置颜色输入框到默认值
      const colorDefaults = {
        '#pageColor': '#D9D9D9',
        '#gameCopyTextColor': '#FFFFFF',
        '#iconButtonTextColor': '#FFFFFF',
        '#singleButtonTextColor': '#FFFFFF',
        '#leftButtonTextColor': '#FFFFFF',
        '#rightButtonTextColor': '#FFFFFF'
      };
      
      for (const [selector, defaultValue] of Object.entries(colorDefaults)) {
        const colorInput = document.querySelector(selector);
        if (colorInput) {
          colorInput.value = defaultValue;
          const textInput = colorInput.nextElementSibling;
          if (textInput && textInput.classList.contains('color-value')) {
            textInput.value = defaultValue;
          }
        }
      }
      
      // 重置选择框
      document.querySelectorAll('select').forEach(select => {
        if (select.options.length > 0) {
          select.selectedIndex = 0;
        }
      });
      
      // 重置数字输入框
      document.querySelectorAll('input[type="number"]').forEach(input => {
        const defaultValue = input.getAttribute('placeholder') || '0';
        input.value = defaultValue;
      });
      
      // 立即处理按钮版本选择器
      const buttonVersionSelect = document.getElementById('buttonVersionSelect');
      if (buttonVersionSelect) {
        buttonVersionSelect.selectedIndex = 0;
        window.utilityFunctions.switchButtonVersion(); // 直接调用函数而不是触发事件
      }
      
      console.log('输入字段重置完成');
    } catch (error) {
      console.error('重置输入字段失败:', error);
      throw error;
    }
  }
  
  reinitializeComponents() {
    try {
      console.log('重新初始化组件...');
      
      // 只重新绑定必要的颜色输入事件，不克隆DOM节点
      this.rebindColorInputs();
      
      console.log('组件重新初始化完成');
    } catch (error) {
      console.error('组件重新初始化失败:', error);
    }
  }
  
  // 高效重新绑定颜色输入事件
  rebindColorInputs() {
    document.querySelectorAll('.color-input-group').forEach(group => {
      const colorInput = group.querySelector('input[type="color"]');
      const textInput = group.querySelector('.color-value');
      
      if (colorInput && textInput && !colorInput.dataset.bound) {
        // 标记已绑定，避免重复绑定
        colorInput.dataset.bound = 'true';
        textInput.dataset.bound = 'true';
        
        // 直接绑定事件，不克隆节点
        colorInput.addEventListener('input', () => {
          textInput.value = colorInput.value.toUpperCase();
        });
        
        textInput.addEventListener('input', () => {
          if (/^#[0-9A-F]{6}$/i.test(textInput.value)) {
            colorInput.value = textInput.value;
          }
        });
      }
    });
  }
  
  resetModules() {
    const container = document.getElementById('modulesContainer');
    if (container) {
      // 直接移除所有模块，不使用动画
      const modules = container.querySelectorAll('.module');
      modules.forEach(module => module.remove());
      
      // 延迟清理模块数据，避免阻塞UI
      setTimeout(() => {
        if (window.imageManager && window.imageManager.moduleData) {
          window.imageManager.moduleData = {};
        }
      }, 50);
      
      // 立即更新模块计数
      if (window.moduleManager) {
        window.moduleManager.updateModuleCount();
      }
    }
  }
  
  resetPreviews() {
    // 批量重置预览
    const previews = document.querySelectorAll('.img-preview-inline, .preview-container');
    previews.forEach(preview => {
      preview.innerHTML = '<span class="upload-icon-inline">+</span>';
    });
    
    // 特殊处理游戏icon预览
    const gameIconPreview = document.getElementById('gameIconPreview');
    if (gameIconPreview) {
      gameIconPreview.innerHTML = '<span class="upload-icon-text">+</span>';
    }
    
    // 批量重置按钮样式
    document.querySelectorAll('.upload-btn, .grid-btn').forEach(btn => {
      btn.style.border = '';
    });
  }
}

// 创建全局表单重置器实例
const formResetter = new FormResetter();

// 导出供其他模块使用
window.formResetter = formResetter; 

/* === ui-controller.js === */
// ==================== UI 控制器模块 ====================

class UIController {
  constructor() {
    this.initialized = false;
    this.eventListeners = new Map();
  }
  
  init() {
    if (this.initialized) return;
    
    this.initializeComponents();
    this.bindEvents();
    this.initialized = true;
  }
  
  // 初始化组件
  initializeComponents() {
    this.initializeTabs();
    this.initializeModuleManagement();
    this.initializeImageUploaders();
    this.initializeThemeSystem();
    this.initializeColorPickers();
    this.initializeCollapsiblePanels();
  }
  
  // 绑定事件
  bindEvents() {
    this.bindTabEvents();
    this.bindButtonEvents();
    this.bindVersionSelectorEvents();
  }
  
  // 初始化标签页
  initializeTabs() {
    const activeTab = document.querySelector('.tab.active');
    if (!activeTab) {
      const firstTab = document.querySelector('.tab');
      if (firstTab) {
        firstTab.classList.add('active');
        this.showTabContent(firstTab.dataset.tab);
      }
    } else {
      this.showTabContent(activeTab.dataset.tab);
    }
  }
  
  // 显示标签页内容
  showTabContent(tabId) {
    // 隐藏所有内容
    document.querySelectorAll('.tab-content').forEach(content => {
      content.classList.remove('active');
    });
    
    // 显示目标内容
    const targetContent = document.getElementById(`${tabId}-content`);
    if (targetContent) {
      targetContent.classList.add('active');
    }
  }
  
  // 绑定标签页事件
  bindTabEvents() {
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        this.showTabContent(tab.dataset.tab);
      });
    });
  }
  
  // 初始化模块管理
  initializeModuleManagement() {
    if (window.moduleManager) {
      window.moduleManager.init();
    }
  }
  
  // 初始化图片上传
  initializeImageUploaders() {
    if (window.imageUploader) {
      window.imageUploader.init();
    }
  }
  
  // 初始化主题系统
  initializeThemeSystem() {
    if (window.themeManager) {
      window.themeManager.init();
    }
  }
  
  // 初始化颜色选择器
  initializeColorPickers() {
    const colorInputs = document.querySelectorAll('input[type="color"]');
    colorInputs.forEach(colorInput => {
      const textInput = colorInput.nextElementSibling;
      if (textInput && textInput.classList.contains('color-value')) {
        this.syncColorInputs(colorInput, textInput);
      }
    });
  }
  
  // 同步颜色输入
  syncColorInputs(colorInput, textInput) {
    colorInput.addEventListener('input', () => {
      textInput.value = colorInput.value.toUpperCase();
    });
    
    textInput.addEventListener('input', () => {
      if (/^#[0-9A-F]{6}$/i.test(textInput.value)) {
        colorInput.value = textInput.value;
      }
    });
  }
  
  // 初始化折叠面板
  initializeCollapsiblePanels() {
    const collapseButtons = document.querySelectorAll('.collapse-btn');
    collapseButtons.forEach(button => {
      button.addEventListener('click', () => {
        const targetId = button.getAttribute('data-target');
        const contentElement = document.getElementById(targetId);
        
        if (contentElement) {
          button.classList.toggle('collapsed');
          contentElement.classList.toggle('collapsed');
        }
      });
    });
  }
  
  // 绑定按钮事件
  bindButtonEvents() {
    const createBtn = document.getElementById('create');
    const resetBtn = document.getElementById('reset');
    
    if (createBtn) {
      createBtn.addEventListener('click', () => this.handleCreatePrototype());
    }
    
    if (resetBtn) {
      resetBtn.addEventListener('click', () => this.handleReset());
    }
  }
  
  // 绑定版本选择器事件
  bindVersionSelectorEvents() {
    const selector = document.getElementById('buttonVersionSelect');
    if (selector) {
      selector.addEventListener('change', (e) => {
        const contents = document.querySelectorAll('#buttonVersionContent .version-content');
        contents.forEach(content => content.classList.remove('active'));
        
        const targetContent = document.getElementById(`${e.target.value}Content`);
        if (targetContent) {
          targetContent.classList.add('active');
        }
      });
    }
  }
  
  // 处理创建原型
  handleCreatePrototype() {
    const createBtn = document.getElementById('create');
    if (!createBtn) return;
    
    createBtn.disabled = true;
    createBtn.textContent = '处理中...';
    
    try {
      const config = window.dataCollector.collectFormData();
      window.pluginComm.postMessage('create-prototype', { config });
    } catch (error) {
      window.notificationSystem.show(`创建失败: ${error.message}`, 'error');
      this.resetCreateButton();
    }
  }
  
  // 处理重置
  handleReset() {
    if (!confirm('确定要重置所有设置吗？此操作无法撤销。')) {
      return;
    }
    
    try {
      console.log('开始执行重置操作...');
      
      const success = window.formResetter.resetAll();
      
      if (success) {
        // 通知插件重置已完成
        window.pluginComm.postMessage('reset-complete', {});
        window.notificationSystem.show('所有设置已重置', 'success');
        console.log('重置操作完成');
      } else {
        window.notificationSystem.show('重置失败，请重试', 'error');
      }
    } catch (error) {
      console.error('重置操作失败:', error);
      window.notificationSystem.show(`重置失败: ${error.message}`, 'error');
    }
  }
  
  // 重置创建按钮
  resetCreateButton() {
    const createBtn = document.getElementById('create');
    if (createBtn) {
      createBtn.textContent = '创建原型';
      createBtn.disabled = false;
    }
  }
}

// 创建全局UI控制器实例
const uiController = new UIController();

// 导出供其他模块使用
window.uiController = uiController; 

/* === app.js === */
// ==================== 主应用初始化和消息处理 ====================

// 应用初始化状态
const AppState = {
  initialized: false,
  initializationPromise: null
};

// 等待所有模块加载完成后初始化
function waitForModules() {
  return new Promise((resolve) => {
    let attempts = 0;
    const maxAttempts = 100; // 最多等待1秒
    
    const checkModules = () => {
      attempts++;
      
      // 检查关键模块是否已加载
      const coreModules = [
        'pluginComm', 'notificationSystem', 'uiController', 
        'dataCollector', 'utilityFunctions'
      ];
      
      const missingModules = coreModules.filter(module => !window[module]);
      
      if (missingModules.length === 0) {
        console.log('✅ 所有核心模块加载完成');
        resolve();
      } else if (attempts >= maxAttempts) {
        console.warn('⚠️ 模块加载超时，但继续初始化:', missingModules);
        resolve(); // 即使有模块缺失也继续初始化
      } else {
        setTimeout(checkModules, 10);
      }
    };
    checkModules();
  });
}

// 注册消息处理器
function registerMessageHandlers() {
  window.pluginComm.on('init', (message) => {
    console.log('插件初始化:', message.data);
  });

  window.pluginComm.on('prototype-created', () => {
    window.notificationSystem.show('原型创建成功！', 'success');
    window.uiController.resetCreateButton();
  });

  window.pluginComm.on('error', (message) => {
    console.error('操作失败:', message);
    
    // 隐藏加载状态
    window.notificationSystem.hideLoading();
    
    // 显示详细错误信息
    const errorMsg = message.message || '未知错误';
    window.notificationSystem.show(`操作失败: ${errorMsg}`, 'error');
    
    // 重置创建按钮状态
    window.uiController.resetCreateButton();
    
    // 可选：记录错误日志或发送错误报告
    if (message.details) {
      console.error('错误详情:', message.details);
    }
    
    // 可选：根据错误类型提供不同的用户提示
    if (message.errorType === 'validation') {
      window.notificationSystem.show('请检查输入的数据是否完整', 'warning', 3000);
    } else if (message.errorType === 'network') {
      window.notificationSystem.show('网络连接异常，请稍后重试', 'warning', 3000);
    }
  });

  window.pluginComm.on('save-success', () => {
    window.notificationSystem.show('配置已保存', 'success');
  });

  window.pluginComm.on('load-config-success', (message) => {
    if (message.config) {
      // TODO: 实现配置加载逻辑
      window.notificationSystem.show('配置加载成功', 'success');
    }
  });

  window.pluginComm.on('reset-acknowledged', (message) => {
    console.log('插件确认重置完成:', message.message);
  });

  window.pluginComm.on('pong', (message) => {
    console.log('插件连接正常:', message.message);
  });

  // 渠道生成成功处理
  window.pluginComm.on('channel-version-generated', (message) => {
    console.log('渠道版本生成成功:', message.message);
    window.notificationSystem.hideLoading();
    window.notificationSystem.show(message.message, 'success');
  });
}

// 初始化应用 (全局函数，供global-init.js调用)
window.initializeApp = async function() {
  // 防止重复初始化
  if (AppState.initialized || window._h5ToolsInitialized) {
    console.log('⚠️ 应用已经初始化，跳过重复初始化');
    return;
  }

  // 如果正在初始化，等待完成
  if (AppState.initializationPromise) {
    console.log('⚠️ 应用正在初始化，等待完成...');
    await AppState.initializationPromise;
    return;
  }

  try {
    // 设置初始化Promise
    AppState.initializationPromise = (async () => {
    console.log('🚀 开始初始化H5Tools应用...');
    
    // 等待所有模块加载完成
    await waitForModules();
    
    // 注册消息处理器
    registerMessageHandlers();
    
    // 🎯 强制显示UI内容 - 修复空白页面问题
    forceShowUI();
    
    // 初始化UI控制器
    if (window.uiController) {
    window.uiController.init();
    } else {
      console.warn('⚠️ UIController未加载，使用备用初始化');
      fallbackUIInit();
    }
    
    // 设置全局事件监听器
    setupEventListeners();
    
    // 初始化主题系统（可选）
    initializeThemeSystem();
    
    console.log('✅ H5Tools应用初始化完成');
    
      // 发送初始化完成消息（确保只发送一次）
      if (window.pluginComm && !AppState.initialized) {
      window.pluginComm.postMessage('ui-ready', { timestamp: Date.now() });
    }
    
      // 标记初始化完成
      AppState.initialized = true;
      window._h5ToolsInitialized = true; // 🔒 设置全局完成标志
      window._h5ToolsInitializing = false; // 清除正在初始化标志
    })();

    await AppState.initializationPromise;
  } catch (error) {
    console.error('❌ 应用初始化失败:', error);
    // 即使初始化失败，也尝试显示基础UI
    forceShowUI();
    // 重置初始化状态，允许重试
    AppState.initialized = false;
    AppState.initializationPromise = null;
    window._h5ToolsInitializing = false; // 清除正在初始化标志
  }
};

// 🚨 强制显示UI内容 - 解决空白页面问题
function forceShowUI() {
  console.log('🔧 强制显示UI内容...');
  
  // 确保第一个标签页激活
  const firstTab = document.querySelector('.tab');
  if (firstTab && !document.querySelector('.tab.active')) {
    firstTab.classList.add('active');
    console.log('✅ 激活第一个标签页:', firstTab.dataset.tab);
  }
  
  // 显示对应的内容区域
  const activeTab = document.querySelector('.tab.active');
  if (activeTab) {
    const tabId = activeTab.dataset.tab;
    const content = document.getElementById(`${tabId}-content`);
    if (content) {
      // 隐藏所有内容
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      // 显示目标内容
      content.classList.add('active');
      console.log('✅ 显示标签页内容:', tabId);
    }
  }
  
  // 确保必要的元素可见
  const channelsMainView = document.getElementById('channelsMainView');
  if (channelsMainView) {
    channelsMainView.style.display = 'block';
    console.log('✅ 显示渠道主视图');
  }
}

// 备用UI初始化
function fallbackUIInit() {
  console.log('🔧 执行备用UI初始化...');
  
  // 基础标签页切换
  const tabs = document.querySelectorAll('.tab');
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      tabs.forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      
      // 显示对应内容
      const tabId = tab.dataset.tab;
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      const content = document.getElementById(`${tabId}-content`);
      if (content) {
        content.classList.add('active');
      }
    });
  });
  
  console.log('✅ 备用UI初始化完成');
}

// 设置事件监听器
function setupEventListeners() {
  try {
    if (window.utilityFunctions) {
    document.addEventListener('click', window.utilityFunctions.globalClickHandler);
    document.addEventListener('change', window.utilityFunctions.globalChangeHandler);
    document.addEventListener('input', window.utilityFunctions.globalInputHandler);
    }
  } catch (error) {
    console.warn('⚠️ 全局事件监听器设置失败:', error);
  }
}
    
    // 初始化主题系统
function initializeThemeSystem() {
  try {
    if (window.utilityFunctions) {
    // 注意：已移除主题缓存机制，直接应用系统主题
    window.utilityFunctions.detectAndApplySystemTheme();
    window.utilityFunctions.setupSystemThemeListener();
    window.utilityFunctions.bindThemeButtonEvents();
    }
  } catch (error) {
    console.warn('⚠️ 主题系统初始化失败:', error);
  }
}

// 注意：DOM事件监听器和兼容性函数现在在global-init.js中处理


/* === global-init.js === */
// ==================== 全局实例化和初始化管理 ====================

/* eslint-disable no-undef */
// 注意：以下类由其他文件在构建时提供，ESLint无法检测到定义

// === 全局实例化代码 ===

// 创建全局数据收集器实例
window.dataCollector = new DataCollector();

// 创建全局图片数据管理器实例  
window.imageDataManager = new ImageDataManager();

// 🚨 向后兼容：为imageManager创建别名
window.imageManager = window.imageDataManager;

// 创建全局渠道管理器实例
window.channelManager = new ChannelManager();

// 创建全局图片上传器实例
window.imageUploader = new ImageUploader();

// 创建全局图片切片处理器实例
window.imageSliceHandler = new ImageSliceHandler();

// 创建全局模块管理器实例
window.moduleManager = new ModuleManager();

// 创建全局表单重置器实例
window.formResetter = new FormResetter();

// 创建全局UI控制器实例
window.uiController = new UIController();

// 创建全局主题管理器实例
window.themeManager = new ThemeManager();

// 创建全局文件处理器实例
window.fileProcessor = new FileProcessor();

// 创建全局工具函数对象（已移除loadThemePreference）
window.utilityFunctions = {
  switchTab,
  switchButtonVersion,
  createPrototype,
  getImageData,
  collectModuleData,
  collectModuleContent,
  collectNineGridData,
  collectSignInData,
  collectCardsData,
  collectActivityContentData,
  getPrizePosition,
  previewImage,
  setupSystemThemeListener,
  detectAndApplySystemTheme,
  applyTheme,
  updateThemeButtonsState,
  switchTheme,
  bindThemeButtonEvents,
  globalClickHandler,
  globalChangeHandler,
  globalInputHandler,
  handleFileUpload,
  resetForm
};

console.log('✅ 所有全局实例创建完成:', {
  storageAdapter: !!window.storageAdapter,
  pluginComm: !!window.pluginComm,
  notificationSystem: !!window.notificationSystem,
  dataCollector: !!window.dataCollector,
  imageManager: !!window.imageManager,
  channelManager: !!window.channelManager,
  imageUploader: !!window.imageUploader,
  imageSliceHandler: !!window.imageSliceHandler,
  moduleManager: !!window.moduleManager,
  formResetter: !!window.formResetter,
  uiController: !!window.uiController,
  themeManager: !!window.themeManager,
  fileProcessor: !!window.fileProcessor,
  utilityFunctions: !!window.utilityFunctions,
  IconManager: !!window.IconManager
});



// 🚨 重要：触发插件通信器就绪事件（告知内联脚本）
if (window.pluginComm) {
  // 在全局窗口对象上设置标志
  window._h5ToolsPluginCommReady = true;
  
  // 触发自定义事件
  const event = new CustomEvent('h5ToolsReady', {
    detail: { 
      pluginCommReady: true,
      timestamp: Date.now(),
      modules: Object.keys(window).filter(k => k.includes('Comm') || k.includes('Manager'))
    }
  });
  window.dispatchEvent(event);
  
  console.log('🎯 插件通信器就绪事件已触发');
}

// 兼容性函数 - 保持向后兼容
window.collectFormData = function() {
  return window.dataCollector ? window.dataCollector.collectFormData() : null;
};

window.postMessageToPlugin = function(type, data) {
  if (window.pluginComm) {
    window.pluginComm.postMessage(type, data);
  }
};

window.showNotification = function(message, type) {
  if (window.notificationSystem) {
    window.notificationSystem.show(message, type);
  }
};

// 🚨 关键修复：确保在DOM加载完成且所有实例创建后才初始化应用
function safeInitializeApp() {
  console.log('🔧 安全初始化应用...');
  
  // 🔒 全局初始化锁 - 防止重复初始化
  if (window._h5ToolsInitializing || window._h5ToolsInitialized) {
    console.log('⚠️ 应用已经初始化或正在初始化，跳过重复调用');
    return;
  }
  
  // 设置初始化标志
  window._h5ToolsInitializing = true;
  
  // 直接调用初始化，此时所有实例都已创建
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      if (!window._h5ToolsInitialized) {
        window.initializeApp();
      }
    });
  } else {
    // DOM已经加载完成，直接初始化
    // 使用setTimeout确保当前执行栈完成后再初始化
    setTimeout(() => {
      if (!window._h5ToolsInitialized) {
        window.initializeApp();
      }
    }, 0);
  }
}

// 调用安全初始化
safeInitializeApp();

// 🎯 立即初始化标签页切换功能（不等待其他模块）
(function immediateTabInit() {
  // 防止重复初始化
  if (window._h5ToolsTabsInitialized) {
    console.log('⚠️ 标签页已经初始化，跳过重复初始化');
    return;
  }
  
  const initTabs = () => {
    const tabs = document.querySelectorAll('.tab');
    if (tabs.length === 0) {
      // DOM可能还没有完全加载，延迟重试（最多重试5次）
      if (!initTabs.retryCount) initTabs.retryCount = 0;
      if (initTabs.retryCount < 5) {
        initTabs.retryCount++;
        setTimeout(initTabs, 100);
      }
      return;
    }
    
    // 标记标签页已初始化
    window._h5ToolsTabsInitialized = true;
    
    tabs.forEach(tab => {
      // 检查是否已经绑定过事件
      if (tab.dataset.tabHandlerBound === 'true') {
        return; // 已经绑定过，跳过
      }
      
      // 标记已绑定
      tab.dataset.tabHandlerBound = 'true';
      
      // 创建新的事件处理器
      tab._tabClickHandler = () => {
        tabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        const tabId = tab.getAttribute('data-tab');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        const content = document.getElementById(`${tabId}-content`);
        if (content) {
          content.classList.add('active');
        }
        
        console.log(`✅ 标签页切换到: ${tabId}`);
      };
      
      // 绑定事件
      tab.addEventListener('click', tab._tabClickHandler);
    });
    
    console.log('✅ 立即标签页切换功能已初始化');
  };
  
  // 立即尝试初始化
  initTabs();
})(); 


</script>

</body>
</html> 