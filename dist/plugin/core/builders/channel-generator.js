import{__awaiter as e}from"../../node_modules/tslib/tslib.es6.js";import{NodeUtils as t,ColorUtils as o}from"./figma-utils.js";let n={};class i{constructor(e,t){this.channel=e.toLowerCase(),this.sourcePrototype=t}generate(){return e(this,void 0,void 0,function*(){try{console.log(`开始生成${this.channel}渠道版本`);const e=yield this.clonePrototype();yield this.applyChannelAdjustments(e),this.positionChannelPrototype(e),console.log(`${this.channel}渠道版本创建完成`)}catch(e){throw console.error(`生成${this.channel}渠道版本失败:`,e),e}})}clonePrototype(){return e(this,void 0,void 0,function*(){try{const e=this.sourcePrototype.clone();return e.name=`${this.channel.toUpperCase()}-H5`,e.x=this.sourcePrototype.x+1080,e.y=this.sourcePrototype.y,t.safeAppendChild(figma.currentPage,e,`${this.channel}渠道原型添加`),console.log(`${this.channel}渠道原型复制完成，位置: (${e.x}, ${e.y})`),e}catch(e){throw console.error("复制原型失败:",e),new Error(`复制${this.channel}原型失败: ${e instanceof Error?e.message:"未知错误"}`)}})}applyChannelAdjustments(t){return e(this,void 0,void 0,function*(){try{console.log(`应用${this.channel}渠道的特定调整`);const e=this.findAdaptiveModule(t);if(!e)throw new Error("未找到自适应模块容器");yield this.adjustAdaptiveModuleContent(e),this.resizeChannelPrototype(t,e)}catch(e){throw console.error(`应用${this.channel}渠道调整失败:`,e),e}})}findAdaptiveModule(e){const t=e=>{if("FRAME"===e.type&&"自适应模块"===e.name)return e;if("children"in e)for(const o of e.children){const e=t(o);if(e)return e}return null};return t(e)}adjustAdaptiveModuleContent(t){return e(this,void 0,void 0,function*(){for(const e of t.children)if("FRAME"===e.type){const t=e;yield this.adjustModuleStyles(t),yield this.adjustModuleContent(t)}})}resizeChannelPrototype(e,t){try{const o=t.width,n=t.height;e.resize(o,n),console.log(`${this.channel}渠道H5容器尺寸已调整为: ${o}x${n}`)}catch(e){console.error("调整渠道H5容器尺寸失败:",e)}}adjustModuleStyles(t){return e(this,void 0,void 0,function*(){try{switch(this.channel){case"oppo":yield this.applyOppoStyles(t);break;case"vivo":yield this.applyVivoStyles(t);break;case"xiaomi":yield this.applyXiaomiStyles(t);break;default:console.log(`${this.channel}渠道暂无特定样式调整`)}}catch(e){console.error("调整模块样式失败:",e)}})}adjustModuleContent(t){return e(this,void 0,void 0,function*(){try{switch(this.channel){case"oppo":yield this.applyOppoContent(t);break;case"vivo":yield this.applyVivoContent(t);break;case"xiaomi":yield this.applyXiaomiContent(t);break;default:console.log(`${this.channel}渠道暂无特定内容调整`)}}catch(e){console.error("调整模块内容失败:",e)}})}applyOppoStyles(t){return e(this,void 0,void 0,function*(){try{switch(console.log(`应用OPPO样式到模块: "${t.name}"`),console.log(`模块名称长度: ${t.name.length}`),console.log("模块名称字符编码:",Array.from(t.name).map(e=>e.charCodeAt(0))),t.name.trim()){case"头图":yield this.adjustOppoHeaderModule(t);break;case"九宫格抽奖":console.log("匹配到九宫格抽奖模块，开始调整"),yield this.adjustOppoNineGridModule(t);break;case"尾版":yield this.adjustOppoFooterModule(t);break;default:console.log(`模块 "${t.name}" 无需OPPO特定样式调整`),console.log("可匹配的模块名称: 头图, 九宫格抽奖, 尾版")}}catch(e){console.error("OPPO样式调整失败:",e)}})}adjustOppoHeaderModule(t){return e(this,void 0,void 0,function*(){try{console.log("开始调整OPPO头图模块"),t.resize(t.width,1300);const e=this.findMaskRectangle(t);if(e){const t=e.height-100;e.resize(e.width,t),e.y=e.y+150}const o=this.findHeaderImageNode(t);o&&(o.y=o.y+100),console.log("OPPO头图模块调整完成")}catch(e){console.error("调整OPPO头图模块失败:",e)}})}findMaskRectangle(e){const t=e=>{if("RECTANGLE"===e.type&&"蒙版"===e.name)return e;if("children"in e)for(const o of e.children){const e=t(o);if(e)return e}return null};return t(e)}findHeaderImageNode(e){const t=e=>{if("头图图片"===e.name)return e;if("children"in e)for(const o of e.children){const e=t(o);if(e)return e}return null};return t(e)}adjustOppoNineGridModule(t){return e(this,void 0,void 0,function*(){try{console.log("开始调整OPPO九宫格模块");const e=this.findNineGridMainContainer(t);if(!e)return void console.warn("未找到九宫格主体容器");this.clearContainerContent(e),yield this.insertEggBreakingImage(e,this.channel);const o=yield this.createDrawContainer(e,t),n=yield this.createMyPrizesContainer(e,o,t);yield this.createRulesContainer(e,n,t),console.log("OPPO九宫格模块调整完成")}catch(e){console.error("调整OPPO九宫格模块失败:",e)}})}adjustOppoFooterModule(t){return e(this,void 0,void 0,function*(){try{console.log("开始调整OPPO尾版模块"),t.resize(t.width,807),this.clearFooterLogo(t),yield this.insertFooterStyleImage(t,this.channel),console.log("OPPO尾版模块调整完成")}catch(e){console.error("调整OPPO尾版模块失败:",e)}})}clearFooterLogo(e){try{const o=e.findOne(e=>e.name.toLowerCase().includes("logo"));o&&(t.safeRemoveNode(o,"清除尾版LOGO"),console.log("尾版LOGO已清除"))}catch(e){console.error("清除尾版LOGO失败:",e)}}findNineGridMainContainer(e){return e.findOne(e=>"FRAME"===e.type&&"九宫格主体"===e.name)||null}clearContainerContent(e){try{[...e.children].forEach(o=>{t.safeRemoveNode(o,`清除${e.name}子节点`)}),console.log(`已清除${e.name}的所有内容`)}catch(e){console.error("清除容器内容失败:",e)}}insertEggBreakingImage(i,r){return e(this,void 0,void 0,function*(){try{const e=n[r],l=null==e?void 0:e.eggBreaking;if(l){const e=yield this.createImageFromData(l,"砸蛋样式");e.resize(864,512),e.x=108,e.y=150,t.safeAppendChild(i,e,"砸蛋样式图片添加"),console.log("砸蛋样式图片已插入:",l.name)}else{const e=figma.createRectangle();e.name="砸蛋样式（占位）",e.resize(864,512),e.x=108,e.y=150,e.fills=[o.createSolidFill({r:.9,g:.8,b:.7})],t.safeAppendChild(i,e,"砸蛋样式占位图片添加"),console.log("砸蛋样式占位图片已插入")}}catch(e){console.error("插入砸蛋样式图片失败:",e)}})}createDrawContainer(n,i){return e(this,void 0,void 0,function*(){try{const e=t.createFrame("立即抽奖",512,133);e.x=284,e.y=648,e.fills=[];const r=yield this.copyButtonImageFromGameInfo(i);if(r){const o=r.height/r.width;r.resize(512,512*o),r.x=(e.width-r.width)/2,r.y=(e.height-r.height)/2,t.safeAppendChild(e,r,"立即抽奖按钮图片添加")}const l=this.getDownloadButtonTextStyle(i);try{const n=figma.createText();n.name="立即抽奖文本",n.characters="立即抽奖",l?(n.fontName=l.fontName,n.fills=l.fills):(n.fontName={family:"Inter",style:"Bold"},n.fills=[o.createSolidFill({r:1,g:1,b:1})]),n.fontSize=58,n.textAlignHorizontal="CENTER",n.textAlignVertical="CENTER",n.x=(e.width-n.width)/2,n.y=(e.height-n.height)/2,t.safeAppendChild(e,n,"立即抽奖文本添加")}catch(e){console.error("创建文本节点失败:",e)}return t.safeAppendChild(n,e,"立即抽奖容器添加"),e}catch(e){return console.error("创建立即抽奖容器失败:",e),null}})}createMyPrizesContainer(n,i,r){return e(this,void 0,void 0,function*(){try{const e=t.createFrame("我的奖品",398,112);if(e.x=102,e.y=851,e.fills=[],i){const o=this.copyButtonImageFromContainer(i);if(o){const n=o.height/o.width;o.resize(398,398*n),o.x=(e.width-o.width)/2,o.y=(e.height-o.height)/2,t.safeAppendChild(e,o,"我的奖品按钮图片添加")}}const l=this.getDownloadButtonTextStyle(r);try{const n=figma.createText();n.name="我的奖品文本",n.characters="我的奖品",l?(n.fontName=l.fontName,n.fills=l.fills):(n.fontName={family:"Inter",style:"Bold"},n.fills=[o.createSolidFill({r:1,g:1,b:1})]),n.fontSize=50,n.textAlignHorizontal="CENTER",n.textAlignVertical="CENTER",n.x=(e.width-n.width)/2,n.y=(e.height-n.height)/2,t.safeAppendChild(e,n,"我的奖品文本添加")}catch(e){console.error("创建我的奖品文本失败:",e)}return t.safeAppendChild(n,e,"我的奖品容器添加"),e}catch(e){return console.error("创建我的奖品容器失败:",e),null}})}createRulesContainer(n,i,r){return e(this,void 0,void 0,function*(){try{const e=t.createFrame("活动规则",398,112);if(e.x=580,e.y=851,e.fills=[],i){const o=this.copyButtonImageFromContainer(i);o&&(o.x=(e.width-o.width)/2,o.y=(e.height-o.height)/2,t.safeAppendChild(e,o,"活动规则按钮图片添加"))}const l=this.getDownloadButtonTextStyle(r);try{const n=figma.createText();n.name="活动规则文本",n.characters="活动规则",l?(n.fontName=l.fontName,n.fills=l.fills):(n.fontName={family:"Inter",style:"Bold"},n.fills=[o.createSolidFill({r:1,g:1,b:1})]),n.fontSize=50,n.textAlignHorizontal="CENTER",n.textAlignVertical="CENTER",n.x=(e.width-n.width)/2,n.y=(e.height-n.height)/2,t.safeAppendChild(e,n,"活动规则文本添加")}catch(e){console.error("创建活动规则文本失败:",e)}t.safeAppendChild(n,e,"活动规则按钮添加")}catch(e){console.error("创建活动规则按钮失败:",e)}})}copyButtonImageFromGameInfo(t){return e(this,void 0,void 0,function*(){try{const e=t.parent;if(!e||"FRAME"!==e.type)return null;const o=e.findOne(e=>"FRAME"===e.type&&"游戏信息"===e.name);if(!o)return null;const n=e=>{if("按钮底图"===e.name){if("clone"in e){return e.clone()}return null}if("children"in e)for(const t of e.children){const e=n(t);if(e)return e}return null};return n(o)}catch(e){return console.error("从游戏信息复制按钮底图失败:",e),null}})}getDownloadButtonTextStyle(e){try{const t=e.parent;if(!t||"FRAME"!==t.type)return null;const o=t.findOne(e=>"FRAME"===e.type&&"游戏信息"===e.name);if(!o)return null;const n=e=>{if("TEXT"===e.type&&e.parent&&"name"in e.parent&&"下载按钮"===e.parent.name)return e;if("children"in e)for(const t of e.children){const e=n(t);if(e)return e}return null},i=n(o);return i?{fontName:i.fontName,fills:i.fills}:null}catch(e){return console.error("获取下载按钮文本样式失败:",e),null}}insertFooterStyleImage(i,r){return e(this,void 0,void 0,function*(){try{const e=n[r],l=null==e?void 0:e.footerStyle;if(l){const e=yield this.createImageFromData(l,"尾版样式");e.resize(1080,289),e.x=(i.width-1080)/2,e.y=122,t.safeAppendChild(i,e,"尾版样式图片添加"),console.log("尾版样式图片已插入:",l.name)}else{const e=figma.createRectangle();e.name="尾版样式（占位）",e.resize(1080,289),e.x=(i.width-1080)/2,e.y=122,e.fills=[o.createSolidFill({r:.8,g:.9,b:.8})],t.safeAppendChild(i,e,"尾版样式占位图片添加"),console.log("尾版样式占位图片已插入")}}catch(e){console.error("插入尾版样式图片失败:",e)}})}createImageFromData(t,o){return e(this,void 0,void 0,function*(){let e;if("string"==typeof t.data){const o=atob(t.data);e=new Uint8Array(o.length);for(let t=0;t<o.length;t++)e[t]=o.charCodeAt(t)}else e=new Uint8Array(t.data);const n=figma.createRectangle();n.name=o,n.resize(t.width,t.height);const i={type:"IMAGE",imageHash:figma.createImage(e).hash,scaleMode:"FILL"};return n.fills=[i],n})}applyVivoStyles(t){return e(this,void 0,void 0,function*(){console.log(`VIVO样式调整: ${t.name}`)})}applyVivoContent(t){return e(this,void 0,void 0,function*(){console.log(`VIVO内容调整: ${t.name}`)})}applyXiaomiStyles(t){return e(this,void 0,void 0,function*(){console.log(`小米样式调整: ${t.name}`)})}applyXiaomiContent(t){return e(this,void 0,void 0,function*(){console.log(`小米内容调整: ${t.name}`)})}applyOppoContent(t){return e(this,void 0,void 0,function*(){console.log(`OPPO内容调整: ${t.name}`)})}positionChannelPrototype(e){e.x=this.sourcePrototype.x+this.sourcePrototype.width+100,e.y=this.sourcePrototype.y}copyButtonImageFromContainer(e){try{const t=e.findOne(e=>"RECTANGLE"===e.type);return t?t.clone():null}catch(e){return console.error("从容器复制按钮图片失败:",e),null}}}function r(t){return e(this,void 0,void 0,function*(){try{console.log(`开始为${t}渠道生成H5原型`);const o=function(){try{const e=figma.currentPage.selection;if(0===e.length)return console.warn("未选中任何节点"),null;const t=e[0];return"FRAME"===t.type&&"H5原型"===t.name?(console.log("找到选中的H5原型容器"),t):(console.warn(`选中的节点不是H5原型容器，当前选中: ${t.name} (类型: ${t.type})`),null)}catch(e){return console.error("获取选中的原型容器失败:",e),null}}();if(!o)throw new Error('请先选中名为"H5原型"的容器');yield function(){return e(this,void 0,void 0,function*(){try{n={};const e=["oppo","vivo","huawei","xiaomi"];for(const t of e){const e=yield figma.clientStorage.getAsync(`channel-images-${t}`);e&&(n[t]=JSON.parse(e),console.log(`已加载 ${t} 渠道图片数据`))}}catch(e){console.warn("获取渠道图片数据失败:",e),n={}}})}(),console.log("分析H5原型容器中的文本节点并加载字体..."),yield function(t){return e(this,void 0,void 0,function*(){try{console.log("开始分析H5原型容器中的文本节点...");const o=new Set,n=e=>{if("TEXT"===e.type){const t=e;if("object"==typeof t.fontName&&"family"in t.fontName){const e=`${t.fontName.family}|${t.fontName.style}`;o.add(e),console.log(`发现文本节点 "${t.name}" 使用字体: ${t.fontName.family} ${t.fontName.style}`)}else if(t.fontName===figma.mixed){const e=t.characters.length;for(let n=0;n<e;n++){const e=t.getRangeFontName(n,n+1),i=`${e.family}|${e.style}`;o.add(i)}console.log(`发现文本节点 "${t.name}" 使用混合字体`)}}if("children"in e)for(const t of e.children)n(t)};n(t),console.log(`共发现 ${o.size} 种字体需要加载`);const i=Array.from(o).map(t=>e(this,void 0,void 0,function*(){const[e,o]=t.split("|");try{yield figma.loadFontAsync({family:e,style:o}),console.log(`✓ 字体加载成功: ${e} ${o}`)}catch(t){console.warn(`✗ 字体加载失败: ${e} ${o}`,t)}}));yield Promise.all(i),console.log("所有字体加载完成")}catch(e){console.error("从原型容器加载字体时发生错误:",e)}})}(o),console.log("字体加载完成");const r=new i(t,o);yield r.generate(),console.log(`${t}渠道版本生成完成`)}catch(e){throw console.error(`生成${t}渠道版本失败:`,e),e}})}export{r as generateChannelVersion};
//# sourceMappingURL=channel-generator.js.map
