import{__awaiter as e}from"../../node_modules/tslib/tslib.es6.js";import{CONSTANTS as o}from"../types/index.js";import{Utils as i}from"../utils/index.js";import{FontManager as t,NodeUtils as s,ColorUtils as r,ImageNodeBuilder as n}from"./figma-utils.js";import{createHeaderModule as l,createGameInfoModule as a,createCustomModule as h,createRulesModule as g,createFooterModule as c}from"./module-builders.js";class f{constructor(e){this.config=e}build(){return e(this,void 0,void 0,function*(){try{return console.log("开始构建H5原型..."),yield t.loadAll(),this.createBaseFrames(),yield this.setupBackground(),yield this.addModules(),this.finalizeLayout(),console.log("H5原型构建完成"),this.outerFrame}catch(e){throw console.error("H5原型构建失败:",e),e}})}hasAnyModuleContent(){const e=!(!this.config.headerImage&&!this.config.titleUpload),o=!!(this.config.gameName||this.config.gameDesc||this.config.gameIcon),i=!!(this.config.modules&&this.config.modules.length>0),t=this.config.rulesTitle&&""!==this.config.rulesTitle.trim(),s=null!==this.config.rulesBgImage&&void 0!==this.config.rulesBgImage,r=this.config.rulesContent&&""!==this.config.rulesContent.trim(),n=t||s||r,l=!(!this.config.footerLogo&&!this.config.footerBg);return e||o||i||n||l}createBaseFrames(){this.outerFrame=s.createFrame("H5原型",o.H5_WIDTH,100),this.outerFrame.layoutMode="NONE",this.outerFrame.clipsContent=!0,this.outerFrame.fills=[],this.hasAnyModuleContent()?(this.h5Frame=s.createFrame("自适应模块",o.H5_WIDTH,100),this.h5Frame.fills=[],s.setupAutoLayout(this.h5Frame,"VERTICAL",0,0),this.h5Frame.clipsContent=!0,this.h5Frame.layoutWrap="NO_WRAP",console.log("检测到模块内容，已创建自适应模块容器")):console.log("未检测到模块内容，跳过自适应模块容器创建")}setupBackground(){return e(this,void 0,void 0,function*(){console.log("🎨 [背景设置调试] 开始设置背景，配置信息:"),console.log("   - pageBgColor:",this.config.pageBgColor),console.log("   - pageBgImage:",!!this.config.pageBgImage);const e=!this.config.pageBgColor||"#FFFFFF"===this.config.pageBgColor||"#ffffff"===this.config.pageBgColor||"#ffffff"===this.config.pageBgColor.toLowerCase();if(console.log("   - 是否为默认白色:",e),this.h5Frame&&(this.h5Frame.fills=[],console.log("✅ 自适应模块容器设置为透明填充")),e)this.outerFrame.fills=[],console.log("✅ H5原型容器背景设置为透明（默认白色，代表用户未修改）"),console.log("   - 最终Frame填充:",this.outerFrame.fills);else{console.log("🎯 [颜色转换] 开始转换颜色:",this.config.pageBgColor);const e=r.hexToRgb(this.config.pageBgColor||"#FFFFFF");console.log("   - RGB转换结果:",e);const o=r.createSolidFill(e);console.log("   - 创建的填充对象:",o),this.outerFrame.fills=[o],console.log(`✅ H5原型容器背景色设置为: ${this.config.pageBgColor}`),console.log("   - 最终Frame填充:",this.outerFrame.fills)}if(this.config.pageBgImage){if(i.extractUint8Array(this.config.pageBgImage)){console.log("🖼️  开始添加背景图片");const e=yield n.insertImage(this.config.pageBgImage,"页面背景图片");e&&(e.x=(this.outerFrame.width-e.width)/2,e.y=0,"constraints"in e&&(e.constraints={horizontal:"CENTER",vertical:"MIN"}),s.safeAppendChild(this.outerFrame,e,"页面背景图片添加"),console.log("✅ 背景图片添加完成"))}}this.h5Frame&&s.safeAppendChild(this.outerFrame,this.h5Frame,"H5自适应模块容器添加"),console.log("🎨 [背景设置调试] 背景设置完成")})}addModules(){return e(this,void 0,void 0,function*(){if(!this.h5Frame)return void console.log("没有自适应模块容器，跳过模块添加");const e=yield this.createAllModules();s.safeBatchAppendChildren(this.h5Frame,e,"H5模块批量添加")})}createAllModules(){return e(this,void 0,void 0,function*(){return Promise.all([this.createHeaderModuleIfNeeded(),this.createGameInfoModuleIfNeeded(),...this.createCustomModules(),this.createRulesModuleIfNeeded(),this.createFooterModuleIfNeeded()])})}createHeaderModuleIfNeeded(){return e(this,void 0,void 0,function*(){if(this.config.headerImage||this.config.titleUpload){const e=yield l(this.config.headerImage,this.config.titleUpload);if(e)return e}return null})}createGameInfoModuleIfNeeded(){return e(this,void 0,void 0,function*(){if(this.config.gameName||this.config.gameDesc||this.config.gameIcon){return yield a(this.config)}return null})}createCustomModules(){var o;return(null===(o=this.config.modules)||void 0===o?void 0:o.map(o=>e(this,void 0,void 0,function*(){return yield h(o)})))||[]}createRulesModuleIfNeeded(){return e(this,void 0,void 0,function*(){const e=this.config.rulesTitle&&""!==this.config.rulesTitle.trim(),o=null!==this.config.rulesBgImage&&void 0!==this.config.rulesBgImage,i=this.config.rulesContent&&""!==this.config.rulesContent.trim();if(e||o||i){return yield g(this.config)}return null})}createFooterModuleIfNeeded(){return e(this,void 0,void 0,function*(){if(this.config.footerLogo||this.config.footerBg){const e=yield c(this.config);if(e)return e}return null})}finalizeLayout(){if(this.h5Frame){this.outerFrame.resize(o.H5_WIDTH,this.h5Frame.height);try{if(this.h5Frame.parent===this.outerFrame){const e=this.outerFrame.children.length;e>1&&this.outerFrame.insertChild(e-1,this.h5Frame)}}catch(e){console.error("重新排列H5模块容器失败:",e)}}else{let e=100;if(this.config.pageBgImage){const o=this.outerFrame.findOne(e=>"页面背景图片"===e.name);o&&"height"in o&&(e=Math.max(e,o.height))}this.outerFrame.resize(o.H5_WIDTH,e),console.log(`没有模块内容，H5原型设置为最小高度: ${e}px`)}s.safeAppendChild(figma.currentPage,this.outerFrame,"H5原型添加到当前页面"),figma.viewport.scrollAndZoomIntoView([this.outerFrame])}}function u(o){return e(this,void 0,void 0,function*(){return new f(o).build()})}export{f as H5PrototypeBuilder,u as createH5Prototype};
//# sourceMappingURL=h5-prototype-builder.js.map
