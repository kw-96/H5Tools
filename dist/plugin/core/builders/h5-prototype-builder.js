import{__awaiter as e}from"../../node_modules/tslib/tslib.es6.js";import{CONSTANTS as o}from"../types/index.js";import{Utils as i}from"../utils/index.js";import{FontManager as t,NodeUtils as s,ColorUtils as r,ImageNodeBuilder as n}from"./figma-utils.js";import{createHeaderModule as l,createGameInfoModule as a,createCustomModule as h,createRulesModule as g,createFooterModule as c}from"./module-builders.js";class f{constructor(e){this.config=e}build(){return e(this,void 0,void 0,function*(){try{return console.log("å¼€å§‹æ„å»ºH5åŸå‹..."),yield t.loadAll(),this.createBaseFrames(),yield this.setupBackground(),yield this.addModules(),this.finalizeLayout(),console.log("H5åŸå‹æ„å»ºå®Œæˆ"),this.outerFrame}catch(e){throw console.error("H5åŸå‹æ„å»ºå¤±è´¥:",e),e}})}hasAnyModuleContent(){const e=!(!this.config.headerImage&&!this.config.titleUpload),o=!!(this.config.gameName||this.config.gameDesc||this.config.gameIcon),i=!!(this.config.modules&&this.config.modules.length>0),t=this.config.rulesTitle&&""!==this.config.rulesTitle.trim(),s=null!==this.config.rulesBgImage&&void 0!==this.config.rulesBgImage,r=this.config.rulesContent&&""!==this.config.rulesContent.trim(),n=t||s||r,l=!(!this.config.footerLogo&&!this.config.footerBg);return e||o||i||n||l}createBaseFrames(){this.outerFrame=s.createFrame("H5åŸå‹",o.H5_WIDTH,100),this.outerFrame.layoutMode="NONE",this.outerFrame.clipsContent=!0,this.outerFrame.fills=[],this.hasAnyModuleContent()?(this.h5Frame=s.createFrame("è‡ªé€‚åº”æ¨¡å—",o.H5_WIDTH,100),this.h5Frame.fills=[],s.setupAutoLayout(this.h5Frame,"VERTICAL",0,0),this.h5Frame.clipsContent=!0,this.h5Frame.layoutWrap="NO_WRAP",console.log("æ£€æµ‹åˆ°æ¨¡å—å†…å®¹ï¼Œå·²åˆ›å»ºè‡ªé€‚åº”æ¨¡å—å®¹å™¨")):console.log("æœªæ£€æµ‹åˆ°æ¨¡å—å†…å®¹ï¼Œè·³è¿‡è‡ªé€‚åº”æ¨¡å—å®¹å™¨åˆ›å»º")}setupBackground(){return e(this,void 0,void 0,function*(){console.log("ğŸ¨ [èƒŒæ™¯è®¾ç½®è°ƒè¯•] å¼€å§‹è®¾ç½®èƒŒæ™¯ï¼Œé…ç½®ä¿¡æ¯:"),console.log("   - pageBgColor:",this.config.pageBgColor),console.log("   - pageBgImage:",!!this.config.pageBgImage);const e=!this.config.pageBgColor||"#FFFFFF"===this.config.pageBgColor||"#ffffff"===this.config.pageBgColor||"#ffffff"===this.config.pageBgColor.toLowerCase();if(console.log("   - æ˜¯å¦ä¸ºé»˜è®¤ç™½è‰²:",e),this.h5Frame&&(this.h5Frame.fills=[],console.log("âœ… è‡ªé€‚åº”æ¨¡å—å®¹å™¨è®¾ç½®ä¸ºé€æ˜å¡«å……")),e)this.outerFrame.fills=[],console.log("âœ… H5åŸå‹å®¹å™¨èƒŒæ™¯è®¾ç½®ä¸ºé€æ˜ï¼ˆé»˜è®¤ç™½è‰²ï¼Œä»£è¡¨ç”¨æˆ·æœªä¿®æ”¹ï¼‰"),console.log("   - æœ€ç»ˆFrameå¡«å……:",this.outerFrame.fills);else{console.log("ğŸ¯ [é¢œè‰²è½¬æ¢] å¼€å§‹è½¬æ¢é¢œè‰²:",this.config.pageBgColor);const e=r.hexToRgb(this.config.pageBgColor||"#FFFFFF");console.log("   - RGBè½¬æ¢ç»“æœ:",e);const o=r.createSolidFill(e);console.log("   - åˆ›å»ºçš„å¡«å……å¯¹è±¡:",o),this.outerFrame.fills=[o],console.log(`âœ… H5åŸå‹å®¹å™¨èƒŒæ™¯è‰²è®¾ç½®ä¸º: ${this.config.pageBgColor}`),console.log("   - æœ€ç»ˆFrameå¡«å……:",this.outerFrame.fills)}if(this.config.pageBgImage){if(i.extractUint8Array(this.config.pageBgImage)){console.log("ğŸ–¼ï¸  å¼€å§‹æ·»åŠ èƒŒæ™¯å›¾ç‰‡");const e=yield n.insertImage(this.config.pageBgImage,"é¡µé¢èƒŒæ™¯å›¾ç‰‡");e&&(e.x=(this.outerFrame.width-e.width)/2,e.y=0,"constraints"in e&&(e.constraints={horizontal:"CENTER",vertical:"MIN"}),s.safeAppendChild(this.outerFrame,e,"é¡µé¢èƒŒæ™¯å›¾ç‰‡æ·»åŠ "),console.log("âœ… èƒŒæ™¯å›¾ç‰‡æ·»åŠ å®Œæˆ"))}}this.h5Frame&&s.safeAppendChild(this.outerFrame,this.h5Frame,"H5è‡ªé€‚åº”æ¨¡å—å®¹å™¨æ·»åŠ "),console.log("ğŸ¨ [èƒŒæ™¯è®¾ç½®è°ƒè¯•] èƒŒæ™¯è®¾ç½®å®Œæˆ")})}addModules(){return e(this,void 0,void 0,function*(){if(!this.h5Frame)return void console.log("æ²¡æœ‰è‡ªé€‚åº”æ¨¡å—å®¹å™¨ï¼Œè·³è¿‡æ¨¡å—æ·»åŠ ");const e=yield this.createAllModules();s.safeBatchAppendChildren(this.h5Frame,e,"H5æ¨¡å—æ‰¹é‡æ·»åŠ ")})}createAllModules(){return e(this,void 0,void 0,function*(){return Promise.all([this.createHeaderModuleIfNeeded(),this.createGameInfoModuleIfNeeded(),...this.createCustomModules(),this.createRulesModuleIfNeeded(),this.createFooterModuleIfNeeded()])})}createHeaderModuleIfNeeded(){return e(this,void 0,void 0,function*(){if(this.config.headerImage||this.config.titleUpload){const e=yield l(this.config.headerImage,this.config.titleUpload);if(e)return e}return null})}createGameInfoModuleIfNeeded(){return e(this,void 0,void 0,function*(){if(this.config.gameName||this.config.gameDesc||this.config.gameIcon){return yield a(this.config)}return null})}createCustomModules(){var o;return(null===(o=this.config.modules)||void 0===o?void 0:o.map(o=>e(this,void 0,void 0,function*(){return yield h(o)})))||[]}createRulesModuleIfNeeded(){return e(this,void 0,void 0,function*(){const e=this.config.rulesTitle&&""!==this.config.rulesTitle.trim(),o=null!==this.config.rulesBgImage&&void 0!==this.config.rulesBgImage,i=this.config.rulesContent&&""!==this.config.rulesContent.trim();if(e||o||i){return yield g(this.config)}return null})}createFooterModuleIfNeeded(){return e(this,void 0,void 0,function*(){if(this.config.footerLogo||this.config.footerBg){const e=yield c(this.config);if(e)return e}return null})}finalizeLayout(){if(this.h5Frame){this.outerFrame.resize(o.H5_WIDTH,this.h5Frame.height);try{if(this.h5Frame.parent===this.outerFrame){const e=this.outerFrame.children.length;e>1&&this.outerFrame.insertChild(e-1,this.h5Frame)}}catch(e){console.error("é‡æ–°æ’åˆ—H5æ¨¡å—å®¹å™¨å¤±è´¥:",e)}}else{let e=100;if(this.config.pageBgImage){const o=this.outerFrame.findOne(e=>"é¡µé¢èƒŒæ™¯å›¾ç‰‡"===e.name);o&&"height"in o&&(e=Math.max(e,o.height))}this.outerFrame.resize(o.H5_WIDTH,e),console.log(`æ²¡æœ‰æ¨¡å—å†…å®¹ï¼ŒH5åŸå‹è®¾ç½®ä¸ºæœ€å°é«˜åº¦: ${e}px`)}s.safeAppendChild(figma.currentPage,this.outerFrame,"H5åŸå‹æ·»åŠ åˆ°å½“å‰é¡µé¢"),figma.viewport.scrollAndZoomIntoView([this.outerFrame])}}function u(o){return e(this,void 0,void 0,function*(){return new f(o).build()})}export{f as H5PrototypeBuilder,u as createH5Prototype};
//# sourceMappingURL=h5-prototype-builder.js.map
